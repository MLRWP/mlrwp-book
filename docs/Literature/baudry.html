<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.189">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Machine Learning in Non-Life Reserving - 15&nbsp; Non-parametric individual claim reserving in insurance</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../Practical/practical.html" rel="next">
<link href="../Literature/al_mudafer.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script src="../site_libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="../site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="../site_libs/datatables-binding-0.25/datatables.js"></script>
<script src="../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="../site_libs/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="../site_libs/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="../site_libs/dt-core-1.11.3/js/jquery.dataTables.min.js"></script>
<link href="../site_libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="../site_libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Non-parametric individual claim reserving in insurance</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Machine Learning in Non-Life Reserving</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../intro.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../Foundations/foundations.html" class="sidebar-item-text sidebar-link">Foundations Workstream</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/01_getting_started.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Getting started</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/02_intro_to_r.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Introduction to R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/03_top_ten_r_packages.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">My Top 10 R Packages for Data Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/04_a_tidyverse.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">The tidyverse for actuaries</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/04_b_datatable.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">R’s data.table - a useful package for actuaries</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/05_a_glms_r.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Reserving with GLMs in R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/06_lasso.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Self-assembling claim reserving models using the LASSO</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/07_mlr3example.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">ML modelling on triangles - a worked example</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/08_intro_glm_gam_xgboost.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Getting to grips with GLM, GAM and XGBoost</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../Data/data.html" class="sidebar-item-text sidebar-link">Data Workstream</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Data/simulationmachine.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">simulationmachine</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Data/synthetic.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">synthetic</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../Literature/literature.html" class="sidebar-item-text sidebar-link">Literature review Workstream</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Literature/history_nn_papers.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">A brief history of papers looking at using neural networks in reserving</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Literature/al_mudafer.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Probabilistic Forecasting with Neural Networks Applied to Loss Reserving</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Literature/baudry.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Non-parametric individual claim reserving in insurance</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../Practical/practical.html" class="sidebar-item-text sidebar-link">Practical Considerations Workstream</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Practical/time_resource.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Practical Considerations Part 1: Time &amp; Resource Limitations</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">Conclusion</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../summary.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Summary</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">References</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="toc-section-number">15.1</span>  Introduction</a></li>
  <li><a href="#simulating-the-data" id="toc-simulating-the-data" class="nav-link" data-scroll-target="#simulating-the-data"><span class="toc-section-number">15.2</span>  Simulating the data</a>
  <ul class="collapse">
  <li><a href="#create-policy-data-set" id="toc-create-policy-data-set" class="nav-link" data-scroll-target="#create-policy-data-set"><span class="toc-section-number">15.2.1</span>  Create Policy Data set</a></li>
  <li><a href="#create-claims-file" id="toc-create-claims-file" class="nav-link" data-scroll-target="#create-claims-file"><span class="toc-section-number">15.2.2</span>  Create claims file</a></li>
  <li><a href="#checking-exhibits" id="toc-checking-exhibits" class="nav-link" data-scroll-target="#checking-exhibits"><span class="toc-section-number">15.2.3</span>  Checking exhibits</a></li>
  <li><a href="#function-to-create-policy-and-claim-data" id="toc-function-to-create-policy-and-claim-data" class="nav-link" data-scroll-target="#function-to-create-policy-and-claim-data"><span class="toc-section-number">15.2.4</span>  Function to create policy and claim data</a></li>
  </ul></li>
  <li><a href="#prepare-data-for-modelling" id="toc-prepare-data-for-modelling" class="nav-link" data-scroll-target="#prepare-data-for-modelling"><span class="toc-section-number">15.3</span>  Prepare data for modelling</a>
  <ul class="collapse">
  <li><a href="#a-few-words-before-we-start" id="toc-a-few-words-before-we-start" class="nav-link" data-scroll-target="#a-few-words-before-we-start"><span class="toc-section-number">15.3.1</span>  A few words before we start</a></li>
  <li><a href="#timeslicing-claim-payments" id="toc-timeslicing-claim-payments" class="nav-link" data-scroll-target="#timeslicing-claim-payments"><span class="toc-section-number">15.3.2</span>  Timeslicing claim payments</a></li>
  <li><a href="#creating-rbns-and-ibner-datasets" id="toc-creating-rbns-and-ibner-datasets" class="nav-link" data-scroll-target="#creating-rbns-and-ibner-datasets"><span class="toc-section-number">15.3.3</span>  Creating RBNS and IBNER datasets</a></li>
  <li><a href="#dataset-inspection" id="toc-dataset-inspection" class="nav-link" data-scroll-target="#dataset-inspection"><span class="toc-section-number">15.3.4</span>  Dataset inspection</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="toc-section-number">15.3.5</span>  Summary</a></li>
  </ul></li>
  <li><a href="#modelling-and-analysing-the-data" id="toc-modelling-and-analysing-the-data" class="nav-link" data-scroll-target="#modelling-and-analysing-the-data"><span class="toc-section-number">15.4</span>  Modelling and analysing the data</a>
  <ul class="collapse">
  <li><a href="#model-build" id="toc-model-build" class="nav-link" data-scroll-target="#model-build"><span class="toc-section-number">15.4.1</span>  Model build</a></li>
  <li><a href="#summary-1" id="toc-summary-1" class="nav-link" data-scroll-target="#summary-1"><span class="toc-section-number">15.4.2</span>  Summary</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-baudry" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Non-parametric individual claim reserving in insurance</span></span></h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<p><em>This <a href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/post/baudry-part1/">article</a> was written by <a href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/authors/ncarpenter/">Nigel Carpenter</a> and originally published on 13 November 2020.</em></p>
<section id="introduction" class="level2" data-number="15.1">
<h2 data-number="15.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">15.1</span> Introduction</h2>
<p>In this chapter, we provide code to replicate the central scenario in Maximilien Baudry’s paper “NON-PARAMETRIC INDIVIDUAL CLAIM RESERVING IN INSURANCE. Before running the code, we recommend that you read the original paper first.</p>
<ul>
<li><a href="https://www.institutdesactuaires.com/global/gene/link.php?doc_id=11747&amp;fg=1">https://www.institutdesactuaires.com/global/gene/link.php?doc_id=11747&amp;fg=1</a><br>
</li>
<li><a href="http://chaire-dami.fr/files/2016/10/Reserving-article.pdf">http://chaire-dami.fr/files/2016/10/Reserving-article.pdf</a></li>
</ul>
</section>
<section id="simulating-the-data" class="level2" data-number="15.2">
<h2 data-number="15.2" class="anchored" data-anchor-id="simulating-the-data"><span class="header-section-number">15.2</span> Simulating the data</h2>
<p>Below we step through the process to create a single simulated dataset. Having stepped through the data creation process, we present the code in the form of a function that returns a simulated policy and claim dataset at the end for later use.</p>
<p>The second notebook details the process for creating a reserving database and the third outlines the process for creating reserves using machine learning.</p>
<p>Before we start we import a few pre-requisite R packages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Importing packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xgboost)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SHAPforxgboost)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="create-policy-data-set" class="level3" data-number="15.2.1">
<h3 data-number="15.2.1" class="anchored" data-anchor-id="create-policy-data-set"><span class="header-section-number">15.2.1</span> Create Policy Data set</h3>
<p>Start by simulating number of policies sold by day and by policy coverage type.</p>
<section id="policy-count-by-date" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="policy-count-by-date">Policy count by date</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set a seed to control reproducibility</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># polices sold between start 2016 to end 2017</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>dt_policydates <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">date_UW =</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2016/1/1"</span>), <span class="fu">as.Date</span>(<span class="st">"2017/12/31"</span>), <span class="st">"day"</span>))</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># number of policies per day follows Poisson process with mean 700 (approx 255,500 pols per annum)</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>dt_policydates[, <span class="st">':='</span>(<span class="at">policycount =</span> <span class="fu">rpois</span>(.N,<span class="dv">700</span>),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">date_lapse =</span> date_UW <span class="sc">%m+%</span> <span class="fu">years</span>(<span class="dv">1</span>),</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                      <span class="at">expodays =</span> <span class="fu">as.integer</span>(date_UW <span class="sc">%m+%</span> <span class="fu">years</span>(<span class="dv">1</span>) <span class="sc">-</span> date_UW),</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">pol_prefix =</span> <span class="fu">year</span>(date_UW)<span class="sc">*</span><span class="dv">10000</span> <span class="sc">+</span> <span class="fu">month</span>(date_UW)<span class="sc">*</span><span class="dv">100</span> <span class="sc">+</span> <span class="fu">mday</span>(date_UW))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="policy-covers-by-by-date" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="policy-covers-by-by-date">Policy covers by by date</h4>
<p>Add policy coverage columns in proportions:</p>
<ul>
<li>25% Breakage</li>
<li>45% Breakage and Oxidation</li>
<li>30% Breakage, Oxidation and Theft.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add columns defining Policy Covers   </span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>dt_policydates[, Cover_B <span class="sc">:</span><span class="er">=</span> <span class="fu">round</span>(policycount <span class="sc">*</span> <span class="fl">0.25</span>)]</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>dt_policydates[, Cover_BO <span class="sc">:</span><span class="er">=</span> <span class="fu">round</span>(policycount <span class="sc">*</span> <span class="fl">0.45</span>)]</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>dt_policydates[, Cover_BOT <span class="sc">:</span><span class="er">=</span> policycount <span class="sc">-</span> Cover_B <span class="sc">-</span> Cover_BO]</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(<span class="fu">head</span>(dt_policydates))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="htmlwidget-1214300544f0d7fd8fc8" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1214300544f0d7fd8fc8">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],["2016-01-01","2016-01-02","2016-01-03","2016-01-04","2016-01-05","2016-01-06"],[685,731,655,703,745,712],["2017-01-01","2017-01-02","2017-01-03","2017-01-04","2017-01-05","2017-01-06"],[366,366,366,366,366,366],[20160101,20160102,20160103,20160104,20160105,20160106],[171,183,164,176,186,178],[308,329,295,316,335,320],[206,219,196,211,224,214]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>date_UW<\/th>\n      <th>policycount<\/th>\n      <th>date_lapse<\/th>\n      <th>expodays<\/th>\n      <th>pol_prefix<\/th>\n      <th>Cover_B<\/th>\n      <th>Cover_BO<\/th>\n      <th>Cover_BOT<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,4,5,6,7,8]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="policy-transaction-file" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="policy-transaction-file">Policy transaction file</h4>
<p>Next create a policy transaction file 1 row per policy, with columns to indicate policy coverage details.</p>
<section id="policy-date-number" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="policy-date-number">Policy date &amp; number</h5>
<p>First step is to create policy table with 1 row per policy and underwriting date.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># repeat rows for each policy by UW-Date</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>dt_policy <span class="ot">&lt;-</span> dt_policydates[<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>.N, policycount),<span class="fu">c</span>(<span class="st">"date_UW"</span>, <span class="st">"pol_prefix"</span>), with <span class="ot">=</span> <span class="cn">FALSE</span>][,pol_seq<span class="sc">:</span><span class="er">=</span><span class="dv">1</span><span class="sc">:</span>.N, by<span class="ot">=</span>pol_prefix]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a unique policy number </span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>dt_policy[, pol_number <span class="sc">:</span><span class="er">=</span> <span class="fu">as.character</span>(pol_prefix <span class="sc">*</span> <span class="dv">10000</span> <span class="sc">+</span> pol_seq)]</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dt_policy) <span class="sc">|&gt;</span> <span class="fu">datatable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="htmlwidget-6ae44d7ebd44ea771d3d" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6ae44d7ebd44ea771d3d">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],["2016-01-01","2016-01-01","2016-01-01","2016-01-01","2016-01-01","2016-01-01"],[20160101,20160101,20160101,20160101,20160101,20160101],[1,2,3,4,5,6],["201601010001","201601010002","201601010003","201601010004","201601010005","201601010006"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>date_UW<\/th>\n      <th>pol_prefix<\/th>\n      <th>pol_seq<\/th>\n      <th>pol_number<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="policy-coverage-type" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="policy-coverage-type">Policy coverage type</h5>
<p>Can now add the coverage appropriate to each row.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set join keys</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(dt_policy,<span class="st">'date_UW'</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(dt_policydates,<span class="st">'date_UW'</span>)  </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># remove pol_prefix before join</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>dt_policydates[, pol_prefix <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]  </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># join cover from summary file (dt_policydates)</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>dt_policy <span class="ot">&lt;-</span> dt_policy[dt_policydates]  </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># now create Cover field for each policy row</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>dt_policy[,Cover <span class="sc">:</span><span class="er">=</span> <span class="st">'BO'</span>]</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>dt_policy[pol_seq <span class="sc">&lt;=</span> policycount<span class="sc">-</span> Cover_BO,Cover <span class="sc">:</span><span class="er">=</span> <span class="st">'BOT'</span>]</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>dt_policy[pol_seq <span class="sc">&lt;=</span> Cover_B,Cover <span class="sc">:</span><span class="er">=</span> <span class="st">'B'</span>]  </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>dt_policy[, Cover_B <span class="sc">:</span><span class="er">=</span> <span class="fu">as.factor</span>(Cover)]  </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># remove interim calculation fields</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>dt_policy[, <span class="st">':='</span>(<span class="at">pol_prefix =</span> <span class="cn">NULL</span>,</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>                 <span class="at">policycount =</span> <span class="cn">NULL</span>,</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>                 <span class="at">pol_seq =</span> <span class="cn">NULL</span>,</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Cover_B =</span> <span class="cn">NULL</span>,</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Cover_BOT =</span> <span class="cn">NULL</span>,</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Cover_BO =</span> <span class="cn">NULL</span>)]</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="co"># check output</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dt_policy) <span class="sc">|&gt;</span> <span class="fu">datatable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="htmlwidget-acfd734343ea5f5bd4b3" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-acfd734343ea5f5bd4b3">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],["2016-01-01","2016-01-01","2016-01-01","2016-01-01","2016-01-01","2016-01-01"],["201601010001","201601010002","201601010003","201601010004","201601010005","201601010006"],["2017-01-01","2017-01-01","2017-01-01","2017-01-01","2017-01-01","2017-01-01"],[366,366,366,366,366,366],["B","B","B","B","B","B"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>date_UW<\/th>\n      <th>pol_number<\/th>\n      <th>date_lapse<\/th>\n      <th>expodays<\/th>\n      <th>Cover<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":4},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="policy-brand-price-model-features" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="policy-brand-price-model-features">Policy Brand, Price, Model features</h5>
<p>Now add policy brand, model and price details to the policy dataset</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add remaining policy details</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>dt_policy[, Brand <span class="sc">:</span><span class="er">=</span> <span class="fu">rep</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>), <span class="fu">c</span>(<span class="dv">9</span>,<span class="dv">6</span>,<span class="dv">3</span>,<span class="dv">2</span>)), <span class="at">length.out =</span> .N)]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>dt_policy[, Base_Price <span class="sc">:</span><span class="er">=</span> <span class="fu">rep</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">600</span>,<span class="dv">550</span>,<span class="dv">300</span>,<span class="dv">150</span>), <span class="fu">c</span>(<span class="dv">9</span>,<span class="dv">6</span>,<span class="dv">3</span>,<span class="dv">2</span>)), <span class="at">length.out =</span> .N)]</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># models types and model cost multipliers</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (eachBrand <span class="cf">in</span> <span class="fu">unique</span>(dt_policy<span class="sc">$</span>Brand)) {</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  dt_policy[Brand <span class="sc">==</span> eachBrand, Model <span class="sc">:</span><span class="er">=</span> <span class="fu">rep</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">0</span>), <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">7</span>, <span class="dv">2</span>, <span class="dv">1</span>)), <span class="at">length.out =</span> .N)]</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  dt_policy[Brand <span class="sc">==</span> eachBrand, Model_mult <span class="sc">:</span><span class="er">=</span> <span class="fu">rep</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="fl">1.15</span><span class="sc">^</span><span class="dv">3</span>, <span class="fl">1.15</span><span class="sc">^</span><span class="dv">2</span>, <span class="fl">1.15</span><span class="sc">^</span><span class="dv">1</span>, <span class="fl">1.15</span><span class="sc">^</span><span class="dv">0</span>), <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">7</span>, <span class="dv">2</span>, <span class="dv">1</span>)), <span class="at">length.out =</span> .N)]</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>dt_policy[, Price <span class="sc">:</span><span class="er">=</span> <span class="fu">ceiling</span> (Base_Price <span class="sc">*</span> Model_mult)]</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co"># check output</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dt_policy) <span class="sc">|&gt;</span> <span class="fu">datatable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="htmlwidget-452913fad04a2794e4df" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-452913fad04a2794e4df">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],["2016-01-01","2016-01-01","2016-01-01","2016-01-01","2016-01-01","2016-01-01"],["201601010001","201601010002","201601010003","201601010004","201601010005","201601010006"],["2017-01-01","2017-01-01","2017-01-01","2017-01-01","2017-01-01","2017-01-01"],[366,366,366,366,366,366],["B","B","B","B","B","B"],[1,1,1,1,1,1],[600,600,600,600,600,600],[3,3,3,3,3,3],[1.520875,1.520875,1.520875,1.520875,1.520875,1.520875],[913,913,913,913,913,913]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>date_UW<\/th>\n      <th>pol_number<\/th>\n      <th>date_lapse<\/th>\n      <th>expodays<\/th>\n      <th>Cover<\/th>\n      <th>Brand<\/th>\n      <th>Base_Price<\/th>\n      <th>Model<\/th>\n      <th>Model_mult<\/th>\n      <th>Price<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[4,6,7,8,9,10]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="tidy-and-save" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="tidy-and-save">Tidy and save</h5>
<p>Keep only columns of interest and save resulting policy file.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># colums to keep</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>cols_policy <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"pol_number"</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"date_UW"</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"date_lapse"</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Cover"</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Brand"</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Model"</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Price"</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>dt_policy <span class="ot">&lt;-</span> dt_policy[, cols_policy, with <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co"># check output</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dt_policy) <span class="sc">|&gt;</span> <span class="fu">datatable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="htmlwidget-39522a00a14b8d422f13" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-39522a00a14b8d422f13">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],["201601010001","201601010002","201601010003","201601010004","201601010005","201601010006"],["2016-01-01","2016-01-01","2016-01-01","2016-01-01","2016-01-01","2016-01-01"],["2017-01-01","2017-01-01","2017-01-01","2017-01-01","2017-01-01","2017-01-01"],["B","B","B","B","B","B"],[1,1,1,1,1,1],[3,3,3,3,3,3],[913,913,913,913,913,913]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>pol_number<\/th>\n      <th>date_UW<\/th>\n      <th>date_lapse<\/th>\n      <th>Cover<\/th>\n      <th>Brand<\/th>\n      <th>Model<\/th>\n      <th>Price<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[5,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
</section>
</section>
<section id="create-claims-file" class="level3" data-number="15.2.2">
<h3 data-number="15.2.2" class="anchored" data-anchor-id="create-claims-file"><span class="header-section-number">15.2.2</span> Create claims file</h3>
<section id="sample-claims-from-policies" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="sample-claims-from-policies">Sample Claims from Policies</h4>
<p>Claim rates vary by policy coverage and type.</p>
<section id="breakage-claims" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="breakage-claims">Breakage Claims</h5>
<p>Start with breakages claims. Sample from policies data set to create claims.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># All policies have breakage cover</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># claims uniformly sampled from policies</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>claim <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(dt_policy), <span class="at">size =</span> <span class="fu">floor</span>(<span class="fu">nrow</span>(dt_policy) <span class="sc">*</span> <span class="fl">0.15</span>))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Claim serverity multiplier sampled from beta distn</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>dt_claim <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">pol_number =</span> dt_policy[claim, pol_number],</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">claim_type =</span> <span class="st">'B'</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>                       <span class="at">claim_count =</span> <span class="dv">1</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>                       <span class="at">claim_sev =</span> <span class="fu">rbeta</span>(<span class="fu">length</span>(claim), <span class="dv">2</span>,<span class="dv">5</span>))</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co"># check output</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dt_claim) <span class="sc">|&gt;</span> <span class="fu">datatable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="htmlwidget-ff598303d9c0d8fc50d4" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-ff598303d9c0d8fc50d4">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],["201609240670","201603270380","201701120212","201712180024","201608060340","201705220523"],["B","B","B","B","B","B"],[1,1,1,1,1,1],[0.359041857698808,0.466384360291419,0.351069179676942,0.119798340429685,0.208868108977834,0.169297243907269]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>pol_number<\/th>\n      <th>claim_type<\/th>\n      <th>claim_count<\/th>\n      <th>claim_sev<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="oxidation-claims" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="oxidation-claims">Oxidation Claims</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># identify all policies with Oxidation cover</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>cov <span class="ot">&lt;-</span> <span class="fu">which</span>(dt_policy<span class="sc">$</span>Cover <span class="sc">!=</span> <span class="st">'B'</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># sample claims from policies with cover</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>claim <span class="ot">&lt;-</span> <span class="fu">sample</span>(cov, <span class="at">size =</span> <span class="fu">floor</span>(<span class="fu">length</span>(cov) <span class="sc">*</span> <span class="fl">0.05</span>))</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co"># add claims to table </span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>dt_claim <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dt_claim,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">data.table</span>(<span class="at">pol_number =</span> dt_policy[claim, pol_number],</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>                             <span class="at">claim_type =</span> <span class="st">'O'</span>,</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>                             <span class="at">claim_count =</span> <span class="dv">1</span>,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>                             <span class="at">claim_sev =</span> <span class="fu">rbeta</span>(<span class="fu">length</span>(claim), <span class="dv">5</span>,<span class="dv">3</span>)))</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co"># check output</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dt_claim) <span class="sc">|&gt;</span> <span class="fu">datatable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="htmlwidget-2390a6f83a44dc881ec5" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-2390a6f83a44dc881ec5">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],["201609240670","201603270380","201701120212","201712180024","201608060340","201705220523"],["B","B","B","B","B","B"],[1,1,1,1,1,1],[0.359041857698808,0.466384360291419,0.351069179676942,0.119798340429685,0.208868108977834,0.169297243907269]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>pol_number<\/th>\n      <th>claim_type<\/th>\n      <th>claim_count<\/th>\n      <th>claim_sev<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="theft-claims" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="theft-claims">Theft Claims</h5>
<p>In the original paper the distribution for Theft severity claims is stated to be Beta(alpha = 5, beta = 0.5).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># identify all policies with Theft cover</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># for Theft claim frequency varies by Brand</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># So need to consider each in turn...</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(myModel <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">3</span>) {</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    cov <span class="ot">&lt;-</span> <span class="fu">which</span>(dt_policy<span class="sc">$</span>Cover <span class="sc">==</span> <span class="st">'BOT'</span> <span class="sc">&amp;</span> dt_policy<span class="sc">$</span>Model <span class="sc">==</span> myModel)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    claim <span class="ot">&lt;-</span> <span class="fu">sample</span>(cov, <span class="at">size =</span> <span class="fu">floor</span>(<span class="fu">length</span>(cov) <span class="sc">*</span> <span class="fl">0.05</span><span class="sc">*</span>(<span class="dv">1</span> <span class="sc">+</span> myModel)))</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    dt_claim <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dt_claim,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">data.table</span>(<span class="at">pol_number =</span> dt_policy[claim, pol_number],</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">claim_type =</span> <span class="st">'T'</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">claim_count =</span> <span class="dv">1</span>,</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">claim_sev =</span> <span class="fu">rbeta</span>(<span class="fu">length</span>(claim), <span class="dv">5</span>,.<span class="dv">5</span>)))</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co"># check output</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dt_claim) <span class="sc">|&gt;</span> <span class="fu">datatable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="htmlwidget-289e224830e2faa55190" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-289e224830e2faa55190">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],["201609240670","201603270380","201701120212","201712180024","201608060340","201705220523"],["B","B","B","B","B","B"],[1,1,1,1,1,1],[0.359041857698808,0.466384360291419,0.351069179676942,0.119798340429685,0.208868108977834,0.169297243907269]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>pol_number<\/th>\n      <th>claim_type<\/th>\n      <th>claim_count<\/th>\n      <th>claim_sev<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(dt_claim) <span class="sc">|&gt;</span> <span class="fu">datatable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="htmlwidget-4c6bae5ce9340fe0e58e" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-4c6bae5ce9340fe0e58e">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],["201704210215","201608210355","201612010350","201704110252","201707250328","201706120306"],["T","T","T","T","T","T"],[1,1,1,1,1,1],[0.673972963985571,0.969033254327245,0.88452185269606,0.917972014199667,0.917873473252391,0.981890028655961]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>pol_number<\/th>\n      <th>claim_type<\/th>\n      <th>claim_count<\/th>\n      <th>claim_sev<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
</section>
<section id="claim-dates-and-costs" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="claim-dates-and-costs">Claim dates and costs</h4>
<section id="policy-uw_date-and-value" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="policy-uw_date-and-value">Policy UW_date and value</h5>
<p>Now need to add details to claims, such as policy underwriting date and phone cost. These details come from the policy table.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set join keys</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(dt_policy, pol_number)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(dt_claim, pol_number)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">#join Brand and Price from policy to claim</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>dt_claim[dt_policy,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>         on <span class="ot">=</span> <span class="st">'pol_number'</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>         <span class="st">':='</span>(<span class="at">date_UW =</span> i.date_UW,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">Price =</span> i.Price,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">Brand =</span> i.Brand)]</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co"># check output</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dt_claim) <span class="sc">|&gt;</span> <span class="fu">datatable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="htmlwidget-5a958740c5f0d5c504d9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5a958740c5f0d5c504d9">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],["201601010016","201601010043","201601010047","201601010056","201601010057","201601010073"],["B","B","B","B","B","B"],[1,1,1,1,1,1],[0.206575261473757,0.50473224208281,0.0790409653088307,0.138838009723771,0.21246920301809,0.102677816226453],["2016-01-01","2016-01-01","2016-01-01","2016-01-01","2016-01-01","2016-01-01"],[457,913,913,457,457,837],[3,1,1,3,3,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>pol_number<\/th>\n      <th>claim_type<\/th>\n      <th>claim_count<\/th>\n      <th>claim_sev<\/th>\n      <th>date_UW<\/th>\n      <th>Price<\/th>\n      <th>Brand<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[3,4,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="add-simulated-claim-occrrence-reporting-and-payment-delays" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="add-simulated-claim-occrrence-reporting-and-payment-delays">Add simulated Claim occrrence, reporting and payment delays</h5>
<p>Occurence delay is assumed uniform over policy exposure period. Reporting and payment delays assumed to follow Beta distribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># use lubridate %m+% date addition operator </span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>dt_claim[, date_lapse <span class="sc">:</span><span class="er">=</span> date_UW <span class="sc">%m+%</span> <span class="fu">years</span>(<span class="dv">1</span>)]</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>dt_claim[, expodays <span class="sc">:</span><span class="er">=</span> <span class="fu">as.integer</span>(date_lapse <span class="sc">-</span> date_UW)]</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>dt_claim[, occ_delay_days <span class="sc">:</span><span class="er">=</span> <span class="fu">floor</span>(expodays <span class="sc">*</span> <span class="fu">runif</span>(.N, <span class="dv">0</span>,<span class="dv">1</span>))]</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>dt_claim[ ,delay_report <span class="sc">:</span><span class="er">=</span> <span class="fu">floor</span>(<span class="dv">365</span> <span class="sc">*</span> <span class="fu">rbeta</span>(.N, .<span class="dv">4</span>, <span class="dv">10</span>))]  </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>dt_claim[ ,delay_pay <span class="sc">:</span><span class="er">=</span> <span class="fu">floor</span>(<span class="dv">10</span> <span class="sc">+</span> <span class="dv">40</span><span class="sc">*</span> <span class="fu">rbeta</span>(.N, <span class="dv">7</span>,<span class="dv">7</span>))]  </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>dt_claim[, date_occur <span class="sc">:</span><span class="er">=</span> date_UW <span class="sc">%m+%</span> <span class="fu">days</span>(occ_delay_days)]</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>dt_claim[, date_report <span class="sc">:</span><span class="er">=</span> date_occur <span class="sc">%m+%</span> <span class="fu">days</span>(delay_report)]</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>dt_claim[, date_pay <span class="sc">:</span><span class="er">=</span> date_report <span class="sc">%m+%</span> <span class="fu">days</span>(delay_pay)]</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>dt_claim[, claim_cost <span class="sc">:</span><span class="er">=</span> <span class="fu">round</span>(Price <span class="sc">*</span> claim_sev)]</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co"># check output</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dt_claim) <span class="sc">|&gt;</span> <span class="fu">datatable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="htmlwidget-081ee942a81f341651d5" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-081ee942a81f341651d5">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],["201601010016","201601010043","201601010047","201601010056","201601010057","201601010073"],["B","B","B","B","B","B"],[1,1,1,1,1,1],[0.206575261473757,0.50473224208281,0.0790409653088307,0.138838009723771,0.21246920301809,0.102677816226453],["2016-01-01","2016-01-01","2016-01-01","2016-01-01","2016-01-01","2016-01-01"],[457,913,913,457,457,837],[3,1,1,3,3,2],["2017-01-01","2017-01-01","2017-01-01","2017-01-01","2017-01-01","2017-01-01"],[366,366,366,366,366,366],[169,30,120,77,95,298],[0,0,73,0,5,5],[37,32,29,27,18,24],["2016-06-18","2016-01-31","2016-04-30","2016-03-18","2016-04-05","2016-10-25"],["2016-06-18","2016-01-31","2016-07-12","2016-03-18","2016-04-10","2016-10-30"],["2016-07-25","2016-03-03","2016-08-10","2016-04-14","2016-04-28","2016-11-23"],[94,461,72,63,97,86]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>pol_number<\/th>\n      <th>claim_type<\/th>\n      <th>claim_count<\/th>\n      <th>claim_sev<\/th>\n      <th>date_UW<\/th>\n      <th>Price<\/th>\n      <th>Brand<\/th>\n      <th>date_lapse<\/th>\n      <th>expodays<\/th>\n      <th>occ_delay_days<\/th>\n      <th>delay_report<\/th>\n      <th>delay_pay<\/th>\n      <th>date_occur<\/th>\n      <th>date_report<\/th>\n      <th>date_pay<\/th>\n      <th>claim_cost<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[3,4,6,7,9,10,11,12,16]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="claim-key-and-tidy" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="claim-key-and-tidy">Claim key and tidy</h5>
<p>Simple tidying and addition of a unique claim key. Then save out the file for future use.</p>
<p>The original paper spoke of using a “competing hazards model” for simulating claims. I have taken this to mean that a policy can only give rise to one claim. Where the above process has simulated multiple claims against the same policy I keep only the first occuring claim.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add a unique claimkey based upon occurence date</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>dt_claim[, clm_prefix <span class="sc">:</span><span class="er">=</span> <span class="fu">year</span>(date_occur)<span class="sc">*</span><span class="dv">10000</span> <span class="sc">+</span> <span class="fu">month</span>(date_occur)<span class="sc">*</span><span class="dv">100</span> <span class="sc">+</span> <span class="fu">mday</span>(date_occur)]</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>dt_claim[, clm_seq <span class="sc">:</span><span class="er">=</span> <span class="fu">seq_len</span>(.N), by <span class="ot">=</span> clm_prefix]</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>dt_claim[, clm_number <span class="sc">:</span><span class="er">=</span> <span class="fu">as.character</span>(clm_prefix <span class="sc">*</span> <span class="dv">10000</span> <span class="sc">+</span> clm_seq)]</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co"># keep only first claim against policy (competing hazards)</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="fu">setkeyv</span>(dt_claim, <span class="fu">c</span>(<span class="st">"pol_number"</span>, <span class="st">"clm_prefix"</span>))</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>dt_claim[, polclm_seq <span class="sc">:</span><span class="er">=</span> <span class="fu">seq_len</span>(.N), by <span class="ot">=</span> .(pol_number)]</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>dt_claim <span class="ot">&lt;-</span> dt_claim[polclm_seq <span class="sc">==</span> <span class="dv">1</span>,]</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co"># colums to keep</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>cols_claim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"clm_number"</span>,</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>                <span class="st">"pol_number"</span>,</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>                <span class="st">"claim_type"</span>,</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>                <span class="st">"claim_count"</span>,</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>                <span class="st">"claim_sev"</span>,</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>                <span class="st">"date_occur"</span>,</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>                <span class="st">"date_report"</span>,</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>                <span class="st">"date_pay"</span>,</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>                <span class="st">"claim_cost"</span>)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>dt_claim <span class="ot">&lt;-</span> dt_claim[, cols_claim, with <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="co"># check output</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dt_claim) <span class="sc">|&gt;</span> <span class="fu">datatable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="htmlwidget-3996f87218251da5e783" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-3996f87218251da5e783">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],["201606180001","201601310001","201604300001","201603180001","201604050001","201610250001"],["201601010016","201601010043","201601010047","201601010056","201601010057","201601010073"],["B","B","B","B","B","B"],[1,1,1,1,1,1],[0.206575261473757,0.50473224208281,0.0790409653088307,0.138838009723771,0.21246920301809,0.102677816226453],["2016-06-18","2016-01-31","2016-04-30","2016-03-18","2016-04-05","2016-10-25"],["2016-06-18","2016-01-31","2016-07-12","2016-03-18","2016-04-10","2016-10-30"],["2016-07-25","2016-03-03","2016-08-10","2016-04-14","2016-04-28","2016-11-23"],[94,461,72,63,97,86]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>clm_number<\/th>\n      <th>pol_number<\/th>\n      <th>claim_type<\/th>\n      <th>claim_count<\/th>\n      <th>claim_sev<\/th>\n      <th>date_occur<\/th>\n      <th>date_report<\/th>\n      <th>date_pay<\/th>\n      <th>claim_cost<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[4,5,9]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
</section>
</section>
<section id="checking-exhibits" class="level3" data-number="15.2.3">
<h3 data-number="15.2.3" class="anchored" data-anchor-id="checking-exhibits"><span class="header-section-number">15.2.3</span> Checking exhibits</h3>
<p>Baudry’s paper produced a number of summary exhibits from the simulated data. Let’s recreate them to get some comfort that we have correctly recreated the data.</p>
<p>You can see that the severity exhbit, Chart B, is inconsistent with that presented in the original paper. The cause of that difference is unclear at the time of writing. It’s likely to be because something nearer to a Beta(alpha = 5, beta = 0.05) has been used. However using that creates other discrepancies likely to be due to issues with the competing hazards implementation. For now we note the differences and continue with the data as created here.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="baudry_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>dt_claim[, Days_reportdelay <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>(<span class="fu">difftime</span>(date_report, date_occur, <span class="at">units=</span><span class="st">"days"</span>))]</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(dt_claim[, Days_reportdelay],<span class="at">breaks =</span> <span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="baudry_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>dt_claim[, Days_paymentdelay <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>(<span class="fu">difftime</span>(date_pay, date_report, <span class="at">units=</span><span class="st">"days"</span>))]</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(dt_claim[, Days_paymentdelay],<span class="at">breaks =</span> <span class="dv">60</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="baudry_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The final set of exhibits are those on slide 44. The only difference of note here is in Chart B, the Claim Rate by phone brand.</p>
<p>Baudry’s exhibits show Brand 1 to have a 5% higher claim frequency than other Brands. From reading the paper I can’t see why we should expect that to be the case. Claim rate varies by phone Model but Model incidence doesn’t vary by Brand. Therefore I can’t see how the Chart B equivalent could be correct given the details in the paper.</p>
<p>I leave the code as is noting the difference but recognising that it will not affect the wider aims of the paper.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="baudry_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="function-to-create-policy-and-claim-data" class="level3" data-number="15.2.4">
<h3 data-number="15.2.4" class="anchored" data-anchor-id="function-to-create-policy-and-claim-data"><span class="header-section-number">15.2.4</span> Function to create policy and claim data</h3>
<p>The above code can be wrapped into a function which returns a list containing the policy and claim datasets.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>simulate_central_scenario <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">seed =</span> <span class="dv">1234</span>){</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#seed = 1234  </span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Policy data</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#~~~~~~~~~~~~~~~~~</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># polices sold between start 2016 to end 2017</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  dt_policydates <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">date_UW =</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2016/1/1"</span>), <span class="fu">as.Date</span>(<span class="st">"2017/12/31"</span>), <span class="st">"day"</span>))</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># number of policies per day follows Poisson process with mean 700 (approx 255,500 pols per annum)</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  dt_policydates[, <span class="st">':='</span>(<span class="at">policycount =</span> <span class="fu">rpois</span>(.N,<span class="dv">700</span>),</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>                        <span class="at">date_lapse =</span> date_UW <span class="sc">%m+%</span> <span class="fu">years</span>(<span class="dv">1</span>),</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>                        <span class="at">expodays =</span> <span class="fu">as.integer</span>(date_UW <span class="sc">%m+%</span> <span class="fu">years</span>(<span class="dv">1</span>) <span class="sc">-</span> date_UW),</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>                        <span class="at">pol_prefix =</span> <span class="fu">year</span>(date_UW)<span class="sc">*</span><span class="dv">10000</span> <span class="sc">+</span> <span class="fu">month</span>(date_UW)<span class="sc">*</span><span class="dv">100</span> <span class="sc">+</span> <span class="fu">mday</span>(date_UW))]</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add columns defining Policy Covers   </span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  dt_policydates[, Cover_B <span class="sc">:</span><span class="er">=</span> <span class="fu">round</span>(policycount <span class="sc">*</span> <span class="fl">0.25</span>)]</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>  dt_policydates[, Cover_BO <span class="sc">:</span><span class="er">=</span> <span class="fu">round</span>(policycount <span class="sc">*</span> <span class="fl">0.45</span>)]</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>  dt_policydates[, Cover_BOT <span class="sc">:</span><span class="er">=</span> policycount <span class="sc">-</span> Cover_B <span class="sc">-</span> Cover_BO]</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># repeat rows for each policy by UW-Date</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>  dt_policy <span class="ot">&lt;-</span> dt_policydates[<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>.N, policycount),<span class="fu">c</span>(<span class="st">"date_UW"</span>, <span class="st">"pol_prefix"</span>), with <span class="ot">=</span> <span class="cn">FALSE</span>][,pol_seq<span class="sc">:</span><span class="er">=</span><span class="dv">1</span><span class="sc">:</span>.N, by<span class="ot">=</span>pol_prefix]</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a unique policy number </span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>  dt_policy[, pol_number <span class="sc">:</span><span class="er">=</span> <span class="fu">as.character</span>(pol_prefix <span class="sc">*</span> <span class="dv">10000</span> <span class="sc">+</span> pol_seq)]</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set join keys</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setkey</span>(dt_policy,<span class="st">'date_UW'</span>)</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setkey</span>(dt_policydates,<span class="st">'date_UW'</span>)  </span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove pol_prefix before join</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>  dt_policydates[, pol_prefix <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]  </span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># join cover from summary file (dt_policydates)</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>  dt_policy <span class="ot">&lt;-</span> dt_policy[dt_policydates]  </span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># now create Cover field for each policy row</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>  dt_policy[,Cover <span class="sc">:</span><span class="er">=</span> <span class="st">'BO'</span>]</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>  dt_policy[pol_seq <span class="sc">&lt;=</span> policycount<span class="sc">-</span> Cover_BO,Cover <span class="sc">:</span><span class="er">=</span> <span class="st">'BOT'</span>]</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>  dt_policy[pol_seq <span class="sc">&lt;=</span> Cover_B,Cover <span class="sc">:</span><span class="er">=</span> <span class="st">'B'</span>]  </span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove interim calculation fields</span></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>  dt_policy[, <span class="st">':='</span>(<span class="at">pol_prefix =</span> <span class="cn">NULL</span>,</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>                   <span class="at">policycount =</span> <span class="cn">NULL</span>,</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>                   <span class="at">pol_seq =</span> <span class="cn">NULL</span>,</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>                   <span class="at">Cover_B =</span> <span class="cn">NULL</span>,</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>                   <span class="at">Cover_BOT =</span> <span class="cn">NULL</span>,</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>                   <span class="at">Cover_BO =</span> <span class="cn">NULL</span>)]</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add remaining policy details</span></span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>  dt_policy[, Brand <span class="sc">:</span><span class="er">=</span> <span class="fu">rep</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>), <span class="fu">c</span>(<span class="dv">9</span>,<span class="dv">6</span>,<span class="dv">3</span>,<span class="dv">2</span>)), <span class="at">length.out =</span> .N)]</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>  dt_policy[, Base_Price <span class="sc">:</span><span class="er">=</span> <span class="fu">rep</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">600</span>,<span class="dv">550</span>,<span class="dv">300</span>,<span class="dv">150</span>), <span class="fu">c</span>(<span class="dv">9</span>,<span class="dv">6</span>,<span class="dv">3</span>,<span class="dv">2</span>)), <span class="at">length.out =</span> .N)]</span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># models types and model cost multipliers</span></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (eachBrand <span class="cf">in</span> <span class="fu">unique</span>(dt_policy<span class="sc">$</span>Brand)) {</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>    dt_policy[Brand <span class="sc">==</span> eachBrand, Model <span class="sc">:</span><span class="er">=</span> <span class="fu">rep</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">0</span>), <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">7</span>, <span class="dv">2</span>, <span class="dv">1</span>)), <span class="at">length.out =</span> .N)]</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>    dt_policy[Brand <span class="sc">==</span> eachBrand, Model_mult <span class="sc">:</span><span class="er">=</span> <span class="fu">rep</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="fl">1.15</span><span class="sc">^</span><span class="dv">3</span>, <span class="fl">1.15</span><span class="sc">^</span><span class="dv">2</span>, <span class="fl">1.15</span><span class="sc">^</span><span class="dv">1</span>, <span class="fl">1.15</span><span class="sc">^</span><span class="dv">0</span>), <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">7</span>, <span class="dv">2</span>, <span class="dv">1</span>)), <span class="at">length.out =</span> .N)]</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>  dt_policy[, Price <span class="sc">:</span><span class="er">=</span> <span class="fu">ceiling</span> (Base_Price <span class="sc">*</span> Model_mult)]</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>  <span class="co"># colums to keep</span></span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>  cols_policy <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"pol_number"</span>,</span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"date_UW"</span>,</span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"date_lapse"</span>,</span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"Cover"</span>,</span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"Brand"</span>,</span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"Model"</span>,</span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"Price"</span>)</span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>  dt_policy <span class="ot">&lt;-</span> dt_policy[, cols_policy, with <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># check output</span></span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>  <span class="co">#head(dt_policy)</span></span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>  <span class="co">#save(dt_policy, file = "./dt_policy.rda")</span></span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Claims data</span></span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a>  <span class="co">#~~~~~~~~~~~~~~~~~</span></span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a> <span class="co"># All policies have breakage cover</span></span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a>  <span class="co"># claims uniformly sampled from policies</span></span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>  claim <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(dt_policy), <span class="at">size =</span> <span class="fu">floor</span>(<span class="fu">nrow</span>(dt_policy) <span class="sc">*</span> <span class="fl">0.15</span>))</span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Claim serverity multiplier sampled from beta distn</span></span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a>  dt_claim <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">pol_number =</span> dt_policy[claim, pol_number],</span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a>                         <span class="at">claim_type =</span> <span class="st">'B'</span>,</span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a>                         <span class="at">claim_count =</span> <span class="dv">1</span>,</span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a>                         <span class="at">claim_sev =</span> <span class="fu">rbeta</span>(<span class="fu">length</span>(claim), <span class="dv">2</span>,<span class="dv">5</span>))</span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># identify all policies with Oxidation cover</span></span>
<span id="cb17-98"><a href="#cb17-98" aria-hidden="true" tabindex="-1"></a>  cov <span class="ot">&lt;-</span> <span class="fu">which</span>(dt_policy<span class="sc">$</span>Cover <span class="sc">!=</span> <span class="st">'B'</span>)</span>
<span id="cb17-99"><a href="#cb17-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-100"><a href="#cb17-100" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sample claims from policies with cover</span></span>
<span id="cb17-101"><a href="#cb17-101" aria-hidden="true" tabindex="-1"></a>  claim <span class="ot">&lt;-</span> <span class="fu">sample</span>(cov, <span class="at">size =</span> <span class="fu">floor</span>(<span class="fu">length</span>(cov) <span class="sc">*</span> <span class="fl">0.05</span>))</span>
<span id="cb17-102"><a href="#cb17-102" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-103"><a href="#cb17-103" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add claims to table </span></span>
<span id="cb17-104"><a href="#cb17-104" aria-hidden="true" tabindex="-1"></a>  dt_claim <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dt_claim,</span>
<span id="cb17-105"><a href="#cb17-105" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">data.table</span>(<span class="at">pol_number =</span> dt_policy[claim, pol_number],</span>
<span id="cb17-106"><a href="#cb17-106" aria-hidden="true" tabindex="-1"></a>                               <span class="at">claim_type =</span> <span class="st">'O'</span>,</span>
<span id="cb17-107"><a href="#cb17-107" aria-hidden="true" tabindex="-1"></a>                               <span class="at">claim_count =</span> <span class="dv">1</span>,</span>
<span id="cb17-108"><a href="#cb17-108" aria-hidden="true" tabindex="-1"></a>                               <span class="at">claim_sev =</span> <span class="fu">rbeta</span>(<span class="fu">length</span>(claim), <span class="dv">5</span>,<span class="dv">3</span>)))</span>
<span id="cb17-109"><a href="#cb17-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-110"><a href="#cb17-110" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-111"><a href="#cb17-111" aria-hidden="true" tabindex="-1"></a>  <span class="co"># identify all policies with Theft cover</span></span>
<span id="cb17-112"><a href="#cb17-112" aria-hidden="true" tabindex="-1"></a>  <span class="co"># for Theft claim frequency varies by Brand</span></span>
<span id="cb17-113"><a href="#cb17-113" aria-hidden="true" tabindex="-1"></a>  <span class="co"># So need to consider each in turn...</span></span>
<span id="cb17-114"><a href="#cb17-114" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-115"><a href="#cb17-115" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(myModel <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">3</span>) {</span>
<span id="cb17-116"><a href="#cb17-116" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-117"><a href="#cb17-117" aria-hidden="true" tabindex="-1"></a>    cov <span class="ot">&lt;-</span> <span class="fu">which</span>(dt_policy<span class="sc">$</span>Cover <span class="sc">==</span> <span class="st">'BOT'</span> <span class="sc">&amp;</span> dt_policy<span class="sc">$</span>Model <span class="sc">==</span> myModel)</span>
<span id="cb17-118"><a href="#cb17-118" aria-hidden="true" tabindex="-1"></a>    claim <span class="ot">&lt;-</span> <span class="fu">sample</span>(cov, <span class="at">size =</span> <span class="fu">floor</span>(<span class="fu">length</span>(cov) <span class="sc">*</span> <span class="fl">0.05</span><span class="sc">*</span>(<span class="dv">1</span> <span class="sc">+</span> myModel)))</span>
<span id="cb17-119"><a href="#cb17-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-120"><a href="#cb17-120" aria-hidden="true" tabindex="-1"></a>    dt_claim <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dt_claim,</span>
<span id="cb17-121"><a href="#cb17-121" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">data.table</span>(<span class="at">pol_number =</span> dt_policy[claim, pol_number],</span>
<span id="cb17-122"><a href="#cb17-122" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">claim_type =</span> <span class="st">'T'</span>,</span>
<span id="cb17-123"><a href="#cb17-123" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">claim_count =</span> <span class="dv">1</span>,</span>
<span id="cb17-124"><a href="#cb17-124" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">claim_sev =</span> <span class="fu">rbeta</span>(<span class="fu">length</span>(claim), <span class="dv">5</span>,.<span class="dv">5</span>)))</span>
<span id="cb17-125"><a href="#cb17-125" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-126"><a href="#cb17-126" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-127"><a href="#cb17-127" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set join keys</span></span>
<span id="cb17-128"><a href="#cb17-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setkey</span>(dt_policy, pol_number)</span>
<span id="cb17-129"><a href="#cb17-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setkey</span>(dt_claim, pol_number)</span>
<span id="cb17-130"><a href="#cb17-130" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-131"><a href="#cb17-131" aria-hidden="true" tabindex="-1"></a>  <span class="co">#join Brand and Price from policy to claim</span></span>
<span id="cb17-132"><a href="#cb17-132" aria-hidden="true" tabindex="-1"></a>  dt_claim[dt_policy,</span>
<span id="cb17-133"><a href="#cb17-133" aria-hidden="true" tabindex="-1"></a>           on <span class="ot">=</span> <span class="st">'pol_number'</span>,</span>
<span id="cb17-134"><a href="#cb17-134" aria-hidden="true" tabindex="-1"></a>           <span class="st">':='</span>(<span class="at">date_UW =</span> i.date_UW,</span>
<span id="cb17-135"><a href="#cb17-135" aria-hidden="true" tabindex="-1"></a>                <span class="at">Price =</span> i.Price,</span>
<span id="cb17-136"><a href="#cb17-136" aria-hidden="true" tabindex="-1"></a>                <span class="at">Brand =</span> i.Brand)]</span>
<span id="cb17-137"><a href="#cb17-137" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-138"><a href="#cb17-138" aria-hidden="true" tabindex="-1"></a>  <span class="co"># use lubridate %m+% date addition operator </span></span>
<span id="cb17-139"><a href="#cb17-139" aria-hidden="true" tabindex="-1"></a>  dt_claim[, date_lapse <span class="sc">:</span><span class="er">=</span> date_UW <span class="sc">%m+%</span> <span class="fu">years</span>(<span class="dv">1</span>)]</span>
<span id="cb17-140"><a href="#cb17-140" aria-hidden="true" tabindex="-1"></a>  dt_claim[, expodays <span class="sc">:</span><span class="er">=</span> <span class="fu">as.integer</span>(date_lapse <span class="sc">-</span> date_UW)]</span>
<span id="cb17-141"><a href="#cb17-141" aria-hidden="true" tabindex="-1"></a>  dt_claim[, occ_delay_days <span class="sc">:</span><span class="er">=</span> <span class="fu">floor</span>(expodays <span class="sc">*</span> <span class="fu">runif</span>(.N, <span class="dv">0</span>,<span class="dv">1</span>))]</span>
<span id="cb17-142"><a href="#cb17-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-143"><a href="#cb17-143" aria-hidden="true" tabindex="-1"></a>  dt_claim[ ,delay_report <span class="sc">:</span><span class="er">=</span> <span class="fu">floor</span>(<span class="dv">365</span> <span class="sc">*</span> <span class="fu">rbeta</span>(.N, .<span class="dv">4</span>, <span class="dv">10</span>))]  </span>
<span id="cb17-144"><a href="#cb17-144" aria-hidden="true" tabindex="-1"></a>  dt_claim[ ,delay_pay <span class="sc">:</span><span class="er">=</span> <span class="fu">floor</span>(<span class="dv">10</span> <span class="sc">+</span> <span class="dv">40</span><span class="sc">*</span> <span class="fu">rbeta</span>(.N, <span class="dv">7</span>,<span class="dv">7</span>))]  </span>
<span id="cb17-145"><a href="#cb17-145" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-146"><a href="#cb17-146" aria-hidden="true" tabindex="-1"></a>  dt_claim[, date_occur <span class="sc">:</span><span class="er">=</span> date_UW <span class="sc">%m+%</span> <span class="fu">days</span>(occ_delay_days)]</span>
<span id="cb17-147"><a href="#cb17-147" aria-hidden="true" tabindex="-1"></a>  dt_claim[, date_report <span class="sc">:</span><span class="er">=</span> date_occur <span class="sc">%m+%</span> <span class="fu">days</span>(delay_report)]</span>
<span id="cb17-148"><a href="#cb17-148" aria-hidden="true" tabindex="-1"></a>  dt_claim[, date_pay <span class="sc">:</span><span class="er">=</span> date_report <span class="sc">%m+%</span> <span class="fu">days</span>(delay_pay)]</span>
<span id="cb17-149"><a href="#cb17-149" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-150"><a href="#cb17-150" aria-hidden="true" tabindex="-1"></a>  dt_claim[, claim_cost <span class="sc">:</span><span class="er">=</span> <span class="fu">round</span>(Price <span class="sc">*</span> claim_sev)]</span>
<span id="cb17-151"><a href="#cb17-151" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-152"><a href="#cb17-152" aria-hidden="true" tabindex="-1"></a>  dt_claim[, clm_prefix <span class="sc">:</span><span class="er">=</span> <span class="fu">year</span>(date_report)<span class="sc">*</span><span class="dv">10000</span> <span class="sc">+</span> <span class="fu">month</span>(date_report)<span class="sc">*</span><span class="dv">100</span> <span class="sc">+</span> <span class="fu">mday</span>(date_report)]</span>
<span id="cb17-153"><a href="#cb17-153" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-154"><a href="#cb17-154" aria-hidden="true" tabindex="-1"></a>  dt_claim[, clm_seq <span class="sc">:</span><span class="er">=</span> <span class="fu">seq_len</span>(.N), by <span class="ot">=</span> clm_prefix]</span>
<span id="cb17-155"><a href="#cb17-155" aria-hidden="true" tabindex="-1"></a>  dt_claim[, clm_number <span class="sc">:</span><span class="er">=</span> <span class="fu">as.character</span>(clm_prefix <span class="sc">*</span> <span class="dv">10000</span> <span class="sc">+</span> clm_seq)]</span>
<span id="cb17-156"><a href="#cb17-156" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-157"><a href="#cb17-157" aria-hidden="true" tabindex="-1"></a>  <span class="co"># keep only first claim against policy (competing hazards)</span></span>
<span id="cb17-158"><a href="#cb17-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setkeyv</span>(dt_claim, <span class="fu">c</span>(<span class="st">"pol_number"</span>, <span class="st">"clm_prefix"</span>))</span>
<span id="cb17-159"><a href="#cb17-159" aria-hidden="true" tabindex="-1"></a>  dt_claim[, polclm_seq <span class="sc">:</span><span class="er">=</span> <span class="fu">seq_len</span>(.N), by <span class="ot">=</span> .(pol_number)]</span>
<span id="cb17-160"><a href="#cb17-160" aria-hidden="true" tabindex="-1"></a>  dt_claim <span class="ot">&lt;-</span> dt_claim[polclm_seq <span class="sc">==</span> <span class="dv">1</span>,]</span>
<span id="cb17-161"><a href="#cb17-161" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-162"><a href="#cb17-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-163"><a href="#cb17-163" aria-hidden="true" tabindex="-1"></a>  <span class="co"># colums to keep</span></span>
<span id="cb17-164"><a href="#cb17-164" aria-hidden="true" tabindex="-1"></a>  cols_claim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"clm_number"</span>,</span>
<span id="cb17-165"><a href="#cb17-165" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"pol_number"</span>,</span>
<span id="cb17-166"><a href="#cb17-166" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"claim_type"</span>,</span>
<span id="cb17-167"><a href="#cb17-167" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"claim_count"</span>,</span>
<span id="cb17-168"><a href="#cb17-168" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"claim_sev"</span>,</span>
<span id="cb17-169"><a href="#cb17-169" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"date_occur"</span>,</span>
<span id="cb17-170"><a href="#cb17-170" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"date_report"</span>,</span>
<span id="cb17-171"><a href="#cb17-171" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"date_pay"</span>,</span>
<span id="cb17-172"><a href="#cb17-172" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"claim_cost"</span>)</span>
<span id="cb17-173"><a href="#cb17-173" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-174"><a href="#cb17-174" aria-hidden="true" tabindex="-1"></a>  dt_claim <span class="ot">&lt;-</span> dt_claim[, cols_claim, with <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb17-175"><a href="#cb17-175" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-176"><a href="#cb17-176" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb17-177"><a href="#cb17-177" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>dt_policy <span class="ot">&lt;-</span> dt_policy</span>
<span id="cb17-178"><a href="#cb17-178" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>dt_claim <span class="ot">&lt;-</span> dt_claim</span>
<span id="cb17-179"><a href="#cb17-179" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-180"><a href="#cb17-180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb17-181"><a href="#cb17-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-182"><a href="#cb17-182" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>By calling the function with a seed you can simulate policy and claim datasets - which we will do in the next section.</p>
</section>
</section>
<section id="prepare-data-for-modelling" class="level2" data-number="15.3">
<h2 data-number="15.3" class="anchored" data-anchor-id="prepare-data-for-modelling"><span class="header-section-number">15.3</span> Prepare data for modelling</h2>
<p>In this section we step through the process to create the underlying data structures that will be used in the machine learning reserving process, as set out in sections 2 and 3 of Baudry’s paper.</p>
<section id="a-few-words-before-we-start" class="level3" data-number="15.3.1">
<h3 data-number="15.3.1" class="anchored" data-anchor-id="a-few-words-before-we-start"><span class="header-section-number">15.3.1</span> A few words before we start</h3>
<p>Baudry assumes that a policy follows a <a href="https://www.cambridge.org/core/services/aop-cambridge-core/content/view/7DA57FED4B4CFE953E7DA31B29844967/S0515036100003317a.pdf/claims_reserving_in_continuous_time_a_nonparametric_bayesian_approach.pdf">Position Dependent Marked Poisson Process</a> for which he uses the following graphical representation.</p>
<p><img src="Images/baudry_image_1.png" class="img-fluid" alt="Graphical representation of the PDMPP."> Baudry explains the notation and database build in sections 2 and 3 of his paper. It is worth taking the time to familiarise yourself with this way of presenting reserving data as it is a different perspective on the traditional claim triangle.</p>
<p>When I first tried to code this paper I had to re-read the approach to building the reserving database many times. Even then the overall process of getting the code to work took weeks and many iterations before it came together for me. So from personal experience I’d say it may take time to understand and follow the details of the approach. Hopefully this series of notebooks will help speed up that process of familiarisation and having made the investment of time exhibits such as the one below will become intuitive.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Images/baudry_image_2.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Graphical representation of IBNR and RBNS claims.</figcaption><p></p>
</figure>
</div>
<p>The data requirements for this approach to reserving are more akin to those used in Pricing. Policy underwriting features are directly used in the reserving process requiring policy and claim records to be joined at the policy exposure period level of granularity. In fact I’d say the data requirements are equivalent to a pricing dataset with two added levels of complexity.</p>
<p>The first additional complexity is that the history of claim transactions are not aggregated over dimensions of time as they would be in Pricing. The second level of complexity is that by keeping those time dimensions, additional data relating to them may be included in the analysis that would not normally be relevant to Pricing annual policies.</p>
<p>This is easiest to explain with some examples:</p>
<ul>
<li><p>weather information can be included by joining on the claim occurrence time dimension which may improve IBNR forecasting</p></li>
<li><p>claim settlement features such as claim handler hours worked or claims system downtime can be included by joining on claim processing date. This, you could imagine, would help explain internal variation in claim payment patterns.</p></li>
</ul>
<p>The table below summarises the reserve models Baudry builds and the classes of explanatory data features each model uses.</p>
<table class="table">
<colgroup>
<col style="width: 13%">
<col style="width: 45%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Feature</th>
<th style="text-align: left;">Description</th>
<th style="text-align: center;">RBNS</th>
<th style="text-align: center;">IBNR Frequency</th>
<th style="text-align: center;">IBNR Severity</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><span class="math inline">\(T_{0,p}\)</span></td>
<td style="text-align: left;">Underwriting features and policy underwriting date</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Y</td>
</tr>
<tr class="even">
<td style="text-align: left;"><span class="math inline">\(t_i - T_{0,p}\)</span></td>
<td style="text-align: left;">Policy exposure from underwriting date <span class="math inline">\(T_0\)</span> to valuation date <span class="math inline">\(t_i\)</span></td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Y</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><span class="math inline">\(F_{t_{i,p}}\)</span></td>
<td style="text-align: left;">Policy risk features at valuation date <span class="math inline">\(t_i\)</span></td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Y</td>
</tr>
<tr class="even">
<td style="text-align: left;"><span class="math inline">\(E_{T_{0,p}}\)</span></td>
<td style="text-align: left;">External information at policy underwriting date <span class="math inline">\(T_0\)</span></td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Y</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><span class="math inline">\(E_{T_{1,p}}\)</span></td>
<td style="text-align: left;">External information at claim occurrence <span class="math inline">\(T_1\)</span></td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">N</td>
<td style="text-align: center;">N</td>
</tr>
<tr class="even">
<td style="text-align: left;"><span class="math inline">\(E_{T_{2,p}}\)</span></td>
<td style="text-align: left;">External information at claim reporting date <span class="math inline">\(T_2\)</span></td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">N</td>
<td style="text-align: center;">N</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><span class="math inline">\(I_{t_{i,p}}\)</span></td>
<td style="text-align: left;">Internal claim related information up to valuation date <span class="math inline">\(t_i\)</span></td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">N</td>
<td style="text-align: center;">N</td>
</tr>
</tbody>
</table>
<p>Baudry shows how this extra data can benefit the reserving process and recognises that it is the adoption of machine learning techniques that enable us to work with larger and more granular volumes of data than we are able to with traditional chainladder reserving techniques.</p>
<section id="simulate-policy-and-claim-data" class="level4 tabset unnumbered">
<h4 class="tabset unnumbered anchored" data-anchor-id="simulate-policy-and-claim-data">Simulate policy and claim data</h4>
<p>We start with a simulated phone insurance policy and claim dataset. I am calling the function from Notebook 1 of this series to create the dataset. Using a fixed seed will ensure you get reproducible simulated dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>dt_PhoneData <span class="ot">&lt;-</span> <span class="fu">simulate_central_scenario</span>(<span class="dv">1234</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now inspect the returned Policy dataset and similarly inspect the returned Claim dataset.</p>
<p>Both have been created to be somewhat similar to standard policy and claim datasets that insurers would extract from their policy and claim administration systems.</p>
<section id="policy" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="policy">Policy</h5>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-f5d0734599265f9a7de6" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-f5d0734599265f9a7de6">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],["201601010001","201601010002","201601010003","201601010004","201601010005","201601010006"],["2016-01-01","2016-01-01","2016-01-01","2016-01-01","2016-01-01","2016-01-01"],["2017-01-01","2017-01-01","2017-01-01","2017-01-01","2017-01-01","2017-01-01"],["B","B","B","B","B","B"],[1,1,1,1,1,1],[3,3,3,3,3,3],[913,913,913,913,913,913]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>pol_number<\/th>\n      <th>date_UW<\/th>\n      <th>date_lapse<\/th>\n      <th>Cover<\/th>\n      <th>Brand<\/th>\n      <th>Model<\/th>\n      <th>Price<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[5,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="claim" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="claim">Claim</h5>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-bd4a94607247107b5d4d" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-bd4a94607247107b5d4d">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],["201606080001","201609150001","201609090001","201602190001","201605140001","201612110001"],["201601010001","201601010014","201601010025","201601010027","201601010043","201601010045"],["B","B","B","B","B","B"],[1,1,1,1,1,1],[0.333792262355628,0.369203377677138,0.449601181195299,0.401973121615581,0.21466529643624,0.278331287231258],["2016-06-08","2016-09-15","2016-09-09","2016-01-25","2016-05-14","2016-12-11"],["2016-06-08","2016-09-15","2016-09-09","2016-02-19","2016-05-14","2016-12-11"],["2016-07-21","2016-10-17","2016-10-07","2016-03-21","2016-06-15","2017-01-06"],[305,309,357,319,196,254]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>clm_number<\/th>\n      <th>pol_number<\/th>\n      <th>claim_type<\/th>\n      <th>claim_count<\/th>\n      <th>claim_sev<\/th>\n      <th>date_occur<\/th>\n      <th>date_report<\/th>\n      <th>date_pay<\/th>\n      <th>claim_cost<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[4,5,9]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
</section>
<section id="join-policy-and-claim-data" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="join-policy-and-claim-data">Join policy and claim data</h4>
<p>We start with a simulated phone dataset policy and claim tables.</p>
<p>We wish to join claims to the appropriate policy exposure period. This will be a familiar process to pricing actuaries but may not be familiar to reserving actuaries as it is not a requirement in traditional chain ladder reserving.</p>
<p>For speed and convenience we will use the <code>data.table::foverlaps</code> R function, which needs the tables being joined to have common keys for policy number and time periods.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(dt_policy, <span class="fu">c</span>(<span class="st">'date_UW'</span>, <span class="st">'date_lapse'</span>), <span class="fu">c</span>(<span class="st">'date_pol_start'</span>, <span class="st">'date_pol_end'</span>))</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># set policy start and end dates in foverlap friendly format</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>dt_policy[, date_pol_start<span class="sc">:</span><span class="er">=</span> <span class="fu">floor_date</span>(date_pol_start, <span class="at">unit=</span> <span class="st">"second"</span>)]</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>dt_policy[, date_pol_end<span class="sc">:</span><span class="er">=</span> <span class="fu">floor_date</span>(date_pol_end, <span class="at">unit=</span> <span class="st">"second"</span>) <span class="sc">-</span> <span class="dv">1</span>]</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># create a dummy end claim occurrence date for foverlap</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>dt_claim[, date_occur<span class="sc">:</span><span class="er">=</span> <span class="fu">floor_date</span>(date_occur, <span class="at">unit=</span> <span class="st">"second"</span>)]</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>dt_claim[, date_occur_end<span class="sc">:</span><span class="er">=</span> date_occur]</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>dt_claim[, date_report<span class="sc">:</span><span class="er">=</span> <span class="fu">floor_date</span>(date_report, <span class="at">unit=</span> <span class="st">"second"</span>)]</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>dt_claim[, date_pay<span class="sc">:</span><span class="er">=</span> <span class="fu">floor_date</span>(date_pay, <span class="at">unit=</span> <span class="st">"second"</span>)]</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co"># set keys for claim join (by policy and dates)</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(dt_claim, pol_number, date_occur, date_occur_end)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(dt_policy, pol_number, date_pol_start, date_pol_end)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co"># use foverlaps to attach claim to right occurrence period and policy</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>dt_polclaim <span class="ot">&lt;-</span> <span class="fu">foverlaps</span>(dt_policy, dt_claim, <span class="at">type=</span><span class="st">"any"</span>) <span class="do">## return overlap indices</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>dt_polclaim[, date_occur_end <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The first few rows of the resulting table are shown below where we can see the first policy has an attached claim.</p>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-9786c2a0d7ceda175678" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-9786c2a0d7ceda175678">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],["201601010001","201601010002","201601010003","201601010004","201601010005","201601010006"],["201606080001",null,null,null,null,null],["B",null,null,null,null,null],[1,null,null,null,null,null],[0.333792262355628,null,null,null,null,null],["2016-06-08T00:00:00Z",null,null,null,null,null],["2016-06-08T00:00:00Z",null,null,null,null,null],["2016-07-21T00:00:00Z",null,null,null,null,null],[305,null,null,null,null,null],["2016-01-01T00:00:00Z","2016-01-01T00:00:00Z","2016-01-01T00:00:00Z","2016-01-01T00:00:00Z","2016-01-01T00:00:00Z","2016-01-01T00:00:00Z"],["2016-12-31T23:59:59Z","2016-12-31T23:59:59Z","2016-12-31T23:59:59Z","2016-12-31T23:59:59Z","2016-12-31T23:59:59Z","2016-12-31T23:59:59Z"],["B","B","B","B","B","B"],[1,1,1,1,1,1],[3,3,3,3,3,3],[913,913,913,913,913,913]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>pol_number<\/th>\n      <th>clm_number<\/th>\n      <th>claim_type<\/th>\n      <th>claim_count<\/th>\n      <th>claim_sev<\/th>\n      <th>date_occur<\/th>\n      <th>date_report<\/th>\n      <th>date_pay<\/th>\n      <th>claim_cost<\/th>\n      <th>date_pol_start<\/th>\n      <th>date_pol_end<\/th>\n      <th>Cover<\/th>\n      <th>Brand<\/th>\n      <th>Model<\/th>\n      <th>Price<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[4,5,9,13,14,15]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="check-for-multi-claim-policies" class="level4" data-number="15.3.1.1">
<h4 data-number="15.3.1.1" class="anchored" data-anchor-id="check-for-multi-claim-policies"><span class="header-section-number">15.3.1.1</span> Check for multi-claim policies</h4>
<p>In a real world situation it is possible for policies to have multiple claims in an insurance period. In such circumstances care needs to be taken in matching policy exposure periods and claims, typically this is done by splitting a policy into sequences that stop at the date of each claim.</p>
<p>Our simulated data does not have this complication, as this check shows, the maximum number of sequences is 1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(dt_polclaim, pol_number, date_pol_start)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co"># create 2 new cols that count how many claims against each policy</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>dt_polclaim[,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>            <span class="st">':='</span>(<span class="at">pol_seq =</span> <span class="fu">seq_len</span>(.N),</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">pol_seq_max =</span> .N),</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>            by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">'pol_number'</span>, <span class="st">'date_pol_start'</span>) ]</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(dt_polclaim[, pol_seq_max])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
     1 
512246 </code></pre>
</div>
</div>
<p>Not all policies have claims, resulting in NA fields in the joined dataset. To facilitate future processing we need to deal with NA fields in the joined policy and claims dataset. Missing dates are set to a long dated future point. Where there are no claims, we set claim counts and costs to zero, resulting in the following table.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#set NA dates to 31/12/2999</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>lst_datefields <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="fu">names</span>(dt_polclaim),<span class="at">pattern =</span> <span class="st">"date"</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (datefield <span class="cf">in</span> lst_datefields)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(dt_polclaim,<span class="fu">which</span>(<span class="fu">is.na</span>(dt_polclaim[[datefield]])),datefield,<span class="fu">as_datetime</span>(<span class="st">"2199-12-31 23:59:59 UTC"</span>))</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co">#set other NAs to zero (claim counts and costs)</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (field <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"claim_count"</span>, <span class="st">"claim_sev"</span>, <span class="st">"claim_cost"</span>))</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(dt_polclaim,<span class="fu">which</span>(<span class="fu">is.na</span>(dt_polclaim[[field]])),field,<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-2d1a8b3087e055618479" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-2d1a8b3087e055618479">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],["201601010001","201601010002","201601010003","201601010004","201601010005","201601010006"],["201606080001",null,null,null,null,null],["B",null,null,null,null,null],[1,0,0,0,0,0],[0.333792262355628,0,0,0,0,0],["2016-06-08T00:00:00Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z"],["2016-06-08T00:00:00Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z"],["2016-07-21T00:00:00Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z"],[305,0,0,0,0,0],["2016-01-01T00:00:00Z","2016-01-01T00:00:00Z","2016-01-01T00:00:00Z","2016-01-01T00:00:00Z","2016-01-01T00:00:00Z","2016-01-01T00:00:00Z"],["2016-12-31T23:59:59Z","2016-12-31T23:59:59Z","2016-12-31T23:59:59Z","2016-12-31T23:59:59Z","2016-12-31T23:59:59Z","2016-12-31T23:59:59Z"],["B","B","B","B","B","B"],[1,1,1,1,1,1],[3,3,3,3,3,3],[913,913,913,913,913,913],[1,1,1,1,1,1],[1,1,1,1,1,1],[2,2,2,2,2,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>pol_number<\/th>\n      <th>clm_number<\/th>\n      <th>claim_type<\/th>\n      <th>claim_count<\/th>\n      <th>claim_sev<\/th>\n      <th>date_occur<\/th>\n      <th>date_report<\/th>\n      <th>date_pay<\/th>\n      <th>claim_cost<\/th>\n      <th>date_pol_start<\/th>\n      <th>date_pol_end<\/th>\n      <th>Cover<\/th>\n      <th>Brand<\/th>\n      <th>Model<\/th>\n      <th>Price<\/th>\n      <th>pol_seq<\/th>\n      <th>pol_seq_max<\/th>\n      <th>ExpoDays<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[4,5,9,13,14,15,16,17,18]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
</section>
<section id="timeslicing-claim-payments" class="level3" data-number="15.3.2">
<h3 data-number="15.3.2" class="anchored" data-anchor-id="timeslicing-claim-payments"><span class="header-section-number">15.3.2</span> Timeslicing claim payments</h3>
<p>Although this paper works with individual policy and claim transactions those transactions are collated into time slices.</p>
<p>Baudry selected time slices of 30 days in length starting from 01 Jan 2016 (Section 5 page 13).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Images/baudry_image_3.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Graphical representation of the PDMPP.</figcaption><p></p>
</figure>
</div>
<p>In the code below, for every individual policy and claim transaction; ie row in <code>dt_polclaim</code>, we are creating an extra column for each possible timeslice and recording in the column the cumulative claim cost up to that time slice.</p>
<p>Given that in the simple simulated dataset we only have one claim payment for any claim, the code to do this is rather more simple than would otherwise be the case. The code below would need to be amended if there are partial claim payments.</p>
<p>This time sliced dataset becomes the source of our RBNS and IBNER datasets used in subsequent machine learning steps.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>lst_Date_slice <span class="ot">&lt;-</span> <span class="fu">floor_date</span>(<span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2016/1/1"</span>), <span class="fu">as.Date</span>(<span class="st">"2019/06/30"</span>), <span class="at">by =</span> <span class="dv">30</span>), <span class="at">unit=</span> <span class="st">"second"</span>) </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Time slice Policy &amp; claims </span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(lst_Date_slice)){</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  dt_polclaim[date_pay<span class="sc">&lt;=</span> lst_Date_slice[i], <span class="fu">paste0</span>(<span class="st">'P_t_'</span>, <span class="fu">format</span>(lst_Date_slice[i], <span class="st">"%Y%m%d"</span>))<span class="sc">:</span><span class="er">=</span> claim_cost]</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(dt_polclaim,<span class="fu">which</span>(<span class="fu">is.na</span>(dt_polclaim[[<span class="fu">paste0</span>(<span class="st">'P_t_'</span>, <span class="fu">format</span>(lst_Date_slice[i], <span class="st">"%Y%m%d"</span>))]])),<span class="fu">paste0</span>(<span class="st">'P_t_'</span>, <span class="fu">format</span>(lst_Date_slice[i], <span class="st">"%Y%m%d"</span>)),<span class="dv">0</span>)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co"># sort data by policynumber</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(dt_polclaim, pol_number)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Looking at the data can see the output of timeslicing. You’ll need to scroll to the right of the table to see the columns labeled <strong>P_t_20160101</strong> through to <strong>P_t_20190614</strong>.</p>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-4cd25e99139cb7f588cf" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-4cd25e99139cb7f588cf">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],["201601010001","201601010002","201601010003","201601010004","201601010005","201601010006"],["201606080001",null,null,null,null,null],["B",null,null,null,null,null],[1,0,0,0,0,0],[0.333792262355628,0,0,0,0,0],["2016-06-08T00:00:00Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z"],["2016-06-08T00:00:00Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z"],["2016-07-21T00:00:00Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z"],[305,0,0,0,0,0],["2016-01-01T00:00:00Z","2016-01-01T00:00:00Z","2016-01-01T00:00:00Z","2016-01-01T00:00:00Z","2016-01-01T00:00:00Z","2016-01-01T00:00:00Z"],["2016-12-31T23:59:59Z","2016-12-31T23:59:59Z","2016-12-31T23:59:59Z","2016-12-31T23:59:59Z","2016-12-31T23:59:59Z","2016-12-31T23:59:59Z"],["B","B","B","B","B","B"],[1,1,1,1,1,1],[3,3,3,3,3,3],[913,913,913,913,913,913],[1,1,1,1,1,1],[1,1,1,1,1,1],[2,2,2,2,2,2],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0],[305,0,0,0,0,0]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>pol_number<\/th>\n      <th>clm_number<\/th>\n      <th>claim_type<\/th>\n      <th>claim_count<\/th>\n      <th>claim_sev<\/th>\n      <th>date_occur<\/th>\n      <th>date_report<\/th>\n      <th>date_pay<\/th>\n      <th>claim_cost<\/th>\n      <th>date_pol_start<\/th>\n      <th>date_pol_end<\/th>\n      <th>Cover<\/th>\n      <th>Brand<\/th>\n      <th>Model<\/th>\n      <th>Price<\/th>\n      <th>pol_seq<\/th>\n      <th>pol_seq_max<\/th>\n      <th>ExpoDays<\/th>\n      <th>P_t_20160101<\/th>\n      <th>P_t_20160131<\/th>\n      <th>P_t_20160301<\/th>\n      <th>P_t_20160331<\/th>\n      <th>P_t_20160430<\/th>\n      <th>P_t_20160530<\/th>\n      <th>P_t_20160629<\/th>\n      <th>P_t_20160729<\/th>\n      <th>P_t_20160828<\/th>\n      <th>P_t_20160927<\/th>\n      <th>P_t_20161027<\/th>\n      <th>P_t_20161126<\/th>\n      <th>P_t_20161226<\/th>\n      <th>P_t_20170125<\/th>\n      <th>P_t_20170224<\/th>\n      <th>P_t_20170326<\/th>\n      <th>P_t_20170425<\/th>\n      <th>P_t_20170525<\/th>\n      <th>P_t_20170624<\/th>\n      <th>P_t_20170724<\/th>\n      <th>P_t_20170823<\/th>\n      <th>P_t_20170922<\/th>\n      <th>P_t_20171022<\/th>\n      <th>P_t_20171121<\/th>\n      <th>P_t_20171221<\/th>\n      <th>P_t_20180120<\/th>\n      <th>P_t_20180219<\/th>\n      <th>P_t_20180321<\/th>\n      <th>P_t_20180420<\/th>\n      <th>P_t_20180520<\/th>\n      <th>P_t_20180619<\/th>\n      <th>P_t_20180719<\/th>\n      <th>P_t_20180818<\/th>\n      <th>P_t_20180917<\/th>\n      <th>P_t_20181017<\/th>\n      <th>P_t_20181116<\/th>\n      <th>P_t_20181216<\/th>\n      <th>P_t_20190115<\/th>\n      <th>P_t_20190214<\/th>\n      <th>P_t_20190316<\/th>\n      <th>P_t_20190415<\/th>\n      <th>P_t_20190515<\/th>\n      <th>P_t_20190614<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[4,5,9,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="creating-rbns-and-ibner-datasets" class="level3" data-number="15.3.3">
<h3 data-number="15.3.3" class="anchored" data-anchor-id="creating-rbns-and-ibner-datasets"><span class="header-section-number">15.3.3</span> Creating RBNS and IBNER datasets</h3>
<p>Before we create the RBNS and IBNER datasets we must pick a valuation point from the available timeslices. I’m selecting the 10th point for illustration, which is the 10th 30 day period from 01/01/2016, ie a valuation date of 27/09/2016.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#_ 2.1 Set initial variables ----</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co">#~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> valuation <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>t_i <span class="ot">&lt;-</span> lst_Date_slice[i] </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>delta <span class="ot">&lt;-</span> <span class="fu">min</span>(i, <span class="fu">length</span>(lst_Date_slice) <span class="sc">-</span> i <span class="sc">+</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In a traditional approach we would be creating reserving triangles with ten 30-day duration development periods.</p>
<p>As we will see the approach adopted by Baudry, in section 3 of his paper, is somewhat different and is much closer to the sort of datasets that Pricing Actuaries are familiar with.</p>
<section id="creating-rbns-dataset" class="level4" data-number="15.3.3.1">
<h4 data-number="15.3.3.1" class="anchored" data-anchor-id="creating-rbns-dataset"><span class="header-section-number">15.3.3.1</span> Creating RBNS dataset</h4>
<p>We start with the RBNS dataset.</p>
<p>The training data for the for the RBNS reserves will consist of all claims reported prior to the valuation date. This data has been joined to the policy exposure data to enable policy related features to be used as explanatory variables in the RBNS reserve calculation.</p>
<p>A training dataset will enable us to build a model of RBNS reserve requirements at historic valuation dates. But what we really require is a view of the RBNS reserve at the valuation date. To calculate this we need to create a test dataset that contains values of the explanatory features at each future claim payment period.</p>
<p>By making model prediction for each row of the test dataset we can calculate the RBNS reserve as the sum of predicted future payments.</p>
</section>
<section id="rbns-dataset-functions" class="level4 tabset" data-number="15.3.3.2">
<h4 class="tabset anchored" data-number="15.3.3.2" data-anchor-id="rbns-dataset-functions"><span class="header-section-number">15.3.3.2</span> RBNS dataset functions</h4>
<p>To create the RBNS train and test datasets we have provided two functions <code>RBNS_Train_ijk</code> and <code>RBNS_Test_ijk</code> which take as an input the joined policy and claims dataset and return data in a format suitable for applying machine learning.</p>
<p>They are actually returning the ‘triangle’ data for all occurrence periods, <strong>i</strong>, for a specified:</p>
<ul>
<li>claim development delay, <strong>j</strong>; and</li>
<li>model type <strong>k</strong></li>
</ul>
<p>For values of <strong>k</strong> equal to 1 the model data is essentially including all claim transactions up to the last calendar period prior to the valuation date. When k is set to 2 effectively the most recent calendar period’s transactions are ignored. Although in this example only models with a k value of 1 are created, Baudry’s framework allows for multiple k value models to be built. In doing so multiple models are created, effectively using aged data which would allow an ensemble modeling approach to be used. Such use of multiple k values would be similar to a Bornhuetter-Ferguson approach to modeling.</p>
<section id="rbns_train" class="level5" data-number="15.3.3.2.1">
<h5 data-number="15.3.3.2.1" class="anchored" data-anchor-id="rbns_train"><span class="header-section-number">15.3.3.2.1</span> RBNS_Train</h5>
<p>The code for creating the RBNS datasets is rather involved so detailed explanation has been skipped over here.<br>
Interested readers are encouraged to come back to this stage and inspect the code and Baudry’s paper once they have an overview of the wider process.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>RBNS_Train_ijk <span class="ot">&lt;-</span> <span class="cf">function</span>(dt_policy_claim, date_i, j_dev_period, k, reserving_dates, model_vars) {</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # debugging</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># #~~~~~~~~~~~~~</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dt_policy_claim = dt_polclaim</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># date_i = t_i</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># j_dev_period = 1</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># k = 1</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reserving_dates = lst_Date_slice</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># #~~~~~~~~~~~~~</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   </span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  date_i <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(date_i)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  date_k <span class="ot">&lt;-</span> (reserving_dates[<span class="fu">which</span>(reserving_dates <span class="sc">==</span> date_i) <span class="sc">-</span> k <span class="sc">+</span> <span class="dv">1</span>])</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  date_j <span class="ot">&lt;-</span> (reserving_dates[<span class="fu">which</span>(reserving_dates <span class="sc">==</span> date_k) <span class="sc">-</span> j_dev_period])</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">#i - j - k + 1 (predictor as at date)</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  date_lookup <span class="ot">&lt;-</span> (reserving_dates[<span class="fu">which</span>(reserving_dates <span class="sc">==</span> (date_i)) <span class="sc">-</span> j_dev_period <span class="sc">-</span>k <span class="sc">+</span> <span class="dv">1</span>]) </span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">#i - k to calculate target incremental paid</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>  target_lookup <span class="ot">&lt;-</span> (reserving_dates[<span class="fu">which</span>(reserving_dates <span class="sc">==</span> (date_i)) <span class="sc">-</span> k]) </span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">#i -k + 1 to calculate target incremental paid</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>  target_lookup_next <span class="ot">&lt;-</span> (reserving_dates[<span class="fu">which</span>(reserving_dates <span class="sc">==</span> (date_i)) <span class="sc">-</span> k <span class="sc">+</span> <span class="dv">1</span>]) </span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">#definition of reported but not settled</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>  dt_policy_claim <span class="ot">&lt;-</span> dt_policy_claim[(date_report <span class="sc">&lt;=</span> date_lookup) <span class="sc">&amp;</span> (date_pay <span class="sc">&gt;</span> date_lookup)] </span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">#simulated data assumes one payment so just need to check date paid in taget calc</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>  dt_policy_claim[, <span class="st">':='</span>(<span class="at">date_lookup =</span> date_lookup,</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>                         <span class="at">delay_train =</span> <span class="fu">as.numeric</span>(date_lookup <span class="sc">-</span> date_pol_start), <span class="co">#extra feature</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>                         <span class="at">j =</span> j_dev_period,</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>                         <span class="at">k =</span> k,</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>                         <span class="at">target =</span> <span class="fu">ifelse</span>(date_pay<span class="sc">&lt;=</span>target_lookup,<span class="dv">0</span>,<span class="fu">ifelse</span>(date_pay<span class="sc">&lt;=</span>target_lookup_next,claim_cost,<span class="dv">0</span>)))]</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dt_policy_claim[, model_vars, <span class="at">with =</span> <span class="cn">FALSE</span>])</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="rbns_test" class="level5" data-number="15.3.3.2.2">
<h5 data-number="15.3.3.2.2" class="anchored" data-anchor-id="rbns_test"><span class="header-section-number">15.3.3.2.2</span> RBNS_Test</h5>
<p>The code for creating the RBNS datasets is rather involved so detailed explanation has been skipped over here.<br>
Interested readers are encouraged to come back to this stage and inspect the code and Baudry’s paper once they have an overview of the wider process.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>RBNS_Test_ijk <span class="ot">&lt;-</span> <span class="cf">function</span>(dt_policy_claim, date_i,j_dev_period, k, reserving_dates, model_vars) {</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # debugging</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># #~~~~~~~~~~~~~</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dt_policy_claim = dt_polclaim</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># date_i = t_i</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># j_dev_period = 1</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># k = 1</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reserving_dates = lst_Date_slice</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># #~~~~~~~~~~~~~</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   </span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  date_i <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(date_i)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">#i - j - k + 1 (predictor as at date)</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  date_lookup <span class="ot">&lt;-</span> (reserving_dates[<span class="fu">which</span>(reserving_dates <span class="sc">==</span> (date_i))]) </span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">#i - k to calculate target incremental paid</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>  target_lookup <span class="ot">&lt;-</span> (reserving_dates[<span class="fu">which</span>(reserving_dates <span class="sc">==</span> (date_i)) <span class="sc">+</span>j_dev_period <span class="sc">-</span> <span class="dv">1</span>]) </span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">#i -k + 1 to calculate targte incremental paid  </span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>  target_lookup_next <span class="ot">&lt;-</span> (reserving_dates[<span class="fu">which</span>(reserving_dates <span class="sc">==</span> (date_i)) <span class="sc">+</span> j_dev_period]) </span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">#definition of reported but not settled</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># P_te_RBNS rowids of policies needing an RBNS reserve</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>  dt_policy_claim <span class="ot">&lt;-</span> dt_policy_claim[date_report <span class="sc">&lt;=</span> date_lookup <span class="sc">&amp;</span> date_lookup <span class="sc">&lt;</span> date_pay] </span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">#model assumes one payment so just need to check date paid</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>  dt_policy_claim[, <span class="st">':='</span>(<span class="at">date_lookup =</span> date_lookup,</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>                         <span class="at">delay_train =</span> <span class="fu">as.numeric</span>(date_lookup <span class="sc">-</span> date_pol_start), <span class="co">#extra feature</span></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>                         <span class="at">j =</span> j_dev_period,</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>                         <span class="at">k =</span> k,</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>                         <span class="at">target =</span> <span class="fu">ifelse</span>(date_pay<span class="sc">&lt;=</span>target_lookup,<span class="dv">0</span>,<span class="fu">ifelse</span>(date_pay<span class="sc">&lt;=</span>target_lookup_next,claim_cost,<span class="dv">0</span>)))] </span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a><span class="fu">return</span>(dt_policy_claim[, model_vars, <span class="at">with =</span> <span class="cn">FALSE</span>])</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="rbns-function-calls" class="level4" data-number="15.3.3.3">
<h4 data-number="15.3.3.3" class="anchored" data-anchor-id="rbns-function-calls"><span class="header-section-number">15.3.3.3</span> RBNS function calls</h4>
<p>The RBNS train and test datasets are created by calling the <code>RBNS_Train</code> and <code>RBNS_Test</code> functions passing, as parameters to them, the names of the joined policy and claim dataset, valuation dates and model features.</p>
<p>The functions <code>RBNS_Train</code> and <code>RBNS_Test</code> iterate over valid values of j and k calling the <code>RBNS_Train_ijk</code> and <code>RBNS_Test_ijk</code> functions to create the complete train and test datasets as illustrated below.</p>
<div id="fig-elephants" class="quarto-layout-panel">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-baudry-left" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="Images/baudry_image_5a.png" class="img-fluid figure-img" data-ref-parent="fig-elephants"></p>
<p></p><figcaption class="figure-caption">(a) Left chart, j=1, k=1</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p></p><figcaption class="figure-caption">Figure&nbsp;15.1: <img src="Images/baudry_image_6a.png" title="fig:" id="fig-baudry-right" class="img-fluid figure-img" data-ref-parent="fig-elephants" alt="(b) Right chart, j=2, k=1"></figcaption><p></p>
</figure>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>RBNS_Train <span class="ot">&lt;-</span> <span class="cf">function</span>(dt_policy_claim, date_i, i, k, reserving_dates, model_vars) {</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a combined TRAIN dataset across all k and j combos</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k){</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (k<span class="sc">==</span><span class="dv">1</span>) dt_train <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(i <span class="sc">-</span> k <span class="sc">+</span> <span class="dv">1</span>)){</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>      dt_train <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dt_train, <span class="fu">RBNS_Train_ijk</span>(dt_polclaim, date_i, j, k,reserving_dates, model_vars))</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  }  </span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dt_train)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>RBNS_Test <span class="ot">&lt;-</span> <span class="cf">function</span>(dt_policy_claim, date_i, delta, k, reserving_dates, model_vars) {</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a combined </span><span class="al">TEST</span><span class="co"> dataset across all k and j combos</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k){</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (k<span class="sc">==</span><span class="dv">1</span>) dt_test <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(delta <span class="sc">-</span> k <span class="sc">+</span> <span class="dv">1</span>)){</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>      dt_test <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dt_test, <span class="fu">RBNS_Test_ijk</span>(dt_polclaim, date_i, j, k,reserving_dates, model_vars))</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dt_test)</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The animation below attempts to summarise the overall data preparation and model prediction process.</p>
<div id="fig-baudry-triangle" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="Images/baudry_triangles.gif" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;15.2: Illustration of the data preparation and model prediction process</figcaption><p></p>
</figure>
</div>
<p>So having given a rough outline of the data creation process let’s now call the functions to create the RBNS datasets.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">#define modelVars</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>RBNS_model_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"clm_number"</span>,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"pol_number"</span>,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"j"</span>,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"k"</span>,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"date_pol_start"</span>,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"date_occur"</span>,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"date_report"</span>,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"date_pay"</span>,</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Cover"</span>,</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"claim_type"</span>,</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Brand"</span>,</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Model"</span>,</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Price"</span>,</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"target"</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a combined TRAIN dataset for k = 1 and all valid j delay values</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>dt_RBNS_train <span class="ot">&lt;-</span> <span class="fu">RBNS_Train</span>(dt_polclaim, t_i, i, <span class="at">k =</span> <span class="dv">1</span>, lst_Date_slice, RBNS_model_vars)</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a combined </span><span class="al">TEST</span><span class="co"> dataset for k = 1 and all valid j delay values</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>dt_RBNS_test <span class="ot">&lt;-</span> <span class="fu">RBNS_Test</span>(dt_polclaim, t_i, delta, <span class="at">k =</span> <span class="dv">1</span>, lst_Date_slice, RBNS_model_vars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The train and test datasets are then joined into a single dataset and a small amount of tidying is done to make them ready for use.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a flag to determine which rows are from the trainset and which from the test set</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>dt_RBNS_train[, flgTrain <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span>]</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>dt_RBNS_test[, flgTrain <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>]</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co"># combine into a single RBNS dataset   </span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>dt_All_RBNS <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dt_RBNS_train, dt_RBNS_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The important aspects of the tidying relate to creating usable delay metrics from the numerous dates and converting some character features such as cover and claim type into factors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># order and create some delay fields</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(dt_All_RBNS, clm_number, k, j)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>dt_All_RBNS[, Count <span class="sc">:</span><span class="er">=</span> .N , by <span class="ot">=</span>clm_number]</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co">#create delay measure by converting from seconds to day periods</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>dt_All_RBNS[, <span class="st">':='</span>(</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">delay_uw_occ =</span> <span class="fu">ifelse</span>(<span class="fu">year</span>(date_occur) <span class="sc">==</span> <span class="dv">2199</span>,</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">ceiling</span>((<span class="fu">as.numeric</span>(date_occur) <span class="sc">-</span> <span class="fu">as.numeric</span>(date_pol_start)) <span class="sc">/</span> (<span class="dv">24</span> <span class="sc">*</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">60</span>))</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>                        ),</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">delay_occ_rep =</span> <span class="fu">ifelse</span>(<span class="fu">year</span>(date_occur) <span class="sc">==</span> <span class="dv">2199</span>,</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>                         <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">ceiling</span>((<span class="fu">as.numeric</span>(date_report) <span class="sc">-</span> <span class="fu">as.numeric</span>(date_occur)) <span class="sc">/</span> (<span class="dv">24</span> <span class="sc">*</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">60</span>))</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>                         ),</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">delay_uw_val =</span> <span class="fu">ceiling</span>((<span class="fu">as.numeric</span>(t_i) <span class="sc">-</span> <span class="fu">as.numeric</span>(date_pol_start)) <span class="sc">/</span> (<span class="dv">24</span> <span class="sc">*</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">60</span>)),</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">delay_rep_pay =</span> <span class="fu">ceiling</span>((<span class="fu">as.numeric</span>(date_pay) <span class="sc">-</span> <span class="fu">as.numeric</span>(date_report)) <span class="sc">/</span> (<span class="dv">24</span> <span class="sc">*</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">60</span>)),</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_uw =</span> <span class="fu">ceiling</span>(<span class="fu">as.numeric</span>(date_pol_start) <span class="sc">/</span> (<span class="dv">24</span> <span class="sc">*</span>  <span class="dv">60</span> <span class="sc">*</span> <span class="dv">60</span>)),</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">Cover =</span> <span class="fu">as.factor</span>(Cover),</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">claim_type =</span> <span class="fu">as.factor</span>(claim_type)</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>  )]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="creating-ibnr-dataset" class="level4" data-number="15.3.3.4">
<h4 data-number="15.3.3.4" class="anchored" data-anchor-id="creating-ibnr-dataset"><span class="header-section-number">15.3.3.4</span> Creating IBNR dataset</h4>
<p>The IBNR dataset creation follows a similar process to RBNS but is a little more complex. Any policy with a live exposure can give rise to an IBNR claim so the training dataset consists of all policy exposure periods prior to the valuation date.</p>
<p>From this we train two models:</p>
<ul>
<li>a frequency model to predict if there will be an IBNR claim; and</li>
<li>a severity model to predict the expected cost of any IBNR claim</li>
</ul>
<p>This is very similar to the traditional pricing approach except that we can add information relating to the claim occurrence date (eg weather information could be useful for Storm losses) and we also predict the incremental run-off of the exposure period.</p>
</section>
<section id="ibnr-dataset-functions" class="level4 tabset" data-number="15.3.3.5">
<h4 class="tabset anchored" data-number="15.3.3.5" data-anchor-id="ibnr-dataset-functions"><span class="header-section-number">15.3.3.5</span> IBNR dataset functions</h4>
<section id="ibnr_frequency-train" class="level5" data-number="15.3.3.5.1">
<h5 data-number="15.3.3.5.1" class="anchored" data-anchor-id="ibnr_frequency-train"><span class="header-section-number">15.3.3.5.1</span> IBNR_Frequency Train</h5>
<p>The code for creating the IBNR datasets is rather involved so detailed explanation has been skipped over here.<br>
Interested readers are encouraged to come back to this stage and inspect the code and Baudry’s paper once they have an overview of the wider process.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>IBNR_Freq_Train_ijk <span class="ot">&lt;-</span> <span class="cf">function</span>(dt_policy_claim, date_i, j_dev_period, k, reserving_dates, model_vars, <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # debugging</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># #~~~~~~~~~~~~~</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dt_policy_claim = dt_polclaim</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># date_i = t_i</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># j_dev_period = 1</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># k = 1</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reserving_dates = lst_Date_slice</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># model_vars &lt;- IBNR_model_vars</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># #~~~~~~~~~~~~~</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>  date_i <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(date_i)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>  date_k <span class="ot">&lt;-</span> (reserving_dates[<span class="fu">which</span>(reserving_dates <span class="sc">==</span> date_i) <span class="sc">-</span> k <span class="sc">+</span> <span class="dv">1</span>])</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>  date_j <span class="ot">&lt;-</span> (reserving_dates[<span class="fu">which</span>(reserving_dates <span class="sc">==</span> date_k) <span class="sc">-</span> j_dev_period])</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>  date_lookup <span class="ot">&lt;-</span> (reserving_dates[<span class="fu">which</span>(reserving_dates <span class="sc">==</span> (date_i)) <span class="sc">-</span> j_dev_period <span class="sc">-</span>k <span class="sc">+</span> <span class="dv">1</span>]) <span class="co">#i - j - k + 1 (predictor as at date)</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>  target_lookup <span class="ot">&lt;-</span> (reserving_dates[<span class="fu">which</span>(reserving_dates <span class="sc">==</span> (date_i)) <span class="sc">-</span> k]) <span class="co">#i - k to calculate target incremental paid</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>  target_lookup_next <span class="ot">&lt;-</span> (reserving_dates[<span class="fu">which</span>(reserving_dates <span class="sc">==</span> (date_i)) <span class="sc">-</span> k <span class="sc">+</span> <span class="dv">1</span>]) <span class="co">#i -k + 1 to calculate targte incremental paid</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(verbose) <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">"Valn date"</span>, date_i, <span class="st">", j = "</span>, j_dev_period, <span class="st">", k ="</span>, k, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>  dt_policy_claim <span class="ot">&lt;-</span> dt_policy_claim[date_pol_start <span class="sc">&lt;</span> date_lookup  <span class="sc">&amp;</span> date_lookup <span class="sc">&lt;</span> date_report] <span class="co">#definition of IBNR</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>  dt_policy_claim[, <span class="st">':='</span>(<span class="at">date_lookup =</span> date_lookup,</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>                         <span class="at">delay_train =</span> <span class="fu">as.numeric</span>(date_lookup <span class="sc">-</span> date_pol_start), <span class="co">#extra feature</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>                         <span class="at">j =</span> j_dev_period,</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>                         <span class="at">k =</span> k,</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>                         <span class="at">exposure =</span> <span class="fu">round</span>((<span class="fu">pmin</span>(<span class="fu">as.numeric</span>(<span class="fu">as.numeric</span>(date_pol_end)), <span class="fu">as.numeric</span>(<span class="fu">floor_date</span>(date_i, <span class="at">unit=</span> <span class="st">"second"</span>)))</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>                                             <span class="sc">-</span> <span class="fu">as.numeric</span>(date_pol_start))<span class="sc">/</span>(<span class="dv">24</span><span class="sc">*</span><span class="dv">60</span><span class="sc">*</span><span class="dv">60</span><span class="sc">*</span><span class="dv">365</span>), <span class="dv">3</span>),</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>                         <span class="at">target =</span> <span class="fu">ifelse</span>(target_lookup <span class="sc">&lt;=</span> date_pay <span class="sc">&amp;</span>  date_pay<span class="sc">&lt;</span> target_lookup_next <span class="sc">&amp;</span> date_occur <span class="sc">&lt;=</span> date_lookup ,<span class="dv">1</span>,<span class="dv">0</span>))]</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>  dt_policy_claim <span class="ot">&lt;-</span> dt_policy_claim [,.(<span class="at">exposure =</span> <span class="fu">sum</span>(exposure)), by<span class="ot">=</span> <span class="fu">c</span>(<span class="fu">setdiff</span>(model_vars, <span class="st">'exposure'</span>)) ]</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dt_policy_claim[, model_vars, <span class="at">with =</span> <span class="cn">FALSE</span>])</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="ibnr_loss-train" class="level5" data-number="15.3.3.5.2">
<h5 data-number="15.3.3.5.2" class="anchored" data-anchor-id="ibnr_loss-train"><span class="header-section-number">15.3.3.5.2</span> IBNR_Loss Train</h5>
<p>The code for creating the IBNR datasets is rather involved so detailed explanation has been skipped over here.<br>
Interested readers are encouraged to come back to this stage and inspect the code and Baudry’s paper once they have an overview of the wider process.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>IBNR_Loss_Train_ijk <span class="ot">&lt;-</span> <span class="cf">function</span>(dt_policy_claim, date_i, j_dev_period, k, reserving_dates, model_vars, <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # debugging</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># #~~~~~~~~~~~~~</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dt_policy_claim = dt_polclaim</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># date_i = t_i</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># j_dev_period = 1</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># k = 1</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reserving_dates = lst_Date_slice</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># model_vars &lt;- IBNR_model_vars</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># #~~~~~~~~~~~~~</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  date_i <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(date_i)</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>  date_k <span class="ot">&lt;-</span> (reserving_dates[<span class="fu">which</span>(reserving_dates <span class="sc">==</span> date_i) <span class="sc">-</span> k <span class="sc">+</span> <span class="dv">1</span>])</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>  date_j <span class="ot">&lt;-</span> (reserving_dates[<span class="fu">which</span>(reserving_dates <span class="sc">==</span> date_k) <span class="sc">-</span> j_dev_period])</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>  date_lookup <span class="ot">&lt;-</span> (reserving_dates[<span class="fu">which</span>(reserving_dates <span class="sc">==</span> (date_i)) <span class="sc">-</span> j_dev_period <span class="sc">-</span>k <span class="sc">+</span> <span class="dv">1</span>]) <span class="co">#i - j - k + 1 (predictor as at date)</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>  target_lookup <span class="ot">&lt;-</span> (reserving_dates[<span class="fu">which</span>(reserving_dates <span class="sc">==</span> (date_i)) <span class="sc">-</span> k]) <span class="co">#i - k to calculate target incremental paid</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>  target_lookup_next <span class="ot">&lt;-</span> (reserving_dates[<span class="fu">which</span>(reserving_dates <span class="sc">==</span> (date_i)) <span class="sc">-</span> k <span class="sc">+</span> <span class="dv">1</span>]) <span class="co">#i -k + 1 to calculate targte incremental paid</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(verbose) <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">"Valn date"</span>, date_i, <span class="st">", j = "</span>, j_dev_period, <span class="st">", k ="</span>, k, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>  dt_policy_claim <span class="ot">&lt;-</span> dt_policy_claim[(date_lookup <span class="sc">&lt;</span> date_report) <span class="sc">&amp;</span> (date_occur <span class="sc">&lt;</span> date_lookup) <span class="sc">&amp;</span> (target_lookup <span class="sc">&gt;=</span> date_pay  <span class="sc">&amp;</span> date_pay <span class="sc">&lt;</span> target_lookup_next)] <span class="co">#definition of reported but not settled</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>  dt_policy_claim[, <span class="st">':='</span>(<span class="at">date_lookup =</span> date_lookup,</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>                         <span class="at">delay_train =</span> <span class="fu">as.numeric</span>(date_lookup <span class="sc">-</span> date_pol_start), <span class="co">#extra feature</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>                         <span class="at">j =</span> j_dev_period,</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>                         <span class="at">k =</span> k,</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>                         <span class="at">exposure =</span> <span class="dv">1</span>, <span class="co">#all claims trated equal</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>                         <span class="at">target =</span> <span class="fu">ifelse</span>(target_lookup <span class="sc">&gt;=</span> date_pay <span class="sc">&amp;</span> date_pay <span class="sc">&lt;</span> target_lookup_next,claim_cost,<span class="dv">0</span>) <span class="co">#model assumes one payment so just need to check date paid</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>  )]</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dt_policy_claim[, model_vars, <span class="at">with =</span> <span class="cn">FALSE</span>])</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="ibnr-test" class="level5" data-number="15.3.3.5.3">
<h5 data-number="15.3.3.5.3" class="anchored" data-anchor-id="ibnr-test"><span class="header-section-number">15.3.3.5.3</span> IBNR Test</h5>
<p>The code for creating the IBNR datasets is rather involved so detailed explanation has been skipped over here.<br>
Interested readers are encouraged to come back to this stage and inspect the code and Baudry’s paper once they have an overview of the wider process.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>IBNR_Test_ijk <span class="ot">&lt;-</span> <span class="cf">function</span>(dt_policy_claim, date_i,j_dev_period, k, reserving_dates, model_vars, <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## debugging</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">##~~~~~~~~~~~~~</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#dt_policy_claim = dt_polclaim</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#date_i = t_i</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#j_dev_period = 8</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">#k = 1</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#reserving_dates = lst_Date_slice</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">#model_vars &lt;- IBNR_model_vars</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  <span class="do">##~~~~~~~~~~~~~</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>  date_i <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(date_i)</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>  date_lookup <span class="ot">&lt;-</span> (reserving_dates[<span class="fu">which</span>(reserving_dates <span class="sc">==</span> (date_i))]) <span class="co">#i - j - k + 1 (predictor as at date)</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>  target_lookup <span class="ot">&lt;-</span> (reserving_dates[<span class="fu">which</span>(reserving_dates <span class="sc">==</span> (date_i)) <span class="sc">+</span>j_dev_period <span class="sc">-</span> <span class="dv">1</span>]) <span class="co">#i - k to calculate target incremental paid</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>  target_lookup_next <span class="ot">&lt;-</span> (reserving_dates[<span class="fu">which</span>(reserving_dates <span class="sc">==</span> (date_i)) <span class="sc">+</span> j_dev_period]) <span class="co">#i -k + 1 to calculate targte incremental paid  </span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(verbose) <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">"Valn date"</span>, date_i, <span class="st">", j = "</span>, j_dev_period, <span class="st">", k ="</span>, k, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># P_te_IBNR rowids of policies needing an RBNS reserve</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>  dt_policy_claim <span class="ot">&lt;-</span> dt_policy_claim[date_pol_start <span class="sc">&lt;=</span> date_lookup <span class="sc">&amp;</span> date_lookup <span class="sc">&lt;</span> date_report] <span class="co">#IBNR</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>  dt_policy_claim[, <span class="st">':='</span>(<span class="at">date_lookup =</span> date_lookup,</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>                         <span class="at">delay_train =</span> <span class="fu">as.numeric</span>(date_lookup <span class="sc">-</span> date_pol_start), <span class="co">#extra feature</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>                         <span class="at">j =</span> j_dev_period,</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>                         <span class="at">k =</span> k,</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>                         <span class="at">exposure =</span> <span class="fu">round</span>((<span class="fu">pmin</span>(<span class="fu">as.numeric</span>(<span class="fu">as.numeric</span>(date_pol_end)), <span class="fu">as.numeric</span>(<span class="fu">floor_date</span>(date_i, <span class="at">unit=</span> <span class="st">"second"</span>)))</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>                                             <span class="sc">-</span> <span class="fu">as.numeric</span>(date_pol_start))<span class="sc">/</span>(<span class="dv">24</span><span class="sc">*</span><span class="dv">60</span><span class="sc">*</span><span class="dv">60</span><span class="sc">*</span><span class="dv">365</span>),<span class="dv">3</span>),</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>                         <span class="at">target =</span> <span class="fu">ifelse</span>(target_lookup <span class="sc">&lt;=</span> date_pay <span class="sc">&amp;</span>  date_pay <span class="sc">&lt;</span> target_lookup_next <span class="sc">&amp;</span> date_occur <span class="sc">&lt;=</span> date_lookup ,claim_cost,<span class="dv">0</span>))]  <span class="co">#model assumes one payment so just need to check date paid</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>  dt_policy_claim <span class="ot">&lt;-</span> dt_policy_claim [,.(<span class="at">exposure =</span> <span class="fu">sum</span>(exposure)), by<span class="ot">=</span> <span class="fu">c</span>(<span class="fu">setdiff</span>(model_vars, <span class="st">'exposure'</span>)) ]</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dt_policy_claim[, model_vars, <span class="at">with =</span> <span class="cn">FALSE</span>])</span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="ibnr-function-calls" class="level4" data-number="15.3.3.6">
<h4 data-number="15.3.3.6" class="anchored" data-anchor-id="ibnr-function-calls"><span class="header-section-number">15.3.3.6</span> IBNR function calls</h4>
<p>The IBNR train and test datasets are created by calling the <code>IBNR_Train</code> and <code>IBNR_Test</code> functions passing, as parameters to them, the names of the joined policy and claim dataset, valuation dates and model features.</p>
<p>The functions <code>IBNR_Train</code> and <code>IBNR_Test</code> iterate over valid values of j and k calling the <code>IBNR_Freq_ijk</code>, <code>IBNR_Loss_ijk</code> and <code>IBNR_Test_ijk</code> functions to create the complete train and test datasets as set out in the code below.</p>
<p>The princple and code is similar to that of RBNS, except that the training data covers both claim counts and costs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>IBNR_Train <span class="ot">&lt;-</span> <span class="cf">function</span>(dt_policy_claim, date_i, i, k, reserving_dates, model_vars, <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a combined TRAIN dataset across all k and j combos</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k){</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (k<span class="sc">==</span><span class="dv">1</span>){</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>        dt_train_Freq <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>        dt_train_Loss <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(i <span class="sc">-</span> k <span class="sc">+</span> <span class="dv">1</span>)){</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>        dt_train_Freq <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dt_train_Freq, <span class="fu">IBNR_Freq_Train_ijk</span>(dt_policy_claim, date_i, j, k,reserving_dates, model_vars, verbose))</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>        dt_train_Loss <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dt_train_Loss, <span class="fu">IBNR_Loss_Train_ijk</span>(dt_policy_claim, date_i, j, k,reserving_dates, model_vars, verbose))</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">Freq =</span> dt_train_Freq, <span class="at">Loss =</span> dt_train_Loss))</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>IBNR_Test <span class="ot">&lt;-</span> <span class="cf">function</span>(dt_policy_claim, date_i, delta, k, reserving_dates, model_vars, <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a combined </span><span class="al">TEST</span><span class="co"> dataset across all k and j combos</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k){</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (k<span class="sc">==</span><span class="dv">1</span>) dt_test <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(delta <span class="sc">-</span> k <span class="sc">+</span> <span class="dv">1</span>)){</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>      dt_test <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dt_test, <span class="fu">IBNR_Test_ijk</span>(dt_policy_claim, date_i, j, k,reserving_dates, model_vars, verbose))</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dt_test)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So having given a rough outline of the data creation process lets now call the functions to create the IBNR datasets.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">#define IBNR modelVars</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>IBNR_model_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"clm_number"</span>,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"pol_number"</span>,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"j"</span>,</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"k"</span>,</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"exposure"</span>,</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"date_pol_start"</span>,</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"date_occur"</span>,</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"date_report"</span>,</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"date_pay"</span>,</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Cover"</span>,</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Brand"</span>,</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Model"</span>,</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Price"</span>,</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"target"</span>)</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a combined TRAIN dataset for k = 1 and all valid j delay values</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>lst_IBNR_train <span class="ot">&lt;-</span> <span class="fu">IBNR_Train</span>(dt_polclaim, t_i, i, <span class="at">k =</span> <span class="dv">1</span>,lst_Date_slice, IBNR_model_vars)</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a combined </span><span class="al">TEST</span><span class="co"> dataset for k = 1 and all valid j delay values</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>dt_IBNR_test <span class="ot">&lt;-</span> <span class="fu">IBNR_Test</span>(dt_polclaim, t_i, delta, <span class="at">k =</span> <span class="dv">1</span>,lst_Date_slice, IBNR_model_vars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The train and test datasets are then joined into a single dataset and a small amount of tidying is done to make them ready for use.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>lst_IBNR_train<span class="sc">$</span>Freq[, flgTrain <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span>]</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>lst_IBNR_train<span class="sc">$</span>Loss[, flgTrain <span class="sc">:</span><span class="er">=</span> <span class="dv">2</span>]</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>dt_IBNR_test[, flgTrain <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>]</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>dt_All_IBNR <span class="ot">&lt;-</span> <span class="fu">rbind</span>(lst_IBNR_train<span class="sc">$</span>Freq, lst_IBNR_train<span class="sc">$</span>Loss, dt_IBNR_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The important aspects of the tidying relate to creating useable delay metrics from the numerous dates and converting some character features such as cover and claim type into factors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># order and create some delay fields</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(dt_All_IBNR, clm_number, k, j)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>dt_All_IBNR[, Count <span class="sc">:</span><span class="er">=</span> .N , by <span class="ot">=</span>clm_number]</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>dt_All_IBNR[,<span class="st">':='</span>( <span class="at">delay_uw_occ =</span> <span class="fu">fifelse</span>(<span class="fu">year</span>(date_occur) <span class="sc">==</span> <span class="dv">2199</span>,</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>                                        <span class="fu">ceiling</span>((<span class="fu">as.numeric</span>(date_occur) <span class="sc">-</span> <span class="fu">as.numeric</span>(date_pol_start))</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>                                                  <span class="sc">/</span>(<span class="dv">24</span><span class="sc">*</span><span class="dv">60</span><span class="sc">*</span><span class="dv">60</span>))</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>                                          ),</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">delay_occ_rep =</span> <span class="fu">fifelse</span>(<span class="fu">year</span>(date_occur) <span class="sc">==</span> <span class="dv">2199</span>,</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>                                          <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>                                          <span class="fu">ceiling</span>((<span class="fu">as.numeric</span>(date_report) <span class="sc">-</span> <span class="fu">as.numeric</span>(date_occur))</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>                                                  <span class="sc">/</span>(<span class="dv">24</span><span class="sc">*</span><span class="dv">60</span><span class="sc">*</span><span class="dv">60</span>))</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>                                          ),</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>                   <span class="at">delay_rep_pay =</span> <span class="fu">fifelse</span>(<span class="fu">year</span>(date_occur) <span class="sc">==</span> <span class="dv">2199</span>,</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>                                          <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>                                          <span class="fu">ceiling</span>((<span class="fu">as.numeric</span>(date_pay) <span class="sc">-</span> <span class="fu">as.numeric</span>(date_report))</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>                                                  <span class="sc">/</span>(<span class="dv">24</span><span class="sc">*</span><span class="dv">60</span><span class="sc">*</span><span class="dv">60</span>))</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>                                          ),</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>                   <span class="at">delay_uw_val =</span> <span class="fu">ceiling</span>((<span class="fu">as.numeric</span>(t_i) <span class="sc">-</span> <span class="fu">as.numeric</span>(date_pol_start))<span class="sc">/</span>(<span class="dv">24</span><span class="sc">*</span><span class="dv">60</span><span class="sc">*</span><span class="dv">60</span>)),</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>                   <span class="at">date_uw =</span> <span class="fu">ceiling</span>(<span class="fu">as.numeric</span>(date_pol_start)<span class="sc">/</span>(<span class="dv">24</span><span class="sc">*</span><span class="dv">60</span><span class="sc">*</span><span class="dv">60</span>)),</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>                   <span class="at">Cover =</span> <span class="fu">as.factor</span>(Cover))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="dataset-inspection" class="level3 tabset" data-number="15.3.4">
<h3 class="tabset anchored" data-number="15.3.4" data-anchor-id="dataset-inspection"><span class="header-section-number">15.3.4</span> Dataset inspection</h3>
<p>So we now have two datasets;</p>
<ul>
<li>dt_ALL_RBNS for calculating RBNS reserves<br>
</li>
<li>dt_ALL_IBNR for calculating IBNR reserves</li>
</ul>
<p>Each dataset contains both training rows and test rows. The test rows are used for model prediction; which in this case means RBNS or IBNR reserve calculation.</p>
<p>IBNR reserves are calculated using a frequency * severity model approach. IBNR therefore requires two models and two training datasets. Training rows for the claim frequency model are identified as rows with a flgTrain column value of 1. Training rows for the claim severity model are identified as rows with a flgTrain column value of 2.</p>
<p>In both datsets the test rows are identified as rows with a flgTrain column value of 0.</p>
<p>Let’s have a quick look at the datasets.</p>
<section id="rbns" class="level4" data-number="15.3.4.1">
<h4 data-number="15.3.4.1" class="anchored" data-anchor-id="rbns"><span class="header-section-number">15.3.4.1</span> RBNS</h4>
<p>The RBNS dataset has 21 columns and 43,596 rows.</p>
<p>In a traditional reserving exercise this would have been summarised as a 10 x 10 triangle ie 50 rows. We have far more rows of data for 3 main reasons;</p>
<ol type="1">
<li>training data is presented without aggregation so there is a row for each one of the 14,878 claims that have been reported up until 2016-09-27</li>
<li>the machine learning training dataset is not just the latest triangle of data as at the valuation date. It is also every possible historic triangle prior to the valuation date as illustrated in the animation above.</li>
<li>the dataset also contains test rows ie the features needed to predict each future period from the current valuation date</li>
</ol>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-d4e0fe30b129c88a4061" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-d4e0fe30b129c88a4061">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],["201601060001","201601080001","201601080002","201601090001","201601090002","201601100001"],["201601050343","201601040365","201601040629","201601010222","201601030514","201601010095"],[8,8,8,8,8,8],[1,1,1,1,1,1],["2016-01-05T00:00:00Z","2016-01-04T00:00:00Z","2016-01-04T00:00:00Z","2016-01-01T00:00:00Z","2016-01-03T00:00:00Z","2016-01-01T00:00:00Z"],["2016-01-06T00:00:00Z","2016-01-08T00:00:00Z","2016-01-08T00:00:00Z","2016-01-09T00:00:00Z","2016-01-07T00:00:00Z","2016-01-10T00:00:00Z"],["2016-01-06T00:00:00Z","2016-01-08T00:00:00Z","2016-01-08T00:00:00Z","2016-01-09T00:00:00Z","2016-01-09T00:00:00Z","2016-01-10T00:00:00Z"],["2016-02-08T00:00:00Z","2016-02-13T00:00:00Z","2016-02-07T00:00:00Z","2016-02-05T00:00:00Z","2016-02-09T00:00:00Z","2016-02-06T00:00:00Z"],["BOT","BOT","BO","BOT","BO","B"],["B","B","B","B","O","B"],[1,2,2,1,2,2],[3,2,2,3,3,3],[913,728,728,913,837,837],[0,0,0,0,0,0],[1,1,1,1,1,1],[1,1,1,1,1,1],[1,4,4,8,4,9],[0,0,0,0,2,0],[266,267,267,270,268,270],[33,36,30,27,31,27],[16805,16804,16804,16801,16803,16801]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>clm_number<\/th>\n      <th>pol_number<\/th>\n      <th>j<\/th>\n      <th>k<\/th>\n      <th>date_pol_start<\/th>\n      <th>date_occur<\/th>\n      <th>date_report<\/th>\n      <th>date_pay<\/th>\n      <th>Cover<\/th>\n      <th>claim_type<\/th>\n      <th>Brand<\/th>\n      <th>Model<\/th>\n      <th>Price<\/th>\n      <th>target<\/th>\n      <th>flgTrain<\/th>\n      <th>Count<\/th>\n      <th>delay_uw_occ<\/th>\n      <th>delay_occ_rep<\/th>\n      <th>delay_uw_val<\/th>\n      <th>delay_rep_pay<\/th>\n      <th>date_uw<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[3,4,11,12,13,14,15,16,17,18,19,20,21]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="ibnr" class="level4" data-number="15.3.4.2">
<h4 data-number="15.3.4.2" class="anchored" data-anchor-id="ibnr"><span class="header-section-number">15.3.4.2</span> IBNR</h4>
<p>The IBNR dataset has 21 columns and 2,477,886 rows.</p>
<p>In a traditional reserving exercise this would have been summarised as a 10 x 10 triangle ie 50 rows. We have far more rows of data and far more that we did for the RBNS dataset.</p>
<p>Again the the same 3 principles apply to the IBNR row count. However this will lead to many more rows of data because we are training two models and the claim frequency model will require a row for every past policy exposure period and of course there should be orders of magnitude more exposure rows than claim rows!</p>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-cad8703dcdfef1de0dd3" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-cad8703dcdfef1de0dd3">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],[null,null,null,null,null,null],["201601010002","201601010003","201601010004","201601010005","201601010006","201601010007"],[1,1,1,1,1,1],[1,1,1,1,1,1],[0.74,0.74,0.74,0.74,0.74,0.74],["2016-01-01T00:00:00Z","2016-01-01T00:00:00Z","2016-01-01T00:00:00Z","2016-01-01T00:00:00Z","2016-01-01T00:00:00Z","2016-01-01T00:00:00Z"],["2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z"],["2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z"],["2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z","2199-12-31T23:59:59Z"],["B","B","B","B","B","B"],[1,1,1,1,1,1],[3,3,3,3,3,3],[913,913,913,913,913,913],[0,0,0,0,0,0],[1,1,1,1,1,1],[2067788,2067788,2067788,2067788,2067788,2067788],[-1,-1,-1,-1,-1,-1],[-1,-1,-1,-1,-1,-1],[-1,-1,-1,-1,-1,-1],[270,270,270,270,270,270],[16801,16801,16801,16801,16801,16801]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>clm_number<\/th>\n      <th>pol_number<\/th>\n      <th>j<\/th>\n      <th>k<\/th>\n      <th>exposure<\/th>\n      <th>date_pol_start<\/th>\n      <th>date_occur<\/th>\n      <th>date_report<\/th>\n      <th>date_pay<\/th>\n      <th>Cover<\/th>\n      <th>Brand<\/th>\n      <th>Model<\/th>\n      <th>Price<\/th>\n      <th>target<\/th>\n      <th>flgTrain<\/th>\n      <th>Count<\/th>\n      <th>delay_uw_occ<\/th>\n      <th>delay_occ_rep<\/th>\n      <th>delay_rep_pay<\/th>\n      <th>delay_uw_val<\/th>\n      <th>date_uw<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[3,4,5,11,12,13,14,15,16,17,18,19,20,21]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
</section>
<section id="summary" class="level3" data-number="15.3.5">
<h3 data-number="15.3.5" class="anchored" data-anchor-id="summary"><span class="header-section-number">15.3.5</span> Summary</h3>
<p>I’ve deliberately rushed through the creation of the datasets so we can see the end output shown above. Interested readers are encourage to revisit and review the RBNS and IBNER data creation process to gain a deeper understanding. In doing so they will be better placed to adapt the code provided to their own circumstances.</p>
<p>The above code can be wrapped into a series of functions which, given a joined policy and claim dataset and a valuation date, will return the reserving datasets needed for machine learning. In notebook 3 of this series we will create and use such functions prior to fitting a machine learning model to the training data and then use it to make reserve predictions.</p>
</section>
</section>
<section id="modelling-and-analysing-the-data" class="level2" data-number="15.4">
<h2 data-number="15.4" class="anchored" data-anchor-id="modelling-and-analysing-the-data"><span class="header-section-number">15.4</span> Modelling and analysing the data</h2>
<p>In this section we step through the process to apply machine learning techniques in order to create reserve estimates following the techniques set out in sections 3 and 4 of Baudry’s paper.</p>
<section id="model-build" class="level3 tabset" data-number="15.4.1">
<h3 class="tabset anchored" data-number="15.4.1" data-anchor-id="model-build"><span class="header-section-number">15.4.1</span> Model build</h3>
<p>I will use the xgboost R machine learning package to build the models. In Baudry’s original paper he used the extraTrees package; a variant upon RandomForests.</p>
<p>Xgboost has been selected as it is the most popular implementation of the gradient boosting machine (GBM) algorithm. GBMs have been known since around 2015 to be the most accurate algorithmic technique for regression and classification tasks.</p>
<p>The code and modelling process for each reserve type is very similar so they are shown in the tabbed sections below rather that repeating in-line.</p>
<section id="rbns-model" class="level4" data-number="15.4.1.1">
<h4 data-number="15.4.1.1" class="anchored" data-anchor-id="rbns-model"><span class="header-section-number">15.4.1.1</span> RBNS model</h4>
<p>Starting with the RBNS reserves we will first build a model upon the training data using a cross validated approach to enable selection of key xgboost hyperparameters.</p>
<p>Then using optimal parameters we retrain on the complete training dataset. This trained model is then scored against the test data in order to create predictions from which the RBNS reserve can be calculated.</p>
<section id="creating-xgboost-dataset" class="level5" data-number="15.4.1.1.1">
<h5 data-number="15.4.1.1.1" class="anchored" data-anchor-id="creating-xgboost-dataset"><span class="header-section-number">15.4.1.1.1</span> Creating xgboost dataset</h5>
<p>Xgboost requires its data to be in a specific format; a dense matrix form called a DMatrix, for which there is a function <code>xgb.DMatrix</code>. Not all variable types can be passed to <code>xgb.DMatrix</code> in particular categorical or nominal variables such as <strong>Brand</strong> have to be converted from text to numeric values.</p>
<p>For this example I’ve chosen to use the <code>parsnip</code> package and create a recipe that converts nominal predictor values into a <strong>one-hot-encoded</strong> form.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>RBNS_predictors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"j"</span>,</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"k"</span>,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Cover"</span>,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"claim_type"</span>,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Brand"</span>,</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Model"</span>,</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Price"</span>,</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>                     <span class="co">#"date_uw",</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>                     <span class="co">#"delay_uw_occ",</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"delay_occ_rep"</span>)</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>rowList_RBNS <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">train=</span>dt_All_RBNS[, <span class="fu">which</span>(flgTrain<span class="sc">==</span><span class="dv">1</span>)],</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>                <span class="at">test=</span>dt_All_RBNS[, <span class="fu">which</span>(flgTrain<span class="sc">==</span><span class="dv">0</span>)],</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>                <span class="at">all =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(dt_All_RBNS))</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>RBNS_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>( <span class="sc">~</span> ., <span class="at">data =</span> dt_All_RBNS[, RBNS_predictors, <span class="at">with =</span> <span class="cn">FALSE</span>])  <span class="sc">|&gt;</span> </span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal</span>(), <span class="at">one_hot =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>df.RBNS_train <span class="ot">&lt;-</span> <span class="fu">bake</span>(RBNS_rec, <span class="at">new_data =</span> dt_All_RBNS[rowList_RBNS<span class="sc">$</span>train,] )</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>df.RBNS_test <span class="ot">&lt;-</span> <span class="fu">bake</span>(RBNS_rec, <span class="at">new_data =</span> dt_All_RBNS[rowList_RBNS<span class="sc">$</span>test,] )</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>df.RBNS_all <span class="ot">&lt;-</span> <span class="fu">bake</span>(RBNS_rec, <span class="at">new_data =</span> dt_All_RBNS )</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>xgb.RBNS_DMat.train <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> <span class="fu">as.matrix</span>(df.RBNS_train),</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>                              <span class="at">label =</span> dt_All_RBNS[rowList_RBNS<span class="sc">$</span>train, target])</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>xgb.RBNS_DMat.test <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> <span class="fu">as.matrix</span>(df.RBNS_test),</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>                              <span class="at">label =</span> dt_All_RBNS[rowList_RBNS<span class="sc">$</span>test, target])</span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>xgb.RBNS_DMat.all <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> <span class="fu">as.matrix</span>(df.RBNS_all),</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>                             <span class="at">label =</span> dt_All_RBNS[, target])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fit-initial-model-using-cross-validation" class="level5" data-number="15.4.1.1.2">
<h5 data-number="15.4.1.1.2" class="anchored" data-anchor-id="fit-initial-model-using-cross-validation"><span class="header-section-number">15.4.1.1.2</span> Fit initial model using cross validation</h5>
<p>Having prepared the data for xgboost I can now fit an initial model. I’ve used a simple set of parameters and used cross validation to select the optimal number of boosted trees (nrounds) for these parameter selections by calling the xgb.cv function with early stopping.</p>
<p>I have used the <strong>reg:tweedie</strong> objective function based upon inspection of the target variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dt_All_RBNS[rowList_RBNS<span class="sc">$</span>train, target])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   0.00    0.00    0.00   76.44    0.00  913.00 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(dt_All_RBNS[rowList_RBNS<span class="sc">$</span>train, target])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="baudry_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In a real world example a process of parameter tuning would be undertaken in order to select more optimal parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>param <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">objective =</span> <span class="st">"reg:tweedie"</span>,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_depth =</span> 2L,            <span class="co"># tree-depth</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">subsample =</span> <span class="fl">0.75</span>,          <span class="co"># randomly sample rows before fitting each tree</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">colsample_bytree =</span> <span class="fl">0.8</span>,    <span class="co"># randomly sample columns before fitting each tree</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">min.child.weight =</span> <span class="dv">10</span>,     <span class="co"># minimum weight per leaf</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">eta =</span> <span class="fl">0.1</span>                  <span class="co"># Learning rate</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Train model with cross validation</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1984</span>) <span class="co"># for repeatability</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>xgb_RBNS_CV <span class="ot">&lt;-</span> <span class="fu">xgb.cv</span>(</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">params                 =</span> param,</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">data                   =</span> xgb.RBNS_DMat.train,</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">nrounds                =</span> <span class="dv">500</span>,        <span class="co"># Maximum number of trees to build</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">nfold =</span> <span class="dv">5</span>,</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">early_stopping_rounds  =</span> 10L,        <span class="co"># Stops algorithm early if performance has not improved in </span></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">print_every_n          =</span> 10L,        <span class="co"># How often to print to console</span></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">prediction             =</span> <span class="cn">TRUE</span>        <span class="co"># Keeps the predictions</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] train-tweedie-nloglik@1.5:197.388756+1.296594   test-tweedie-nloglik@1.5:197.391244+4.609216 
Multiple eval metrics are present. Will use test_tweedie_nloglik@1.5 for early stopping.
Will train until test_tweedie_nloglik@1.5 hasn't improved in 10 rounds.

[11]    train-tweedie-nloglik@1.5:75.924330+0.469210    test-tweedie-nloglik@1.5:75.942832+1.753744 
[21]    train-tweedie-nloglik@1.5:34.531029+0.276990    test-tweedie-nloglik@1.5:34.546202+0.679007 
[31]    train-tweedie-nloglik@1.5:22.710654+0.268914    test-tweedie-nloglik@1.5:22.724562+0.308235 
[41]    train-tweedie-nloglik@1.5:20.129801+0.104845    test-tweedie-nloglik@1.5:20.152850+0.320732 
[51]    train-tweedie-nloglik@1.5:19.632863+0.090769    test-tweedie-nloglik@1.5:19.671306+0.309964 
[61]    train-tweedie-nloglik@1.5:19.500483+0.086323    test-tweedie-nloglik@1.5:19.538232+0.308355 
[71]    train-tweedie-nloglik@1.5:19.444729+0.082132    test-tweedie-nloglik@1.5:19.493532+0.308265 
[81]    train-tweedie-nloglik@1.5:19.414329+0.078574    test-tweedie-nloglik@1.5:19.475748+0.309372 
[91]    train-tweedie-nloglik@1.5:19.398779+0.078291    test-tweedie-nloglik@1.5:19.469874+0.307553 
[101]   train-tweedie-nloglik@1.5:19.387133+0.077247    test-tweedie-nloglik@1.5:19.467463+0.308378 
[111]   train-tweedie-nloglik@1.5:19.375232+0.076711    test-tweedie-nloglik@1.5:19.460278+0.304426 
[121]   train-tweedie-nloglik@1.5:19.362611+0.075821    test-tweedie-nloglik@1.5:19.464628+0.312824 
Stopping. Best iteration:
[116]   train-tweedie-nloglik@1.5:19.368173+0.075742    test-tweedie-nloglik@1.5:19.459806+0.308833</code></pre>
</div>
</div>
<p>Having fit the model we store the out-of-fold predictions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>dt_All_RBNS[rowList_RBNS<span class="sc">$</span>train, preds_oof <span class="sc">:</span><span class="er">=</span> xgb_RBNS_CV<span class="sc">$</span>pred]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fit-final-model-on-all-training-data" class="level5" data-number="15.4.1.1.3">
<h5 data-number="15.4.1.1.3" class="anchored" data-anchor-id="fit-final-model-on-all-training-data"><span class="header-section-number">15.4.1.1.3</span> Fit final model on all training data</h5>
<p>Having fit the model using 5 fold cross validation we observe the optimum number of fitting rounds to be 116.</p>
<p>We can then use this to train a final model on all the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>xgb_RBNS_Fit <span class="ot">&lt;-</span> <span class="fu">xgb.train</span>(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">params                 =</span> param,</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data                   =</span> xgb.RBNS_DMat.train,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">nrounds                =</span> xgb_RBNS_CV<span class="sc">$</span>best_iteration,</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="co"># base_score             = 1,</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">watchlist              =</span> <span class="fu">list</span>(<span class="at">train=</span>xgb.RBNS_DMat.train, <span class="at">test=</span>xgb.RBNS_DMat.test) ,</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">print_every_n          =</span> <span class="dv">10</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] train-tweedie-nloglik@1.5:197.153822    test-tweedie-nloglik@1.5:82.790522 
[11]    train-tweedie-nloglik@1.5:75.846599 test-tweedie-nloglik@1.5:32.097264 
[21]    train-tweedie-nloglik@1.5:34.402921 test-tweedie-nloglik@1.5:14.722707 
[31]    train-tweedie-nloglik@1.5:22.522187 test-tweedie-nloglik@1.5:9.660561 
[41]    train-tweedie-nloglik@1.5:20.075724 test-tweedie-nloglik@1.5:8.625063 
[51]    train-tweedie-nloglik@1.5:19.604785 test-tweedie-nloglik@1.5:8.390317 
[61]    train-tweedie-nloglik@1.5:19.486131 test-tweedie-nloglik@1.5:8.323290 
[71]    train-tweedie-nloglik@1.5:19.439339 test-tweedie-nloglik@1.5:8.290276 
[81]    train-tweedie-nloglik@1.5:19.412141 test-tweedie-nloglik@1.5:8.275901 
[91]    train-tweedie-nloglik@1.5:19.391867 test-tweedie-nloglik@1.5:8.265842 
[101]   train-tweedie-nloglik@1.5:19.379859 test-tweedie-nloglik@1.5:8.260251 
[111]   train-tweedie-nloglik@1.5:19.370579 test-tweedie-nloglik@1.5:8.260420 
[116]   train-tweedie-nloglik@1.5:19.367158 test-tweedie-nloglik@1.5:8.260664 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>dt_All_RBNS[, preds_full <span class="sc">:</span><span class="er">=</span> <span class="fu">predict</span>(xgb_RBNS_Fit,xgb.RBNS_DMat.all)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="inspect-model-fit" class="level5" data-number="15.4.1.1.4">
<h5 data-number="15.4.1.1.4" class="anchored" data-anchor-id="inspect-model-fit"><span class="header-section-number">15.4.1.1.4</span> Inspect model fit</h5>
<p>Having fitted the full model we can then inspect the model fit. The traditional way of inspecting global model feature importance is to use the gain chart.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co">#default feature importance by gain</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>featImp_RBNS <span class="ot">&lt;-</span> <span class="fu">xgb.importance</span>(xgb_RBNS_Fit, <span class="at">feature_names =</span> <span class="fu">colnames</span>(xgb.RBNS_DMat.train))</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="fu">xgb.plot.importance</span>(featImp_RBNS, <span class="at">main=</span><span class="st">"Feature Importance - RBNS"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="baudry_files/figure-html/unnamed-chunk-56-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>An increasingly popular and more robust approach is to use SHAP values <a href="http://">https://github.com/slundberg/shap</a>. The SHAP equivalent of the feature importance chart is shown below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Return the SHAP values and ranked features by mean|SHAP|</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>shap_values <span class="ot">&lt;-</span> <span class="fu">shap.values</span>(<span class="at">xgb_model =</span> xgb_RBNS_Fit, <span class="at">X_train =</span> <span class="fu">as.matrix</span>(df.RBNS_train))</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare the long-format data:</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>shap_long <span class="ot">&lt;-</span> <span class="fu">shap.prep</span>(<span class="at">shap_contrib =</span> shap_values<span class="sc">$</span>shap_score, <span class="at">X_train =</span>  <span class="fu">as.matrix</span>(df.RBNS_train))</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="co"># **SHAP summary plot**</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="fu">shap.plot.summary</span>(shap_long, <span class="at">dilute =</span> <span class="fu">nrow</span>(df.RBNS_train)<span class="sc">/</span><span class="dv">10000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="baudry_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>A second useful chart is the partial dependency plot. This shows how the values of a predictive a feature influence the predicted value, while holding all other values constant.</p>
<p>Here we show the marginal plots for the top SHAP features.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>fig_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(shap_values<span class="sc">$</span>mean_shap_score)[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>], </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>                   shap.plot.dependence,</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data_long =</span> shap_long,</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">dilute =</span> <span class="fu">nrow</span>(shap_long)<span class="sc">/</span> <span class="dv">10000</span>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="fu">wrap_plots</span>(fig_list, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="baudry_files/figure-html/unnamed-chunk-58-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The feature importance and partial dependency plots provide quick insight into the model.</p>
<ul>
<li>We see that claim development period, j is the most important feature and that the RBNS reserve is smaller for larger values of j.</li>
<li>The second most important feature is claimtype where breakage claims are associated with lower RBNS reserves. This is as expected from the data generating process where breakage claims come from a Beta distribution with a lower mean.</li>
<li>The third most important feature is phone price where there is linear increase in RBNS reserve with increasing phone price. This is also as expected from the data generating process.</li>
<li>The fourth feature is phone brand which again follows expectations from the data generating process.</li>
</ul>
<p>SHAP values can also be used to show the components of a single prediction. In the following plot we show the top 4 components for each row of the data and zoom in at row 500.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># choose to show top 4 features by setting `top_n = 4`, set 6 clustering groups.  </span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> <span class="fu">shap.prep.stack.data</span>(<span class="at">shap_contrib =</span> shap_values<span class="sc">$</span>shap_score,</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">data_percent =</span> <span class="dv">10000</span><span class="sc">/</span><span class="fu">nrow</span>(shap_long),</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">top_n =</span> <span class="dv">4</span>,</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">n_groups =</span> <span class="dv">6</span>)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="co"># choose to zoom in at location 500, set y-axis limit using `y_parent_limit`  </span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="co"># it is also possible to set y-axis limit for zoom-in part alone using `y_zoomin_limit`  </span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="fu">shap.plot.force_plot</span>(plot_data, <span class="at">zoom_in_location =</span> <span class="dv">500</span>, <span class="at">y_parent_limit =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="baudry_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="summarising-rbns-reserves" class="level5" data-number="15.4.1.1.5">
<h5 data-number="15.4.1.1.5" class="anchored" data-anchor-id="summarising-rbns-reserves"><span class="header-section-number">15.4.1.1.5</span> Summarising RBNS reserves</h5>
<p>By comparing the model predictions to the simulated claims run-off we can get a feel for the accuracy of the machine learning approach. Below I aggregate the RBNS predictions by claim occurrence month and compare then to the known simulated claim run-off.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>dt_All_RBNS [, date_occur_YYYYMM <span class="sc">:</span><span class="er">=</span> <span class="fu">as.character</span>(<span class="fu">year</span>(date_occur) <span class="sc">+</span> <span class="fu">month</span>(date_occur)<span class="sc">/</span><span class="dv">100</span> )]</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>dt_RBNS_summary <span class="ot">&lt;-</span> dt_All_RBNS[rowList_RBNS<span class="sc">$</span>test,.(<span class="at">preds =</span> <span class="fu">sum</span>(preds_full), <span class="at">target =</span> <span class="fu">sum</span>(target)), keyby <span class="ot">=</span> date_occur_YYYYMM]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-e75724685c893033c695" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-e75724685c893033c695">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7"],["2016.04","2016.05","2016.06","2016.07","2016.08","2016.09","Total"],[1309.54179857243,4741.94003300763,12517.6466599699,56011.4067900268,326241.368243193,625187.373481669,1026009.27700644],[911,5188,14257,53815,326631,622179,1022981],[398.541798572434,-446.059966992369,-1739.35334003007,2196.40679002684,-389.631756806746,3008.373481669,3028.27700643905],[0.437477276149763,-0.0859791763670718,-0.12199995370906,0.0408140256439068,-0.00119288051901609,0.00483522182791286,0.00296024755732418]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>date_occur_YYYYMM<\/th>\n      <th>preds<\/th>\n      <th>target<\/th>\n      <th>Diff<\/th>\n      <th>Diff_pcnt<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"targets":5,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatPercentage(data, 1, 3, \",\", \".\", null);\n  }"},{"targets":2,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 0, 3, \",\", \".\", null);\n  }"},{"targets":3,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 0, 3, \",\", \".\", null);\n  }"},{"targets":4,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 0, 3, \",\", \".\", null);\n  }"},{"className":"dt-right","targets":[2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":["options.columnDefs.0.render","options.columnDefs.1.render","options.columnDefs.2.render","options.columnDefs.3.render"],"jsHooks":[]}</script>
</div>
</div>
<p>You can now jump back up to the beginning of the modeling section and select the IBNR frequency modeling tab.</p>
</section>
</section>
<section id="ibnr-frequency-model" class="level4" data-number="15.4.1.2">
<h4 data-number="15.4.1.2" class="anchored" data-anchor-id="ibnr-frequency-model"><span class="header-section-number">15.4.1.2</span> IBNR Frequency model</h4>
<p>IBNR reserves are built by multiplying the outpts of a claim frequency and claim severity model. The general process of building the model follows that of the RBNS reserves.</p>
<section id="creating-xgboost-dataset-1" class="level5" data-number="15.4.1.2.1">
<h5 data-number="15.4.1.2.1" class="anchored" data-anchor-id="creating-xgboost-dataset-1"><span class="header-section-number">15.4.1.2.1</span> Creating xgboost dataset</h5>
<p>Again we convert the data into a dense matrix form called a DMatrix. However before doing so we aggregate the data for efficiency of model fit times. There could be a loss of accuracy in doing, so in practice this is something you would want to experiment with.</p>
<p>The other point to note is the values of <strong>flgTrain</strong> used to identify the training and test rows in our dataset. Recall from Notebook 2, in the IBNR dataset training rows for the frequency model have a flgtrain value of 1 whereas the Severity training rows have a value of 2.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>IBNR_predictors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"j"</span>,</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"k"</span>,</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Cover"</span>,</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Brand"</span>,</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Model"</span>,</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Price"</span>,</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"date_uw"</span>)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a><span class="co"># aggregate the data ... does this lead to loss of variance and accuracy?</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>dt_All_IBNR [, date_pol_start_YYYYMM <span class="sc">:</span><span class="er">=</span> <span class="fu">as.character</span>(<span class="fu">year</span>(date_pol_start) <span class="sc">+</span> <span class="fu">month</span>(date_pol_start)<span class="sc">/</span><span class="dv">100</span> )]</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>dt_All_IBNR_F <span class="ot">&lt;-</span> dt_All_IBNR[, .(<span class="at">exposure =</span> <span class="fu">sum</span>(exposure),</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">target_cost =</span> <span class="fu">sum</span>(target),</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">target_count =</span> <span class="fu">sum</span>(target<span class="sc">&gt;</span><span class="dv">0</span>)),</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>                               by<span class="ot">=</span> <span class="fu">c</span>(IBNR_predictors, <span class="st">"date_pol_start_YYYYMM"</span>, <span class="st">"flgTrain"</span>)]</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>dt_All_IBNR_F <span class="ot">&lt;-</span> dt_All_IBNR_F[exposure<span class="sc">&gt;</span><span class="dv">0</span>]</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a><span class="co"># setup train and test rows</span></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>rowList_IBNR_F <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">train=</span>dt_All_IBNR_F[, <span class="fu">which</span>(flgTrain<span class="sc">==</span><span class="dv">1</span>)],</span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>                     <span class="at">test=</span>dt_All_IBNR_F[, <span class="fu">which</span>(flgTrain<span class="sc">==</span><span class="dv">0</span>)],</span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>                     <span class="at">all =</span> dt_All_IBNR_F[, <span class="fu">which</span>(flgTrain<span class="sc">!=</span><span class="dv">2</span>)])</span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a><span class="co"># setup data for xgboost</span></span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>IBNR_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>( <span class="sc">~</span> ., <span class="at">data =</span> dt_All_IBNR_F[, IBNR_predictors, <span class="at">with =</span> <span class="cn">FALSE</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal</span>(), <span class="at">one_hot =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a>df.IBNR_F_train <span class="ot">&lt;-</span> <span class="fu">bake</span>(IBNR_rec, <span class="at">new_data =</span> dt_All_IBNR_F[rowList_IBNR_F<span class="sc">$</span>train,] )</span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a>df.IBNR_F_test <span class="ot">&lt;-</span> <span class="fu">bake</span>(IBNR_rec, <span class="at">new_data =</span> dt_All_IBNR_F[rowList_IBNR_F<span class="sc">$</span>test,] )</span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a>df.IBNR_F_all <span class="ot">&lt;-</span> <span class="fu">bake</span>(IBNR_rec, <span class="at">new_data =</span> dt_All_IBNR_F[rowList_IBNR_F<span class="sc">$</span>all,] )</span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>xgb.IBNR_F_DMat.train <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> <span class="fu">as.matrix</span>(df.IBNR_F_train),</span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a>                              <span class="at">weight =</span> dt_All_IBNR_F[rowList_IBNR_F<span class="sc">$</span>train, exposure],</span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>                              <span class="at">label =</span> dt_All_IBNR_F[rowList_IBNR_F<span class="sc">$</span>train, target_count])</span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-40"><a href="#cb55-40" aria-hidden="true" tabindex="-1"></a>xgb.IBNR_F_DMat.test <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> <span class="fu">as.matrix</span>(df.IBNR_F_test),</span>
<span id="cb55-41"><a href="#cb55-41" aria-hidden="true" tabindex="-1"></a>                             <span class="at">weight =</span> dt_All_IBNR_F[rowList_IBNR_F<span class="sc">$</span>test, exposure],</span>
<span id="cb55-42"><a href="#cb55-42" aria-hidden="true" tabindex="-1"></a>                             <span class="at">label =</span> dt_All_IBNR_F[rowList_IBNR_F<span class="sc">$</span>test, target_count])</span>
<span id="cb55-43"><a href="#cb55-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-44"><a href="#cb55-44" aria-hidden="true" tabindex="-1"></a>xgb.IBNR_F_DMat.all <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> <span class="fu">as.matrix</span>(df.IBNR_F_all),</span>
<span id="cb55-45"><a href="#cb55-45" aria-hidden="true" tabindex="-1"></a>                            <span class="at">weight =</span> dt_All_IBNR_F[rowList_IBNR_F<span class="sc">$</span>all, exposure],</span>
<span id="cb55-46"><a href="#cb55-46" aria-hidden="true" tabindex="-1"></a>                            <span class="at">label =</span> dt_All_IBNR_F[rowList_IBNR_F<span class="sc">$</span>all, target_count])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fit-initial-model-using-cross-validation-1" class="level5" data-number="15.4.1.2.2">
<h5 data-number="15.4.1.2.2" class="anchored" data-anchor-id="fit-initial-model-using-cross-validation-1"><span class="header-section-number">15.4.1.2.2</span> Fit initial model using cross validation</h5>
<p>Having prepared the data for xgboost we now need to select xgboost hyperparameter and fit an initial model.</p>
<p>I have used the <strong>count:poisson</strong> objective function based upon inspection of the target variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(dt_All_IBNR_F[rowList_IBNR_F<span class="sc">$</span>train, target_count])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="baudry_files/figure-html/unnamed-chunk-63-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>param <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">objective =</span> <span class="st">"count:poisson"</span>,</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_depth =</span> 2L,           <span class="co"># tree-depth</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">subsample =</span> <span class="fl">0.7</span>,          <span class="co"># randomly sample rows before fitting each tree</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">colsample_bytree =</span> <span class="fl">0.8</span>,   <span class="co"># randomly sample columns before fitting each tree</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">min.child.weight =</span> <span class="dv">10</span>,    <span class="co"># minimum weight per leaf</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">eta =</span> <span class="fl">0.1</span>               <span class="co"># Learning rate</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">#monotone_constraints = monotone_Vec # Monotonicity constraints</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Train model with cross validation</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1984</span>) <span class="co"># for repeatability</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>xgb_IBNR_F_CV <span class="ot">&lt;-</span> <span class="fu">xgb.cv</span>(</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a> <span class="at">params                 =</span> param,</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a> <span class="at">data                   =</span> xgb.IBNR_F_DMat.train,</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a> <span class="at">nrounds                =</span> <span class="dv">2000</span>,        <span class="co"># Maximum number of trees to build</span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a> <span class="at">nfold =</span> <span class="dv">5</span>,</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a> <span class="at">early_stopping_rounds  =</span> 50L,        <span class="co"># Stops algorithm early if performance has not improved in n rounds</span></span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a> <span class="at">print_every_n          =</span> 50L,        <span class="co"># How often to print to console</span></span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a> <span class="co">#base_score             = 0.001,       # Model starting point</span></span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>   <span class="at">prediction             =</span> <span class="cn">TRUE</span>        <span class="co"># Keeps the predictions</span></span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] train-poisson-nloglik:0.509649+0.000442 test-poisson-nloglik:0.509662+0.001670 
Multiple eval metrics are present. Will use test_poisson_nloglik for early stopping.
Will train until test_poisson_nloglik hasn't improved in 50 rounds.

[51]    train-poisson-nloglik:0.162211+0.002027 test-poisson-nloglik:0.162435+0.005655 
[101]   train-poisson-nloglik:0.136555+0.002231 test-poisson-nloglik:0.137046+0.007991 
[151]   train-poisson-nloglik:0.132412+0.002202 test-poisson-nloglik:0.133890+0.008357 
[201]   train-poisson-nloglik:0.130635+0.002154 test-poisson-nloglik:0.133224+0.008607 
[251]   train-poisson-nloglik:0.129481+0.002143 test-poisson-nloglik:0.132928+0.008833 
[301]   train-poisson-nloglik:0.128445+0.002096 test-poisson-nloglik:0.132870+0.008822 
[351]   train-poisson-nloglik:0.127596+0.002078 test-poisson-nloglik:0.132839+0.008840 
[401]   train-poisson-nloglik:0.126853+0.002010 test-poisson-nloglik:0.132943+0.008736 
Stopping. Best iteration:
[354]   train-poisson-nloglik:0.127535+0.002085 test-poisson-nloglik:0.132833+0.008836</code></pre>
</div>
</div>
<p>Having fit the model we store the out-of-fold predictions for both the claim frequency and the claim counts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a> dt_All_IBNR_F[rowList_IBNR_F<span class="sc">$</span>train, preds_oof_IBNR_F <span class="sc">:</span><span class="er">=</span> xgb_IBNR_F_CV<span class="sc">$</span>pred]</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a> dt_All_IBNR_F[rowList_IBNR_F<span class="sc">$</span>train, preds_oof_IBNR_Nos <span class="sc">:</span><span class="er">=</span> exposure <span class="sc">*</span> preds_oof_IBNR_F]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fit-final-model-on-all-training-data-1" class="level5" data-number="15.4.1.2.3">
<h5 data-number="15.4.1.2.3" class="anchored" data-anchor-id="fit-final-model-on-all-training-data-1"><span class="header-section-number">15.4.1.2.3</span> Fit final model on all training data</h5>
<p>Having fit the model using 5 fold cross validation we observe the optimum number of fitting rounds to be 354.</p>
<p>We can then us this to train a final model on all the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>xgb_IBNR_F_Fit <span class="ot">&lt;-</span> <span class="fu">xgb.train</span>(</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>   <span class="at">params                 =</span> param,</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>   <span class="at">data                   =</span> xgb.IBNR_F_DMat.train,</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>   <span class="at">nrounds                =</span> xgb_IBNR_F_CV<span class="sc">$</span>best_iteration,</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="co"># base_score             = 1,</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>   <span class="at">watchlist              =</span> <span class="fu">list</span>(<span class="at">train=</span>xgb.IBNR_F_DMat.train, <span class="at">test=</span>xgb.IBNR_F_DMat.test) ,</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>   <span class="at">print_every_n          =</span> <span class="dv">50</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] train-poisson-nloglik:0.509641  test-poisson-nloglik:0.497402 
[51]    train-poisson-nloglik:0.162953  test-poisson-nloglik:0.121425 
[101]   train-poisson-nloglik:0.136572  test-poisson-nloglik:0.087977 
[151]   train-poisson-nloglik:0.132644  test-poisson-nloglik:0.084498 
[201]   train-poisson-nloglik:0.130981  test-poisson-nloglik:0.083343 
[251]   train-poisson-nloglik:0.129897  test-poisson-nloglik:0.082925 
[301]   train-poisson-nloglik:0.129155  test-poisson-nloglik:0.082865 
[351]   train-poisson-nloglik:0.128418  test-poisson-nloglik:0.083072 
[354]   train-poisson-nloglik:0.128371  test-poisson-nloglik:0.083107 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a> dt_All_IBNR_F[rowList_IBNR_F<span class="sc">$</span>all, preds_full_IBNR_Nos <span class="sc">:</span><span class="er">=</span> <span class="fu">predict</span>(xgb_IBNR_F_Fit,xgb.IBNR_F_DMat.all)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="inspect-model-fit-1" class="level5" data-number="15.4.1.2.4">
<h5 data-number="15.4.1.2.4" class="anchored" data-anchor-id="inspect-model-fit-1"><span class="header-section-number">15.4.1.2.4</span> Inspect model fit</h5>
<p>Having fitted the full model we can then inspect the model fit. The traditional way of inspecting global model feature importance is to use gain.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co">#default feature importance by gain</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>featImp_IBNR_F <span class="ot">&lt;-</span> <span class="fu">xgb.importance</span>(xgb_IBNR_F_Fit, <span class="at">feature_names =</span> <span class="fu">colnames</span>(xgb.IBNR_F_DMat.train))</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="fu">xgb.plot.importance</span>(featImp_IBNR_F, <span class="at">main=</span><span class="st">"Feature Importance - IBNR Frequency"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="baudry_files/figure-html/unnamed-chunk-67-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>An increasingly popular and more robust approach is to use SHAP values <a href="http://">https://github.com/slundberg/shap</a>. The SHAP equivalent of the feature importance chart is shown below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Return the SHAP values and ranked features by mean|SHAP|</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>shap_values <span class="ot">&lt;-</span> <span class="fu">shap.values</span>(<span class="at">xgb_model =</span> xgb_IBNR_F_Fit, <span class="at">X_train =</span> <span class="fu">as.matrix</span>(df.IBNR_F_train))</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare the long-format data:</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>shap_long <span class="ot">&lt;-</span> <span class="fu">shap.prep</span>(<span class="at">shap_contrib =</span> shap_values<span class="sc">$</span>shap_score, <span class="at">X_train =</span>  <span class="fu">as.matrix</span>(df.IBNR_F_train))</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="co"># **SHAP summary plot**</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="fu">shap.plot.summary</span>(shap_long, <span class="at">dilute =</span> <span class="fu">nrow</span>(df.IBNR_F_train)<span class="sc">/</span><span class="dv">10000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="baudry_files/figure-html/unnamed-chunk-68-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>A second useful chart is the partial dependency plot. This shows how the values of a predictive a feature influence the predicted value, while holding all other values constant.</p>
<p>Here we show the SHAP equivalent of partial dependency plots; marginal plots for the top SHAP features.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>fig_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(shap_values<span class="sc">$</span>mean_shap_score)[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>], </span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>                   shap.plot.dependence,</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data_long =</span> shap_long,</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">dilute =</span> <span class="fu">nrow</span>(shap_long)<span class="sc">/</span> <span class="dv">10000</span>)</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="fu">wrap_plots</span>(fig_list, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="baudry_files/figure-html/unnamed-chunk-69-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The feature importance and partial dependency plots provide quick insight into the model.</p>
<ul>
<li>We see that claim development period, j is the most important feature and that the IBNR frequency is smaller for larger values of j.</li>
<li>The second most important feature is phone price with the IBNR claim count increasing as price increases. Although this is not a direct feature in the data generating process there is a link with higher theft frequencies and higher phone prices.</li>
<li>The third most important feature is phone model with IBNR frequency increasing with model type. This is expected from the data generating process as theft claim frequency increases with model type.</li>
<li>The fourth feature is phone cover and it should be no suprise to see that Breakage only, the most basic cover level is associated with lower IBNR claim counts.</li>
</ul>
<p>SHAP values can also be used to show the components of a single predction. In the following plot we show the top 4 components for each row of the data and zoom in at row 500.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># choose to show top 4 features by setting `top_n = 4`, set 6 clustering groups.  </span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> <span class="fu">shap.prep.stack.data</span>(<span class="at">shap_contrib =</span> shap_values<span class="sc">$</span>shap_score,</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">data_percent =</span> <span class="dv">10000</span><span class="sc">/</span><span class="fu">nrow</span>(shap_long),</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">top_n =</span> <span class="dv">4</span>,</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">n_groups =</span> <span class="dv">6</span>)</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="co"># choose to zoom in at location 500, set y-axis limit using `y_parent_limit`  </span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="co"># it is also possible to set y-axis limit for zoom-in part alone using `y_zoomin_limit`  </span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="fu">shap.plot.force_plot</span>(plot_data, <span class="at">zoom_in_location =</span> <span class="dv">500</span>, <span class="at">y_parent_limit =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="baudry_files/figure-html/unnamed-chunk-70-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="summarising-ibnr-claim-counts" class="level5" data-number="15.4.1.2.5">
<h5 data-number="15.4.1.2.5" class="anchored" data-anchor-id="summarising-ibnr-claim-counts"><span class="header-section-number">15.4.1.2.5</span> Summarising IBNR claim counts</h5>
<p>Again we convert the data into a dense matrix form called a DMatrix. However before doing so we aggregate the data for efficient of model fit times. There could be a loss of accuracy in doing, so in practice this is something you’d want to experiment with.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>dt_All_IBNR_F_summary <span class="ot">&lt;-</span> dt_All_IBNR_F[rowList_IBNR_F<span class="sc">$</span>test,.(<span class="at">preds =</span> <span class="fu">sum</span>(preds_full_IBNR_Nos), <span class="at">target =</span> <span class="fu">sum</span>(target_count)), keyby <span class="ot">=</span> date_pol_start_YYYYMM]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-abfedf0a117e8bc682ba" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-abfedf0a117e8bc682ba">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10"],["2016.01","2016.02","2016.03","2016.04","2016.05","2016.06","2016.07","2016.08","2016.09","Total"],[208.771256074571,179.391088224103,183.772730839002,176.127053607153,163.590983750255,154.368389668889,103.904382487446,76.4519859725478,69.5995136748534,1315.97738429882],[168,176,160,164,195,179,170,162,59,1433],[40.7712560745713,3.39108822410344,23.7727308390022,12.1270536071534,-31.409016249745,-24.631610331111,-66.0956175125539,-85.5480140274522,10.5995136748534,-117.022615701178],[0.242686048062924,0.0192675467278605,0.148579567743764,0.0739454488241058,-0.161071878203821,-0.137606761626318,-0.388797750073846,-0.528074160663285,0.179652774150057,-0.0816626766930764]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>date_pol_start_YYYYMM<\/th>\n      <th>preds<\/th>\n      <th>target<\/th>\n      <th>Diff<\/th>\n      <th>Diff_pcnt<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"targets":5,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatPercentage(data, 1, 3, \",\", \".\", null);\n  }"},{"targets":2,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 0, 3, \",\", \".\", null);\n  }"},{"targets":3,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 0, 3, \",\", \".\", null);\n  }"},{"targets":4,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 0, 3, \",\", \".\", null);\n  }"},{"className":"dt-right","targets":[2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":["options.columnDefs.0.render","options.columnDefs.1.render","options.columnDefs.2.render","options.columnDefs.3.render"],"jsHooks":[]}</script>
</div>
</div>
<p>You can now jump back up to the beginning of the modeling section and select the IBNR severity modeling tab.</p>
</section>
</section>
<section id="ibnr-severity-model" class="level4" data-number="15.4.1.3">
<h4 data-number="15.4.1.3" class="anchored" data-anchor-id="ibnr-severity-model"><span class="header-section-number">15.4.1.3</span> IBNR Severity model</h4>
<p>IBNR reserves are built by multiplying the outputs of a claim frequency and claim severity model. The general process of building the model follows that of the RBNS reserves.</p>
<section id="creating-xgboost-dataset-2" class="level5" data-number="15.4.1.3.1">
<h5 data-number="15.4.1.3.1" class="anchored" data-anchor-id="creating-xgboost-dataset-2"><span class="header-section-number">15.4.1.3.1</span> Creating xgboost dataset</h5>
<p>Again we convert the data into a dense matrix form called a DMatrix.</p>
<p>The other point to note is the values of <em>flgTrain</em> used to identify the training and test rows in our dataset. Recall from Notebook 2, in the IBNR dataset training rows for the frequency model have a flgtrain value of 1 whereas the Severity training roes have a value of 2.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>IBNR_predictors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"j"</span>,</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"k"</span>,</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Cover"</span>,</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Brand"</span>,</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Model"</span>,</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Price"</span>,</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"date_uw"</span>)</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>dt_All_IBNR [, date_pol_start_YYYYMM <span class="sc">:</span><span class="er">=</span> <span class="fu">as.character</span>(<span class="fu">year</span>(date_pol_start) <span class="sc">+</span> <span class="fu">month</span>(date_pol_start)<span class="sc">/</span><span class="dv">100</span> )]</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>dt_All_IBNR_S <span class="ot">&lt;-</span> dt_All_IBNR[, .(<span class="at">exposure =</span> <span class="fu">sum</span>(target<span class="sc">&gt;</span><span class="dv">0</span>),</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">target_cost =</span> <span class="fu">sum</span>(target)),</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>                            by<span class="ot">=</span> <span class="fu">c</span>(IBNR_predictors, <span class="st">"date_pol_start_YYYYMM"</span>, <span class="st">"flgTrain"</span>)]</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>dt_All_IBNR_S <span class="ot">&lt;-</span> dt_All_IBNR_S[exposure<span class="sc">&gt;</span><span class="dv">0</span>]</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a><span class="co"># setup train and test rows</span></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>rowList_IBNR_S <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">train=</span>dt_All_IBNR_S[, <span class="fu">which</span>(flgTrain<span class="sc">==</span><span class="dv">2</span>)],</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>                     <span class="at">test=</span>dt_All_IBNR_S[, <span class="fu">which</span>(flgTrain<span class="sc">==</span><span class="dv">0</span>)],</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>                     <span class="at">all =</span> dt_All_IBNR_S[, <span class="fu">which</span>(flgTrain<span class="sc">!=</span><span class="dv">1</span>)])</span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a><span class="co"># setup data for xgboost</span></span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>IBNR_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>( <span class="sc">~</span> ., <span class="at">data =</span> dt_All_IBNR_S[, IBNR_predictors, <span class="at">with =</span> <span class="cn">FALSE</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal</span>(), <span class="at">one_hot =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a>df.IBNR_S_train <span class="ot">&lt;-</span> <span class="fu">bake</span>(IBNR_rec, <span class="at">new_data =</span> dt_All_IBNR_S[rowList_IBNR_S<span class="sc">$</span>train,] )</span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a>df.IBNR_S_test <span class="ot">&lt;-</span> <span class="fu">bake</span>(IBNR_rec, <span class="at">new_data =</span> dt_All_IBNR_S[rowList_IBNR_S<span class="sc">$</span>test,] )</span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a>df.IBNR_S_all <span class="ot">&lt;-</span> <span class="fu">bake</span>(IBNR_rec, <span class="at">new_data =</span> dt_All_IBNR_S[rowList_IBNR_S<span class="sc">$</span>all,] )</span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a>xgb.IBNR_S_DMat.train <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> <span class="fu">as.matrix</span>(df.IBNR_S_train),</span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a>                              <span class="at">weight =</span> dt_All_IBNR_S[rowList_IBNR_S<span class="sc">$</span>train, exposure],</span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true" tabindex="-1"></a>                              <span class="at">label =</span> dt_All_IBNR_S[rowList_IBNR_S<span class="sc">$</span>train, target_cost])</span>
<span id="cb68-37"><a href="#cb68-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-38"><a href="#cb68-38" aria-hidden="true" tabindex="-1"></a>xgb.IBNR_S_DMat.test <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> <span class="fu">as.matrix</span>(df.IBNR_S_test),</span>
<span id="cb68-39"><a href="#cb68-39" aria-hidden="true" tabindex="-1"></a>                             <span class="at">weight =</span> dt_All_IBNR_S[rowList_IBNR_S<span class="sc">$</span>test, exposure],</span>
<span id="cb68-40"><a href="#cb68-40" aria-hidden="true" tabindex="-1"></a>                             <span class="at">label =</span> dt_All_IBNR_S[rowList_IBNR_S<span class="sc">$</span>test, target_cost])</span>
<span id="cb68-41"><a href="#cb68-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-42"><a href="#cb68-42" aria-hidden="true" tabindex="-1"></a>xgb.IBNR_S_DMat.all <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> <span class="fu">as.matrix</span>(df.IBNR_S_all),</span>
<span id="cb68-43"><a href="#cb68-43" aria-hidden="true" tabindex="-1"></a>                            <span class="at">weight =</span> dt_All_IBNR_S[rowList_IBNR_S<span class="sc">$</span>all, exposure],</span>
<span id="cb68-44"><a href="#cb68-44" aria-hidden="true" tabindex="-1"></a>                            <span class="at">label =</span> dt_All_IBNR_S[rowList_IBNR_S<span class="sc">$</span>all, target_cost])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fit-initial-model-using-cross-validation-2" class="level5" data-number="15.4.1.3.2">
<h5 data-number="15.4.1.3.2" class="anchored" data-anchor-id="fit-initial-model-using-cross-validation-2"><span class="header-section-number">15.4.1.3.2</span> Fit initial model using cross validation</h5>
<p>Having prepared the data for xgboost.</p>
<p>I have used the <strong>reg:gamma</strong> objective function based upon inspection of the target variable.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
    3.0   125.5   255.0   353.9   486.5  2011.0 </code></pre>
</div>
<div class="cell-output-display">
<p><img src="baudry_files/figure-html/unnamed-chunk-74-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>param <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">objective =</span> <span class="st">"reg:gamma"</span>,</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_depth =</span> 2L,           <span class="co"># tree-depth</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">subsample =</span> <span class="fl">0.7</span>,          <span class="co"># randomly sample rows before fitting each tree</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">colsample_bytree =</span> <span class="fl">0.8</span>,   <span class="co"># randomly sample columns before fitting each tree</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">min.child.weight =</span> <span class="dv">10</span>,    <span class="co"># minimum weight per leaf</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">eta =</span> <span class="fl">0.1</span>               <span class="co"># Learning rate</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">#monotone_constraints = monotone_Vec # Monotonicity constraints</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Train model with cross validation</span></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1984</span>) <span class="co"># for repeatability</span></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>xgb_IBNR_S_CV <span class="ot">&lt;-</span> <span class="fu">xgb.cv</span>(</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a> <span class="at">params                 =</span> param,</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a> <span class="at">data                   =</span> xgb.IBNR_S_DMat.train,</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a> <span class="at">nrounds                =</span> <span class="dv">2000</span>,        <span class="co"># Maximum number of trees to build</span></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a> <span class="at">nfold =</span> <span class="dv">5</span>,</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a> <span class="at">early_stopping_rounds  =</span> 50L,        <span class="co"># Stops algorithm early if performance has not improved in n rounds</span></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a> <span class="at">print_every_n          =</span> 50L,        <span class="co"># How often to print to console</span></span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a> <span class="co">#base_score             = 0.001,       # Model starting point</span></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>   <span class="at">prediction             =</span> <span class="cn">TRUE</span>        <span class="co"># Keeps the predictions</span></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] train-gamma-nloglik:725.773272+11.678322    test-gamma-nloglik:724.944332+48.085563 
Multiple eval metrics are present. Will use test_gamma_nloglik for early stopping.
Will train until test_gamma_nloglik hasn't improved in 50 rounds.

[51]    train-gamma-nloglik:10.028548+0.083001  test-gamma-nloglik:10.030530+0.394205 
[101]   train-gamma-nloglik:6.820625+0.017219   test-gamma-nloglik:6.827891+0.071678 
[151]   train-gamma-nloglik:6.810464+0.017320   test-gamma-nloglik:6.825314+0.071134 
[201]   train-gamma-nloglik:6.805024+0.017430   test-gamma-nloglik:6.825313+0.071630 
Stopping. Best iteration:
[160]   train-gamma-nloglik:6.809337+0.017458   test-gamma-nloglik:6.825086+0.071190</code></pre>
</div>
</div>
<p>Having fitted an initial model the out-of-fold predictions are stored.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a> dt_All_IBNR_S[rowList_IBNR_S<span class="sc">$</span>train, preds_oof_IBNR_S <span class="sc">:</span><span class="er">=</span> xgb_IBNR_S_CV<span class="sc">$</span>pred]</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a> dt_All_IBNR_S[rowList_IBNR_S<span class="sc">$</span>train, preds_oof_IBNR_Cost <span class="sc">:</span><span class="er">=</span> exposure <span class="sc">*</span> preds_oof_IBNR_S]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fit-final-model-on-all-training-data-2" class="level5" data-number="15.4.1.3.3">
<h5 data-number="15.4.1.3.3" class="anchored" data-anchor-id="fit-final-model-on-all-training-data-2"><span class="header-section-number">15.4.1.3.3</span> Fit final model on all training data</h5>
<p>Having fit the model using 5 fold cross validation we observe the optimum number of fitting rounds to be 160.</p>
<p>We can then us this to train a final model on all the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>xgb_IBNR_S_Fit <span class="ot">&lt;-</span> <span class="fu">xgb.train</span>(</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>   <span class="at">params                 =</span> param,</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>   <span class="at">data                   =</span> xgb.IBNR_S_DMat.train,</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>   <span class="at">nrounds                =</span> xgb_IBNR_S_CV<span class="sc">$</span>best_iteration,</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="co"># base_score             = 1,</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>   <span class="at">watchlist              =</span> <span class="fu">list</span>(<span class="at">train=</span>xgb.IBNR_F_DMat.train, <span class="at">test=</span>xgb.IBNR_F_DMat.test) ,</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>   <span class="at">print_every_n          =</span> <span class="dv">50</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] train-gamma-nloglik:-0.520863   test-gamma-nloglik:-0.546764 
[51]    train-gamma-nloglik:4.166608    test-gamma-nloglik:4.165618 
[101]   train-gamma-nloglik:5.650526    test-gamma-nloglik:5.655644 
[151]   train-gamma-nloglik:5.630720    test-gamma-nloglik:5.607739 
[160]   train-gamma-nloglik:5.627124    test-gamma-nloglik:5.601972 </code></pre>
</div>
</div>
<p>Having trained the model the predictions are stored.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a> dt_All_IBNR_S[rowList_IBNR_S<span class="sc">$</span>all, preds_full_IBNR_Cost <span class="sc">:</span><span class="er">=</span> <span class="fu">predict</span>(xgb_IBNR_S_Fit,xgb.IBNR_S_DMat.all)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="inspect-model-fit-2" class="level5" data-number="15.4.1.3.4">
<h5 data-number="15.4.1.3.4" class="anchored" data-anchor-id="inspect-model-fit-2"><span class="header-section-number">15.4.1.3.4</span> Inspect model fit</h5>
<p>Having fitted the full model we can then inspect the model fit. The traditional way of inspecting global model feature importance is to use the gains chart.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co">#default feature importance by gain</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>featImp_IBNR_S <span class="ot">&lt;-</span> <span class="fu">xgb.importance</span>(xgb_IBNR_S_Fit, <span class="at">feature_names =</span> <span class="fu">colnames</span>(xgb.IBNR_S_DMat.train))</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="fu">xgb.plot.importance</span>(featImp_IBNR_S, <span class="at">main=</span><span class="st">"Feature Importance - IBNR Severity"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="baudry_files/figure-html/unnamed-chunk-79-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>An increasingly popular and more robust approach is to use SHAP values <a href="http://">https://github.com/slundberg/shap</a>. The SHAP equivalent of the feature importance chart is shown below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Return the SHAP values and ranked features by mean|SHAP|</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>shap_values <span class="ot">&lt;-</span> <span class="fu">shap.values</span>(<span class="at">xgb_model =</span> xgb_IBNR_S_Fit, <span class="at">X_train =</span> <span class="fu">as.matrix</span>(df.IBNR_S_train))</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare the long-format data:</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>shap_long <span class="ot">&lt;-</span> <span class="fu">shap.prep</span>(<span class="at">shap_contrib =</span> shap_values<span class="sc">$</span>shap_score, <span class="at">X_train =</span>  <span class="fu">as.matrix</span>(df.IBNR_S_train))</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a><span class="co"># **SHAP summary plot**</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a><span class="fu">shap.plot.summary</span>(shap_long, <span class="at">dilute =</span> <span class="fu">max</span>(<span class="fu">nrow</span>(df.IBNR_S_train),<span class="dv">10000</span>)<span class="sc">/</span><span class="dv">10000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="baudry_files/figure-html/unnamed-chunk-80-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>A second useful chart is the partial dependency plot. This shows how the values of a predictive a feature influence the predicted value, while holding all other values constant.</p>
<p>Here we show the SHAP equivalent of partial dependency plots; marginal plots for the top SHAP features.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>fig_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(shap_values<span class="sc">$</span>mean_shap_score)[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>], </span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>                   shap.plot.dependence,</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data_long =</span> shap_long,</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">dilute =</span> <span class="fu">nrow</span>(shap_long)<span class="sc">/</span> <span class="dv">10000</span>)</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="fu">wrap_plots</span>(fig_list, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="baudry_files/figure-html/unnamed-chunk-81-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The feature importance and partial dependency plots provide quick insight into the model.</p>
<ul>
<li>We see that phone price is the most important feature and has a linear relationship with IBNR severity as we would expect from the data generating process.</li>
<li>The second and third most important features relate to phone cover. We see that cover BOT is associated with higher IBNR costs whereas cover B is associated with lower.<br>
</li>
<li>The fourth feature is phone brand and follows the pattern we would expect from the data simulation process.</li>
</ul>
<p>SHAP values can also be used to show the components of a single prediction. In the following plot we show the top 4 components for each row of the data and zoom in at row 500.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># choose to show top 4 features by setting `top_n = 4`, set 6 clustering groups.  </span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> <span class="fu">shap.prep.stack.data</span>(<span class="at">shap_contrib =</span> shap_values<span class="sc">$</span>shap_score,</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">data_percent =</span> <span class="dv">10000</span><span class="sc">/</span><span class="fu">max</span>(<span class="fu">nrow</span>(shap_long),<span class="dv">10000</span>),</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">top_n =</span> <span class="dv">4</span>,</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">n_groups =</span> <span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>The SHAP values of the Rest 5 features were summed into variable 'rest_variables'.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># choose to zoom in at location 500, set y-axis limit using `y_parent_limit`  </span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="co"># it is also possible to set y-axis limit for zoom-in part alone using `y_zoomin_limit`  </span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="fu">shap.plot.force_plot</span>(plot_data, <span class="at">zoom_in_location =</span> <span class="dv">500</span>, <span class="at">y_parent_limit =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Data has N = 1111 | zoom in length is 111 at location 500.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="baudry_files/figure-html/unnamed-chunk-82-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="summarising-ibnr-claim-costs" class="level5" data-number="15.4.1.3.5">
<h5 data-number="15.4.1.3.5" class="anchored" data-anchor-id="summarising-ibnr-claim-costs"><span class="header-section-number">15.4.1.3.5</span> Summarising IBNR claim costs</h5>
<p>Again we convert the data into a dense matrix form called a DMatrix. However before doing so we aggregate the data for efficient of model fit times. There could be a loss of accuracy in doing, so in practice this is something you’d want to experiment with.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>dt_All_IBNR_S_summary <span class="ot">&lt;-</span> dt_All_IBNR_S[rowList_IBNR_S<span class="sc">$</span>test,.(<span class="at">preds =</span> <span class="fu">sum</span>(preds_full_IBNR_Cost), <span class="at">target =</span> <span class="fu">sum</span>(target_cost)), keyby <span class="ot">=</span> date_pol_start_YYYYMM]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-ad51be6f30451dc523b4" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-ad51be6f30451dc523b4">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10"],["2016.01","2016.02","2016.03","2016.04","2016.05","2016.06","2016.07","2016.08","2016.09","Total"],[56127.9330596924,53271.763256073,51198.8593521118,52763.8570823669,65279.267616272,56776.5145111084,54615.7408065796,55512.2281990051,19966.0144462585,465512.178329468],[52782,55615,47200,56975,64833,52989,50276,53502,18989,453161],[3345.93305969238,-2343.236743927,3998.85935211182,-4211.14291763306,446.267616271973,3787.5145111084,4339.74080657959,2010.22819900513,977.014446258545,12351.1783294678],[0.0633915550697659,-0.0421331788892745,0.084721596443047,-0.0739121179049242,0.00688334052522593,0.0714773728718866,0.086318338900859,0.0375729542634878,0.0514516007298196,0.0272556074540125]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>date_pol_start_YYYYMM<\/th>\n      <th>preds<\/th>\n      <th>target<\/th>\n      <th>Diff<\/th>\n      <th>Diff_pcnt<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"targets":5,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatPercentage(data, 1, 3, \",\", \".\", null);\n  }"},{"targets":2,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 0, 3, \",\", \".\", null);\n  }"},{"targets":3,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 0, 3, \",\", \".\", null);\n  }"},{"targets":4,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 0, 3, \",\", \".\", null);\n  }"},{"className":"dt-right","targets":[2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":["options.columnDefs.0.render","options.columnDefs.1.render","options.columnDefs.2.render","options.columnDefs.3.render"],"jsHooks":[]}</script>
</div>
</div>
</section>
</section>
</section>
<section id="summary-1" class="level3" data-number="15.4.2">
<h3 data-number="15.4.2" class="anchored" data-anchor-id="summary-1"><span class="header-section-number">15.4.2</span> Summary</h3>
<p>In this section we have stepped through the process to apply machine learning techniques in order to create reserve estimates following the techniques set out in sections 3 and 4 of Baudry’s paper.</p>
<p>Specifically we have shown how to apply the xgboost machine learning algorithm and illustrated how it can, with little human input, create reasonable reserve estimates as shown below.</p>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-9c24bc6da9e7b5a9b6bd" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-9c24bc6da9e7b5a9b6bd">{"x":{"filter":"none","vertical":false,"data":[["1","2","3"],["RBNS","IBNR","TOTAL"],[1026009.27700644,465512.178329468,1491521.45533591],[1022981,453161,1476142],[3028.27700644208,12351.1783294678,15379.45533591],[0.00296024755732714,0.0272556074540125,0.0104186828475241]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Reserve<\/th>\n      <th>Prediction<\/th>\n      <th>Ground_Truth<\/th>\n      <th>Diff<\/th>\n      <th>Diff_pcnt<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"targets":5,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatPercentage(data, 1, 3, \",\", \".\", null);\n  }"},{"targets":2,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 0, 3, \",\", \".\", null);\n  }"},{"targets":3,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 0, 3, \",\", \".\", null);\n  }"},{"targets":4,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 0, 3, \",\", \".\", null);\n  }"},{"className":"dt-right","targets":[2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":["options.columnDefs.0.render","options.columnDefs.1.render","options.columnDefs.2.render","options.columnDefs.3.render"],"jsHooks":[]}</script>
</div>
</div>
<p>In addition we have seen how we can create explanations for the reserve predictions using feature importance and partial dependence plots. We have also used SHAP values which can be used to explain both global features and individual predictions.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../Literature/al_mudafer.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Probabilistic Forecasting with Neural Networks Applied to Loss Reserving</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../Practical/practical.html" class="pagination-link">
        <span class="nav-page-text">Practical Considerations Workstream</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>