<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Machine Learning in Non-Life Reserving - 8&nbsp; Self-assembling claim reserving models using the LASSO</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../Foundations/07_mlr3example.html" rel="next">
<link href="../Foundations/05_a_glms_r.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script src="../site_libs/htmlwidgets-1.6.2/htmlwidgets.js"></script>
<link href="../site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="../site_libs/datatables-binding-0.30/datatables.js"></script>
<script src="../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="../site_libs/dt-core-1.13.4/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="../site_libs/dt-core-1.13.4/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="../site_libs/dt-core-1.13.4/js/jquery.dataTables.min.js"></script>
<link href="../site_libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="../site_libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../Foundations/foundations.html">Foundations</a></li><li class="breadcrumb-item"><a href="../Foundations/06_lasso.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Self-assembling claim reserving models using the LASSO</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Machine Learning in Non-Life Reserving</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../Foundations/foundations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/01_getting_started.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Getting started</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/02_intro_to_r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Introduction to R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/03_top_ten_r_packages.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">My Top 10 R Packages for Data Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/04_a_tidyverse.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">The tidyverse for actuaries</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/04_b_datatable.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">R’s data.table - a useful package for actuaries</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/05_a_glms_r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Reserving with GLMs in R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/06_lasso.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Self-assembling claim reserving models using the LASSO</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/07_mlr3example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">ML modelling on triangles - a worked example</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/08_intro_glm_gam_xgboost.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Getting to grips with GLM, GAM and XGBoost</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../Data/data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Data/simulationmachine.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">simulationmachine engine for simulating data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Data/splice.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">SPLICE</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../Literature/literature.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Literature review</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Literature/baudry.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Non-parametric individual claim reserving in insurance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Literature/history_nn_papers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">A brief history of papers looking at using neural networks in reserving</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Literature/al_mudafer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Probabilistic Forecasting with Neural Networks Applied to Loss Reserving</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../Research/research.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Research</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Research/giro-2021-questions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Machine learning: Reserving on triangles - Q &amp; A after GIRO 2021</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Research/giro-2021-diagnostics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Modelling Five Scenarios using the SynthETIC Dataset - Diagnostic from GIRO 2021</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Research/chainladder_to_individual_mdn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">From Chain Ladder to Individual Mixture Density Networks on SPLICE Data</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../Practical/practical.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Practical Considerations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Practical/time_resource.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Practical Considerations Part 1: Time &amp; Resource Limitations</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../Survey/survey.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Surveys</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Survey/surveys2020.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">2020 Surveys of the use of ML in reserving</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Summary</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction-to-the-lasso" id="toc-introduction-to-the-lasso" class="nav-link active" data-scroll-target="#introduction-to-the-lasso"><span class="header-section-number">8.1</span> Introduction to the LASSO</a>
  <ul class="collapse">
  <li><a href="#from-glms" id="toc-from-glms" class="nav-link" data-scroll-target="#from-glms"><span class="header-section-number">8.1.1</span> From GLMs …</a></li>
  <li><a href="#to-the-lasso" id="toc-to-the-lasso" class="nav-link" data-scroll-target="#to-the-lasso"><span class="header-section-number">8.1.2</span> … to the LASSO</a></li>
  <li><a href="#model-selection" id="toc-model-selection" class="nav-link" data-scroll-target="#model-selection"><span class="header-section-number">8.1.3</span> Model selection</a></li>
  </ul></li>
  <li><a href="#using-the-lasso-for-reserving" id="toc-using-the-lasso-for-reserving" class="nav-link" data-scroll-target="#using-the-lasso-for-reserving"><span class="header-section-number">8.2</span> Using the LASSO for reserving</a></li>
  <li><a href="#tutorial-on-how-to-use-our-lasso-technique-for-reserving" id="toc-tutorial-on-how-to-use-our-lasso-technique-for-reserving" class="nav-link" data-scroll-target="#tutorial-on-how-to-use-our-lasso-technique-for-reserving"><span class="header-section-number">8.3</span> Tutorial on how to use our LASSO technique for reserving</a></li>
  <li><a href="#initial-setup" id="toc-initial-setup" class="nav-link" data-scroll-target="#initial-setup"><span class="header-section-number">8.4</span> Initial Setup</a></li>
  <li><a href="#generating-the-synthetic-data-set" id="toc-generating-the-synthetic-data-set" class="nav-link" data-scroll-target="#generating-the-synthetic-data-set"><span class="header-section-number">8.5</span> Generating the synthetic data set</a>
  <ul class="collapse">
  <li><a href="#specifying-the-lasso-model" id="toc-specifying-the-lasso-model" class="nav-link" data-scroll-target="#specifying-the-lasso-model"><span class="header-section-number">8.5.1</span> Specifying the LASSO model</a></li>
  <li><a href="#fitting-a-lasso" id="toc-fitting-a-lasso" class="nav-link" data-scroll-target="#fitting-a-lasso"><span class="header-section-number">8.5.2</span> Fitting a LASSO</a></li>
  <li><a href="#analysing-the-model" id="toc-analysing-the-model" class="nav-link" data-scroll-target="#analysing-the-model"><span class="header-section-number">8.5.3</span> Analysing the model</a></li>
  <li><a href="#claims-reserves" id="toc-claims-reserves" class="nav-link" data-scroll-target="#claims-reserves"><span class="header-section-number">8.5.4</span> Claims reserves</a></li>
  </ul></li>
  <li><a href="#commentary" id="toc-commentary" class="nav-link" data-scroll-target="#commentary"><span class="header-section-number">8.6</span> Commentary</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">8.7</span> Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-lasso" class="quarto-section-identifier"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Self-assembling claim reserving models using the LASSO</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p><em>This <a href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/post/foundations/lasso/">article</a> was written by Grainne McGuire and Greg Taylor and originally published on 26 April 2021</em></p>
<p><em>In this post we look at how regularised regression techniques such as the LASSO can be used to set reserves for triangles.</em></p>
<p>The <a href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/post/foundations/intro-to-foundations-blog/">Foundation Workstream’s first post</a> set out a suggested path to getting to grips with machine learning. The first step was to start by applying GLMs to reserving and one way of doing this was covered in our most recent post (<a href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/post/foundations/r-glms/">Reserving with GLMs</a>).</p>
<p>In this post, we move onto the next step which is to use regularised regression methods. These allow us to build something that looks like a GLM but in a machine learning way - i.e.&nbsp;the machine selects the model. Put simply, regularisation techniques shrink or regularise regression parameters towards zero (excluding the intercept - this is normally not regularised, so in effect, this means that the fitted values are regularised towards the constant term in the regression). This penalises more complex models and reduces the risk of overfitting.</p>
<p>Here we will be focussing on a particular type of regularised regression, called the LASSO. As well as shrinking the parameters towards zero, the LASSO also selects parameters (and their corresponding regressor) by explicitly setting some to zero. This makes it a particularly useful method.</p>
<p>Below we will first provide a brief technical overview of the LASSO for those interested, before moving onto a practical example.</p>
<section id="introduction-to-the-lasso" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="introduction-to-the-lasso"><span class="header-section-number">8.1</span> Introduction to the LASSO</h2>
<p>The LASSO (<strong>L</strong>east <strong>A</strong>bsolute <strong>S</strong>hrinkage and <strong>S</strong>election <strong>O</strong>perator) is a form of regularised regression. This means that the regression is subject to a penalty for the addition of each additional term in the predictor. The purpose of this is to prevent over-fitting of the model to data.</p>
<section id="from-glms" class="level3" data-number="8.1.1">
<h3 data-number="8.1.1" class="anchored" data-anchor-id="from-glms"><span class="header-section-number">8.1.1</span> From GLMs …</h3>
<p>The loss function associated with a GLM regression is the <strong>deviance</strong>, defined as</p>
<p><span class="math display">\[D(y; X, \hat{\beta}) = -\sum_{i=1}^N \ell (y_i; X, \hat{\beta})  + \text{other terms}\]</span></p>
<p>where:</p>
<ul>
<li><p><span class="math inline">\(y\)</span> is the <em>N</em>-vector of observations <span class="math inline">\(y_i\)</span></p></li>
<li><p><span class="math inline">\(X\)</span> is the regression design matrix</p></li>
<li><p><span class="math inline">\(\beta\)</span> is the <em>p</em>-vector of coefficients <span class="math inline">\(\beta_j\)</span> in the linear predictor</p></li>
<li><p><span class="math inline">\(\hat{\beta}\)</span> is the regression estimate of <span class="math inline">\(\beta\)</span></p></li>
<li><p><span class="math inline">\(\ell (y_i; X, \hat{\beta})\)</span> is the log-likelihood of observation <span class="math inline">\(y_i\)</span></p></li>
<li><p>the other terms are of no great interest here.</p></li>
</ul>
<p>Parameter estimation of a GLM can be performed by minimisation of the deviance with respect to <span class="math inline">\(\hat{\beta}\)</span>, which is equivalent to maximisation of the likelihood.</p>
</section>
<section id="to-the-lasso" class="level3" data-number="8.1.2">
<h3 data-number="8.1.2" class="anchored" data-anchor-id="to-the-lasso"><span class="header-section-number">8.1.2</span> … to the LASSO</h3>
<p>The loss function for the LASSO version of this GLM is:</p>
<p><span class="math display">\[\mathcal{L} (y; X, \hat{\beta}) = D(y; X, \hat{\beta}) + \lambda ||\hat{\beta}||_1\]</span></p>
<p>where:</p>
<ul>
<li><p><span class="math inline">\(\lambda ||\hat{\beta}||_1\)</span> is the parameter penalty or regularisation</p></li>
<li><p><span class="math inline">\(||\hat{\beta}||_1 = \sum_{j=1}^p | \hat{\beta}_j|\)</span> is the <span class="math inline">\(L_1\)</span> norm of <span class="math inline">\(\hat{\beta}\)</span> (which is the absolute value)</p></li>
<li><p><span class="math inline">\(\lambda \geq 0\)</span> is a tuning parameter controlling the size of the penalty and therefore the amount of the regularisation.</p></li>
</ul>
<p>LASSO parameter estimation is effected by minimisation of <span class="math inline">\(\mathcal{L} (y; X, \hat{\beta})\)</span> with respect to <span class="math inline">\(\hat{\beta}\)</span>. The quantity <span class="math inline">\(\lambda ||\hat{\beta}||_1\)</span> adds a penalty for each non-zero coefficient.</p>
</section>
<section id="model-selection" class="level3" data-number="8.1.3">
<h3 data-number="8.1.3" class="anchored" data-anchor-id="model-selection"><span class="header-section-number">8.1.3</span> Model selection</h3>
<p>The non-differentiability of the penalty function tends to cause the occurrence of corner solutions in the minimisation, so that some coefficients <span class="math inline">\(\hat{\beta}_j\)</span> are forced to zero.<br>
The strength of this effect increases with <span class="math inline">\(\lambda\)</span>. In the limit <span class="math inline">\(\lambda=0\)</span>, the LASSO is the same as the GLM; in the limit <span class="math inline">\(\lambda \rightarrow \infty\)</span>, the LASSO model becomes null, i.e.&nbsp;<span class="math inline">\(\hat{\beta} = 0\)</span> (other than the intercept if this has not been regularised). Thus, as <span class="math inline">\(\lambda\)</span> increases from 0 to <span class="math inline">\(\infty\)</span>, the LASSO model shifts from the relatively complex GLM to increasingly simpler representations of the data.</p>
<p>In practical use, models are fitted for a number of different possible values of <span class="math inline">\(\lambda\)</span> (a path of values, from high to low). Cross-validation may then be used to select a particular <span class="math inline">\(\lambda\)</span>, and therefore model - one popular choice is the model which minimises the selected error measure over the different folds. Another popular alternative is to select the model with an average error across the folds that is one standard deviation away from the minimum. In this case, it is always the simpler model (i.e.&nbsp;higher <span class="math inline">\(\lambda\)</span> value) that is selected with the aim of further reducing the risk of overfitting.</p>
<p>There is a Bayesian version of the LASSO (further details in the paper, and references therein), in which it is viewed as a hierarchical model, consisting of the original GLM with randomised parameters, each subject to the Laplace prior density:</p>
<p><span class="math display">\[ \pi(\beta_j) = \frac{1}{2} \lambda \exp( -\lambda | \beta_j |), \space\space\space\space -\infty &lt; \beta_j &lt; \infty .\]</span></p>
<p>The LASSO is dealt with in more detail in <a href="https://web.stanford.edu/~hastie/ElemStatLearn/">Hastie T, Tibshirani R and Friedman J. (2009). <strong>The Elements of Statistical Learning: Data Mining, Inference and Prediction</strong>. Springer, New York USA.</a></p>
</section>
</section>
<section id="using-the-lasso-for-reserving" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="using-the-lasso-for-reserving"><span class="header-section-number">8.2</span> Using the LASSO for reserving</h2>
<p>In GIRO 2018 (and presented again at TIGI 2019), we, along with our co-author Hugh Miller, describe how the LASSO could be used to carry out reserving for a traditional triangle. The motivation behind this work was to develop an automatic method to construct a general insurance claims reserving model for data sets with complex features where simple approaches such as the chain ladder fail. In the past we have advocated the use of GLM models for such data sets, but the construction of a GLM is a time-consuming process, even for a skilled analyst. Our aim was to develop a procedure that produced a model similar to a GLM, but using machine learning techniques.</p>
<p>We used the LASSO rather than other types of regularised regression, for the following reasons:</p>
<ul>
<li>The ability of the LASSO to select parameters (by setting some parameter estimates to zero)</li>
<li>The LASSO leads to lower error variance in the fitted values (at the cost of some additional bias).</li>
</ul>
<p>This approach has performed well - as may be seen from the figures towards the end of this article, which show that the fitted curves can track the underlying specification quite closely, even in the presence of significant noise, or difficult to detect interactions. A paper describing the method is available on <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3241906">SSRN</a>. This contains much more technical detail around the choice, use and implementation of the LASSO for the reserving problem.</p>
<p>For the rest of this post, we will work through this method in a tutorial example. This is based on an existing <a href="https://grainnemcguire.github.io/post/self-assembling-claim-reserving-models">worked example</a> so if you’ve seen that one, then you may already be familiar with a lot of the content below.</p>
</section>
<section id="tutorial-on-how-to-use-our-lasso-technique-for-reserving" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="tutorial-on-how-to-use-our-lasso-technique-for-reserving"><span class="header-section-number">8.3</span> Tutorial on how to use our LASSO technique for reserving</h2>
<p>In our paper we investigate the use of the LASSO using four synthetic (i.e.&nbsp;simulated) data sets as well as a real data set. This worked example will use the third simulated data set. The specifications for this data set are given in Section 4.2.1 of the paper. The main points to note are that this data set:</p>
<ul>
<li>is a 40x40 triangle, with</li>
<li>accident and development period effects</li>
<li>calendar period effects (i.e.&nbsp;superimposed inflation)</li>
<li>a step-interaction between accident and development period for accident periods greater than 16 and development periods greater than 20 (note this affects only 10 cells of the triangle)</li>
</ul>
<p>These effects are represented graphically below.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="06_lasso_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="initial-setup" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="initial-setup"><span class="header-section-number">8.4</span> Initial Setup</h2>
<p>First we must open R and load any libraries required. These include:</p>
<ul>
<li><strong>data.table</strong> for manipulating data</li>
<li><strong>glmnet</strong> to fit the LASSO model</li>
<li><strong>ggplot2</strong> and <strong>patchwork</strong> for graphing</li>
</ul>
<p>If you would prefer all data manipulation in base R, then refer to the <a href="https://grainnemcguire.github.io/post/self-assembling-claim-reserving-models/">original version of this tutorial</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># other setup</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="st">"scipen"</span><span class="ot">=</span><span class="dv">99</span>) <span class="co"># turn off scientific notation</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># colour palette for some plots</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># IFoA colours</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># primary colours</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>dblue <span class="ot">&lt;-</span> <span class="st">"#113458"</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>mblue <span class="ot">&lt;-</span> <span class="st">"#4096b8"</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>gold <span class="ot">&lt;-</span> <span class="st">"#d9ab16"</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>lgrey <span class="ot">&lt;-</span> <span class="st">"#dcddd9"</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>dgrey <span class="ot">&lt;-</span> <span class="st">"#3f4548"</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>black <span class="ot">&lt;-</span> <span class="st">"#3F4548"</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co">#secondary colours</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>red <span class="ot">&lt;-</span> <span class="st">"#d01e45"</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>purple <span class="ot">&lt;-</span> <span class="st">"#8f4693"</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>orange <span class="ot">&lt;-</span> <span class="st">"#ee741d"</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>fuscia <span class="ot">&lt;-</span> <span class="st">"#e9458c"</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>violet <span class="ot">&lt;-</span> <span class="st">"#8076cf"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="generating-the-synthetic-data-set" class="level2" data-number="8.5">
<h2 data-number="8.5" class="anchored" data-anchor-id="generating-the-synthetic-data-set"><span class="header-section-number">8.5</span> Generating the synthetic data set</h2>
<p>The functions defined below will generate data sets similar to those used in our paper. Here we’ll use simulated data set 3, but we’ve included the code to generate the other data sets so that you can experiment with others if you wish.</p>
<p>The utility function <code>LinearSpline()</code> will be widely used in this example - it takes a vector <code>var</code> and produces a spline piece between <code>start</code> and <code>stop</code> - flat (and 0) up to <code>start</code>, thereafter increasing to <code>stop</code> and then levelling out at this point. This is used both in the data generation and in the generation of basis functions for the LASSO.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>LinearSpline <span class="ot">&lt;-</span> <span class="cf">function</span>(var, start, stop){</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pmin</span>(stop <span class="sc">-</span> start, <span class="fu">pmax</span>(<span class="dv">0</span>, var <span class="sc">-</span> start))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>CreateSyntheticData<span class="ot">&lt;-</span><span class="cf">function</span>(whichsim, numperiods)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># whichsim determins which data set to simulate</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># numperiods determines the size of the triangle</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create the acc/dev/cal parameters</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    kk <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>numperiods, <span class="at">each =</span> numperiods) <span class="co">#AQ</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    jj <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>numperiods, <span class="at">times=</span> numperiods) <span class="co">#DQ</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    tt <span class="ot">&lt;-</span> kk<span class="sc">+</span>jj<span class="dv">-1</span> <span class="co"># PQ</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># set alpha/beta/gamma - hard-code up the sim values</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (whichsim <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>        alpha <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="dv">100000</span>)<span class="sc">+</span><span class="fl">0.1</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">1</span>,<span class="dv">15</span>)<span class="sc">+</span><span class="fl">0.2</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">15</span>,<span class="dv">20</span>) <span class="sc">-</span> <span class="fl">0.05</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">30</span>,<span class="dv">40</span>) </span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        beta  <span class="ot">&lt;-</span> (<span class="dv">16</span><span class="sc">/</span><span class="dv">3</span> <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="fu">log</span>(jj)<span class="sc">-</span> (<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)<span class="sc">*</span>jj</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>        gamma <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>        mu <span class="ot">&lt;-</span> <span class="fu">exp</span>( alpha <span class="sc">+</span> beta <span class="sc">+</span> gamma)  </span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> (whichsim <span class="sc">==</span> <span class="dv">2</span>){</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>        alpha <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="dv">100000</span>)<span class="sc">+</span><span class="fl">0.1</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">1</span>,<span class="dv">15</span>)<span class="sc">+</span><span class="fl">0.2</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">15</span>,<span class="dv">20</span>) <span class="sc">-</span> <span class="fl">0.05</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">30</span>,<span class="dv">40</span>) </span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        beta  <span class="ot">&lt;-</span> (<span class="dv">16</span><span class="sc">/</span><span class="dv">3</span> <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="fu">log</span>(jj)<span class="sc">-</span> (<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)<span class="sc">*</span>jj  <span class="co"># a is 16/3, b is 1/3 </span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        gamma <span class="ot">&lt;-</span> <span class="fu">gammafunc</span>(tt)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>        mu <span class="ot">&lt;-</span> <span class="fu">exp</span>( alpha <span class="sc">+</span> beta <span class="sc">+</span> gamma)  </span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> (whichsim <span class="sc">==</span> <span class="dv">3</span>){</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>        alpha <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="dv">100000</span>)<span class="sc">+</span><span class="fl">0.1</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">1</span>,<span class="dv">15</span>)<span class="sc">+</span><span class="fl">0.2</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">15</span>,<span class="dv">20</span>) <span class="sc">-</span> <span class="fl">0.05</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">30</span>,<span class="dv">40</span>) </span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>        beta  <span class="ot">&lt;-</span> (<span class="dv">16</span><span class="sc">/</span><span class="dv">3</span> <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="fu">log</span>(jj)<span class="sc">-</span> (<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)<span class="sc">*</span>jj  <span class="co"># a is 16/3, b is 1/3 </span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>        gamma <span class="ot">&lt;-</span> <span class="fu">gammafunc</span>(tt)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>        mu <span class="ot">&lt;-</span> <span class="fu">exp</span>( alpha <span class="sc">+</span> beta <span class="sc">+</span> gamma <span class="sc">+</span> <span class="fl">0.3</span><span class="sc">*</span>beta<span class="sc">*</span><span class="fu">ifelse</span>(kk<span class="sc">&gt;</span><span class="dv">16</span> <span class="sc">&amp;</span> jj<span class="sc">&gt;</span><span class="dv">20</span>,<span class="dv">1</span>,<span class="dv">0</span>))  </span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> (whichsim <span class="sc">==</span> <span class="dv">4</span>){</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>        alpha <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="dv">100000</span>)<span class="sc">+</span><span class="fl">0.1</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">1</span>,<span class="dv">15</span>)<span class="sc">+</span><span class="fl">0.2</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">15</span>,<span class="dv">20</span>) <span class="sc">-</span> <span class="fl">0.05</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">30</span>,<span class="dv">40</span>) </span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>        beta  <span class="ot">&lt;-</span> (<span class="dv">16</span><span class="sc">/</span><span class="dv">3</span> <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="fu">log</span>(jj)<span class="sc">-</span> (<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)<span class="sc">*</span>jj  <span class="co"># a is 16/3, b is 1/3 </span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>        gamma <span class="ot">&lt;-</span> <span class="fu">gammafunc</span>(tt)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>        mu <span class="ot">&lt;-</span> <span class="fu">exp</span>( alpha <span class="sc">+</span> beta <span class="sc">+</span> gamma<span class="sc">*</span>((numperiods<span class="dv">-1</span>)<span class="sc">-</span><span class="fu">LinearSpline</span>(jj,<span class="dv">1</span>,numperiods))<span class="sc">/</span>(numperiods<span class="dv">-1</span>) )  <span class="co"># need to check</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    varbase <span class="ot">&lt;-</span> (<span class="fl">0.3</span> <span class="sc">*</span> mu[  kk<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> jj <span class="sc">==</span><span class="dv">16</span>] )<span class="sc">^</span><span class="dv">2</span> <span class="co"># can scale variance up and down here</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    CC  <span class="ot">&lt;-</span>  varbase <span class="sc">/</span> mu[  kk<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> jj <span class="sc">==</span><span class="dv">16</span>]</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    vars   <span class="ot">&lt;-</span> CC<span class="sc">*</span>mu</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    tausq  <span class="ot">&lt;-</span> <span class="fu">log</span> (vars <span class="sc">/</span> (mu<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    pmts <span class="ot">&lt;-</span> <span class="fu">exp</span>( <span class="fu">rnorm</span>( numperiods<span class="sc">^</span><span class="dv">2</span>, <span class="at">mean =</span> <span class="fu">log</span>(mu)<span class="sc">-</span><span class="fl">0.5</span><span class="sc">*</span>tausq , <span class="at">sd =</span> <span class="fu">sqrt</span>(tausq)  ) )</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># indicator for past/future = traint/test</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    train_ind<span class="ot">&lt;-</span>(tt<span class="sc">&lt;=</span>numperiods)</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    <span class="do">### data.table for output</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>    full<span class="ot">&lt;-</span><span class="fu">data.table</span>(pmts, <span class="at">acc=</span><span class="fu">as.integer</span>(kk), <span class="at">dev=</span><span class="fu">as.integer</span>(jj), <span class="at">cal=</span><span class="fu">as.integer</span>(tt), mu, train_ind )</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    full</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a><span class="co">#---------------------------</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a><span class="co"># function to generate calendar period effects used in CreateSyntheticData()</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a><span class="co"># written as a seperate function for convenience</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>gammafunc <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>    gg <span class="ot">&lt;-</span> </span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ifelse</span>( t<span class="sc">&lt;=</span><span class="dv">12</span>, gg <span class="ot">&lt;-</span> <span class="fl">0.0075</span><span class="sc">*</span><span class="fu">LinearSpline</span>(t,<span class="dv">1</span>,<span class="dv">12</span>),</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>                <span class="fu">ifelse</span>(t<span class="sc">&lt;=</span><span class="dv">24</span>,  gg <span class="ot">&lt;-</span> <span class="fl">0.0075</span><span class="sc">*</span><span class="fu">LinearSpline</span>(<span class="dv">12</span>,<span class="dv">1</span>,<span class="dv">12</span>) <span class="sc">+</span> <span class="fl">0.001</span><span class="sc">*</span> (t<span class="dv">-12</span>)<span class="sc">*</span>(t<span class="dv">-11</span>)<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">ifelse</span>(t<span class="sc">&lt;=</span><span class="dv">32</span>, gg <span class="ot">&lt;-</span> <span class="fl">0.0075</span><span class="sc">*</span><span class="fu">LinearSpline</span>(<span class="dv">12</span>,<span class="dv">1</span>,<span class="dv">12</span>) <span class="sc">+</span> <span class="fl">0.001</span><span class="sc">*</span> (<span class="dv">24-12</span>)<span class="sc">*</span>(<span class="dv">24-11</span>)<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">ifelse</span>(t<span class="sc">&lt;=</span><span class="dv">40</span>, gg <span class="ot">&lt;-</span> <span class="fl">0.0075</span><span class="sc">*</span><span class="fu">LinearSpline</span>(<span class="dv">12</span>,<span class="dv">1</span>,<span class="dv">12</span>) <span class="sc">+</span> <span class="fl">0.001</span><span class="sc">*</span> (<span class="dv">24-12</span>)<span class="sc">*</span>(<span class="dv">24-11</span>)<span class="sc">/</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.002</span><span class="sc">*</span>(t<span class="dv">-32</span>)<span class="sc">*</span>(t<span class="dv">-31</span>)<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>                               <span class="fl">0.0075</span><span class="sc">*</span><span class="fu">LinearSpline</span>(<span class="dv">12</span>,<span class="dv">1</span>,<span class="dv">12</span>) <span class="sc">+</span> <span class="fl">0.001</span><span class="sc">*</span> (<span class="dv">24-12</span>)<span class="sc">*</span>(<span class="dv">24-11</span>)<span class="sc">/</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.002</span><span class="sc">*</span>(<span class="dv">40-32</span>)<span class="sc">*</span>(<span class="dv">40-31</span>)<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>                           ))))</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>    gg  </span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The code below generates the data set as specified in our paper. If you want to use our data set, use a seed of 130. Otherwise, use different seeds to produce different data sets. Or change <code>use_data_set</code> to 1, 2 or 4 to use data sets simulated in a similar way to those in our paper.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>use_data_set <span class="ot">&lt;-</span> <span class="dv">3</span>       <span class="co"># which data set to use</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>use_data_set_seed <span class="ot">&lt;-</span> <span class="dv">130</span>  <span class="co"># seed to generate data</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>num_periods <span class="ot">&lt;-</span> <span class="dv">40</span>   <span class="co"># size of data set</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(use_data_set_seed)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">CreateSyntheticData</span>(<span class="at">whichsim=</span>use_data_set, <span class="at">numperiods=</span>num_periods)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s have a look at the data:</p>
<ul>
<li><code>acc</code> / <code>dev</code> / <code>cal</code> = accident / development / calendar quarter</li>
<li><code>pmts</code> = simulated payments</li>
<li><code>mu</code> = underlying mean</li>
<li><code>train_ind</code>: TRUE for past values and FALSE for future.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># head(dat,10) gives the same information, the rest is just formatting</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dat, <span class="dv">10</span>)  <span class="sc">|&gt;</span> </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>() <span class="sc">|&gt;</span> </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatRound</span>(<span class="fu">c</span>(<span class="st">"pmts"</span>, <span class="st">"mu"</span>), <span class="at">digits =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-59dcd27d4e26888c9d61" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-59dcd27d4e26888c9d61">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10"],[242671.1640383284,164001.2960466034,3224477.79346903,3682530.827048554,10149368.64017366,28578274.66015073,29022300.65969213,56795754.44236322,47360540.76112714,99139254.55222465],[1,1,1,1,1,1,1,1,1,1],[1,2,3,4,5,6,7,8,9,10],[1,2,3,4,5,6,7,8,9,10],[71653.13105737889,1042775.619296191,4362599.773141178,10955670.088305,20800545.12341599,33089166.75114899,46588740.24285702,59989022.52811839,72148133.04018961,82224253.22813225],[true,true,true,true,true,true,true,true,true,true]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>pmts<\/th>\n      <th>acc<\/th>\n      <th>dev<\/th>\n      <th>cal<\/th>\n      <th>mu<\/th>\n      <th>train_ind<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"targets":1,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 0, 3, \",\", \".\", null);\n  }"},{"targets":5,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 0, 3, \",\", \".\", null);\n  }"},{"className":"dt-right","targets":[1,2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":["options.columnDefs.0.render","options.columnDefs.1.render"],"jsHooks":[]}</script>
</div>
</div>
<p>It may also be helpful to visualise the data, using shading to indicate the size of the payments (specifically, log(payments)).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get limits for use with raster plots</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>data_raster_limits <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">floor</span>(dat[, <span class="fu">min</span>(<span class="fu">log</span>(pmts))]), <span class="fu">ceiling</span>(dat[, <span class="fu">max</span>(<span class="fu">log</span>(pmts))]))</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(dev, acc)) <span class="sc">+</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>(<span class="fu">aes</span>(<span class="at">fill =</span> <span class="fu">log</span>(pmts)))<span class="sc">+</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>num_periods<span class="sc">+</span><span class="dv">1</span><span class="sc">-</span>acc, <span class="at">y=</span>acc), <span class="at">colour=</span>dgrey, <span class="at">size=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_reverse</span>()<span class="sc">+</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">begin=</span><span class="dv">1</span>, <span class="at">end=</span><span class="dv">0</span>, <span class="at">limits=</span>data_raster_limits)<span class="sc">+</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()<span class="sc">+</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">"Development quarter"</span>, <span class="at">y=</span><span class="st">"Accident quarter"</span>, <span class="at">title=</span><span class="st">"Log(payments)"</span>)<span class="sc">+</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="06_lasso_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="specifying-the-lasso-model" class="level3" data-number="8.5.1">
<h3 data-number="8.5.1" class="anchored" data-anchor-id="specifying-the-lasso-model"><span class="header-section-number">8.5.1</span> Specifying the LASSO model</h3>
<p>The LASSO model requires data (which we have), basis functions or regressors and model settings for the LASSO procedure. In our example we have 3 regressors - accident, development and calendar periods. If we use these as is, then all our model can potentially contain are a linear effect related to each of these. That won’t come anywhere close to modelling the data. Therefore, a key part of our paper was how to expand these 3 regressors into a flexible set of basis functions, capable of capturing a variety of shapes in the model experience.</p>
<section id="set-of-basis-functions" class="level4" data-number="8.5.1.1">
<h4 data-number="8.5.1.1" class="anchored" data-anchor-id="set-of-basis-functions"><span class="header-section-number">8.5.1.1</span> Set of basis functions</h4>
<p>In the paper we proposed creating a basis function set consisting of ramp functions and step (or heaviside) functions, as shown in the plot below:</p>
<ul>
<li>Ramps start flat at 0, then have a knot (turning point) after which they increase linearly</li>
<li>Step or heaviside functions start at 0, then step up to 1 and a specific point and remain there.</li>
</ul>
<div class="cell">
<div class="cell-output-display">
<p><img src="06_lasso_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>More specifically we use the ramp functions for main effects and the heaviside functions for interactions.</p>
<p>Since the procedure is intended to be automatic, the default basis function set includes all possible main effects ramps and all possible two-way interaction step functions.</p>
<p>For the particular data set here, this means that our basis functions include:</p>
<ul>
<li><p>3 x 39 ramp functions, e.g. <span class="math display">\[\max(\text{acc} - k, 0), \;\; k=1, 2, ..., 39\]</span></p>
<ul>
<li>and similar for <code>dev</code> and <code>cal</code>.</li>
</ul></li>
<li><p>3 x 39 x 39 interactions <span class="math display">\[I(\text{acc} \geq k)*I(\text{acc} \geq j), \;\; k, j = 2,3,..., 40\]</span></p>
<ul>
<li>similar for (<code>acc</code>, <code>cal</code>) and (<code>dev</code>, <code>cal</code>)</li>
</ul></li>
<li><p>This leads to 4680(!) basis functions.</p></li>
</ul>
<p>Since there are really only 2 regressors (as in, once you know two of accident, development and calendar, you know the third), there are a lot of correlated variables. For real problems (as in the real data example in the paper), where you have prior knowledge about what effects are likely to be in the data we would recommend more discernment in the selection of which of the effects to include. For example, if you expect only development and calendar effects, then do not include the accident period basis functions.</p>
</section>
<section id="scaling" class="level4" data-number="8.5.1.2">
<h4 data-number="8.5.1.2" class="anchored" data-anchor-id="scaling"><span class="header-section-number">8.5.1.2</span> Scaling</h4>
<p>Referring back to the introduction of this article, the loss function to be minimised for the LASSO is</p>
<p><span class="math display">\[\mathcal{L} (y; X, \hat{\beta}) = D(y; X, \hat{\beta}) + \lambda ||\hat{\beta}||_1\]</span></p>
<p>We noted that <span class="math inline">\(\lambda\)</span> controlled the size of the penalty attaching to each parameter, and therefore each basis function. However, as the size of the parameters also features in this equation, it is important that the basis functions be on similar scales. Otherwise whether a parameter is included or not could depend on whether the corresponding basis function has large values (and therefore smaller <span class="math inline">\(\hat{\beta}\)</span>) or small values (and therefore larger <span class="math inline">\(\hat{\beta}\)</span>), which is clearly undesirable.</p>
<p>Once you’re aware of this issue, it should come as no surprise that scaling parameters is something that is common in machine learning work like this one. Indeed, the <strong>glmnet</strong> package which we will be using comes with an in-built scaling tool. However this scaling will scale each variable independently. This isn’t what we want since the basis functions are not independent - we have over 4000 of these, but really we only have 3 fundamental regressors so we probably want all <code>acc</code> functions to be scaled similarly (and the same is true for <code>dev</code> and <code>cal</code>).</p>
<p>Our paper has some more discussion around scaling. In a nutshell, we calculate a scaling factor for each of the 3 fundamental regressors and then apply that to all basis functions generated from that regressor. The scaling we use is <span class="math inline">\(\rho\)</span> scaling which is calculated as</p>
<p><span class="math display">\[\sum_{i=1}^n {\frac{(x_i-\bar{x})^2}{n}}\]</span></p>
<p>where</p>
<ul>
<li><span class="math inline">\(\bar{x}\)</span> is the mean of the regressor <span class="math inline">\(x\)</span> and</li>
<li><span class="math inline">\(n\)</span> is the number of elements in the regressor.</li>
</ul>
<p>Another nuance to note is that in the real world, the future data will not be available. So our fundamental regressors contain only past data and the scaling factors should therefore be calculated using past data only.</p>
<p>In other implementations of the LASSO, it is often common to centre the variables as well. We don’t do that here as we want to preserve interactions having a zero level.</p>
</section>
<section id="code" class="level4" data-number="8.5.1.3">
<h4 data-number="8.5.1.3" class="anchored" data-anchor-id="code"><span class="header-section-number">8.5.1.3</span> Code</h4>
<p>Now we’ll go through the code used to generate the set of basis functions.</p>
<p>We first write a function to do the <span class="math inline">\(\rho\)</span>-scaling. The input is a vector and the output is a scaling factor. Having this as a function makes sense because we need to call it three times (once for each of <code>acc</code>, <code>dev</code> and <code>cal</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># function to calculate scaling factors for the basis functions</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># scaling is discussed in the paper</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>GetScaling <span class="ot">&lt;-</span> <span class="cf">function</span>(vec) {</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">length</span>(vec)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  fm <span class="ot">&lt;-</span> <span class="fu">mean</span>(vec)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  fc <span class="ot">&lt;-</span> vec <span class="sc">-</span> fm</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  rho_factor <span class="ot">&lt;-</span> ((<span class="fu">sum</span>(fc<span class="sc">^</span><span class="dv">2</span>))<span class="sc">/</span>fn)<span class="sc">^</span><span class="fl">0.5</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We next write some code to calculate the main effects ramp functions. This is also a function, again because we need to run it three times.</p>
<p>Inputs to this function are the fundamental regressor and its name and scaling and the number of periods, which in turn tell the function what ramps to generate (you might think that is not needed because we can calculate it from the input vector, but it is important if we are working with vectors that contain future time periods - vectors of future <code>cal</code> will contain calendar periods not present in the past data and we don’t want to generate ramp functions for these values).</p>
<p>The output is a matrix with named columns - e.g.&nbsp;<code>L_1_999_acc</code>, <code>L_2_999_acc</code>, …, <code>L_39_999_acc</code> where each column is the scaled ramp vector.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># function to create the ramps for a particular primary vector</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>GetRamps <span class="ot">&lt;-</span> <span class="cf">function</span>(vec, vecname, np, scaling){</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># vec = fundamental regressor</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># vecname = name of regressor</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># np = number of periods</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scaling = scaling factor to use</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pre-allocate the matrix to hold the results for speed/efficiency</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(vec)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  nramps <span class="ot">&lt;-</span> (np<span class="dv">-1</span>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">data=</span><span class="cn">NA</span>, <span class="at">nrow=</span>n, <span class="at">ncol=</span>nramps)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  cnames <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode=</span><span class="st">"character"</span>, <span class="at">length=</span>nramps)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  col_indx <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(np<span class="dv">-1</span>)){</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    col_indx <span class="ot">&lt;-</span> col_indx <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    mat[, col_indx] <span class="ot">&lt;-</span> <span class="fu">LinearSpline</span>(vec, i, <span class="dv">999</span>) <span class="sc">/</span> scaling</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    cnames[col_indx] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"L_"</span>, i, <span class="st">"_999_"</span>, vecname)</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(mat) <span class="ot">&lt;-</span> cnames</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(mat)</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also need to calculate the interactions which the function does below for a given pair of input vectors, e.g.&nbsp;accident and development periods. The inputs are similar to those for the <code>GetRamps()</code> function, except that we have two sets, one for each input fundamental regressor. The output is also a column-named matrix where names are, e.g., <code>I_acc_ge_5xI_dev_ge_14</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create the step (heaviside) function interactions</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>GetInts <span class="ot">&lt;-</span> <span class="cf">function</span>(vec1, vec2, vecname1, vecname2, np, scaling1, scaling2) {</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># vec1 = fundamental regressor 1</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># vec2 = fundamental regressor 2</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># vecname1 = name of regressor 1</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># vecname2 = name of regressor 2</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># np = number of periods</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scaling1 = scaling factor to use for regressor 1</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scaling2 = scaling factor to use for regressor 2</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pre-allocate the matrix to hold the results for speed/efficiency</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(vec1)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  nints <span class="ot">&lt;-</span> (np<span class="dv">-1</span>)<span class="sc">*</span>(np<span class="dv">-1</span>)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">data=</span><span class="cn">NA_real_</span>, <span class="at">nrow=</span>n, <span class="at">ncol=</span>nints)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  cnames <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode=</span><span class="st">"character"</span>, <span class="at">length=</span>nints)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  col_indx <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>np){</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    ivec <span class="ot">&lt;-</span> <span class="fu">LinearSpline</span>(vec1, i<span class="dv">-1</span>, i) <span class="sc">/</span> scaling1</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    iname <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"I_"</span>, vecname1, <span class="st">"_ge_"</span>, i)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(ivec[<span class="fu">is.na</span>(ivec)]<span class="sc">&gt;</span><span class="dv">0</span>)) <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"NAs in ivec for"</span>, i))</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>np){</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>      col_indx <span class="ot">&lt;-</span> col_indx <span class="sc">+</span> <span class="dv">1</span>  </span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>      mat[, col_indx] <span class="ot">&lt;-</span> ivec <span class="sc">*</span> <span class="fu">LinearSpline</span>(vec2, j<span class="dv">-1</span>, j) <span class="sc">/</span> scaling2</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>      cnames[col_indx] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(iname, <span class="st">"xI_"</span>, vecname2, <span class="st">"_ge_"</span>, j)</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>      jvec <span class="ot">&lt;-</span> <span class="fu">LinearSpline</span>(vec2, j<span class="dv">-1</span>, j) <span class="sc">/</span> scaling2</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(jvec[<span class="fu">is.na</span>(jvec)]<span class="sc">&gt;</span><span class="dv">0</span>)) <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"NAs in jvec for"</span>, j))</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(mat) <span class="ot">&lt;-</span> cnames</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(mat)</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally we put all these functions together and run the code to:</p>
<ul>
<li>calculate the scaling factors</li>
<li>generate the ramp functions</li>
<li>generate the interactions</li>
<li>put everything together into a single matrix, <code>varset</code>
<ul>
<li>We create <code>varset</code> as a matrix and not a data.frame or a data.table since this is the form required by <strong>glmnet</strong>.</li>
</ul></li>
</ul>
<p>Note that we calculate the basis functions for all the data, both past and future. However we only use past data when calculating the scaling factors - <code>dat[train_ind == TRUE,]</code> is the data.table way to select the past rows in the data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the scaling values</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>rho_factor_list <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode=</span><span class="st">"list"</span>, <span class="at">length=</span><span class="dv">3</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(rho_factor_list) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"acc"</span>, <span class="st">"dev"</span>, <span class="st">"cal"</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (v <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"acc"</span>, <span class="st">"dev"</span>, <span class="st">"cal"</span>)){</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># NB: only calculating scaling using past data    </span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  rho_factor_list[[v]] <span class="ot">&lt;-</span> <span class="fu">GetScaling</span>(dat[train_ind <span class="sc">==</span> <span class="cn">TRUE</span>, <span class="fu">get</span>(v)])</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co"># main effects - matrix of values of Ramp functions</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>main_effects_acc <span class="ot">&lt;-</span> <span class="fu">GetRamps</span>(<span class="at">vec =</span> dat[, acc], <span class="at">vecname =</span> <span class="st">"acc"</span>, <span class="at">np =</span> num_periods, <span class="at">scaling =</span> rho_factor_list[[<span class="st">"acc"</span>]])</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>main_effects_dev <span class="ot">&lt;-</span> <span class="fu">GetRamps</span>(<span class="at">vec =</span> dat[, dev], <span class="at">vecname =</span> <span class="st">"dev"</span>, <span class="at">np =</span> num_periods, <span class="at">scaling =</span> rho_factor_list[[<span class="st">"dev"</span>]])</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>main_effects_cal <span class="ot">&lt;-</span> <span class="fu">GetRamps</span>(<span class="at">vec =</span> dat[, cal], <span class="at">vecname =</span> <span class="st">"cal"</span>, <span class="at">np =</span> num_periods, <span class="at">scaling =</span> rho_factor_list[[<span class="st">"cal"</span>]])</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>                             </span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>main_effects <span class="ot">&lt;-</span> <span class="fu">cbind</span>(main_effects_acc, main_effects_dev, main_effects_cal)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="co"># interaction effects</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>int_effects <span class="ot">&lt;-</span> <span class="fu">cbind</span>(</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GetInts</span>(<span class="at">vec1=</span>dat[, acc], <span class="at">vecname1=</span><span class="st">"acc"</span>, <span class="at">scaling1=</span>rho_factor_list[[<span class="st">"acc"</span>]], <span class="at">np=</span>num_periods, </span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>            <span class="at">vec2=</span>dat[, dev], <span class="at">vecname2=</span><span class="st">"dev"</span>, <span class="at">scaling2=</span>rho_factor_list[[<span class="st">"dev"</span>]]),</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GetInts</span>(<span class="at">vec1=</span>dat[, dev], <span class="at">vecname1=</span><span class="st">"dev"</span>, <span class="at">scaling1=</span>rho_factor_list[[<span class="st">"dev"</span>]], <span class="at">np=</span>num_periods, </span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>            <span class="at">vec2=</span>dat[, cal], <span class="at">vecname2=</span><span class="st">"cal"</span>, <span class="at">scaling2=</span>rho_factor_list[[<span class="st">"cal"</span>]]),</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GetInts</span>(<span class="at">vec1=</span>dat[, acc], <span class="at">vecname1=</span><span class="st">"acc"</span>, <span class="at">scaling1=</span>rho_factor_list[[<span class="st">"acc"</span>]], <span class="at">np=</span>num_periods, </span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>            <span class="at">vec2=</span>dat[, cal], <span class="at">vecname2=</span><span class="st">"cal"</span>, <span class="at">scaling2=</span>rho_factor_list[[<span class="st">"cal"</span>]])</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>varset <span class="ot">&lt;-</span> <span class="fu">cbind</span>(main_effects, int_effects)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Have a look at a subset of the data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>varset[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">39</span><span class="sc">:</span><span class="dv">44</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      L_39_999_acc L_1_999_dev L_2_999_dev L_3_999_dev L_4_999_dev L_5_999_dev
 [1,]            0   0.0000000   0.0000000   0.0000000   0.0000000   0.0000000
 [2,]            0   0.1048285   0.0000000   0.0000000   0.0000000   0.0000000
 [3,]            0   0.2096570   0.1048285   0.0000000   0.0000000   0.0000000
 [4,]            0   0.3144855   0.2096570   0.1048285   0.0000000   0.0000000
 [5,]            0   0.4193139   0.3144855   0.2096570   0.1048285   0.0000000
 [6,]            0   0.5241424   0.4193139   0.3144855   0.2096570   0.1048285
 [7,]            0   0.6289709   0.5241424   0.4193139   0.3144855   0.2096570
 [8,]            0   0.7337994   0.6289709   0.5241424   0.4193139   0.3144855
 [9,]            0   0.8386279   0.7337994   0.6289709   0.5241424   0.4193139
[10,]            0   0.9434564   0.8386279   0.7337994   0.6289709   0.5241424</code></pre>
</div>
</div>
<p>We can also look at the scaling factors used</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>rho_factor_list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$acc
[1] 9.539392

$dev
[1] 9.539392

$cal
[1] 9.539392</code></pre>
</div>
</div>
<p>The factors are all equal in this case. In hindsight this makes sense - we have the complete 40 x 40 past triangle, and all regressors are numbered from 1, so all three regressors are permutations of the same numbers.</p>
<p><br></p>
<p>Some of the interactions will be constant over the past data set - i.e.&nbsp;those that involve combinations of parameters that are only possible in the future such as <code>I_acc_ge35xI_dev_ge30</code>. We don’t have to remove these but we can do if we want.</p>
<p>This next block of code does this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># drop any constant columns over the training data set</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># do this by identifying the constant columns and dropping them</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># get the past data subset only using TRUE/FALSE from train_ind in dat</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>varset_train <span class="ot">&lt;-</span> varset[dat<span class="sc">$</span>train_ind, ]</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># identify constant columns as those with max=min</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>rm_cols <span class="ot">&lt;-</span> varset_train[, <span class="fu">apply</span>(varset_train, <span class="at">MARGIN=</span><span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">max</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">==</span> <span class="fu">min</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))]</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># drop these constant columns</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>varset <span class="ot">&lt;-</span> varset[, <span class="sc">!</span>(<span class="fu">colnames</span>(varset) <span class="sc">%in%</span> <span class="fu">colnames</span>(rm_cols))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
</section>
</section>
<section id="fitting-a-lasso" class="level3" data-number="8.5.2">
<h3 data-number="8.5.2" class="anchored" data-anchor-id="fitting-a-lasso"><span class="header-section-number">8.5.2</span> Fitting a LASSO</h3>
<p>The <strong>glmnet</strong> package has two functions for fitting a LASSO: <code>glmnet()</code> and <code>cv.glmnet()</code>.</p>
<ul>
<li><code>glmnet()</code> fits a regularised regression model for various values of the penalty parameter, <span class="math inline">\(\lambda\)</span>.</li>
<li><code>cv.glmnet()</code> adds a cross-validation (“CV”) layer on top of this so helps us to select the particular value of <span class="math inline">\(\lambda\)</span> to use - <span class="math inline">\(\lambda\)</span> values that have lower cross-validation error values are preferred.</li>
</ul>
<p>We’ll use the latter function here.</p>
<p>In addition to the data and basis functions, <code>cv.glmnet()</code> has a number of parameters. These include:</p>
<ul>
<li><p><code>family</code> - the response type to use. We’ll use the Poisson distribution here, but note that recent versions of the <strong>glmnet</strong> package have widened the options available for this parameter. At the time we did this work, the Poisson (with a log link) was the most suitable option.</p></li>
<li><p><code>nlambda</code> and <code>lambda.min.ratio</code> - control the vector of lambda values calculated by <code>cv.glmnet()</code></p></li>
<li><p><code>pmax</code> - the maximum number of variables ever to be non-zero in a model</p></li>
<li><p><code>dfmax</code> - maximum number of variables in a model</p></li>
<li><p><code>alpha</code> - set this to 1 for the LASSO</p></li>
<li><p><code>thresh</code> - convergence parameter. Default is 1E-7</p></li>
<li><p><code>maxit</code> - maximum number of interations</p></li>
<li><p><code>nfolds</code> - number of cross-validation folds</p></li>
<li><p><code>standardize</code> - whether to standardise the x variables (we set this to FALSE since we have done our own standardisation).</p></li>
</ul>
<p>There’s also a <code>parallel</code> argument which will use parallel processing to speed things up. This is worth using if you have a large data set and access to a multi-core machine.</p>
<p>Below we fit the LASSO via <code>cv.glmnet()</code> with our selections for the parameters above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>my_pmax <span class="ot">&lt;-</span> num_periods<span class="sc">^</span><span class="dv">2</span>   <span class="co"># max number of variables ever to be nonzero</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>my_dfmax <span class="ot">&lt;-</span> num_periods<span class="sc">*</span><span class="dv">10</span>  <span class="co">#max number of vars in the model</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>time1 <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>cv_fit <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(<span class="at">x =</span> varset[dat<span class="sc">$</span>train_ind,], </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y =</span> dat[train_ind<span class="sc">==</span><span class="cn">TRUE</span>, pmts], </span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family =</span> <span class="st">"poisson"</span>, </span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nlambda =</span> <span class="dv">200</span>,  <span class="co"># default is 100 but often not enough for this type of problem</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nfolds =</span> <span class="dv">8</span>,</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">thresh =</span> <span class="fl">1e-08</span>, <span class="co"># default is 1e-7 but we found we needed to reduce it from time to time</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">lambda.min.ratio =</span> <span class="dv">0</span>, <span class="co"># allow very small values in lambda</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dfmax =</span> my_dfmax, </span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">pmax =</span> my_pmax, </span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>                  <span class="at">alpha =</span> <span class="dv">1</span>, </span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>                  <span class="at">standardize =</span> <span class="cn">FALSE</span>, </span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>                  <span class="at">maxit =</span> <span class="dv">200000</span>)  <span class="co"># convergence can be slow so increase max number of iterations</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"time taken for cross validation fit: "</span>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] "time taken for cross validation fit: "</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.time</span>() <span class="sc">-</span> time1</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="do">## Time difference of 43.85213 secs</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>cv.glmnet</code> objects have a plot method associated with them which plots the CV fit:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cv_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="06_lasso_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Each point shows the average error across all folds, the bars show the standard deviation. The dashed lines represent the minimum CV error model (smaller <span class="math inline">\(\lambda\)</span>, called <code>lambda.min</code>) and one a standard deviation away (<code>lambda.1se</code>). These are selections commonly used by modellers. The numbers across the upper y-axis are the number of non-zero parameters in the model for that value of <span class="math inline">\(\lambda\)</span>.</p>
<p>Occasionally, the minimum CV value is the final point in the lambda sequence. In this case you should rerun <code>cv.glmnet()</code> with a longer lambda vector - one easy way to do this is to extract the <code>lambda</code> vector from the <code>cv.glmnet</code> object, and then extend it by adding values at the end, e.g.&nbsp;using a decay factor. Then rerun the cross-validation fit with this longer vector (specify its use via the <code>lambda</code> function argument) and, all going well, the minimum CV error lambda will now be a true minimum, rather than the last evaluated point. The original article does something like this, if you would like to see some more details around this.</p>
</section>
<section id="analysing-the-model" class="level3" data-number="8.5.3">
<h3 data-number="8.5.3" class="anchored" data-anchor-id="analysing-the-model"><span class="header-section-number">8.5.3</span> Analysing the model</h3>
<section id="model-coefficients" class="level4" data-number="8.5.3.1">
<h4 data-number="8.5.3.1" class="anchored" data-anchor-id="model-coefficients"><span class="header-section-number">8.5.3.1</span> Model coefficients</h4>
<p>We used the model corresponding to the minimum CV error in the paper (<code>lambda.min</code> in the <code>cv.glmnet</code> results object, <code>cv_fit</code>). First let’s look at the coefficients in this model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># all coefficients, including those that are 0</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>coefs_min <span class="ot">&lt;-</span> <span class="fu">predict</span>(cv_fit, <span class="at">type =</span> <span class="st">"coefficients"</span>, <span class="at">s =</span> cv_fit<span class="sc">$</span>lambda.min)  <span class="co"># NB this is a data.frame not a vector</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>coefnames <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Intercept"</span>, <span class="fu">colnames</span>(varset))  <span class="co"># don't forget the intercept  # coeff names - this is a vector</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># get indicators for non-zero ones</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>ind_nz_min<span class="ot">&lt;-</span><span class="fu">which</span>(<span class="sc">!</span>(coefs_min <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co"># make a data.table for easy viewing</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>nzcoefs_min <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">Parameter =</span> coefnames[ind_nz_min], <span class="at">Coefficient =</span> coefs_min[ind_nz_min,])</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co"># print the table</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(nzcoefs_min) <span class="sc">|&gt;</span> </span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatRound</span>(<span class="st">"Coefficient"</span>, <span class="at">digits =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-f0d3c511dd5e53904322" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-f0d3c511dd5e53904322">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80"],["Intercept","L_3_999_acc","L_6_999_acc","L_8_999_acc","L_9_999_acc","L_10_999_acc","L_11_999_acc","L_12_999_acc","L_14_999_acc","L_15_999_acc","L_16_999_acc","L_18_999_acc","L_19_999_acc","L_20_999_acc","L_23_999_acc","L_24_999_acc","L_25_999_acc","L_26_999_acc","L_30_999_acc","L_33_999_acc","L_1_999_dev","L_2_999_dev","L_3_999_dev","L_4_999_dev","L_5_999_dev","L_6_999_dev","L_7_999_dev","L_8_999_dev","L_9_999_dev","L_10_999_dev","L_11_999_dev","L_12_999_dev","L_13_999_dev","L_14_999_dev","L_15_999_dev","L_18_999_dev","L_19_999_dev","L_21_999_dev","L_22_999_dev","L_24_999_dev","L_26_999_dev","L_27_999_dev","L_29_999_dev","L_35_999_dev","L_36_999_dev","L_1_999_cal","L_8_999_cal","L_10_999_cal","L_11_999_cal","L_13_999_cal","L_15_999_cal","L_16_999_cal","L_17_999_cal","L_20_999_cal","L_21_999_cal","L_22_999_cal","L_24_999_cal","L_26_999_cal","L_28_999_cal","L_29_999_cal","L_31_999_cal","L_32_999_cal","L_33_999_cal","L_34_999_cal","L_35_999_cal","L_36_999_cal","L_37_999_cal","L_38_999_cal","L_39_999_cal","I_acc_ge_17xI_dev_ge_19","I_acc_ge_17xI_dev_ge_20","I_acc_ge_17xI_dev_ge_21","I_acc_ge_18xI_dev_ge_21","I_dev_ge_10xI_cal_ge_31","I_dev_ge_12xI_cal_ge_26","I_dev_ge_13xI_cal_ge_37","I_dev_ge_22xI_cal_ge_39","I_acc_ge_20xI_cal_ge_36","I_acc_ge_20xI_cal_ge_37","I_acc_ge_20xI_cal_ge_38"],[12.92207021011612,-0.1424911282003249,0.1424952905398195,-0.08845839302253529,-0.002356621475584735,-0.0006386426947024308,-0.01700391266341224,0.30781555078822,-0.1343044596532449,0.3683452203513344,0.90115664796166,-0.5226734925912589,-0.2039319901273777,-1.38919000072655,-0.7503076544606528,1.154051236477654,-0.8621134731581266,0.2987480109011125,-0.6825285298451307,0.4850362657843129,8.952660351711977,-0.00455293266552681,-0.02292611794225139,-3.01997379398008,-2.885701321113828,-0.6691708356947983,-0.7571646369952446,-0.9759173562167844,-0.2521811552351231,-0.3038994312853575,-0.6489552834114378,-0.3327072318290299,-0.1587379250746459,0.01913944497612654,-0.7603246774904082,0.008993547698962545,0.6619856257107427,-1.566961153543035,-0.4150953959637441,1.042836223318228,-1.051508859415068,-0.0597903427909498,0.767192794884236,1.611979481828647,2.68169512578316,1.154921869017344,-0.0002615723053953592,-0.03817526812110718,-1.348507731864274e-05,-0.549931489101905,0.3091744975442042,0.2269983639796404,0.05954187621596981,0.00863256808991511,7.69031620896992e-06,-0.0529479551776381,-0.3901919484700412,0.1052377633009192,0.1896166920530081,0.1673146051834933,0.09830281518130139,-0.7529415257048674,0.4106218242734938,0.02380363089288428,-0.1085132516476737,0.6728492540414298,-0.2998564112844091,0.3772383686470672,-0.7329640391142225,4.958428531881177,0.4301121175484421,137.6568428940558,5.667296043121972,-1.67371282251988,-0.3625366093559657,0.6548813231367339,0.9191499314619691,-1.136087219592567,-3.526625578024789,-4.051810563334722]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Parameter<\/th>\n      <th>Coefficient<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"targets":2,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 4, 3, \",\", \".\", null);\n  }"},{"className":"dt-right","targets":2},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":["options.columnDefs.0.render"],"jsHooks":[]}</script>
</div>
</div>
<p>Note the interactions at the end. Are these detecting the interaction that we know is in this simulated data set? We will find out below.</p>
</section>
<section id="tracking-plots" class="level4" data-number="8.5.3.2">
<h4 data-number="8.5.3.2" class="anchored" data-anchor-id="tracking-plots"><span class="header-section-number">8.5.3.2</span> Tracking plots</h4>
<p>We plot the model results in a number of different ways in the paper. Below we replicate some of these plots.</p>
<p>First, we add the fitted values to the data.table.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>dat[, fitted <span class="sc">:</span><span class="er">=</span> <span class="fu">as.vector</span>(<span class="fu">predict</span>(cv_fit, </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">newx =</span> varset, </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">s =</span> cv_fit<span class="sc">$</span>lambda.min, </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">type=</span><span class="st">"response"</span>))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The function below produces the tracking graphs shown in the paper - plot values for all levels of one fundamental predictor holding a second predictor at a fixed value. To help with interpreting the results, it also shades the past part of the data in grey.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>GraphModelVals<span class="ot">&lt;-</span><span class="cf">function</span>(dat, primary_predictor, secondary_predictor, secondary_predictor_val, </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                         xaxis_label, yaxis_label, var_names, <span class="at">log_values =</span> <span class="cn">TRUE</span>, </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">include_st=</span><span class="cn">FALSE</span>, <span class="at">include_legend=</span><span class="cn">FALSE</span>, <span class="at">font_size=</span><span class="dv">6</span>){</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dat = input data. Must be in wide format</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># primary_predictor = plot values for this predictor</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># secondary_predictor = hold this predictor fixed</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># secondary_predictor_val = value to hold secondary_predictor fixed at</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># xaxis_label = label for x axis</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># yaxis_label = label for y axis</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># var_names = names of actual / fitted variables in the input data to plot.     </span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#    var_names must be list with names like this: list(actual="pmts", mean="mu", fitted="fitted")</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># log_values = plot log(values) - default = TRUE</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># include_st = include a subtitle in the plot saying the grey rectangle is past data, default=FALSE    </span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># include_legend = include the legend in the plot, default=FALSE    </span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># font_size = size of font, default = 6</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (these last 3 variables + default values might seem odd - this function is used in a later article</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">#    and the defaults are sensible in that context)    </span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># extract data we want to use</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>  use_dat <span class="ot">&lt;-</span> dat[<span class="fu">get</span>(secondary_predictor) <span class="sc">==</span> secondary_predictor_val, ]</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># turn into long format (tidy format in this case) using melt.data.table since that works better with ggplot</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>  dat_long <span class="ot">&lt;-</span> <span class="fu">melt</span>(dat[<span class="fu">get</span>(secondary_predictor) <span class="sc">==</span> secondary_predictor_val, ],</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>                   <span class="at">measure.vars =</span> <span class="fu">unlist</span>(var_names),</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>                   <span class="at">id.vars =</span> primary_predictor)</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make the names nicer - colnames and labels</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setnames</span>(dat_long, primary_predictor, <span class="st">"predictor"</span>)</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>  dat_long[variable <span class="sc">==</span> var_names<span class="sc">$</span>actual, variable <span class="sc">:</span><span class="er">=</span> <span class="st">"Simulated"</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>           ][variable <span class="sc">==</span> var_names<span class="sc">$</span>mean, variable <span class="sc">:</span><span class="er">=</span> <span class="st">"Underlying"</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>             ][variable <span class="sc">==</span> var_names<span class="sc">$</span>fitted, variable <span class="sc">:</span><span class="er">=</span> <span class="st">"Fitted"</span>]</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get the levels of the variables right so that they are plotted in the right order</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>  dat_long[, variable <span class="sc">:</span><span class="er">=</span> <span class="fu">factor</span>(variable, <span class="at">levels=</span><span class="fu">c</span>(<span class="st">"Fitted"</span>, <span class="st">"Simulated"</span>, <span class="st">"Underlying"</span>))]</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (log_values) dat_long[, value <span class="sc">:</span><span class="er">=</span> <span class="fu">log</span>(value)]</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># figure out past data rectangle coordinates</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>  xmin1 <span class="ot">&lt;-</span> use_dat[train_ind <span class="sc">==</span> <span class="cn">TRUE</span>, <span class="fu">min</span>(<span class="fu">get</span>(primary_predictor))]</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>  xmax1 <span class="ot">&lt;-</span> use_dat[train_ind <span class="sc">==</span> <span class="cn">TRUE</span>, <span class="fu">max</span>(<span class="fu">get</span>(primary_predictor))]</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>  ymin1 <span class="ot">&lt;-</span> dat_long[, <span class="fu">min</span>(value)]<span class="sc">*</span><span class="fl">0.95</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>  ymax1 <span class="ot">&lt;-</span> dat_long[, <span class="fu">max</span>(value)]<span class="sc">*</span><span class="fl">1.05</span></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># draw the tracking plots</span></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>dat_long, <span class="fu">aes</span>(<span class="at">x=</span>predictor, <span class="at">y=</span>value, <span class="at">group=</span>variable))<span class="sc">+</span></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">linetype=</span>variable, <span class="at">colour=</span>variable, <span class="at">size=</span>variable, <span class="at">alpha=</span>variable))<span class="sc">+</span></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">linetype=</span>variable, <span class="at">colour=</span>variable))<span class="sc">+</span></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">name=</span><span class="st">""</span>, <span class="at">values=</span><span class="fu">c</span>(red, dgrey, dgrey))<span class="sc">+</span></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_linetype_manual</span>(<span class="at">name=</span><span class="st">""</span>, <span class="at">values=</span><span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"solid"</span>, <span class="st">"dotted"</span>))<span class="sc">+</span></span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_size_manual</span>(<span class="at">name=</span><span class="st">""</span>, <span class="at">values=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>))<span class="sc">+</span></span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_alpha_manual</span>(<span class="at">name=</span><span class="st">""</span>, <span class="at">values=</span><span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>))<span class="sc">+</span></span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>()<span class="sc">+</span></span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="at">geom=</span><span class="st">"rect"</span>, <span class="at">xmin=</span>xmin1, <span class="at">xmax=</span>xmax1, <span class="at">ymin=</span>ymin1, <span class="at">ymax=</span>ymax1, <span class="at">alpha=</span><span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x=</span>xaxis_label, <span class="at">y=</span>yaxis_label, <span class="at">title=</span><span class="fu">paste</span>(xaxis_label, <span class="st">"tracking for"</span>, secondary_predictor, <span class="st">"="</span>, secondary_predictor_val)) <span class="sc">+</span></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> font_size), <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> font_size<span class="dv">-1</span>))</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(include_st<span class="sc">==</span><span class="cn">TRUE</span>) g <span class="ot">&lt;-</span> g <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">subtitle=</span><span class="st">"Past data in grey rectangle"</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">plot.subtitle =</span> <span class="fu">element_text</span> (<span class="at">size =</span> font_size))</span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="cf">if</span>(include_legend<span class="sc">==</span><span class="cn">TRUE</span>) g <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>) <span class="cf">else</span> g <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return the results  </span></span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="fu">list</span>(<span class="at">data=</span>dat_long, <span class="at">graph=</span>g))</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s look at development quarter when accident quarter is 20. Remember the step-interaction starts at dev=21 - which we see in the graph.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>dev_graph_list <span class="ot">&lt;-</span> <span class="fu">GraphModelVals</span>(dat, </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">primary_predictor =</span> <span class="st">"dev"</span>, </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">secondary_predictor =</span> <span class="st">"acc"</span>, </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">secondary_predictor_val =</span> <span class="dv">20</span>, </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">xaxis_label =</span> <span class="st">"Development quarter"</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">yaxis_label =</span> <span class="st">"Log(Payments)"</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">var_names =</span> <span class="fu">list</span>(<span class="at">actual=</span><span class="st">"pmts"</span>, <span class="at">mean=</span><span class="st">"mu"</span>, <span class="at">fitted=</span><span class="st">"fitted"</span>),</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">include_st =</span> <span class="cn">TRUE</span>,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">include_legend =</span> <span class="cn">TRUE</span>,</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">font_size =</span> <span class="dv">10</span>)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>dev_graph_list<span class="sc">$</span>graph</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="06_lasso_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Similarly we can look at accident quarter tracking when development quarter is 24 and again see the interaction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>acc_graph_list <span class="ot">&lt;-</span> <span class="fu">GraphModelVals</span>(dat, </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">primary_predictor =</span> <span class="st">"acc"</span>, </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">secondary_predictor =</span> <span class="st">"dev"</span>, </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">secondary_predictor_val =</span> <span class="dv">24</span>, </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">xaxis_label =</span> <span class="st">"Accident quarter"</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">yaxis_label =</span> <span class="st">"Log(Payments)"</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">var_names =</span> <span class="fu">list</span>(<span class="at">actual=</span><span class="st">"pmts"</span>, <span class="at">mean=</span><span class="st">"mu"</span>, <span class="at">fitted=</span><span class="st">"fitted"</span>),</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">include_st =</span> <span class="cn">TRUE</span>,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">include_legend =</span> <span class="cn">TRUE</span>,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">font_size =</span> <span class="dv">10</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>acc_graph_list<span class="sc">$</span>graph</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="06_lasso_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>You can explore other combinations of <code>primary_predictor</code>, <code>secondary_predictor</code> and <code>secondary_predictor_val</code> to see how the models track the past and future experience in other parts of the triangle</p>
</section>
<section id="heat-map" class="level4" data-number="8.5.3.3">
<h4 data-number="8.5.3.3" class="anchored" data-anchor-id="heat-map"><span class="header-section-number">8.5.3.3</span> Heat map</h4>
<p>Plotting colour-coded actual/fitted values can be a useful way of looking at the model fit. The function below plots these values (subject to lower and upper bounds of 25% and 400%) and shades them with blue values being less than 100% and red values being greater than 100%. The darker the shading, the further from 100%.</p>
<p>The function below will draw the heatmap.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># heat maps</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>GraphHeatMap <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, <span class="at">x=</span><span class="st">"dev"</span>, <span class="at">y=</span><span class="st">"acc"</span>, actual, fitted, <span class="at">lims=</span><span class="fu">c</span>(<span class="fl">0.25</span>, <span class="dv">4</span>),</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">xlab=</span><span class="st">"Development quarter"</span>, <span class="at">ylab=</span><span class="st">"Accident Quarter"</span>){</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># copy data to avoid modifying original</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  localdat <span class="ot">&lt;-</span> <span class="fu">copy</span>(dat)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get fails if there is a variable with the same name so make local copies</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  local_x <span class="ot">&lt;-</span> x</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  local_y <span class="ot">&lt;-</span> y</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  local_actual <span class="ot">&lt;-</span> actual</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  local_fitted <span class="ot">&lt;-</span> fitted</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make restricted Avs F for heatmap and set up past/future split line</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>  np <span class="ot">&lt;-</span> <span class="fu">max</span>(localdat[[y]])</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>  localdat[, .avsf <span class="sc">:</span><span class="er">=</span> <span class="fu">get</span>(local_actual) <span class="sc">/</span> <span class="fu">get</span>(local_fitted)</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>           ][, .avsf_restrict_log <span class="sc">:</span><span class="er">=</span> <span class="fu">log</span>(<span class="fu">pmax</span>(<span class="fu">min</span>(lims), <span class="fu">pmin</span>(<span class="fu">max</span>(lims), .avsf)))</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>             ][, .past_line <span class="sc">:</span><span class="er">=</span> np <span class="sc">+</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">get</span>(local_y)]</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>localdat, <span class="fu">aes_string</span>(<span class="at">x=</span>local_x, <span class="at">y=</span>local_y)) <span class="sc">+</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> .avsf_restrict_log))<span class="sc">+</span><span class="fu">scale_y_reverse</span>()<span class="sc">+</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>()<span class="sc">+</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradient2</span>(<span class="at">name=</span><span class="st">"AvF_min"</span>, <span class="at">low=</span>mblue, <span class="at">mid=</span><span class="st">"white"</span>, <span class="at">high=</span>red, <span class="at">midpoint=</span><span class="dv">0</span>, </span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>                         <span class="at">space=</span><span class="st">"Lab"</span>, <span class="at">na.value=</span>lgrey, <span class="at">guide=</span><span class="st">"colourbar"</span>)<span class="sc">+</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x=</span>xlab, <span class="at">y=</span>ylab)<span class="sc">+</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes_string</span>(<span class="at">x=</span><span class="st">".past_line"</span>, <span class="at">y=</span>local_y), <span class="at">colour=</span>dgrey, <span class="at">size=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">8</span>,<span class="at">colour=</span>dgrey), </span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>          <span class="at">strip.background =</span> <span class="fu">element_rect</span>(<span class="at">colour=</span><span class="st">"white"</span>, <span class="at">fill=</span><span class="st">"white"</span>))<span class="sc">+</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">10</span>), <span class="at">axis.text.x  =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">10</span>))<span class="sc">+</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">10</span>), <span class="at">axis.text.y  =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">10</span>))<span class="sc">+</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="fu">element_line</span>(<span class="at">size=</span><span class="fl">0.25</span>, <span class="at">colour=</span>dgrey))<span class="sc">+</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"none"</span>, )<span class="sc">+</span>  </span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NULL</span>    </span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="fu">list</span>(<span class="at">data=</span>localdat, <span class="at">graph=</span>g))</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">GraphHeatMap</span>(dat, <span class="at">x=</span><span class="st">"dev"</span>, <span class="at">y=</span><span class="st">"acc"</span>, <span class="at">actual=</span><span class="st">"pmts"</span>, <span class="at">fitted=</span><span class="st">"fitted"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: `aes_string()` was deprecated in ggplot2 3.0.0.
ℹ Please use tidy evaluation idioms with `aes()`.
ℹ See also `vignette("ggplot2-in-packages")` for more information.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The `size` argument of `element_line()` is deprecated as of ggplot2 3.4.0.
ℹ Please use the `linewidth` argument instead.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>g<span class="sc">$</span>graph</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="06_lasso_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>You should, of course, carry out a full model validation exercise on any model prior to use. These plots may be helpful tools in this.</p>
</section>
</section>
<section id="claims-reserves" class="level3" data-number="8.5.4">
<h3 data-number="8.5.4" class="anchored" data-anchor-id="claims-reserves"><span class="header-section-number">8.5.4</span> Claims reserves</h3>
<p>Finally, let’s have a look at the claim reserve estimates and compare them to those from an 8-period chain ladder.</p>
<p>The code below uses data.table functionality to sum up the reserves by accident period and overall.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>os_acc <span class="ot">&lt;-</span> dat[train_ind <span class="sc">==</span> <span class="cn">FALSE</span>, </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>              .(<span class="at">LASSO =</span> <span class="fu">sum</span>(fitted), <span class="at">simulated =</span> <span class="fu">sum</span>(pmts), <span class="at">underlying =</span> <span class="fu">sum</span>(mu)), </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>              keyby<span class="ot">=</span>.(acc)]</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>os <span class="ot">&lt;-</span> os_acc[, .(<span class="at">LASSO =</span> <span class="fu">sum</span>(LASSO), </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">simulated =</span> <span class="fu">sum</span>(simulated), </span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">underlying =</span> <span class="fu">sum</span>(underlying))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="chainladder-reserves" class="level4" data-number="8.5.4.1">
<h4 data-number="8.5.4.1" class="anchored" data-anchor-id="chainladder-reserves"><span class="header-section-number">8.5.4.1</span> Chainladder reserves</h4>
<p>In the paper we compared some of our results to the 8-period Chainladder reserve. This is calculated below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get cumulative payments to make it easier to calculate CL factors</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>dat[, cumpmts <span class="sc">:</span><span class="er">=</span> <span class="fu">cumsum</span>(pmts), by<span class="ot">=</span>.(acc)][train_ind<span class="sc">==</span><span class="cn">FALSE</span>, cumpmts <span class="sc">:</span><span class="er">=</span> <span class="cn">NA</span>]</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 8-period average</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>cl_fac <span class="ot">&lt;-</span> <span class="fu">numeric</span>(num_periods<span class="dv">-1</span>) <span class="co"># hold CL factors</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>num_periods<span class="dv">-1</span>){</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  cl_fac[j] <span class="ot">&lt;-</span> </span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>      dat[train_ind<span class="sc">==</span><span class="cn">TRUE</span> <span class="sc">&amp;</span> dev <span class="sc">==</span> (j<span class="sc">+</span><span class="dv">1</span>) <span class="sc">&amp;</span> acc <span class="sc">&gt;</span> (num_periods<span class="dv">-8</span><span class="sc">-</span>j) <span class="sc">&amp;</span> acc <span class="sc">&lt;=</span> (num_periods<span class="sc">-</span>j), <span class="fu">sum</span>(cumpmts)] <span class="sc">/</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>      dat[train_ind<span class="sc">==</span><span class="cn">TRUE</span> <span class="sc">&amp;</span> dev <span class="sc">==</span> (j) <span class="sc">&amp;</span> acc <span class="sc">&gt;</span> (num_periods<span class="dv">-8</span><span class="sc">-</span>j) <span class="sc">&amp;</span> acc <span class="sc">&lt;=</span> (num_periods<span class="sc">-</span>j), <span class="fu">sum</span>(cumpmts)]</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="co"># accumulate the CL factors</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>cl_cum <span class="ot">&lt;-</span> <span class="fu">cumprod</span>(<span class="fu">rev</span>(cl_fac))</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="co"># leading diagonal for projection</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>leading_diagonal <span class="ot">&lt;-</span> dat[train_ind<span class="sc">==</span><span class="cn">TRUE</span> <span class="sc">&amp;</span> cal <span class="sc">==</span> num_periods <span class="sc">&amp;</span> acc <span class="sc">&gt;</span> <span class="dv">1</span>, cumpmts]</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="co"># CL amounts now</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>cl_os <span class="ot">&lt;-</span> cl_cum <span class="sc">*</span> leading_diagonal <span class="sc">-</span> leading_diagonal</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will attach these results to the data.tables holding the results from the LASSO.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>os_acc[, Chainladder <span class="sc">:</span><span class="er">=</span> cl_os]</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>os[, Chainladder <span class="sc">:</span><span class="er">=</span> <span class="fu">sum</span>(cl_os)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="results-by-accident-period" class="level4" data-number="8.5.4.2">
<h4 data-number="8.5.4.2" class="anchored" data-anchor-id="results-by-accident-period"><span class="header-section-number">8.5.4.2</span> Results by accident period</h4>
<p>Here’s a plot of the results (similar to that in the paper). Note that the y-axis is restricted for readability so that the actual chain ladder value (488 Bn) for accident period 40 does not display on the graph.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make a long [tidy format] version of the data for use with ggplot2</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>os_acc_long <span class="ot">&lt;-</span> <span class="fu">melt</span>(os_acc, <span class="at">id.vars =</span> <span class="st">"acc"</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co"># divide by Bn to make numbers more readable</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>os_acc_long[, value <span class="sc">:</span><span class="er">=</span> value<span class="sc">/</span><span class="fl">1e9</span>]</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>os_plot <span class="ot">&lt;-</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="at">data=</span>os_acc_long, <span class="fu">aes</span>(<span class="at">x=</span>acc, <span class="at">y=</span>value, <span class="at">colour=</span>variable, </span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">linetype=</span>variable, <span class="at">size=</span>variable, <span class="at">alpha=</span>variable))<span class="sc">+</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>()<span class="sc">+</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_linetype_manual</span>(<span class="at">name=</span><span class="st">""</span>, <span class="at">values=</span><span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"dashed"</span>, <span class="st">"dotted"</span>, <span class="st">"solid"</span> ))<span class="sc">+</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">name=</span><span class="st">""</span>, <span class="at">values=</span><span class="fu">c</span>(red, dgrey, dgrey, mblue ))<span class="sc">+</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_size_manual</span>(<span class="at">name=</span><span class="st">""</span>, <span class="at">values=</span><span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">1.5</span>))<span class="sc">+</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_alpha_manual</span>(<span class="at">name=</span><span class="st">""</span>, <span class="at">values=</span><span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.8</span>))<span class="sc">+</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">40</span>))<span class="sc">+</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>()<span class="sc">+</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>, <span class="at">legend.title=</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x=</span><span class="st">"Accident quarter"</span>, <span class="at">y=</span><span class="st">"Amount (B)"</span>)<span class="sc">+</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="at">geom=</span><span class="st">"text"</span>, <span class="at">x=</span><span class="dv">37</span>, <span class="at">y=</span><span class="dv">40</span>, <span class="at">label=</span><span class="st">"488B-&gt;"</span>)<span class="sc">+</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Outstanding amounts"</span>)</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>os_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="06_lasso_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>You can see from the graph that - despite the presence of an interaction affecting only a small number of cells, the LASSO model detects and responds appropriately to this change. By contrast, the chainladder model does not perform so well.</p>
<p>The table below displays these results also.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>cols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(os_acc), <span class="st">"acc"</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>os_acc[, <span class="fu">lapply</span>(.SD, <span class="cf">function</span>(x) x<span class="sc">/</span><span class="fl">1e9</span>)][, acc <span class="sc">:</span><span class="er">=</span> acc<span class="sc">*</span><span class="fl">1e9</span>]  <span class="sc">|&gt;</span> </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>() <span class="sc">|&gt;</span> </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatRound</span>(cols, <span class="at">digits =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-adfe067a5cb67485c093" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-adfe067a5cb67485c093">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39"],[2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40],[0.02435510129569471,0.04674311219320284,0.06673496604618226,0.0852534419760522,0.1027632019439551,0.12430682825661,0.1513072669074706,0.1835622855544405,0.2238931400259165,0.27450313763542,0.3375856502193386,0.4306844662453023,0.5574879842484641,0.72146020958013,0.9820104043891769,7.027230236328864,11.05136854006308,15.64291198147147,19.90459212848601,24.10212615900917,25.20829078876093,26.35538978246878,25.47822212837583,27.86031936598383,27.89692296641735,28.89018154291195,29.89174460643835,30.90416373431116,31.89876907902482,30.57991365413631,29.18573631013911,27.74000358747735,27.61560553228226,27.33989289947487,26.92870995159386,26.41425449120938,25.80436416280272,25.1456802544817,24.48197168129049],[0.0003292568849970228,0.007181833974832959,0.005621639228368158,0.01274878716788026,0.03193670436148408,0.01695178040370595,0.06586382553943158,0.08422902827546315,0.1689948784881587,0.1608529976400966,0.2078605369529153,0.3082220763764781,0.4582165687198161,0.5175735595112528,0.7634969409064291,5.25056754546713,8.126306841151743,12.61998636160585,19.18463684897805,22.75674622526723,24.22169519978302,25.49833997832778,25.68804552495003,26.97410754693588,28.46162013289911,29.18452159805585,29.56679376688211,32.0308919036075,33.17300771045227,32.30528301876701,31.28200381069352,31.09832448910249,29.76898010665487,29.49456982724853,28.35669902142179,26.82818489788204,25.8508210540809,24.63008821705634,23.32401799560885],[0.001977287339563354,0.004918100538224168,0.009201749073198108,0.0153447807331424,0.02404727001500747,0.03625338771234701,0.05323007590357865,0.07666841296014462,0.1088130375869977,0.1526257333473438,0.2119898320183776,0.2919622869916913,0.3990798237141955,0.5417241150595907,0.8073803555833892,5.307539344319815,8.173433752693684,12.48927804415153,18.92997395063292,23.29214273168677,24.06088422932229,24.91992565823882,25.86840422413345,26.90169721979115,28.0106070795297,29.18065397873841,30.39160746728405,31.61742358864707,32.82678014162951,32.32696832992843,31.7176070156397,30.98411977905159,30.12118198740697,29.13459572909266,28.04207604656737,26.8722919293915,25.66158356843095,24.44816685462823,23.26454674058891],[0.00493443755605793,0.06020578111618734,0.06561866533206749,0.1008086833476472,0.09406624710005904,0.1202939629373956,0.159800784517096,0.18942158778268,0.233621180757854,0.3015376596126366,0.3421557373351956,0.4637381766254835,0.6066228707067441,0.7441083042136584,1.045232070996431,2.493727712290289,3.865538422062527,5.986418515964096,8.983925047616607,11.67846576010054,12.79922049057111,14.16174351556228,13.74035024626886,16.1712560302548,16.37957645396229,17.82305991941328,18.88981295968369,20.08936663021195,21.99055563756826,21.15703330678621,21.38828678046466,19.42338581811373,19.58845138326767,22.05057157863696,21.27672596779571,17.46893901553713,21.60131522208892,13.97484777037694,488.3211906870499]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>acc<\/th>\n      <th>LASSO<\/th>\n      <th>simulated<\/th>\n      <th>underlying<\/th>\n      <th>Chainladder<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"targets":2,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 1, 3, \",\", \".\", null);\n  }"},{"targets":3,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 1, 3, \",\", \".\", null);\n  }"},{"targets":4,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 1, 3, \",\", \".\", null);\n  }"},{"targets":5,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 1, 3, \",\", \".\", null);\n  }"},{"className":"dt-right","targets":[1,2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":["options.columnDefs.0.render","options.columnDefs.1.render","options.columnDefs.2.render","options.columnDefs.3.render"],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="total-reserves" class="level4" data-number="8.5.4.3">
<h4 data-number="8.5.4.3" class="anchored" data-anchor-id="total-reserves"><span class="header-section-number">8.5.4.3</span> Total reserves</h4>
<p>The overall reserve values (in units of B) are</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>os[, <span class="fu">lapply</span>(.SD, <span class="cf">function</span>(x) x<span class="sc">/</span><span class="fl">1e9</span>)] <span class="sc">|&gt;</span> </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>() <span class="sc">|&gt;</span> </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatRound</span>(cols, <span class="at">digits =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-b7a08e115e1238a48012" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-b7a08e115e1238a48012">{"x":{"filter":"none","vertical":false,"data":[["1"],[607.6610167614571],[608.4863200373112],[607.2787056401023],[855.8359310215856]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>LASSO<\/th>\n      <th>simulated<\/th>\n      <th>underlying<\/th>\n      <th>Chainladder<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"targets":1,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 1, 3, \",\", \".\", null);\n  }"},{"targets":2,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 1, 3, \",\", \".\", null);\n  }"},{"targets":3,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 1, 3, \",\", \".\", null);\n  }"},{"targets":4,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 1, 3, \",\", \".\", null);\n  }"},{"className":"dt-right","targets":[1,2,3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":["options.columnDefs.0.render","options.columnDefs.1.render","options.columnDefs.2.render","options.columnDefs.3.render"],"jsHooks":[]}</script>
</div>
</div>
</section>
</section>
</section>
<section id="commentary" class="level2" data-number="8.6">
<h2 data-number="8.6" class="anchored" data-anchor-id="commentary"><span class="header-section-number">8.6</span> Commentary</h2>
<p>In practice, no actuary would fit the 8-period chainladder (or any other estimating period) without significant review and likely modification based on actuarial judgement. So in an example like this, the gains from a method like the LASSO will not be as large as suggested by the results above. Furthermore, the large step change in this data set would likely result from something like a legislative change that the actuary should know about and be able to estimate its effect and then incorporate this into any projection.</p>
<p>Nonetheless, there is benefit from the raw or naive model projection being closer to what we might want to project and in that sense, the LASSO model clearly outperforms the chainladder.</p>
</section>
<section id="conclusion" class="level2" data-number="8.7">
<h2 data-number="8.7" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">8.7</span> Conclusion</h2>
<p>The aim of this article has been to demonstrate the fitting of a claims reserving model using a LASSO approach in R and to produce some of the model diagnostic and results output that a user might wish to examine. If you would like to experiment some more, you could try modifying the synthetic data set code to produce other types of simulated data (such as those in our paper), or try it out on a real data example.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../Foundations/05_a_glms_r.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Reserving with GLMs in R</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../Foundations/07_mlr3example.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">ML modelling on triangles - a worked example</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>