<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Machine Learning in Non-Life Reserving - 9&nbsp; ML modelling on triangles - a worked example</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../Foundations/08_intro_glm_gam_xgboost.html" rel="next">
<link href="../Foundations/06_lasso.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script src="../site_libs/htmlwidgets-1.6.2/htmlwidgets.js"></script>
<link href="../site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="../site_libs/datatables-binding-0.30/datatables.js"></script>
<script src="../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="../site_libs/dt-core-1.13.4/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="../site_libs/dt-core-1.13.4/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="../site_libs/dt-core-1.13.4/js/jquery.dataTables.min.js"></script>
<link href="../site_libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="../site_libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>


</head>

<body class="nav-sidebar floating">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../Foundations/foundations.html">Foundations</a></li><li class="breadcrumb-item"><a href="../Foundations/07_mlr3example.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">ML modelling on triangles - a worked example</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Machine Learning in Non-Life Reserving</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../Foundations/foundations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/01_getting_started.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Getting started</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/02_intro_to_r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Introduction to R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/03_top_ten_r_packages.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">My Top 10 R Packages for Data Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/04_a_tidyverse.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">The tidyverse for actuaries</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/04_b_datatable.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">R’s data.table - a useful package for actuaries</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/05_a_glms_r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Reserving with GLMs in R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/06_lasso.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Self-assembling claim reserving models using the LASSO</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/07_mlr3example.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">ML modelling on triangles - a worked example</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Foundations/08_intro_glm_gam_xgboost.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Getting to grips with GLM, GAM and XGBoost</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../Data/data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Data/simulationmachine.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">simulationmachine engine for simulating data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Data/splice.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">SPLICE</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../Literature/literature.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Literature review</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Literature/baudry.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Non-parametric individual claim reserving in insurance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Literature/history_nn_papers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">A brief history of papers looking at using neural networks in reserving</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Literature/al_mudafer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Probabilistic Forecasting with Neural Networks Applied to Loss Reserving</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../Research/research.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Research</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Research/giro-2021-questions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Machine learning: Reserving on triangles - Q &amp; A after GIRO 2021</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Research/giro-2021-diagnostics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Modelling Five Scenarios using the SynthETIC Dataset - Diagnostic from GIRO 2021</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Research/chainladder_to_individual_mdn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">From Chain Ladder to Individual Mixture Density Networks on SPLICE Data</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../Practical/practical.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Practical Considerations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Practical/time_resource.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Practical Considerations Part 1: Time &amp; Resource Limitations</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../Survey/survey.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Surveys</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Survey/surveys2020.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">2020 Surveys of the use of ML in reserving</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Summary</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">9.1</span> Introduction</a>
  <ul class="collapse">
  <li><a href="#who-is-this-article-aimed-at" id="toc-who-is-this-article-aimed-at" class="nav-link" data-scroll-target="#who-is-this-article-aimed-at"><span class="header-section-number">9.1.1</span> Who is this article aimed at?</a></li>
  </ul></li>
  <li><a href="#pre-requisites-to-this-article" id="toc-pre-requisites-to-this-article" class="nav-link" data-scroll-target="#pre-requisites-to-this-article"><span class="header-section-number">9.2</span> Pre-requisites to this article</a>
  <ul class="collapse">
  <li><a href="#the-data-set" id="toc-the-data-set" class="nav-link" data-scroll-target="#the-data-set"><span class="header-section-number">9.2.1</span> The data set</a></li>
  <li><a href="#machine-learning-and-aggregate-triangles" id="toc-machine-learning-and-aggregate-triangles" class="nav-link" data-scroll-target="#machine-learning-and-aggregate-triangles"><span class="header-section-number">9.2.2</span> Machine learning and aggregate triangles</a></li>
  <li><a href="#dont-rank-the-ml-models-used-based-on-this-example" id="toc-dont-rank-the-ml-models-used-based-on-this-example" class="nav-link" data-scroll-target="#dont-rank-the-ml-models-used-based-on-this-example"><span class="header-section-number">9.2.3</span> Don’t rank the ML models used based on this example</a></li>
  <li><a href="#mlr3-package" id="toc-mlr3-package" class="nav-link" data-scroll-target="#mlr3-package"><span class="header-section-number">9.2.4</span> mlr3 package</a></li>
  <li><a href="#ml-methods-used" id="toc-ml-methods-used" class="nav-link" data-scroll-target="#ml-methods-used"><span class="header-section-number">9.2.5</span> ML methods used</a></li>
  </ul></li>
  <li><a href="#outline-of-the-workflow" id="toc-outline-of-the-workflow" class="nav-link" data-scroll-target="#outline-of-the-workflow"><span class="header-section-number">9.3</span> Outline of the workflow</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup"><span class="header-section-number">9.4</span> Setup</a></li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation"><span class="header-section-number">9.5</span> Data preparation</a>
  <ul class="collapse">
  <li><a href="#data.table-package" id="toc-data.table-package" class="nav-link" data-scroll-target="#data.table-package"><span class="header-section-number">9.5.1</span> data.table package</a></li>
  <li><a href="#load-the-data" id="toc-load-the-data" class="nav-link" data-scroll-target="#load-the-data"><span class="header-section-number">9.5.2</span> Load the data</a></li>
  <li><a href="#create-a-mlr3-task" id="toc-create-a-mlr3-task" class="nav-link" data-scroll-target="#create-a-mlr3-task"><span class="header-section-number">9.5.3</span> Create a mlr3 task</a></li>
  </ul></li>
  <li><a href="#tuning-process-for-hyper-parameters" id="toc-tuning-process-for-hyper-parameters" class="nav-link" data-scroll-target="#tuning-process-for-hyper-parameters"><span class="header-section-number">9.6</span> Tuning process for hyper-parameters</a>
  <ul class="collapse">
  <li><a href="#cross-validation" id="toc-cross-validation" class="nav-link" data-scroll-target="#cross-validation"><span class="header-section-number">9.6.1</span> Cross-validation</a></li>
  <li><a href="#setting-up-cross-validation-in-mlr3" id="toc-setting-up-cross-validation-in-mlr3" class="nav-link" data-scroll-target="#setting-up-cross-validation-in-mlr3"><span class="header-section-number">9.6.2</span> Setting up cross-validation in mlr3</a></li>
  <li><a href="#performance-measure" id="toc-performance-measure" class="nav-link" data-scroll-target="#performance-measure"><span class="header-section-number">9.6.3</span> Performance measure</a></li>
  <li><a href="#searching-hyper-parameter-space" id="toc-searching-hyper-parameter-space" class="nav-link" data-scroll-target="#searching-hyper-parameter-space"><span class="header-section-number">9.6.4</span> Searching hyper-parameter space</a></li>
  </ul></li>
  <li><a href="#fitting-some-ml-models" id="toc-fitting-some-ml-models" class="nav-link" data-scroll-target="#fitting-some-ml-models"><span class="header-section-number">9.7</span> Fitting some ML models</a>
  <ul class="collapse">
  <li><a href="#decision-tree" id="toc-decision-tree" class="nav-link" data-scroll-target="#decision-tree"><span class="header-section-number">9.7.1</span> Decision tree</a></li>
  <li><a href="#fitting-a-single-model" id="toc-fitting-a-single-model" class="nav-link" data-scroll-target="#fitting-a-single-model"><span class="header-section-number">9.7.2</span> Fitting a single model</a></li>
  <li><a href="#random-forest-fitting" id="toc-random-forest-fitting" class="nav-link" data-scroll-target="#random-forest-fitting"><span class="header-section-number">9.7.3</span> Random forest fitting</a></li>
  <li><a href="#xgboost" id="toc-xgboost" class="nav-link" data-scroll-target="#xgboost"><span class="header-section-number">9.7.4</span> XGBoost</a></li>
  <li><a href="#consolidate-results" id="toc-consolidate-results" class="nav-link" data-scroll-target="#consolidate-results"><span class="header-section-number">9.7.5</span> Consolidate results</a></li>
  <li><a href="#chainladder---the-baseline-model" id="toc-chainladder---the-baseline-model" class="nav-link" data-scroll-target="#chainladder---the-baseline-model"><span class="header-section-number">9.7.6</span> Chainladder - the baseline model</a></li>
  <li><a href="#lasso-regularised-regression" id="toc-lasso-regularised-regression" class="nav-link" data-scroll-target="#lasso-regularised-regression"><span class="header-section-number">9.7.7</span> LASSO (regularised regression)</a></li>
  <li><a href="#basis-functions" id="toc-basis-functions" class="nav-link" data-scroll-target="#basis-functions"><span class="header-section-number">9.7.8</span> Basis functions</a></li>
  <li><a href="#mlr3-setup-for-lasso" id="toc-mlr3-setup-for-lasso" class="nav-link" data-scroll-target="#mlr3-setup-for-lasso"><span class="header-section-number">9.7.9</span> mlr3 setup for LASSO</a></li>
  <li><a href="#model-fitting" id="toc-model-fitting" class="nav-link" data-scroll-target="#model-fitting"><span class="header-section-number">9.7.10</span> Model fitting</a></li>
  </ul></li>
  <li><a href="#model-analysis" id="toc-model-analysis" class="nav-link" data-scroll-target="#model-analysis"><span class="header-section-number">9.8</span> Model analysis</a>
  <ul class="collapse">
  <li><a href="#rmse" id="toc-rmse" class="nav-link" data-scroll-target="#rmse"><span class="header-section-number">9.8.1</span> RMSE</a></li>
  <li><a href="#visualising-the-fit" id="toc-visualising-the-fit" class="nav-link" data-scroll-target="#visualising-the-fit"><span class="header-section-number">9.8.2</span> Visualising the fit</a></li>
  </ul></li>
  <li><a href="#reserves" id="toc-reserves" class="nav-link" data-scroll-target="#reserves"><span class="header-section-number">9.9</span> Reserves</a></li>
  <li><a href="#commentary" id="toc-commentary" class="nav-link" data-scroll-target="#commentary"><span class="header-section-number">9.10</span> Commentary</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">9.11</span> Conclusion</a>
  <ul class="collapse">
  <li><a href="#what-next" id="toc-what-next" class="nav-link" data-scroll-target="#what-next"><span class="header-section-number">9.11.1</span> What next?</a></li>
  </ul></li>
  <li><a href="#session-details" id="toc-session-details" class="nav-link" data-scroll-target="#session-details"><span class="header-section-number">9.12</span> Session details</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">ML modelling on triangles - a worked example</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p><em>This <a href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/post/foundations/mlr3example/">article</a> was written by Grainne McGuire and Jacky Poon and originally published on 5 May 2021.</em></p>
<p><em>A python version (including a simple neural network) is available <a href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/post/foundations/scikitexample/">here</a>.</em></p>
<section id="introduction" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">9.1</span> Introduction</h2>
<p>In this chapter we look at applying different machine learning (ML) models to a data set. Our goal is to illustrate a work flow for:</p>
<ul>
<li>setting up a data set for ML</li>
<li>applying different ML models to this data</li>
<li>tuning the ML hyper-parameters</li>
<li>comparing and contrasting performance for the past fitted values and the future predictions.</li>
</ul>
<p>A secondary goal is to demonstrate the utility of a multi-model machine learning framework which enables the user to easily “plug and play” different machine learning models within the same framework. We use the <strong>mlr3</strong> set of packages in R here - this and other similar packages in R (e.g.&nbsp;<strong>caret</strong> and <strong>tidymodels</strong>) and tools in <strong>scikit-learn</strong> in python may be useful in creating a smoother work flow.</p>
<p>A <a href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/f_notebooks/ML%20modelling%20on%20triangles%20-%20a%20worked%20example.html">notebook version of this article</a> is also available which may be helpful if you want to experiment with this code.</p>
<section id="who-is-this-article-aimed-at" class="level3" data-number="9.1.1">
<h3 data-number="9.1.1" class="anchored" data-anchor-id="who-is-this-article-aimed-at"><span class="header-section-number">9.1.1</span> Who is this article aimed at?</h3>
<p>This article is aimed at those who know a little about some of the standard machine learning models, but who may not have done much hands-on work with an analysis. It will also be useful for those who have done some experimentation, but maybe not on a reserving data set. Finally, it may also be of interest to R users who have never used a multi-model framework before and who would like to see how the <strong>mlr3</strong> ecosystem works.</p>
</section>
</section>
<section id="pre-requisites-to-this-article" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="pre-requisites-to-this-article"><span class="header-section-number">9.2</span> Pre-requisites to this article</h2>
<p>We’ve tried to make this article accessible to people new to ML, and to make this article stand-alone. Having some knowledge about basic machine learning techniques like decision trees, random forests and XGBoost (gradient boosting) will help. Furthermore, we also fit the Chainladder model as a GLM (sometimes referred to as a Stochastic Chainladder) and fit a particular type of LASSO model. We’ve included limited details on these models here - our previous chapters have more details on these:</p>
<ul>
<li>Reserving with GLMs - see <a href="05_a_glms_r.html"><span>Chapter&nbsp;7</span></a></li>
<li>Self-assembling claim reserving models using the LASSO - see <a href="06_lasso.html"><span>Chapter&nbsp;8</span></a></li>
</ul>
<section id="the-data-set" class="level3" data-number="9.2.1">
<h3 data-number="9.2.1" class="anchored" data-anchor-id="the-data-set"><span class="header-section-number">9.2.1</span> The data set</h3>
<p>Our example deals with using ML to set reserves for a single aggregate 40x40 triangle. We’ve selected the data set because:</p>
<ul>
<li>It’s small, so the code will run relatively quickly on your machine - there’s nothing worse than running through a worked example and having to wait hours for results!</li>
<li>A lot of reserving is still done using traditional accident (or underwriting) + development aggregated triangles so it is relevant to the real world.</li>
</ul>
<p>We use a simulated data set. There are several reasons for this:</p>
<ul>
<li>We know the future results so can examine how different reserve predictions perform.</li>
<li>We can control how the future experience emerges. In particular, we can ensure there are no future systemic changes (e.g.&nbsp;from legislation or court precedent) that would impact future payments. Changes like this can make it difficult when examining performance of reserve prediction methods on real data - it can be hard to separate poor performance of the model from a good model where the future experience departs markedly from that used to build the model.</li>
<li>We can share the data set (and the code to generate it) with you.</li>
</ul>
<p>The data set used is simulated data set 3 from the paper <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3241906">Self-assembling insurance claim models using regularized regression and machine learning</a>. This is a 40x40 triangle of incremental quarterly payments over 10 years. Variables on the data set are accident, development and calendar quarters only. A copy of the data set is available <a href="./_lasso_simdata3.csv">here</a>.</p>
</section>
<section id="machine-learning-and-aggregate-triangles" class="level3" data-number="9.2.2">
<h3 data-number="9.2.2" class="anchored" data-anchor-id="machine-learning-and-aggregate-triangles"><span class="header-section-number">9.2.2</span> Machine learning and aggregate triangles</h3>
<p>Typically, ML and big data go hand-in-hand. By big data we mean lots of observations and lots of features (covariates / independent variables / regressors). Aggregate triangles are small in both senses - small numbers of observations and limited features (often just the 3 time features of accident/underwriting period, development period and calendar period).</p>
<p>This is not to say that it is invalid to use machine learning for aggregate triangles - many people have demonstrated good results from machine learning for such data - there are many papers on this topic. But it’s also true that an experienced actuary using a Chainladder model (or other traditional) method, overlaid with judgement, will often get a similar answer to the best ML method, even for a complex triangle. However ML may be a more efficient way of getting to an answer. In the worked example below, we use a data set which deviates significantly from Chainladder assumptions. Therefore the unadjusted Chainladder projection is quite poor and would need a significant investment of time to yield a better model. In contrast, the better performing ML models we looked at have a better first estimate, so may not require as much intervention to produce a final estimate, thereby leading to a time-saving.</p>
</section>
<section id="dont-rank-the-ml-models-used-based-on-this-example" class="level3" data-number="9.2.3">
<h3 data-number="9.2.3" class="anchored" data-anchor-id="dont-rank-the-ml-models-used-based-on-this-example"><span class="header-section-number">9.2.3</span> Don’t rank the ML models used based on this example</h3>
<p>The purpose of this article is to demonstrate a workflow for fitting ML models in R. While we’ve done some work to improve model fitting, there are a lot more things we would consider if we were looking for the best models (e.g.&nbsp;feature engineering, train/test splits, performance measures). So, although we do look at the relative performance of the different models at the end, you should not make any conclusions about the relative performance of the different ML methods based on this work.</p>
<p>You may find that by adjusting some hyper-parameters, or by revising the training/test data set split, you’re able to find better models. We’ll be discussing this point a bit further at the end of the article.</p>
<p><em>A priori</em>, given the form of the data (simulated using a regression style structure) and that the LASSO model we used is based on previous work which did aim to establish a framework to fit good models to triangular data using the LASSO, we expected that the LASSO model would perform the best and (spoiler alert!) it did.</p>
</section>
<section id="mlr3-package" class="level3" data-number="9.2.4">
<h3 data-number="9.2.4" class="anchored" data-anchor-id="mlr3-package"><span class="header-section-number">9.2.4</span> mlr3 package</h3>
<p>One problem with applying many different types of ML models is that they all generally have different input specifications for the data, and different output types. This can make it a bit tedious to try several models.</p>
<p>There are a number of ML aggregator or multi-model packages that do a lot of the data manipulation behind the scenes. These packages take in data in a specified form and allow users to call the different ML methods. They abstract away any data manipulation required to put the data into the form required by the method. The benefit of these is apparent - set up the data in the aggregator and then switch models in and out at will.</p>
<p>One of our <a href="#f-topten-r-packages">previous chapters</a> covers multi-model packages.</p>
<p>Some ML aggregators in R include</p>
<ul>
<li><a href="https://cran.r-project.org/web/packages/caret/index.html">caret</a></li>
<li><a href="https://www.tidymodels.org/">tidymodels</a> - a successor to caret.</li>
<li><a href="https://mlr3.mlr-org.com/">mlr3</a> is the successor to the popular but no longer actively developed <a href="https://mlr.mlr-org.com/">mlr</a>.</li>
</ul>
<p>The Python package <strong>scikit-learn</strong> also provides a lot of useful machine learning tools.</p>
<p>If you’re looking to use an aggregator package then it’s probably best to read up on a few of them, then select the one that best works for you. We picked <strong>mlr3</strong> first because one of us has used <strong>mlr</strong> in the past and second we are part of the <strong>M</strong>achine <strong>L</strong>earning in <strong>R</strong>eserving working party, so we had to give <strong>mlr3</strong> a try!</p>
<p><strong>mlr3</strong> uses the R6 object orientated classes - R6 is similar to object orientated programming in other languages such as Python or C++, but is quite different to R’s S3 and S4 object orientated approaches. So, depending on your programming experience, the syntax may take a bit of getting used to.</p>
<p>As a rough rule of thumb, when working with R6 classes we:</p>
<ul>
<li>First set up an instance of the class. Note that the class can contain both methods (like functions) and data.</li>
<li>We then run methods for the class object. These may update the data in the object.</li>
<li>We can view and use the data in the class object. Sometimes we can edit the data directory, othertimes, the data is read only and can only be modified using a method (function) available in the class object.</li>
</ul>
<p>If you want to learn more there is plenty of documentation out there:</p>
<ul>
<li>The <a href="https://mlr3book.mlr-org.com/">mlr3 book</a></li>
<li><a href="https://cheatsheets.mlr-org.com/">Cheatsheets</a></li>
<li><a href="https://mlr3gallery.mlr-org.com/">Gallery of examples</a></li>
</ul>
<p>When using <strong>mlr3</strong> code, then you can get inline help in R by using the <code>help()</code> method in a class object. This will bring you to help pages. E.g. <code>lrn("regr.rpart")$help()</code> with get you help on decision tree learners and the learner object in general.</p>
<p>In our worked example below, we aim to explain each step clearly, so if you prefer to use another package (or language) or work separately with the individual ML packages, you should be able to translate what we are doing into code that is more familiar to you.</p>
</section>
<section id="ml-methods-used" class="level3" data-number="9.2.5">
<h3 data-number="9.2.5" class="anchored" data-anchor-id="ml-methods-used"><span class="header-section-number">9.2.5</span> ML methods used</h3>
<p>We’ve looked at the following methods:</p>
<ul>
<li>Decision trees</li>
<li>Random forests</li>
<li>XGBoost</li>
<li>LASSO</li>
</ul>
<p>We also use a GLM which is set up to replicate the Chainladder estimates (refer to this <a href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/post/glms/">post</a> for more details).</p>
<p>An obvious omission from here are neural networks / deep learning models. We’ve omitted these for a couple of reasons:</p>
<ul>
<li>We’re using <strong>mlr3</strong> here. While there is a <a href="https://github.com/mlr-org/mlr3keras"><strong>mlr3keras</strong></a> package, the developers state (as of May 2021) that <em>mlr3keras is in very early stages, and currently under development. Functionality is therefore experimental and we do not guarantee correctness, safety or stability</em>.</li>
<li>The setup for <strong>mlr3keras</strong> is more difficult as it requires having an instance of Python running on your system. R’s <strong>reticulate</strong> package then interfaces between the two. Sometimes this is straightforward (some recent improvements have made this a lot easier), but other times it can be frustrating.</li>
</ul>
<p>However, we are actively looking at using deep learning models and will be revisiting them in the near future.</p>
</section>
</section>
<section id="outline-of-the-workflow" class="level2" data-number="9.3">
<h2 data-number="9.3" class="anchored" data-anchor-id="outline-of-the-workflow"><span class="header-section-number">9.3</span> Outline of the workflow</h2>
<p>The workflow we have set up consists of the following:</p>
<ul>
<li>Prepare the data for use in the models, including train and test partitions (past data) and hold-out or validation partitions (future data).</li>
<li>Fit each of the models selected. For each of these we:
<ul>
<li>Select hyper-parameters (these control the model-fitting process) for tuning</li>
<li>Tune the hyper-parameters using the train and test partitions and select the set of values that yield the best results</li>
<li>Calculate predicted values on the holdout (future) data.</li>
</ul></li>
<li>Run diagnostics on the predicted values for each model and look at the reserve estimates.</li>
</ul>
<p>We’ll now work through each of the stages below.</p>
</section>
<section id="setup" class="level2" data-number="9.4">
<h2 data-number="9.4" class="anchored" data-anchor-id="setup"><span class="header-section-number">9.4</span> Setup</h2>
<p>The first step is to load all the libraries required for this work (and install them first if needed). We’ve included details of our session which includes versions of the packages we used at the end of this article. If you are having problems running our code, check that your packages (the mlr3 ones in particular) are the same as ours.</p>
<p>Note that <strong>mlr3</strong> is actually a collection of a number of different packages. If you want to do a specific task, it’s worth seeing if there is an <strong>mlr3</strong> package out there for it. There are a number of core <strong>mlr3</strong> packages which are hosted on CRAN. We’ve attached them separately here to make it clear which ones we are using but it is also possible to install and attach the most commonly used ones via the <a href="https://cran.r-project.org/web/packages/mlr3verse/index.html">mlr3verse</a> wrapper package.</p>
<p>Some of the accompanying packages are on github only. Of these, we’re just going to use one here - <strong>mlr3extralearners</strong> - which contains an extended set of machine learning models (the CRAN package <strong>mlr3learners</strong> includes the most common ones). Install this using the <strong>remotes</strong> package - the code is given below in the comments. If you’re using <strong>renv</strong> to manage your packages, then use that instead.</p>
<p>You also need to have the following packages installed - but you do not need to attach them as a library:</p>
<ul>
<li><strong>glmnet</strong> (for the LASSO model)</li>
<li><strong>rpart</strong> (decision tree)</li>
<li><strong>ranger</strong> (random forest)</li>
<li><strong>xgboost</strong></li>
<li><strong>viridis</strong> (colour schemes used in some of the plots).</li>
</ul>
<p>Finally you need to install <strong>mlr3measures</strong> but you <strong>must not</strong> attach it (i.e.&nbsp;use <code>library(mlr3measures)</code>) as this will lead to code errors.</p>
<p>The code below checks for these packages and will give you a warning message if you are missing any of them. You can then install them (with the exception of <strong>mlr3extralearners</strong>) with <code>install.packages()</code> or, for RStudio users, via the Packages tab.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>reqd_packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"data.table"</span>,</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"DT"</span>,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"ggplot2"</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"glmnet"</span>,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"mlr3verse"</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"mlr3extralearners"</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"patchwork"</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"ranger"</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"rpart"</span>,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"rpart.plot"</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"viridis"</span>,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"xgboost"</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (p <span class="cf">in</span> reqd_packages){</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  check_p <span class="ot">&lt;-</span> <span class="fu">requireNamespace</span>(p, <span class="at">quietly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>check_p) <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">"Install the package"</span>, p, <span class="st">"before continuing</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Package checking complete</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Package checking complete</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># To install packages via code:</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(&lt;package name&gt;) </span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># To install mlr3extralearners (which is not on CRAN so must be installed on github)</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Ensure you have the remotes package installed</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. if note using renv then install using</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     remotes::install_github("mlr-org/mlr3extralearners")</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># if this fails (e.g. if you are using renv to manage packages then it might), you may need to use</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># remotes::install_github("mlr-org/mlr3extralearners", INSTALL_opts = c("--no-multiarch") )</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># see https://github.com/rstudio/renv/issues/162</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># If using renv, then use this:</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co"># renv::install("mlr-org/mlr3extralearners")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we’ve checked the required packages are there, we can get started with the example by attaching the libraries we require.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># machine learning libraries</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)   <span class="co"># base mlr3 package</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3extralearners) <span class="co"># needed for glms</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># data manipulation</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># graphing</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)  <span class="co"># plotting</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork) <span class="co"># easy way to combine ggplots</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart.plot)   <span class="co"># to draw decision trees created by rpart</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co"># making nice tables</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co"># stop R from showing big numbers in scientific notation</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="st">"scipen"</span><span class="ot">=</span><span class="dv">99</span>)  </span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co"># colours for plots - not all are used</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="co"># We will also use viridis for some plots</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>dblue  <span class="ot">&lt;-</span> <span class="st">"#113458"</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>mblue  <span class="ot">&lt;-</span> <span class="st">"#4096b8"</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>gold   <span class="ot">&lt;-</span> <span class="st">"#d9ab16"</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>lgrey  <span class="ot">&lt;-</span> <span class="st">"#dcddd9"</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>dgrey  <span class="ot">&lt;-</span> <span class="st">"#3f4548"</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>black  <span class="ot">&lt;-</span> <span class="st">"#3F4548"</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>red    <span class="ot">&lt;-</span> <span class="st">"#d01e45"</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>purple <span class="ot">&lt;-</span> <span class="st">"#8f4693"</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>orange <span class="ot">&lt;-</span> <span class="st">"#ee741d"</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>fuscia <span class="ot">&lt;-</span> <span class="st">"#e9458c"</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>violet <span class="ot">&lt;-</span> <span class="st">"#8076cf"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-preparation" class="level2" data-number="9.5">
<h2 data-number="9.5" class="anchored" data-anchor-id="data-preparation"><span class="header-section-number">9.5</span> Data preparation</h2>
<p>We’re using a simulated data triangle with all values (past and future).</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="07_mlr3example_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The data set we use is the simulated data set 3 from this <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3241906">paper</a>. It is available in CSV form <a href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/csv/lasso_simdata3.csv">here</a>.</p>
<p>This is a 40x40 triangle of payments:</p>
<ul>
<li>That vary by accident quarter</li>
<li>That vary by development quarter</li>
<li>Have varying rates of superimposed inflation in payment size by calendar quarter (including no inflation)</li>
<li>Have a step-up in payment size for accident quarters &gt; 16 and development quarters &gt; 20.</li>
</ul>
<p>The first two effects are captured by a Chainladder model but the last two effects depart from Chainladder assumptions.</p>
<section id="data.table-package" class="level3" data-number="9.5.1">
<h3 data-number="9.5.1" class="anchored" data-anchor-id="data.table-package"><span class="header-section-number">9.5.1</span> data.table package</h3>
<p>We’ll be using the <strong>data.table</strong> package for manipulating the data. There’s an introduction to <strong>data.table</strong> on our <a href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/post/datatable/">blog</a> if you are unfamiliar with it. If you see <code>:=</code> in the R code, then that’s <strong>data.table</strong> assignment.</p>
</section>
<section id="load-the-data" class="level3" data-number="9.5.2">
<h3 data-number="9.5.2" class="anchored" data-anchor-id="load-the-data"><span class="header-section-number">9.5.2</span> Load the data</h3>
<p>First, load in the data and have a look at it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"./_lasso_simdata3.csv"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dat)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="do">##          pmts acc dev cal          mu train_ind</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 1:   242671.2   1   1   1    71653.13      TRUE</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 2:   164001.3   1   2   2  1042775.62      TRUE</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 3:  3224477.8   1   3   3  4362599.77      TRUE</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 4:  3682530.8   1   4   4 10955670.09      TRUE</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 5: 10149368.6   1   5   5 20800545.12      TRUE</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="do">## 6: 28578274.7   1   6   6 33089166.75      TRUE</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(dat)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="do">##         pmts acc dev cal        mu train_ind</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="do">## 1: 125261750  40  35  74 109039367     FALSE</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="do">## 2:  62657370  40  36  75  82853302     FALSE</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="do">## 3:  63467681  40  37  76  62682720     FALSE</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="do">## 4:  26041979  40  38  77  47227843     FALSE</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="do">## 5:  33947274  40  39  78  35444881     FALSE</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="do">## 6:  37258687  40  40  79  26503298     FALSE</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co"># create the num_periods variable - number of acc/dev periods</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>num_periods <span class="ot">&lt;-</span> dat[, <span class="fu">max</span>(acc)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As you can see, the data is not in triangular form as per the diagram above, but is instead in long form where:</p>
<ul>
<li>each row of the data set consists of one observation</li>
<li>each observation has the accident(<code>acc</code>), development(<code>dev</code>) and calendar(<code>cal</code>) period associated with it</li>
<li>the <code>mu</code> value is the mean value of the distribution from which <code>pmts</code> was simulated - this won’t form part of the analysis below so can be ignored</li>
<li>the final variable, <code>train_ind</code> is <code>TRUE</code> for past values and <code>FALSE</code> for future values.</li>
</ul>
<p>This long format of data is standard for a lot of modelling and data analysis.</p>
<p>We can also show a visualisation of the data. This contains both past and future data (with a diagonal line marking the boundary). The plot uses shading to indicate the size of the payments (specifically, log(payments)). The step-up in claim size (acc &gt; 16 and dev &gt; 20) is quite obvious in this graphic. What is also apparent is this this increase only affects a small part of the past triangle (10 cells out of 820 to be exact), but impacts much of the future lower triangle.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get limits for use with raster plots</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>data_raster_limits <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">floor</span>(dat[, <span class="fu">min</span>(<span class="fu">log</span>(pmts))]), <span class="fu">ceiling</span>(dat[, <span class="fu">max</span>(<span class="fu">log</span>(pmts))]))</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(dev, acc)) <span class="sc">+</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>(<span class="fu">aes</span>(<span class="at">fill =</span> <span class="fu">log</span>(pmts)))<span class="sc">+</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>num_periods<span class="sc">+</span><span class="dv">1</span><span class="sc">-</span>acc, <span class="at">y=</span>acc), <span class="at">colour=</span><span class="st">"grey30"</span>, <span class="at">size=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_reverse</span>()<span class="sc">+</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">begin=</span><span class="dv">1</span>, <span class="at">end=</span><span class="dv">0</span>, <span class="at">limits=</span>data_raster_limits)<span class="sc">+</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()<span class="sc">+</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">"Development quarter"</span>, <span class="at">y=</span><span class="st">"Accident quarter"</span>, <span class="at">title=</span><span class="st">"Log(payments)"</span>)<span class="sc">+</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="07_mlr3example_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The step-up in payments can be modelled as an interaction between accident and development quarters. Because it affects only a small number of past values, it may be difficult for some of the modelling approaches to capture this. It’s likely, therefore, that the main differentiator between the performance of different methods for this data set will be how much well they capture this interaction.</p>
<p>One thing to note is that the Chainladder will struggle with this data set. Both the calendar period terms and the interaction are not effects that the Chainladder can model - it assumes that only accident and development period main effects (i.e.&nbsp;no interactions) are present. So an actuary using the Chainladder for this data set would need to overlay judgement to obtain a good result.</p>
<p>We need to modify this data a little before proceeding further:</p>
<ul>
<li>We’ll add factor versions (essentially a categorical version) of acc and dev - these are needed later for fitting the Chainladder</li>
<li>We’ll add a unique ID associated with each row</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># data.table code, := is assignment</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># if you see an underscore under the := in the code below, then this is a formatting thing - ignore the underscore here and elsewhere</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># the code should look like this: dat[, accf := as.factor(acc)]</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>dat[, accf <span class="sc">:</span><span class="er">=</span> <span class="fu">as.factor</span>(acc)]</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>dat[, devf <span class="sc">:</span><span class="er">=</span> <span class="fu">as.factor</span>(dev)]</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># data.table code, .N = number of rows</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>dat[, row_id <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span><span class="sc">:</span>.N]</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        pmts acc dev cal        mu train_ind accf devf row_id
1: 125261750  40  35  74 109039367     FALSE   40   35   1595
2:  62657370  40  36  75  82853302     FALSE   40   36   1596
3:  63467681  40  37  76  62682720     FALSE   40   37   1597
4:  26041979  40  38  77  47227843     FALSE   40   38   1598
5:  33947274  40  39  78  35444881     FALSE   40   39   1599
6:  37258687  40  40  79  26503298     FALSE   40   40   1600</code></pre>
</div>
</div>
</section>
<section id="create-a-mlr3-task" class="level3" data-number="9.5.3">
<h3 data-number="9.5.3" class="anchored" data-anchor-id="create-a-mlr3-task"><span class="header-section-number">9.5.3</span> Create a mlr3 task</h3>
<p>Now create an <strong>mlr3</strong> <a href="https://mlr3book.mlr-org.com/tasks.html">task</a> - making an object to hold data and set roles for the data. These tasks abstract away (i.e.&nbsp;do it for you) all the hard work in getting the data into the right form for each model (learner in <strong>mlr3</strong> parlance) - just specify what the target is and what the features are, and <strong>mlr3</strong> will take care of the rest.</p>
<p>We need to make a regression task since we will be estimating payments. So we make a new instance of the <code>TaskRegr</code> class via <code>TaskRegr$new</code>. When loading the data in via the <code>backend</code>, we’ve omitted <code>mu</code> since this is not used in the modelling. We’ve also omitted the factor versions of <code>acc</code> and <code>dev</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># note can also use the sugar function tsk()</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>task <span class="ot">&lt;-</span> TaskRegr<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"reserves"</span>,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">backend =</span> dat[, .(pmts, train_ind, acc, dev, cal, row_id)],</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">target =</span> <span class="st">"pmts"</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"># look at the task</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>task</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TaskRegr:reserves&gt; (1600 x 6)
* Target: pmts
* Properties: -
* Features (5):
  - int (4): acc, cal, dev, row_id
  - lgl (1): train_ind</code></pre>
</div>
</div>
<p>We need to ensure everything is correctly assigned:</p>
<ul>
<li>Future data must not be used for model training. Currently all parts of the triangle are used because we loaded all the data into the <code>backend</code>.</li>
<li>The right features must be used in model training. Right now <code>row_id</code> and <code>train_ind</code> are also included in the features which is incorrect.</li>
</ul>
<p>For the first, we’ll use <code>row_roles</code> to ensure that future data is not used for model training. There are two types of <code>row_roles</code> - <code>use</code> and <code>validation</code>. Right now all rows are in <code>use</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># number of entries in use</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">length</span>(task<span class="sc">$</span>row_roles<span class="sc">$</span>use))</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 1600</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># for brevity just print first 10 elements</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(task<span class="sc">$</span>row_roles<span class="sc">$</span>use[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>])</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="do">##  [1]  1  2  3  4  5  6  7  8  9 10</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co"># number of entries in validation</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">length</span>(task<span class="sc">$</span>row_roles<span class="sc">$</span>validation))</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Move all future values (<code>train_ind==FALSE</code>) into <code>validation</code> so they are not used in the model.</p>
<p>We can’t edit row_roles directly, so use the method (<code>set_row_roles()</code>) to do this. Supply the list of future row_ids in the first argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>task<span class="sc">$</span><span class="fu">set_row_roles</span>(dat[train_ind<span class="sc">==</span><span class="cn">FALSE</span>, row_id], <span class="at">roles=</span><span class="st">"holdout"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check that the task has been updated correctly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># number of entries in use</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">length</span>(task<span class="sc">$</span>row_roles<span class="sc">$</span>use))</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 820</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># for brevity just print the end of the second accident period - row id 80 should be in validate</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(task<span class="sc">$</span>row_roles<span class="sc">$</span>use[<span class="dv">70</span><span class="sc">:</span><span class="dv">90</span>])</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="do">##  [1] 70 71 72 73 74 75 76 77 78 79 81 82 83 84 85 86 87 88 89 90 91</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># number of entries in holdout</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">length</span>(task<span class="sc">$</span>row_roles<span class="sc">$</span>holdout))</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 780</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(task<span class="sc">$</span>row_roles<span class="sc">$</span>validation[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>])</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="do">## NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This looks right (we’ve checked more than this, but have limited what we display in this notebook).</p>
<p>Now we need to remove <code>row_id</code> and <code>train_ind</code> from the list of features:</p>
<ul>
<li>we’ll ignore <code>train_ind</code> (so it won’t have any role)</li>
<li>we’ll set <code>row_id</code> to be a name. This could be used in plots to label points if needed.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make row_id a name</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>task<span class="sc">$</span><span class="fu">set_col_roles</span>(<span class="st">"row_id"</span>, <span class="at">roles=</span><span class="st">"name"</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># drop train_ind from the feature list</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>task<span class="sc">$</span>col_roles<span class="sc">$</span>feature <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(task<span class="sc">$</span>feature_names, <span class="st">"train_ind"</span>)  </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># check the task has the correct variables now</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>task</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="do">## &lt;TaskRegr:reserves&gt; (820 x 4)</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="do">## * Target: pmts</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="do">## * Properties: -</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="do">## * Features (3):</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="do">##   - int (3): acc, cal, dev</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co"># check alll the col_roles</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>task<span class="sc">$</span>col_roles</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="do">## $feature</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] "acc" "cal" "dev"</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="do">## $target</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] "pmts"</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="do">## $name</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] "row_id"</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="do">## $order</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="do">## character(0)</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="do">## $stratum</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="do">## character(0)</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a><span class="do">## $group</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a><span class="do">## character(0)</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a><span class="do">## $weight</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a><span class="do">## character(0)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="tuning-process-for-hyper-parameters" class="level2" data-number="9.6">
<h2 data-number="9.6" class="anchored" data-anchor-id="tuning-process-for-hyper-parameters"><span class="header-section-number">9.6</span> Tuning process for hyper-parameters</h2>
<p>Machine learning models have a number of hyper-parameters that control the model fit. Tweaking the hyper-parameters that control model fitting (e.g.&nbsp;for decision trees, the depth of the tree, or for random forests, the number of trees to average over) can have a significant impact on the quality of the fit. The standard way of doing this is to use a train and test data set where:</p>
<ul>
<li>The model is trained (built) on the train data set</li>
<li>The performance of the model is evaluated on the test data set</li>
<li>This is repeated for a number of different combinations of hyper-parameters, and the best performing one is selected.</li>
</ul>
<p>Evaluating the models on a separate data set not used in the model fitting helps to control over-fitting. Usually we would then select the hyper-parameters that lead to the best results on the test data set and use these to predict our future values.</p>
<p>There are various ways we can select the test and train data sets. For this work we use cross-validation. We’ll give a brief overview of it below. Note that we will be discussing validation options in a separate article.</p>
<section id="cross-validation" class="level3" data-number="9.6.1">
<h3 data-number="9.6.1" class="anchored" data-anchor-id="cross-validation"><span class="header-section-number">9.6.1</span> Cross-validation</h3>
<p>The simplest implementation of a train and test partition is a random one where each point in the data set is allocated to train and test at random. Typically, the train part might be around 70-80% of the data and the test part the remainder.</p>
<p><strong>Random test data set</strong></p>
<div class="cell">
<div class="cell-output-display">
<p><img src="07_mlr3example_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Cross-validation repeats this type of split a number of times.</p>
<p>In more detail, the steps are:</p>
<ul>
<li>Randomly partition the data into <em>k</em> equal-sized folds (between 5-10 folds are common choices). These folds are then fixed for the remainder of the algorithm.
<ul>
<li>This means that we do a train/test split like the triangle above but repeat this <em>k</em> times.</li>
</ul></li>
<li>Fit the model using data from <em>k</em>-1 of the folds, using the remaining fold as the test data. Do this <em>k</em> times, so each fold is used as test data once.</li>
<li>Calculate the performance metrics for each model on the corresponding test fold.</li>
<li>Average the performance metrics across all the folds.</li>
</ul>
<p>A simplified representation of the process is given below.</p>
<p><strong>5-fold cross validation</strong></p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="07_mlr3example_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Cross-validation provides an estimate of out-of-sample performance even though all the data is used for training and testing. It is often considered more robust due to its use of the full dataset for testing, but can be computationally expensive for larger datasets. Here we only have a small amount of data, so there is an advantage to using the full dataset, whilst the computational cost is manageable.</p>
</section>
<section id="setting-up-cross-validation-in-mlr3" class="level3" data-number="9.6.2">
<h3 data-number="9.6.2" class="anchored" data-anchor-id="setting-up-cross-validation-in-mlr3"><span class="header-section-number">9.6.2</span> Setting up cross-validation in mlr3</h3>
<p>We can set up a cross-validation resampler in mlr3 that can then be applied to any model. As always, the <a href="https://mlr3book.mlr-org.com/resampling.html">book</a> is a useful starting reference point.</p>
<p>Here we will use 6-fold cross validation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create object</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>crossval <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds=</span><span class="dv">6</span>)  </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)  <span class="co"># reproducible results</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co"># populate the folds</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co"># NB: mlr3 will only use data where role was set to “use”</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>crossval<span class="sc">$</span><span class="fu">instantiate</span>(task)   </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Below we show the allocation of points into test and train for each fold - the dark blue points are the test subset in each of the 6 folds.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="07_mlr3example_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="performance-measure" class="level3" data-number="9.6.3">
<h3 data-number="9.6.3" class="anchored" data-anchor-id="performance-measure"><span class="header-section-number">9.6.3</span> Performance measure</h3>
<p>As well as the cross-validation process, we want to set up a performance measure to use. Here we will use RMSE (root mean square error).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to see all measures use </span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># mlr_measures$help()</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># follow the links for a specific one, or you can type</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ?mlr_measures_regr.rmse to get help for RMSE, and then insert the </span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># other names for others, eg ?mlr_measures_regr.rmsle etc</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>measure <span class="ot">&lt;-</span> <span class="fu">msr</span>(<span class="st">"regr.rmse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="searching-hyper-parameter-space" class="level3" data-number="9.6.4">
<h3 data-number="9.6.4" class="anchored" data-anchor-id="searching-hyper-parameter-space"><span class="header-section-number">9.6.4</span> Searching hyper-parameter space</h3>
<p>Searching hyper-parameter space needs to be customised to each model, so we can’t set up a common framework here. However, to control computations, it is useful to set a limit on the number of searches that can be performed in a tuning exercise. <strong>mlr3</strong> offers a number of different options for terminating searches - here we are just going to use the simplest one - where only a limited number of evaluations are permitted.</p>
<p>Given how we set up the tuning process below we need 25 evaluations for the decision tree and random forest models. We need many more evaluations for the XGBoost model since we tune more parameters. However, this can take a long time to run. In practice, using a more powerful computer, or running things in parallel can help.</p>
<p>So we’ve set the number of evaluations to a low number here (25). For the XGBoost model, we used 500 evaluations to tune the hyper-parameters and saved the results for use here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># setting we used to get the xgboost results below</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co">#evals_trm = trm("evals", n_evals = 500)</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># using a low number so things run quickly</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>evals_trm <span class="ot">=</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="fitting-some-ml-models" class="level2" data-number="9.7">
<h2 data-number="9.7" class="anchored" data-anchor-id="fitting-some-ml-models"><span class="header-section-number">9.7</span> Fitting some ML models</h2>
<p>Now it’s time to fit and tune the following ML models using <strong>mlr3</strong>:</p>
<ul>
<li>Decision tree</li>
<li>Random forest</li>
<li>XGBoost</li>
</ul>
<section id="decision-tree" class="level3" data-number="9.7.1">
<h3 data-number="9.7.1" class="anchored" data-anchor-id="decision-tree"><span class="header-section-number">9.7.1</span> Decision tree</h3>
<p>A decision tree is unlikely to be a very good model for this data, and tuning often doesn’t help much. Nonetheless, it’s a simple model, so it’s useful to fit it to see what happens.</p>
<p>To illustrate the use of mlr3, we’ll first show how to fit a model using the default hyper-parameters. We’ll then move onto the code needed to run hyper-parameter tuning using cross-validation.</p>
</section>
<section id="fitting-a-single-model" class="level3" data-number="9.7.2">
<h3 data-number="9.7.2" class="anchored" data-anchor-id="fitting-a-single-model"><span class="header-section-number">9.7.2</span> Fitting a single model</h3>
<p>First let’s fit a decision tree using default parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a learner, ie a container for a decision tree model</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>lrn_rpart_default <span class="ot">&lt;-</span> <span class="fu">lrn</span>(<span class="st">"regr.rpart"</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># fit the model on all the past data (ie where row_roles==use)</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>lrn_rpart_default<span class="sc">$</span><span class="fu">train</span>(task)  </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualise the tree</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>rpart.plot<span class="sc">::</span><span class="fu">rpart.plot</span>(lrn_rpart_default<span class="sc">$</span>model, <span class="at">roundint =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_mlr3example_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>If you are unfamiliar with decision tree diagrams, the model specifies that, for example, for accident years greater than 17, with development periods less than 7.5 (ie 7 or under) and less than 4.5, the predicted claim cost is $43m.</p>
<p>While the tree is fairly simple, we do see splits for acc&lt;17 and dev&lt;21, which match the location of the interaction.</p>
<p>Here’s a list of the parameters - the documentation on <code>rpart.control</code> will have more information.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>lrn_rpart_default<span class="sc">$</span>param_set</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ParamSet&gt;
                id    class lower upper nlevels        default value
 1:             cp ParamDbl     0     1     Inf           0.01      
 2:     keep_model ParamLgl    NA    NA       2          FALSE      
 3:     maxcompete ParamInt     0   Inf     Inf              4      
 4:       maxdepth ParamInt     1    30      30             30      
 5:   maxsurrogate ParamInt     0   Inf     Inf              5      
 6:      minbucket ParamInt     1   Inf     Inf &lt;NoDefault[3]&gt;      
 7:       minsplit ParamInt     1   Inf     Inf             20      
 8: surrogatestyle ParamInt     0     1       2              0      
 9:   usesurrogate ParamInt     0     2       3              2      
10:           xval ParamInt     0   Inf     Inf             10     0</code></pre>
</div>
</div>
<p>Let’s try tuning the <code>cp</code> and <code>minsplit</code> parameters.</p>
<section id="tuning-the-decision-tree" class="level4" data-number="9.7.2.1">
<h4 data-number="9.7.2.1" class="anchored" data-anchor-id="tuning-the-decision-tree"><span class="header-section-number">9.7.2.1</span> Tuning the decision tree</h4>
<p>To set up the tuning we need to specify:</p>
<ul>
<li>The ranges of values to search over</li>
<li>A resampling strategy (already have this - crossvalidation)</li>
<li>An evaluation measure (this is RMSE)</li>
<li>A termination criterion so searches don’t go on for ever (our <code>evals_trm</code>)</li>
<li>The search strategy (e.g.&nbsp;grid search, random search, etc - see, e.g., <a href="https://towardsdatascience.com/hyperparameter-tuning-a-practical-guide-and-template-b3bf0504f095">this post</a> )</li>
</ul>
<p>We first set ranges of values to consider for these using functionality from the <strong>paradox</strong> library.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>tune_ps_rpart <span class="ot">&lt;-</span> <span class="fu">ps</span>(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">cp =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="fl">0.001</span>, <span class="at">upper =</span> <span class="fl">0.1</span>),</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">minsplit =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">1</span>, <span class="at">upper =</span> <span class="dv">10</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can see what’s going to be searched over if we specify a 5x5 grid</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to see what's searched if we set a grid of 5</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rbindlist</span>(<span class="fu">generate_design_grid</span>(tune_ps_rpart, <span class="dv">5</span>)<span class="sc">$</span><span class="fu">transpose</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         cp minsplit
 1: 0.00100        1
 2: 0.00100        3
 3: 0.00100        5
 4: 0.00100        8
 5: 0.00100       10
 6: 0.02575        1
 7: 0.02575        3
 8: 0.02575        5
 9: 0.02575        8
10: 0.02575       10
11: 0.05050        1
12: 0.05050        3
13: 0.05050        5
14: 0.05050        8
15: 0.05050       10
16: 0.07525        1
17: 0.07525        3
18: 0.07525        5
19: 0.07525        8
20: 0.07525       10
21: 0.10000        1
22: 0.10000        3
23: 0.10000        5
24: 0.10000        8
25: 0.10000       10
         cp minsplit</code></pre>
</div>
</div>
<p>Given we only have 25 points (in a grid of 5), we can easily evaluate every option so we’ll use a grid search strategy. In practice other search strategies may be preferable - e.g.&nbsp;a random search often gets similar results to a grid search, in a much smaller amount of time. Another possible choice is Bayesian optimisation search.</p>
<p>So now we have everything we need to tune our hyper-parameters so we can set this up in <strong>mlr3</strong> now.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create the hyper-parameter for this particular learner/model</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>instance_rpart <span class="ot">&lt;-</span> TuningInstanceSingleCrit<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> task,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"regr.rpart"</span>),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> crossval,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> measure,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">search_space =</span> tune_ps_rpart,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> evals_trm</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="co"># create a grid-search tuner for a 5-point grid</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>tuner <span class="ot">&lt;-</span> <span class="fu">tnr</span>(<span class="st">"grid_search"</span>, <span class="at">resolution =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we run the tuning on the <code>instance_rpart</code> space.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># suppress log output for readability</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"bbotk"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"mlr3"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(instance_rpart) </span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co"># restart log output</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"bbotk"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"info"</span>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"mlr3"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"info"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The parameters in the best fit may be accessed here:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>instance_rpart<span class="sc">$</span>result_learner_param_vals</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$xval
[1] 0

$cp
[1] 0.001

$minsplit
[1] 3</code></pre>
</div>
</div>
<p>So we can now fit a final model to all the data using these optimised parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>lrn_rpart_tuned <span class="ot">&lt;-</span> <span class="fu">lrn</span>(<span class="st">"regr.rpart"</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>lrn_rpart_tuned<span class="sc">$</span>param_set<span class="sc">$</span>values <span class="ot">=</span> instance_rpart<span class="sc">$</span>result_learner_param_vals</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>lrn_rpart_tuned<span class="sc">$</span><span class="fu">train</span>(task)  </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the model</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>rpart.plot<span class="sc">::</span><span class="fu">rpart.plot</span>(lrn_rpart_tuned<span class="sc">$</span>model, <span class="at">roundint =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_mlr3example_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This model is much more complicated than the original and looks overfitted - we’ll see if this is the case when we evaluate the model performance later in the article.</p>
</section>
</section>
<section id="random-forest-fitting" class="level3" data-number="9.7.3">
<h3 data-number="9.7.3" class="anchored" data-anchor-id="random-forest-fitting"><span class="header-section-number">9.7.3</span> Random forest fitting</h3>
<p>The <strong>ranger</strong> random forest package is implemented in <strong>mlr3learners</strong> (the regression version is <code>regr.ranger</code>).</p>
<p>Let’s have a look at the hyper-parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>)<span class="sc">$</span>param_set</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ParamSet&gt;
                              id    class lower upper nlevels        default
 1:                        alpha ParamDbl  -Inf   Inf     Inf            0.5
 2:       always.split.variables ParamUty    NA    NA     Inf &lt;NoDefault[3]&gt;
 3:                      holdout ParamLgl    NA    NA       2          FALSE
 4:                   importance ParamFct    NA    NA       4 &lt;NoDefault[3]&gt;
 5:                   keep.inbag ParamLgl    NA    NA       2          FALSE
 6:                    max.depth ParamInt     0   Inf     Inf               
 7:                min.node.size ParamInt     1   Inf     Inf              5
 8:                     min.prop ParamDbl  -Inf   Inf     Inf            0.1
 9:                      minprop ParamDbl  -Inf   Inf     Inf            0.1
10:                         mtry ParamInt     1   Inf     Inf &lt;NoDefault[3]&gt;
11:                   mtry.ratio ParamDbl     0     1     Inf &lt;NoDefault[3]&gt;
12:            num.random.splits ParamInt     1   Inf     Inf              1
13:                  num.threads ParamInt     1   Inf     Inf              1
14:                    num.trees ParamInt     1   Inf     Inf            500
15:                    oob.error ParamLgl    NA    NA       2           TRUE
16:                     quantreg ParamLgl    NA    NA       2          FALSE
17:        regularization.factor ParamUty    NA    NA     Inf              1
18:      regularization.usedepth ParamLgl    NA    NA       2          FALSE
19:                      replace ParamLgl    NA    NA       2           TRUE
20:    respect.unordered.factors ParamFct    NA    NA       3         ignore
21:              sample.fraction ParamDbl     0     1     Inf &lt;NoDefault[3]&gt;
22:                  save.memory ParamLgl    NA    NA       2          FALSE
23: scale.permutation.importance ParamLgl    NA    NA       2          FALSE
24:                    se.method ParamFct    NA    NA       2        infjack
25:                         seed ParamInt  -Inf   Inf     Inf               
26:         split.select.weights ParamUty    NA    NA     Inf               
27:                    splitrule ParamFct    NA    NA       3       variance
28:                      verbose ParamLgl    NA    NA       2           TRUE
29:                 write.forest ParamLgl    NA    NA       2           TRUE
                              id    class lower upper nlevels        default
       parents value
 1:  splitrule      
 2:                 
 3:                 
 4:                 
 5:                 
 6:                 
 7:                 
 8:                 
 9:  splitrule      
10:                 
11:                 
12:  splitrule      
13:                1
14:                 
15:                 
16:                 
17:                 
18:                 
19:                 
20:                 
21:                 
22:                 
23: importance      
24:                 
25:                 
26:                 
27:                 
28:                 
29:                 
       parents value</code></pre>
</div>
</div>
<p>Here, we’ll try tuning number of trees (<code>num.trees</code>) and the minimum node size (<code>min.node.size</code>). <code>max.depth</code>, <code>mtry</code> and <code>sample.fraction</code> are also often helpful to tune.</p>
<p>We’ll follow the same steps as for decision trees - set up a parameter space for searching, combine this with RMSE and cross-validation and then tune using grid search.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>tune_ps_ranger <span class="ot">&lt;-</span> <span class="fu">ps</span>(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">num.trees =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">100</span>, <span class="at">upper =</span> <span class="dv">900</span>),</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">min.node.size =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">1</span>, <span class="at">upper =</span> <span class="dv">5</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co"># to see what's searched if we set a grid of 5</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co">#rbindlist(generate_design_grid(tune_ps_ranger, 5)$transpose())</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>instance_ranger <span class="ot">&lt;-</span> TuningInstanceSingleCrit<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> task,</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>),</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> crossval,</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> measure,</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">search_space =</span> tune_ps_ranger,</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> evals_trm</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="co"># suppress output</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"bbotk"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"mlr3"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="co">#We can reuse the tuner we set up for the decision tree</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a><span class="co">#this was tuner &lt;- tnr("grid_search", resolution = 5)</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(instance_ranger) </span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a><span class="co"># turn output back on</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"bbotk"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"info"</span>)</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"mlr3"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"info"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Get the best fit</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>instance_ranger<span class="sc">$</span>result_learner_param_vals</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$num.threads
[1] 1

$num.trees
[1] 300

$min.node.size
[1] 2</code></pre>
</div>
</div>
<p>Now we fit the model to all the parameters</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>lrn_ranger_tuned <span class="ot">&lt;-</span> <span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>lrn_ranger_tuned<span class="sc">$</span>param_set<span class="sc">$</span>values <span class="ot">=</span> instance_ranger<span class="sc">$</span>result_learner_param_vals</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>lrn_ranger_tuned<span class="sc">$</span><span class="fu">train</span>(task)  </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>lrn_ranger_tuned<span class="sc">$</span>model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Ranger result

Call:
 ranger::ranger(dependent.variable.name = task$target_names, data = task$data(),      case.weights = task$weights$weight, num.threads = 1L, num.trees = 300L,      min.node.size = 2L) 

Type:                             Regression 
Number of trees:                  300 
Sample size:                      820 
Number of independent variables:  3 
Mtry:                             1 
Target node size:                 2 
Variable importance mode:         none 
Splitrule:                        variance 
OOB prediction error (MSE):       14255125223769820 
R squared (OOB):                  0.9224571 </code></pre>
</div>
</div>
</section>
<section id="xgboost" class="level3" data-number="9.7.4">
<h3 data-number="9.7.4" class="anchored" data-anchor-id="xgboost"><span class="header-section-number">9.7.4</span> XGBoost</h3>
<p>Here are the XGBoost parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Can just run</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="co"># lrn("regr.xgboost")$param_set</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># the code below just removes some of the columns for display purposes</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(<span class="fu">lrn</span>(<span class="st">"regr.xgboost"</span>)<span class="sc">$</span>param_set)[, .(id, class, default)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                             id    class          default
 1:                       alpha ParamDbl                0
 2:               approxcontrib ParamLgl            FALSE
 3:                  base_score ParamDbl              0.5
 4:                     booster ParamFct           gbtree
 5:                   callbacks ParamUty        &lt;list[0]&gt;
 6:           colsample_bylevel ParamDbl                1
 7:            colsample_bynode ParamDbl                1
 8:            colsample_bytree ParamDbl                1
 9: disable_default_eval_metric ParamLgl            FALSE
10:       early_stopping_rounds ParamInt                 
11:          early_stopping_set ParamFct             none
12:                         eta ParamDbl              0.3
13:                 eval_metric ParamUty             rmse
14:            feature_selector ParamFct           cyclic
15:                       feval ParamUty                 
16:                       gamma ParamDbl                0
17:                 grow_policy ParamFct        depthwise
18:     interaction_constraints ParamUty   &lt;NoDefault[3]&gt;
19:              iterationrange ParamUty   &lt;NoDefault[3]&gt;
20:                      lambda ParamDbl                1
21:                 lambda_bias ParamDbl                0
22:                     max_bin ParamInt              256
23:              max_delta_step ParamDbl                0
24:                   max_depth ParamInt                6
25:                  max_leaves ParamInt                0
26:                    maximize ParamLgl                 
27:            min_child_weight ParamDbl                1
28:                     missing ParamDbl               NA
29:        monotone_constraints ParamUty                0
30:              normalize_type ParamFct             tree
31:                     nrounds ParamInt   &lt;NoDefault[3]&gt;
32:                     nthread ParamInt                1
33:                  ntreelimit ParamInt                 
34:           num_parallel_tree ParamInt                1
35:                   objective ParamUty reg:squarederror
36:                    one_drop ParamLgl            FALSE
37:                outputmargin ParamLgl            FALSE
38:                 predcontrib ParamLgl            FALSE
39:                   predictor ParamFct    cpu_predictor
40:             predinteraction ParamLgl            FALSE
41:                    predleaf ParamLgl            FALSE
42:               print_every_n ParamInt                1
43:                process_type ParamFct          default
44:                   rate_drop ParamDbl                0
45:                refresh_leaf ParamLgl             TRUE
46:                     reshape ParamLgl            FALSE
47:             sampling_method ParamFct          uniform
48:                 sample_type ParamFct          uniform
49:                   save_name ParamUty                 
50:                 save_period ParamInt                 
51:            scale_pos_weight ParamDbl                1
52:          seed_per_iteration ParamLgl            FALSE
53:                   skip_drop ParamDbl                0
54:                strict_shape ParamLgl            FALSE
55:                   subsample ParamDbl                1
56:                       top_k ParamInt                0
57:                    training ParamLgl            FALSE
58:                 tree_method ParamFct             auto
59:      tweedie_variance_power ParamDbl              1.5
60:                     updater ParamUty   &lt;NoDefault[3]&gt;
61:                     verbose ParamInt                1
62:                   watchlist ParamUty                 
63:                   xgb_model ParamUty                 
                             id    class          default</code></pre>
</div>
</div>
<p>With gradient boosting, it is often helpful to optimise over hyper-parameters, so we will vary some parameters and select the best performing set. For speed reasons we will just consider <code>tweedie_variance_power</code>, <code>eta</code>, <code>max_depth</code> , and <code>nrounds</code> but in practice, we could consider doing more.</p>
<p>The steps are the generally same as before for decision trees and random forests. However as we are searching over a greater number of parameters, we’ve switched to a random search to try to achieve better results. Depending on your computer, this step takes a while to run (since our terminator is 500 evaluations) - so it might be a good point to grab a cup of coffee or tea! Alternatively reduce the number of evaluations in <code>eval_trm</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>tune_ps_xgboost <span class="ot">&lt;-</span> <span class="fu">ps</span>(</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ensure non-negative values</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">objective =</span> <span class="fu">p_fct</span>(<span class="st">"reg:tweedie"</span>),</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tweedie_variance_power =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="fl">1.01</span>, <span class="at">upper =</span> <span class="fl">1.99</span>),</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># eta can be up to 1, but usually it is better to use low eta, and tune nrounds for a more fine-grained model</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">eta =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="fl">0.01</span>, <span class="at">upper =</span> <span class="fl">0.3</span>),</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select value for gamma</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tuning can help overfitting but we don't investigate this here</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">gamma =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="dv">0</span>, <span class="at">upper =</span> <span class="dv">0</span>),</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We know that the problem is not that deep in interactivity so we search a low depth</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_depth =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">2</span>, <span class="at">upper =</span> <span class="dv">6</span>),</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># nrounds to stop overfitting</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">nrounds =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">100</span>, <span class="at">upper =</span> <span class="dv">500</span>)</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>instance_xgboost <span class="ot">&lt;-</span> TuningInstanceSingleCrit<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> task,</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"regr.xgboost"</span>),</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> crossval,</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> measure,</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">search_space =</span> tune_ps_xgboost,</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> evals_trm</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a><span class="co"># need to make a new tuner with resolution 4</span></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a><span class="co">#tuner &lt;- tnr("grid_search", resolution = 4)</span></span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">84</span>)  <span class="co"># for random search for reproducibility</span></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>tuner <span class="ot">&lt;-</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>)</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"bbotk"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"mlr3"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>time_bef <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(instance_xgboost) </span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a><span class="do">##      objective tweedie_variance_power       eta gamma max_depth nrounds</span></span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a><span class="do">## 1: reg:tweedie               1.555728 0.1107844     0         4     467</span></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a><span class="do">##    learner_param_vals  x_domain regr.rmse</span></span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a><span class="do">## 1:          &lt;list[9]&gt; &lt;list[6]&gt;  79119552</span></span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"bbotk"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"info"</span>)</span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"mlr3"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"info"</span>)</span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.time</span>() <span class="sc">-</span> time_bef</span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a><span class="do">## Time difference of 46.43769 secs</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Get the best fit:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>instance_xgboost<span class="sc">$</span>result_learner_param_vals</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$nrounds
[1] 467

$nthread
[1] 1

$verbose
[1] 0

$early_stopping_set
[1] "none"

$objective
[1] "reg:tweedie"

$tweedie_variance_power
[1] 1.555728

$eta
[1] 0.1107844

$gamma
[1] 0

$max_depth
[1] 4</code></pre>
</div>
</div>
<p>However, remember that these results are from 25 evaluations only, and with 4 hyper-parameters, we’d really like to use more evaluations. The model above isn’t a particularly good one</p>
<p>The table below shows the results we got from 500 evaluations along with the results we got in earlier development work for this article (the hyper-parameter tuning results are subject to randomness, first due to the specification of the cross-validation folds and second due to the random search). We’ll use these when looking at the model.</p>
<div class="cell">
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-997a1c381f2412d5e20b" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-997a1c381f2412d5e20b">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5"],["nrounds","tweedie_variance_power","eta","gamma[fixed]","max_depth"],["265","1.011768","0.2310797","0","3"],["233","1.01","0.3","0","3"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Hyperparameter<\/th>\n      <th>Evals500<\/th>\n      <th>Best<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>We’ll fit both models here:</p>
<ul>
<li><code>lrn_xgboost_tuned</code> - the results found from running the tuning code with 500 evaluations</li>
<li><code>lrn_xgboost_prevtuned</code> - the best results we found in previous work</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>lrn_xgboost_prevtuned <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"regr.xgboost"</span>, <span class="at">objective=</span><span class="st">"reg:tweedie"</span>, <span class="at">nrounds=</span><span class="dv">233</span>, </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">tweedie_variance_power=</span><span class="fl">1.01</span>, <span class="at">eta=</span><span class="fl">0.3</span>, <span class="at">gamma=</span><span class="dv">0</span>, <span class="at">max_depth=</span><span class="dv">3</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>lrn_xgboost_prevtuned<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>lrn_xgboost_tuned <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"regr.xgboost"</span>, <span class="at">objective=</span><span class="st">"reg:tweedie"</span>, <span class="at">nrounds=</span><span class="dv">265</span>, </span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>                            <span class="at">tweedie_variance_power=</span><span class="fl">1.011768</span>, <span class="at">eta=</span><span class="fl">0.2310797</span>, <span class="at">gamma=</span><span class="dv">0</span>, <span class="at">max_depth=</span><span class="dv">3</span>)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>lrn_xgboost_tuned<span class="sc">$</span><span class="fu">train</span>(task)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If, instead, you would like to fit the XGBoost model found after 25 evaluations, you can use the code below to pick up the selected values after tuning. This replaces the model fitted above using the hyper-parameters found after 500 evaluations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>lrn_xgboost_tuned <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"regr.xgboost"</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>lrn_xgboost_tuned<span class="sc">$</span>param_set<span class="sc">$</span>values <span class="ot">=</span> instance_xgboost<span class="sc">$</span>result_learner_param_vals</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>lrn_xgboost_tuned<span class="sc">$</span><span class="fu">train</span>(task)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We haven’t run this code so our <code>lrn_xgboost_tuned</code> uses the 500 evaluations results.</p>
</section>
<section id="consolidate-results" class="level3" data-number="9.7.5">
<h3 data-number="9.7.5" class="anchored" data-anchor-id="consolidate-results"><span class="header-section-number">9.7.5</span> Consolidate results</h3>
<p>Now we will consolidate results for these models. We will gather together:</p>
<ul>
<li>RMSE for past and future data</li>
<li>predictions for each model.</li>
</ul>
<p>Note that <strong>mlr3</strong> has various benchmarking tools which we haven’t used here - partially because we want to focus on the concepts rather than the code and partially because we want to compare the results to a couple of other models not fitted in the same framework. If you’re interested in learning more then the section on <a href="https://mlr3book.mlr-org.com/benchmarking.html">benchmarking</a> in the mlr3 book is a good start. <a href="https://mlr3book.mlr-org.com/pipelines.html">Pipelines</a> offer more flexible functionality too.</p>
<p>First, we’ll set up a data.table to hold the model projections for each model and populate these projections for each model</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make a new copy of the data, deleting the row_id, accf and devf columns</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>model_forecasts <span class="ot">&lt;-</span> <span class="fu">copy</span>(dat)[, <span class="fu">c</span>(<span class="st">"row_id"</span>, <span class="st">"accf"</span>, <span class="st">"devf"</span>) <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co"># add the model projections - specify list of learners to use and their names</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>lrnrs <span class="ot">&lt;-</span> <span class="fu">c</span>(lrn_rpart_tuned, lrn_ranger_tuned, lrn_xgboost_tuned, lrn_xgboost_prevtuned)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="co"># the id property is used to name the variables - since we have 2 xgboosts, adjust id where necessary</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>lrn_xgboost_prevtuned<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="st">"regr.xgboost_prev"</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(l <span class="cf">in</span> lrnrs){</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#learner$predict(task, row_ids) is how to get predicted values, returns 3 cols with preds in response</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># use row_ids to tell it to use entire data set, ie "use" and validation rows</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">#model_forecasts[, (nl) := l$predict(task, row_ids=1:nrow(dat))$response]</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>  model_forecasts[, l<span class="sc">$</span>id <span class="sc">:</span><span class="er">=</span> l<span class="sc">$</span><span class="fu">predict</span>(<span class="at">task=</span>task, <span class="at">row_ids=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(dat))<span class="sc">$</span>response]</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(model_forecasts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        pmts acc dev cal        mu train_ind regr.rpart regr.ranger
1: 125261750  40  35  74 109039367     FALSE 3276251556  1145325092
2:  62657370  40  36  75  82853302     FALSE 3276251556  1145309205
3:  63467681  40  37  76  62682720     FALSE 3276251556  1145296469
4:  26041979  40  38  77  47227843     FALSE 3276251556  1145284081
5:  33947274  40  39  78  35444881     FALSE 3276251556  1145273028
6:  37258687  40  40  79  26503298     FALSE 3276251556  1145296139
   regr.xgboost regr.xgboost_prev
1:    437965920         750788160
2:    280243104         527827456
3:    808473344        1523731712
4:    374183648         677887360
5:    233077136         364650848
6:    233077136         364650848</code></pre>
</div>
</div>
<p>Before we do any analysis, let’s fit a couple more models to compare these results against:</p>
<ul>
<li>a Chainladder model</li>
<li>a LASSO model</li>
</ul>
</section>
<section id="chainladder---the-baseline-model" class="level3" data-number="9.7.6">
<h3 data-number="9.7.6" class="anchored" data-anchor-id="chainladder---the-baseline-model"><span class="header-section-number">9.7.6</span> Chainladder - the baseline model</h3>
<p>Since this is a traditional triangle, it seems natural to compare any results to the Chainladder result. So here, we will get the predicted values and reserve estimate for the Chain ladder model.</p>
<p>It’s important to note that we will just use a volume-all Chainladder (i.e.&nbsp;include all periods in the estimation of the development factors) and will not attempt to impose any judgement over the results. In practice, of course, models like the Chainladder are often subject to additional analysis, reasonableness tests and manual assumption selections, so it’s likely the actual result would be different, perhaps significantly, from that returned here.</p>
<p>At the same time, no model, whether it be the Chainladder, or a more sophisticated ML model should be accepted without further testing, so on that basis, comparing Chainladder and ML results without modification is a reasonable thing to do. Better methods should require less human intervention to return a reasonable result.</p>
<section id="getting-the-chainladder-reserve-estimates" class="level4" data-number="9.7.6.1">
<h4 data-number="9.7.6.1" class="anchored" data-anchor-id="getting-the-chainladder-reserve-estimates"><span class="header-section-number">9.7.6.1</span> Getting the Chainladder reserve estimates</h4>
<p>The Chainladder reserve can also be calculated using a GLM with:</p>
<ul>
<li>Accident and development factors</li>
<li>The Poisson or over-dispersed Poisson distribution</li>
<li>The log link.</li>
</ul>
<p>We’ve used this method here as it’s easy to set up in R but practical work using the Chain ladder may be better done with a package like the <a href="https://cran.r-project.org/web/packages/ChainLadder/index.html">R ChainLadder package</a>.</p>
<p>The easiest way to do this is to work outside <strong>mlr3</strong> and use the <code>glm()</code> function directly - this is because our mlr3 <code>task</code> doesn’t contain <code>accf</code> and <code>devf</code>.</p>
<p>Here’s the code using <code>glm()</code> and the <code>predict()</code> method to add predicted values into <code>model_forecasts</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="at">data=</span>dat[train_ind<span class="sc">==</span><span class="cn">TRUE</span>, .(pmts, accf, devf)], <span class="at">formula=</span>pmts <span class="sc">~</span> accf <span class="sc">+</span> devf, <span class="at">family=</span><span class="fu">quasipoisson</span>(<span class="at">link=</span><span class="st">"log"</span>))</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>model_forecasts[, <span class="st">"regr.glm"</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">predict</span>(cl, <span class="at">newdata=</span>dat[, .(pmts, accf, devf)], <span class="at">type=</span><span class="st">"response"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It is possible to fit this in <strong>mlr3</strong> too - but as we need to create a new task, it’s easier to fit it directly uisng <code>glm()</code> as above. However, we’ve included the <strong>mlr3</strong> code below for those who are interested. There’s a good bit more code here since we need to set up a new task and a new learner.</p>
<p>It isn’t necessary to run this code (we haven’t used it below) but if you do, the end result will be that it recalculates the <code>regr.glm</code> variable in the <code>model_forecasts</code> data.table.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># create a task with the factor versions of acc and dev [accf and devf] as the only features</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>task_cl <span class="ot">&lt;-</span> TaskRegr<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"reserves"</span>,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">backend =</span> dat[, .(pmts, train_ind, row_id, accf, devf)],</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">target =</span> <span class="st">"pmts"</span>)</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>task_cl<span class="sc">$</span><span class="fu">set_row_roles</span>(dat[train_ind<span class="sc">==</span><span class="cn">FALSE</span>, row_id], <span class="at">roles=</span><span class="st">"validation"</span>)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>task_cl<span class="sc">$</span><span class="fu">set_col_roles</span>(<span class="st">"row_id"</span>, <span class="at">roles=</span><span class="st">"name"</span>)</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="co"># drop train_ind from the feature list</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>task_cl<span class="sc">$</span>col_roles<span class="sc">$</span>feature <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(task_cl<span class="sc">$</span>feature_names, <span class="st">"train_ind"</span>)  </span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>task_cl</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="co"># fit the GLM - no hyper-parameter tuning since we know exactly the type of model we want to fit</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>lrn_glm <span class="ot">&lt;-</span> <span class="fu">lrn</span>(<span class="st">"regr.glm"</span>, <span class="at">family=</span><span class="st">"quasipoisson"</span>, <span class="at">link=</span><span class="st">"log"</span>)</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>lrn_glm<span class="sc">$</span><span class="fu">train</span>(task_cl)</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lrn_glm<span class="sc">$</span>model)</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a><span class="co"># add the predicted values to model_forecasts in the same way as we did for the other models.</span></span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>model_forecasts[, lrn_glm<span class="sc">$</span>id <span class="sc">:</span><span class="er">=</span> lrn_glm<span class="sc">$</span><span class="fu">predict</span>(<span class="at">task=</span>task_cl, <span class="at">row_ids=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(dat))<span class="sc">$</span>response]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="lasso-regularised-regression" class="level3" data-number="9.7.7">
<h3 data-number="9.7.7" class="anchored" data-anchor-id="lasso-regularised-regression"><span class="header-section-number">9.7.7</span> LASSO (regularised regression)</h3>
<p>Finally, we will use the LASSO to fit a model. We are going to fit the same model as we did in our previous <a href="@f-lasso">chapter</a>. We’ll include a bare-bones description of the model here. If you haven’t seen it before, then you may want to just take the model as given and skip ahead to the next section. Once you’ve read this entire article you may then wish to read the post on the LASSO model to understand the specifics of this model.</p>
<p>The main things to note about this model are:</p>
<ul>
<li>Feature engineering is needed to produce continuous functions of accident / development / calendar quarters for the LASSO to fit.</li>
<li>The blog post and related paper detail how to do this - essentially we create a large group of basis functions from the primary <code>acc</code>, <code>dev</code> and <code>cal</code> variables that are flexible enough to capture a wide variety of shapes.</li>
<li>If we want to use <strong>mlr3</strong> to do this, then we need to create a task that contains these basis functions as features.</li>
<li>Cross-validation can be done within the underlying LASSO package (<strong>glmnet</strong>) rather than via <strong>mlr3</strong>. This is what we’ve done here.</li>
</ul>
<p>There’s a reasonable amount of code to run this model, whether we use <strong>mlr3</strong> or not:</p>
<ul>
<li>We need to create all the basis functions</li>
<li><strong>mlr3</strong> only - we need to set up a task</li>
<li>We need to train the model using <strong>glmnet</strong>’s cross-validation function, <code>cv_glmnet()</code>.</li>
<li>We then need to predict using the values for a particular penalty setting (the regularisation parameter) - following the paper, we use the penalty value that leads to the lowest cross-validation error.</li>
</ul>
<p>Since the blog post shows how to do this using <strong>glmnet</strong> directly, here we use some <strong>mlr3</strong> code to fit the model to show how it would work in <strong>mlr3</strong>. As with the Chainladder/GLM example, it’s more efficient code-wise to do the fitting outside of <strong>mlr3</strong>.</p>
</section>
<section id="basis-functions" class="level3" data-number="9.7.8">
<h3 data-number="9.7.8" class="anchored" data-anchor-id="basis-functions"><span class="header-section-number">9.7.8</span> Basis functions</h3>
<p>The first step is to create all the basis functions that we need. The functions below create the ramp and step functions needed (over 4000 of these!). The end result is a data.table of the original payments and all the basis functions. As noted above, all the details are in the blog post and paper.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co">#---------------------------</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="co"># linear spline function - used in data generation and in spline generation below</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>LinearSpline <span class="ot">&lt;-</span> <span class="cf">function</span>(var, start, stop){</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pmin</span>(stop <span class="sc">-</span> start, <span class="fu">pmax</span>(<span class="dv">0</span>, var <span class="sc">-</span> start))</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="co"># function to calculate scaling factors for the basis functions</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="co"># scaling is discussed in the paper</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>GetScaling <span class="ot">&lt;-</span> <span class="cf">function</span>(vec) {</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">length</span>(vec)</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>  fm <span class="ot">&lt;-</span> <span class="fu">mean</span>(vec)</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>  fc <span class="ot">&lt;-</span> vec <span class="sc">-</span> fm</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>  rho_factor <span class="ot">&lt;-</span> ((<span class="fu">sum</span>(fc<span class="sc">^</span><span class="dv">2</span>))<span class="sc">/</span>fn)<span class="sc">^</span><span class="fl">0.5</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a><span class="co"># function to create the ramps for a particular primary vector</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>GetRamps <span class="ot">&lt;-</span> <span class="cf">function</span>(vec, vecname, np, scaling){</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># vec = fundamental regressor</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># vecname = name of regressor</span></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># np = number of periods</span></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scaling = scaling factor to use</span></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pre-allocate the matrix to hold the results for speed/efficiency</span></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(vec)</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>  nramps <span class="ot">&lt;-</span> (np<span class="dv">-1</span>)</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>  mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">data=</span><span class="cn">NA</span>, <span class="at">nrow=</span>n, <span class="at">ncol=</span>nramps)</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>  cnames <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode=</span><span class="st">"character"</span>, <span class="at">length=</span>nramps)</span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>  col_indx <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(np<span class="dv">-1</span>)){</span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>    col_indx <span class="ot">&lt;-</span> col_indx <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>    mat[, col_indx] <span class="ot">&lt;-</span> <span class="fu">LinearSpline</span>(vec, i, <span class="dv">999</span>) <span class="sc">/</span> scaling</span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>    cnames[col_indx] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"L_"</span>, i, <span class="st">"_999_"</span>, vecname)</span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(mat) <span class="ot">&lt;-</span> cnames</span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(mat)</span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a><span class="co"># create the step (heaviside) function interactions</span></span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a>GetInts <span class="ot">&lt;-</span> <span class="cf">function</span>(vec1, vec2, vecname1, vecname2, np, scaling1, scaling2) {</span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-52"><a href="#cb48-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pre-allocate the matrix to hold the results for speed/efficiency</span></span>
<span id="cb48-53"><a href="#cb48-53" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(vec1)</span>
<span id="cb48-54"><a href="#cb48-54" aria-hidden="true" tabindex="-1"></a>  nints <span class="ot">&lt;-</span> (np<span class="dv">-1</span>)<span class="sc">*</span>(np<span class="dv">-1</span>)</span>
<span id="cb48-55"><a href="#cb48-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-56"><a href="#cb48-56" aria-hidden="true" tabindex="-1"></a>  mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">data=</span><span class="cn">NA_real_</span>, <span class="at">nrow=</span>n, <span class="at">ncol=</span>nints)</span>
<span id="cb48-57"><a href="#cb48-57" aria-hidden="true" tabindex="-1"></a>  cnames <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode=</span><span class="st">"character"</span>, <span class="at">length=</span>nints)</span>
<span id="cb48-58"><a href="#cb48-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-59"><a href="#cb48-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-60"><a href="#cb48-60" aria-hidden="true" tabindex="-1"></a>  col_indx <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb48-61"><a href="#cb48-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-62"><a href="#cb48-62" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>np){</span>
<span id="cb48-63"><a href="#cb48-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-64"><a href="#cb48-64" aria-hidden="true" tabindex="-1"></a>    ivec <span class="ot">&lt;-</span> <span class="fu">LinearSpline</span>(vec1, i<span class="dv">-1</span>, i) <span class="sc">/</span> scaling1</span>
<span id="cb48-65"><a href="#cb48-65" aria-hidden="true" tabindex="-1"></a>    iname <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"I_"</span>, vecname1, <span class="st">"_ge_"</span>, i)</span>
<span id="cb48-66"><a href="#cb48-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-67"><a href="#cb48-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(ivec[<span class="fu">is.na</span>(ivec)]<span class="sc">&gt;</span><span class="dv">0</span>)) <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"NAs in ivec for"</span>, i))</span>
<span id="cb48-68"><a href="#cb48-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-69"><a href="#cb48-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>np){</span>
<span id="cb48-70"><a href="#cb48-70" aria-hidden="true" tabindex="-1"></a>      col_indx <span class="ot">&lt;-</span> col_indx <span class="sc">+</span> <span class="dv">1</span>  </span>
<span id="cb48-71"><a href="#cb48-71" aria-hidden="true" tabindex="-1"></a>      mat[, col_indx] <span class="ot">&lt;-</span> ivec <span class="sc">*</span> <span class="fu">LinearSpline</span>(vec2, j<span class="dv">-1</span>, j) <span class="sc">/</span> scaling2</span>
<span id="cb48-72"><a href="#cb48-72" aria-hidden="true" tabindex="-1"></a>      cnames[col_indx] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(iname, <span class="st">"xI_"</span>, vecname2, <span class="st">"_ge_"</span>, j)</span>
<span id="cb48-73"><a href="#cb48-73" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb48-74"><a href="#cb48-74" aria-hidden="true" tabindex="-1"></a>      jvec <span class="ot">&lt;-</span> <span class="fu">LinearSpline</span>(vec2, j<span class="dv">-1</span>, j) <span class="sc">/</span> scaling2</span>
<span id="cb48-75"><a href="#cb48-75" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(jvec[<span class="fu">is.na</span>(jvec)]<span class="sc">&gt;</span><span class="dv">0</span>)) <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"NAs in jvec for"</span>, j))</span>
<span id="cb48-76"><a href="#cb48-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-77"><a href="#cb48-77" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb48-78"><a href="#cb48-78" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb48-79"><a href="#cb48-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-80"><a href="#cb48-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(mat) <span class="ot">&lt;-</span> cnames</span>
<span id="cb48-81"><a href="#cb48-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-82"><a href="#cb48-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(mat)</span>
<span id="cb48-83"><a href="#cb48-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-84"><a href="#cb48-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-85"><a href="#cb48-85" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now the functions are defined, we’ll create a data.table of basis functions here which we’ll use later when fitting the LASSO. The <code>dat_plus</code> table will hold them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the scaling values</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>rho_factor_list <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode=</span><span class="st">"list"</span>, <span class="at">length=</span><span class="dv">3</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(rho_factor_list) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"acc"</span>, <span class="st">"dev"</span>, <span class="st">"cal"</span>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (v <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"acc"</span>, <span class="st">"dev"</span>, <span class="st">"cal"</span>)){</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  rho_factor_list[[v]] <span class="ot">&lt;-</span> <span class="fu">GetScaling</span>(dat[train_ind <span class="sc">==</span> <span class="cn">TRUE</span>, <span class="fu">get</span>(v)])</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="co"># main effects - matrix of values</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>main_effects_acc <span class="ot">&lt;-</span> <span class="fu">GetRamps</span>(<span class="at">vec =</span> dat[, acc], <span class="at">vecname =</span> <span class="st">"acc"</span>, <span class="at">np =</span> num_periods, <span class="at">scaling =</span> rho_factor_list[[<span class="st">"acc"</span>]])</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>main_effects_dev <span class="ot">&lt;-</span> <span class="fu">GetRamps</span>(<span class="at">vec =</span> dat[, dev], <span class="at">vecname =</span> <span class="st">"dev"</span>, <span class="at">np =</span> num_periods, <span class="at">scaling =</span> rho_factor_list[[<span class="st">"dev"</span>]])</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>main_effects_cal <span class="ot">&lt;-</span> <span class="fu">GetRamps</span>(<span class="at">vec =</span> dat[, cal], <span class="at">vecname =</span> <span class="st">"cal"</span>, <span class="at">np =</span> num_periods, <span class="at">scaling =</span> rho_factor_list[[<span class="st">"cal"</span>]])</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>                             </span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>main_effects <span class="ot">&lt;-</span> <span class="fu">cbind</span>(main_effects_acc, main_effects_dev, main_effects_cal)</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a><span class="co"># interaction effects</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>int_effects <span class="ot">&lt;-</span> <span class="fu">cbind</span>(</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GetInts</span>(<span class="at">vec1=</span>dat[, acc], <span class="at">vecname1=</span><span class="st">"acc"</span>, <span class="at">scaling1=</span>rho_factor_list[[<span class="st">"acc"</span>]], <span class="at">np=</span>num_periods, </span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>            <span class="at">vec2=</span>dat[, dev], <span class="at">vecname2=</span><span class="st">"dev"</span>, <span class="at">scaling2=</span>rho_factor_list[[<span class="st">"dev"</span>]]),</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GetInts</span>(<span class="at">vec1=</span>dat[, dev], <span class="at">vecname1=</span><span class="st">"dev"</span>, <span class="at">scaling1=</span>rho_factor_list[[<span class="st">"dev"</span>]], <span class="at">np=</span>num_periods, </span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>            <span class="at">vec2=</span>dat[, cal], <span class="at">vecname2=</span><span class="st">"cal"</span>, <span class="at">scaling2=</span>rho_factor_list[[<span class="st">"cal"</span>]]),</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GetInts</span>(<span class="at">vec1=</span>dat[, acc], <span class="at">vecname1=</span><span class="st">"acc"</span>, <span class="at">scaling1=</span>rho_factor_list[[<span class="st">"acc"</span>]], <span class="at">np=</span>num_periods, </span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>            <span class="at">vec2=</span>dat[, cal], <span class="at">vecname2=</span><span class="st">"cal"</span>, <span class="at">scaling2=</span>rho_factor_list[[<span class="st">"cal"</span>]])</span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>varset <span class="ot">&lt;-</span> <span class="fu">cbind</span>(main_effects, int_effects)</span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a><span class="co"># drop any constant columns over the training data set</span></span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a><span class="co"># do this by identifying the constant columns and dropping them</span></span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>varset_train <span class="ot">&lt;-</span> varset[dat<span class="sc">$</span>train_ind, ]</span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>rm_cols <span class="ot">&lt;-</span> varset_train[, <span class="fu">apply</span>(varset_train, <span class="at">MARGIN=</span><span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">max</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">==</span> <span class="fu">min</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))]</span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>varset <span class="ot">&lt;-</span> varset[, <span class="sc">!</span>(<span class="fu">colnames</span>(varset) <span class="sc">%in%</span> <span class="fu">colnames</span>(rm_cols))]</span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a><span class="co"># now add these variables into an extended data object</span></span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a><span class="co"># remove anything not used in modelling</span></span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a>dat_plus <span class="ot">&lt;-</span> <span class="fu">cbind</span>(dat[, .(pmts, train_ind, row_id)], varset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="mlr3-setup-for-lasso" class="level3" data-number="9.7.9">
<h3 data-number="9.7.9" class="anchored" data-anchor-id="mlr3-setup-for-lasso"><span class="header-section-number">9.7.9</span> mlr3 setup for LASSO</h3>
<p>First we need to set up a task. This differs from the tree-based models task as follows in that the input variables are all the basis functions we created and not the raw accident / development / calendar quarter terms - the <code>dat_plus</code> data.table.</p>
<p>Also we don’t need to set up a cross-validation resampling for this task since the <strong>glmnet</strong> package has in-built cross-validation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>task_lasso <span class="ot">&lt;-</span> TaskRegr<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"reserves_lasso"</span>, <span class="at">backend =</span> dat_plus, <span class="at">target =</span> <span class="st">"pmts"</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="co"># sort out row and column roles</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>task_lasso<span class="sc">$</span><span class="fu">set_row_roles</span>(dat[train_ind<span class="sc">==</span><span class="cn">FALSE</span>, row_id], <span class="at">roles=</span><span class="st">"holdout"</span>)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="co"># turn row_id into a name</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>task_lasso<span class="sc">$</span><span class="fu">set_col_roles</span>(<span class="st">"row_id"</span>, <span class="at">roles=</span><span class="st">"name"</span>)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="co"># drop train_ind from the feature list</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>task_lasso<span class="sc">$</span>col_roles<span class="sc">$</span>feature <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(task_lasso<span class="sc">$</span>feature_names, <span class="st">"train_ind"</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="model-fitting" class="level3" data-number="9.7.10">
<h3 data-number="9.7.10" class="anchored" data-anchor-id="model-fitting"><span class="header-section-number">9.7.10</span> Model fitting</h3>
<p>As noted above, the <strong>glmnet</strong> package has an inbuilt cross-validation function to fit LASSO models so we’ll use that rather than running cross validation via <strong>mlr3</strong>. We’ll use a Poisson distribution so the cross-validation will look to minimise the Poisson deviance.</p>
<p>The results will not be identical to those in the paper - that used 8-fold cross-validation and, even if the number of folds were the same, the random number seeds will be different, so the composition of the folds would be different.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>use_pmax  <span class="ot">&lt;-</span> num_periods<span class="sc">^</span><span class="dv">2</span>   <span class="co"># max number of variables ever to be nonzero</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>use_dfmax <span class="ot">&lt;-</span> num_periods<span class="sc">*</span><span class="dv">10</span>  </span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">777</span>)  <span class="co"># for reproducibility</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="co"># create the mlr3 learner</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>lrn_cv_glmnet <span class="ot">&lt;-</span> <span class="fu">lrn</span>(</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"regr.cv_glmnet"</span>, </span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"poisson"</span>,   </span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">nfolds =</span> <span class="dv">6</span>,</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">thresh =</span> <span class="fl">1e-08</span>, </span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda.min.ratio =</span> <span class="dv">0</span>,</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># additional parameter for mlr3 - means that the model used when predicting is the min CV error model rather than default 1se model</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">s=</span><span class="st">"lambda.min"</span>,   </span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">dfmax =</span> use_dfmax, </span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">pmax =</span> use_pmax, </span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="dv">1</span>, </span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">standardize =</span> <span class="cn">FALSE</span>, </span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">maxit =</span> <span class="dv">200000</span>)    </span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a><span class="co"># train the model</span></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>lrn_cv_glmnet<span class="sc">$</span><span class="fu">train</span>(task_lasso)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>s</code> parameter requires a little more explanation. The <code>regr.cv_glmnet</code> learner (which uses the <code>cv_glmnet()</code> function) fits models for many different possible penalty values (termed the <code>lambda</code> vector). For each of these, the average error is calculated across all folds. These are then plotted (together with error bars in the special plot created when we plot a <code>cv.glmnet</code> results object).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the path includes a minimum value of error</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(lrn_cv_glmnet<span class="sc">$</span>model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_mlr3example_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The two dotted lines in this plot represent two special penalty (or <code>lambda</code> values):</p>
<ul>
<li>the <code>lambda.min</code> value - the penalty value which has the lowest cross-validation error (the left-most dotted line)</li>
<li>the <code>lambda.1se</code> value - the penalty value where the cross-validation error is 1 standard error from the minimum value and the model is simpler (the right-most dotted line).</li>
</ul>
<p>These names come from the <strong>glmnet</strong> package - <code>cv.glmnet</code> objects include these values. It’s important to check that a true minimum has been found - if the left-most line (the <code>lambda.min</code> value) is the final value where the penalty is lowest, this suggests that the <code>lambda</code> vector needs to be lengthened and have smaller values than the current minimum. It’s possible to supply a user-defined vector of penalty values in this case.</p>
<p>When working directly with <strong>glmnet</strong> we can easily access the model corresponding to any parameter value. When using <code>regr.cvglmnet</code> in <strong>mlr3</strong>, we need to specify which penalty value to use for predictions. By default, the <strong>mlr3</strong> <code>predict</code> method uses <code>lambda.1se</code>, so we specify <code>s="lambda.min"</code> to use the <code>lambda.min</code> value as in the LASSO blog post.</p>
<p>Now we add the predictions to the <code>model_forecasts</code> table.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>model_forecasts[, lrn_cv_glmnet<span class="sc">$</span>id <span class="sc">:</span><span class="er">=</span> lrn_cv_glmnet<span class="sc">$</span><span class="fu">predict</span>(task_lasso, <span class="at">row_ids =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(dat))<span class="sc">$</span>response]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="model-analysis" class="level2" data-number="9.8">
<h2 data-number="9.8" class="anchored" data-anchor-id="model-analysis"><span class="header-section-number">9.8</span> Model analysis</h2>
<p>This is the interesting bit - let’s look at all the models to see how they’ve performed (but remember not to draw too many conclusions about model performance from this example as discussed earlier!)</p>
<p>Before we go any further though, we will make a long version of the data set (1 model result per row) as that will make a lot of calculations easier. data.table has a <code>melt</code> method for doing this. Tidyverse users may be more familiar with <code>pivot_longer()</code> which also does the same thing.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get list of variables to form observations by - this is why we used a common naming structure</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>model_names <span class="ot">&lt;-</span> <span class="fu">names</span>(model_forecasts)[ <span class="fu">names</span>(model_forecasts) <span class="sc">%like%</span> <span class="st">"regr"</span>]</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co"># wide -&gt; long</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>model_forecasts_long <span class="ot">&lt;-</span> <span class="fu">melt</span>(model_forecasts, </span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>                             <span class="at">measure.vars =</span> model_names, </span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>                             <span class="at">id.vars=</span><span class="fu">c</span>(<span class="st">"acc"</span>, <span class="st">"dev"</span>, <span class="st">"cal"</span>, <span class="st">"pmts"</span>, <span class="st">"train_ind"</span>))</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="co"># rename columns</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(model_forecasts_long, <span class="fu">c</span>(<span class="st">"variable"</span>, <span class="st">"value"</span>), <span class="fu">c</span>(<span class="st">"model"</span>, <span class="st">"fitted"</span>))</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(model_forecasts_long)</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="do">##    acc dev cal       pmts train_ind      model   fitted</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="do">## 1:   1   1   1   242671.2      TRUE regr.rpart 18315018</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a><span class="do">## 2:   1   2   2   164001.3      TRUE regr.rpart 18315018</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a><span class="do">## 3:   1   3   3  3224477.8      TRUE regr.rpart 18315018</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a><span class="do">## 4:   1   4   4  3682530.8      TRUE regr.rpart 18315018</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a><span class="do">## 5:   1   5   5 10149368.6      TRUE regr.rpart 18315018</span></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a><span class="do">## 6:   1   6   6 28578274.7      TRUE regr.rpart 18315018</span></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(model_forecasts_long)</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a><span class="do">##    acc dev cal      pmts train_ind          model    fitted</span></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a><span class="do">## 1:  40  35  74 125261750     FALSE regr.cv_glmnet 193852526</span></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a><span class="do">## 2:  40  36  75  62657370     FALSE regr.cv_glmnet 216713450</span></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a><span class="do">## 3:  40  37  76  63467681     FALSE regr.cv_glmnet 276806761</span></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a><span class="do">## 4:  40  38  77  26041979     FALSE regr.cv_glmnet 353563579</span></span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a><span class="do">## 5:  40  39  78  33947274     FALSE regr.cv_glmnet 451604591</span></span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a><span class="do">## 6:  40  40  79  37258687     FALSE regr.cv_glmnet 576831776</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s a reminder on the model names:</p>
<ul>
<li><code>regr.glm</code> - Chainladder</li>
<li><code>regr.cv_glmnet</code> - LASSO</li>
<li><code>regr.rpart</code> - decision tree</li>
<li><code>regr.ranger</code> - random forest</li>
<li><code>regr.xgboost</code> and <code>regr.xgboost_prev</code> - the two XGBoost models.</li>
</ul>
<section id="rmse" class="level3" data-number="9.8.1">
<h3 data-number="9.8.1" class="anchored" data-anchor-id="rmse"><span class="header-section-number">9.8.1</span> RMSE</h3>
<p>As discussed above, we are going to do these calculations manually rather than use the <strong>mlr3</strong> benchmark tools because we want to include the Chainladder and LASSO models as well (even though we’ve fitted them here using <strong>mlr3</strong>, we used separate tasks). In any case the calculations are easy to do in <strong>data.table</strong> (for those who know that package anyway!) and it can be helpful to see what’s going on..</p>
<p>For those who are unfamiliar, we’ve used a feature of data.table called chaining (similar in many ways to using the <code>%&gt;%</code> pipe, or the newly introduced base R pipe, <code>|&gt;</code>). The code does the following:</p>
<ul>
<li>the first line calculates <code>(fitted-pmts)^2</code> for each row of the long table (the squared error contribution)</li>
<li>the second line sums up all these contributions grouped by <code>model</code> and by <code>train_ind</code>. It also gets the count of values</li>
<li>the third line calculates the RMSE as the square root of these average contributions</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>model_rmse <span class="ot">&lt;-</span> model_forecasts_long[, se_contrib <span class="sc">:</span><span class="er">=</span> (fitted<span class="sc">-</span>pmts)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>                                   ][, .(<span class="at">se_contrib =</span> <span class="fu">sum</span>(se_contrib), <span class="at">num =</span> .N), by<span class="ot">=</span>.(model, train_ind)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>                                     ][, rmse <span class="sc">:</span><span class="er">=</span> <span class="fu">sqrt</span>(se_contrib <span class="sc">/</span> num)]</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(model_rmse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          model train_ind             se_contrib num       rmse
1:   regr.rpart      TRUE    3307128991724779520 820   63506568
2:   regr.rpart     FALSE 2864339162983414890466 780 1916306264
3:  regr.ranger      TRUE    3625163799701476352 820   66490085
4:  regr.ranger     FALSE  525256075856879353846 780  820612713
5: regr.xgboost      TRUE     825437127145255936 820   31727443
6: regr.xgboost     FALSE  215007724850275385344 780  525024694</code></pre>
</div>
</div>
<p>Let’s have a look at these results separately for past and future data sets with results ranked.</p>
<p><strong>Past data - train_ind == TRUE</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>model_rmse[train_ind<span class="sc">==</span><span class="cn">TRUE</span>, .(model, num, rmse)][<span class="fu">order</span>(rmse),] <span class="sc">|&gt;</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>() <span class="sc">|&gt;</span> </span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatRound</span>(<span class="st">"rmse"</span>, <span class="at">digits =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-ffcd71c060a4714b2f7e" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-ffcd71c060a4714b2f7e">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],["regr.xgboost_prev","regr.xgboost","regr.cv_glmnet","regr.rpart","regr.ranger","regr.glm"],[820,820,820,820,820,820],[31287526.23669044,31727443.05581634,46966366.66331225,63506567.6623271,66490085.44926514,138528927.1351613]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>model<\/th>\n      <th>num<\/th>\n      <th>rmse<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"targets":3,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 0, 3, \",\", \".\", null);\n  }"},{"className":"dt-right","targets":[2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":["options.columnDefs.0.render"],"jsHooks":[]}</script>
</div>
</div>
<p>On the training data, all the tuned models perform reasonably well, with the XGBoost models having the lowest RMSE, followed by the LASSO model. Unsurprisingly, the Chainladder model (regr.glm) has high RMSE - we know that these data will not be well modelled by a Chain ladder.</p>
<p>However, the key indicator is performance on a hold-out data set, in this case the future data.</p>
<p><strong>Future data - train_ind == FALSE</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>model_rmse[train_ind<span class="sc">==</span><span class="cn">FALSE</span>, .(model, num, rmse)][<span class="fu">order</span>(rmse),] <span class="sc">|&gt;</span> </span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>() <span class="sc">|&gt;</span> </span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatRound</span>(<span class="st">"rmse"</span>, <span class="at">digits =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-bdb8aee9d4577f96d6d4" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-bdb8aee9d4577f96d6d4">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],["regr.cv_glmnet","regr.xgboost","regr.xgboost_prev","regr.ranger","regr.glm","regr.rpart"],[780,780,780,780,780,780],[251388945.5939648,525024693.9861256,750897301.7702339,820612713.4388899,1722472389.667281,1916306263.6574]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>model<\/th>\n      <th>num<\/th>\n      <th>rmse<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"targets":3,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 0, 3, \",\", \".\", null);\n  }"},{"className":"dt-right","targets":[2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":["options.columnDefs.0.render"],"jsHooks":[]}</script>
</div>
</div>
<p>For the future data, we see a very different story. As expected, the tuned decision tree does appear to be over-fitted - it performs poorer than the default decision tree. The LASSO model is the best, followed by the previously tuned XGBoost model. Despite having similar hyper-parameters, the two XGBoost models perform differently.</p>
</section>
<section id="visualising-the-fit" class="level3" data-number="9.8.2">
<h3 data-number="9.8.2" class="anchored" data-anchor-id="visualising-the-fit"><span class="header-section-number">9.8.2</span> Visualising the fit</h3>
<p>Although useful, the RMSE is just a single number so it’s helpful to visualise the fit. In particular, because these are models for a reserving data set, we can take advantage of that structure when analysing how well each model is performing.</p>
<section id="fitted-values" class="level4" data-number="9.8.2.1">
<h4 data-number="9.8.2.1" class="anchored" data-anchor-id="fitted-values"><span class="header-section-number">9.8.2.1</span> Fitted values</h4>
<p>First, lets show visualise the fitted payments. The graphs below show the log(fitted values), or log(payments) in the case of the actual values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add in the actual values for comparison</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>actuals <span class="ot">&lt;-</span> model_forecasts_long[model<span class="sc">==</span><span class="st">"regr.glm"</span>,]</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>actuals[, model <span class="sc">:</span><span class="er">=</span> <span class="st">"actual"</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>        ][, fitted <span class="sc">:</span><span class="er">=</span> pmts]</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>model_forecasts_long_plot <span class="ot">&lt;-</span> <span class="fu">rbind</span>(actuals, model_forecasts_long)</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate log_fitted</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>model_forecasts_long_plot[, log_fitted <span class="sc">:</span><span class="er">=</span> <span class="fu">log</span>(<span class="fu">pmax</span>(<span class="dv">1</span>, fitted))]</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(model_forecasts_long_plot, <span class="fu">aes</span>(dev, acc)) <span class="sc">+</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_reverse</span>() <span class="sc">+</span></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>(<span class="fu">aes</span>(<span class="at">fill =</span> log_fitted)) <span class="sc">+</span></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>model, <span class="at">ncol=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">begin=</span><span class="dv">1</span>, <span class="at">end=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>num_periods<span class="sc">+</span><span class="dv">1</span><span class="sc">-</span>acc, <span class="at">y=</span>acc), <span class="at">colour=</span>dgrey, <span class="at">size=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()<span class="sc">+</span></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">8</span>,<span class="at">colour=</span>dgrey), <span class="at">strip.background =</span> <span class="fu">element_rect</span>(<span class="at">colour=</span><span class="st">"white"</span>, <span class="at">fill=</span><span class="st">"white"</span>))<span class="sc">+</span></span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">8</span>), <span class="at">axis.text.x  =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">7</span>))<span class="sc">+</span></span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">8</span>), <span class="at">axis.text.y  =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">7</span>))<span class="sc">+</span></span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="fu">element_line</span>(<span class="at">size=</span><span class="fl">0.25</span>, <span class="at">colour=</span>dgrey))<span class="sc">+</span></span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="fu">c</span>(<span class="fl">0.75</span>, <span class="fl">0.1</span>), <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>, <span class="at">legend.title=</span><span class="fu">element_blank</span>(), <span class="at">legend.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">8</span>))<span class="sc">+</span></span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">"Accident Quarter"</span>, <span class="at">y=</span><span class="st">"Development Quarter"</span>)<span class="sc">+</span></span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The `size` argument of `element_line()` is deprecated as of ggplot2 3.4.0.
ℹ Please use the `linewidth` argument instead.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="07_mlr3example_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Some things are apparent from this:</p>
<ul>
<li>The lack of interactions or diagonal effects in the Chain ladder (regr.glm)</li>
<li>All the machine learning models do detect and project the interaction</li>
<li>The blocky nature of the decision tree (regr.rpart) and the overfit to the past data</li>
<li>The random forest (regr.ranger) and XGBoost fit look smoother since they are a function of a number of trees.</li>
<li>The LASSO fit (regr.cv_glmnet) is the smoothest, which is not surprising since it consists of continuous functions.</li>
<li>Visually, the LASSO seems to capture the interaction the best.</li>
</ul>
</section>
<section id="actual-vs-fitted-heat-maps" class="level4" data-number="9.8.2.2">
<h4 data-number="9.8.2.2" class="anchored" data-anchor-id="actual-vs-fitted-heat-maps"><span class="header-section-number">9.8.2.2</span> Actual vs Fitted heat maps</h4>
<p>We can also look at the model fits via heat maps of the actual/fitted values. The function defined below calculates the actual/fitted values, capping and collaring them at 400% and 25%. The values are then shaded so that:</p>
<ul>
<li>Dark blue = 25%</li>
<li>White = 100%</li>
<li>Dark red = 400%</li>
</ul>
<p>For triangular reserving data, these types of plots are very helpful when examining plot fit.</p>
<p>First, here’s a function to draw the heatmaps.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># heat maps</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>GraphHeatMap <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, <span class="at">x=</span><span class="st">"dev"</span>, <span class="at">y=</span><span class="st">"acc"</span>, <span class="at">facet=</span><span class="st">"model"</span>, actual, fitted, <span class="at">lims=</span><span class="fu">c</span>(<span class="fl">0.25</span>, <span class="dv">4</span>),</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">xlab=</span><span class="st">"Development quarter"</span>, <span class="at">ylab=</span><span class="st">"Accident Quarter"</span>){</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># copy data to avoid modifying original</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>  localdat <span class="ot">&lt;-</span> <span class="fu">copy</span>(dat)</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get fails if there is a variable with the same name so make local copies</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>  local_x <span class="ot">&lt;-</span> x</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>  local_y <span class="ot">&lt;-</span> y</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>  local_actual <span class="ot">&lt;-</span> actual</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>  local_fitted <span class="ot">&lt;-</span> fitted</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make restricted Avs F for heatmap and set up past/future split line</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>  np <span class="ot">&lt;-</span> <span class="fu">max</span>(localdat[[y]])</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>  localdat[, .avsf <span class="sc">:</span><span class="er">=</span> <span class="fu">get</span>(local_actual) <span class="sc">/</span> <span class="fu">get</span>(local_fitted)</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>           ][, .avsf_restrict_log <span class="sc">:</span><span class="er">=</span> <span class="fu">log</span>(<span class="fu">pmax</span>(<span class="fu">min</span>(lims), <span class="fu">pmin</span>(<span class="fu">max</span>(lims), .avsf)))</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>             ][, .past_line <span class="sc">:</span><span class="er">=</span> np <span class="sc">+</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">get</span>(local_y)]</span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>localdat, <span class="fu">aes_string</span>(<span class="at">x=</span>local_x, <span class="at">y=</span>local_y)) <span class="sc">+</span></span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> .avsf_restrict_log))<span class="sc">+</span><span class="fu">scale_y_reverse</span>()<span class="sc">+</span></span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span><span class="fu">get</span>(facet), <span class="at">ncol=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>()<span class="sc">+</span></span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradient2</span>(<span class="at">name=</span><span class="st">"AvF_min"</span>, <span class="at">low=</span>mblue, <span class="at">mid=</span><span class="st">"white"</span>, <span class="at">high=</span>red, <span class="at">midpoint=</span><span class="dv">0</span>, <span class="at">space=</span><span class="st">"Lab"</span>, <span class="at">na.value=</span><span class="st">"grey50"</span>, <span class="at">guide=</span><span class="st">"colourbar"</span>)<span class="sc">+</span></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x=</span>xlab, <span class="at">y=</span>ylab)<span class="sc">+</span></span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes_string</span>(<span class="at">x=</span><span class="st">".past_line"</span>, <span class="at">y=</span>local_y), <span class="at">colour=</span>dgrey, <span class="at">size=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">8</span>,<span class="at">colour=</span><span class="st">"grey30"</span>), <span class="at">strip.background =</span> <span class="fu">element_rect</span>(<span class="at">colour=</span><span class="st">"white"</span>, <span class="at">fill=</span><span class="st">"white"</span>))<span class="sc">+</span></span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">8</span>), <span class="at">axis.text.x  =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">7</span>))<span class="sc">+</span></span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">8</span>), <span class="at">axis.text.y  =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">7</span>))<span class="sc">+</span></span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="fu">element_line</span>(<span class="at">size=</span><span class="fl">0.25</span>, <span class="at">colour=</span><span class="st">"grey30"</span>))<span class="sc">+</span></span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"none"</span>, )<span class="sc">+</span>  <span class="co"># legend.direction = "horizontal", legend.title=element_blank(), legend.text=element_text(size=8)</span></span>
<span id="cb61-35"><a href="#cb61-35" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NULL</span>    </span>
<span id="cb61-36"><a href="#cb61-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-37"><a href="#cb61-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-38"><a href="#cb61-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="fu">list</span>(<span class="at">data=</span>localdat, <span class="at">graph=</span>g))</span>
<span id="cb61-39"><a href="#cb61-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-40"><a href="#cb61-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-41"><a href="#cb61-41" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">GraphHeatMap</span>(model_forecasts_long, <span class="at">x=</span><span class="st">"dev"</span>, <span class="at">y=</span><span class="st">"acc"</span>, <span class="at">facet=</span><span class="st">"model"</span>, <span class="at">actual=</span><span class="st">"pmts"</span>, <span class="at">fitted=</span><span class="st">"fitted"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: `aes_string()` was deprecated in ggplot2 3.0.0.
ℹ Please use tidy evaluation idioms with `aes()`.
ℹ See also `vignette("ggplot2-in-packages")` for more information.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>g<span class="sc">$</span>graph</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_mlr3example_files/figure-html/unnamed-chunk-53-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>All models have shortcomings, but the LASSO and previously tuned XGBoost models outperform the others.</p>
</section>
<section id="quarterly-tracking" class="level4" data-number="9.8.2.3">
<h4 data-number="9.8.2.3" class="anchored" data-anchor-id="quarterly-tracking"><span class="header-section-number">9.8.2.3</span> Quarterly tracking</h4>
<p>Finally, we will look at the predictions for specific parts of the data set. Quarterly tracking graphs:</p>
<ul>
<li>Plot the actual and fitted payments, including future values, by one of accident / development / calendar period</li>
<li>Hold one of the other triangle directions fixed, meaning that the third direction is then determined.</li>
<li>Additionally plot the underlying mean from which the data were simulated.</li>
</ul>
<p>We’ll use a couple of functions because we want to do this repeatedly.</p>
<p>The first function (<code>GraphModelVals</code>) is from the blog on the LASSO model, and draws a single tracking graph. The second function (<code>QTracking</code>) generates the graphs for all models and uses the <strong>patchwork</strong> package to wrap them into a single plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>GraphModelVals<span class="ot">&lt;-</span><span class="cf">function</span>(dat, primary_predictor, secondary_predictor, secondary_predictor_val, </span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>                         xaxis_label, yaxis_label, var_names, <span class="at">log_values =</span> <span class="cn">TRUE</span>, <span class="at">include_st=</span><span class="cn">FALSE</span>, <span class="at">include_legend=</span><span class="cn">FALSE</span>, <span class="at">font_size=</span><span class="dv">6</span>){</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># var_names must be list with names like this: list(actual="pmts", mean="mu", fitted="fitted")</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># extract data we want to use</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>  use_dat <span class="ot">&lt;-</span> dat[<span class="fu">get</span>(secondary_predictor) <span class="sc">==</span> secondary_predictor_val, ]</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># turn into long format using melt.data.table since that works better with ggplot</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>  dat_long <span class="ot">&lt;-</span> <span class="fu">melt</span>(dat[<span class="fu">get</span>(secondary_predictor) <span class="sc">==</span> secondary_predictor_val, ],</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>                   <span class="at">measure.vars =</span> <span class="fu">unlist</span>(var_names),</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>                   <span class="at">id.vars =</span> primary_predictor)</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make the names nicer - colnames and labels</span></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setnames</span>(dat_long, primary_predictor, <span class="st">"predictor"</span>)</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>  dat_long[variable <span class="sc">==</span> var_names<span class="sc">$</span>actual, variable <span class="sc">:</span><span class="er">=</span> <span class="st">"Simulated"</span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>           ][variable <span class="sc">==</span> var_names<span class="sc">$</span>mean, variable <span class="sc">:</span><span class="er">=</span> <span class="st">"Underlying"</span></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>             ][variable <span class="sc">==</span> var_names<span class="sc">$</span>fitted, variable <span class="sc">:</span><span class="er">=</span> <span class="st">"Fitted"</span>]</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get the levels of the variables right so that they are plotted in the right order</span></span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>  dat_long[, variable <span class="sc">:</span><span class="er">=</span> <span class="fu">factor</span>(variable, <span class="at">levels=</span><span class="fu">c</span>(<span class="st">"Fitted"</span>, <span class="st">"Simulated"</span>, <span class="st">"Underlying"</span>))]</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (log_values) dat_long[, value <span class="sc">:</span><span class="er">=</span> <span class="fu">log</span>(value)]</span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># figure out past data rectangle coordinates</span></span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a>  xmin1 <span class="ot">&lt;-</span> use_dat[train_ind <span class="sc">==</span> <span class="cn">TRUE</span>, <span class="fu">min</span>(<span class="fu">get</span>(primary_predictor))]</span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a>  xmax1 <span class="ot">&lt;-</span> use_dat[train_ind <span class="sc">==</span> <span class="cn">TRUE</span>, <span class="fu">max</span>(<span class="fu">get</span>(primary_predictor))]</span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a>  ymin1 <span class="ot">&lt;-</span> dat_long[, <span class="fu">min</span>(value)]<span class="sc">*</span><span class="fl">0.95</span></span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a>  ymax1 <span class="ot">&lt;-</span> dat_long[, <span class="fu">max</span>(value)]<span class="sc">*</span><span class="fl">1.05</span></span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># draw the tracking plots</span></span>
<span id="cb65-37"><a href="#cb65-37" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>dat_long, <span class="fu">aes</span>(<span class="at">x=</span>predictor, <span class="at">y=</span>value, <span class="at">group=</span>variable))<span class="sc">+</span></span>
<span id="cb65-38"><a href="#cb65-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">linetype=</span>variable, <span class="at">colour=</span>variable, <span class="at">size=</span>variable, <span class="at">alpha=</span>variable))<span class="sc">+</span></span>
<span id="cb65-39"><a href="#cb65-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">linetype=</span>variable, <span class="at">colour=</span>variable))<span class="sc">+</span></span>
<span id="cb65-40"><a href="#cb65-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">name=</span><span class="st">""</span>, <span class="at">values=</span><span class="fu">c</span>(red, dgrey, dgrey))<span class="sc">+</span></span>
<span id="cb65-41"><a href="#cb65-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_linetype_manual</span>(<span class="at">name=</span><span class="st">""</span>, <span class="at">values=</span><span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"solid"</span>, <span class="st">"dotted"</span>))<span class="sc">+</span></span>
<span id="cb65-42"><a href="#cb65-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_size_manual</span>(<span class="at">name=</span><span class="st">""</span>, <span class="at">values=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>))<span class="sc">+</span></span>
<span id="cb65-43"><a href="#cb65-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_alpha_manual</span>(<span class="at">name=</span><span class="st">""</span>, <span class="at">values=</span><span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>))<span class="sc">+</span></span>
<span id="cb65-44"><a href="#cb65-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>()<span class="sc">+</span></span>
<span id="cb65-45"><a href="#cb65-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="at">geom=</span><span class="st">"rect"</span>, <span class="at">xmin=</span>xmin1, <span class="at">xmax=</span>xmax1, <span class="at">ymin=</span>ymin1, <span class="at">ymax=</span>ymax1, <span class="at">alpha=</span><span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb65-46"><a href="#cb65-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x=</span>xaxis_label, <span class="at">y=</span>yaxis_label, <span class="at">title=</span><span class="fu">paste</span>(xaxis_label, <span class="st">"tracking for"</span>, secondary_predictor, <span class="st">"="</span>, secondary_predictor_val)) <span class="sc">+</span></span>
<span id="cb65-47"><a href="#cb65-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> font_size), <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> font_size<span class="dv">-1</span>))</span>
<span id="cb65-48"><a href="#cb65-48" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb65-49"><a href="#cb65-49" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(include_st<span class="sc">==</span><span class="cn">TRUE</span>) g <span class="ot">&lt;-</span> g <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">subtitle=</span><span class="st">"Past data in grey rectangle"</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">plot.subtitle =</span> <span class="fu">element_text</span> (<span class="at">size =</span> font_size))</span>
<span id="cb65-50"><a href="#cb65-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-51"><a href="#cb65-51" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="cf">if</span>(include_legend<span class="sc">==</span><span class="cn">TRUE</span>) g <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="fu">c</span>(<span class="fl">1.5</span>, <span class="fl">0.5</span>)) <span class="cf">else</span> g <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb65-52"><a href="#cb65-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-53"><a href="#cb65-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-54"><a href="#cb65-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-55"><a href="#cb65-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return the results  </span></span>
<span id="cb65-56"><a href="#cb65-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="fu">list</span>(<span class="at">data=</span>dat_long, <span class="at">graph=</span>g))</span>
<span id="cb65-57"><a href="#cb65-57" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s have a look at the tracking for accident quarter when development quarter = 5. We’ll wrap this in another function since we want to call this for a few different combinations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>QTracking <span class="ot">&lt;-</span> <span class="cf">function</span>(dat,</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>                      model_names,</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>                      primary_predictor,</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>                      secondary_predictor,</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>                      secondary_predictor_val,</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>                      xaxis_label,</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>                      <span class="at">yaxis_label =</span> <span class="st">"Log(Payments)"</span>,</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>                      <span class="at">font_size =</span> <span class="dv">8</span>,</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">plots_ncol=</span><span class="dv">2</span>){</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># hold each plot</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>  tracking_g <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># produce each plot  </span></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (model <span class="cf">in</span> model_names){</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># variable names in plot</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>    vn <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">actual=</span><span class="st">"pmts"</span>, <span class="at">mean=</span><span class="st">"mu"</span>, <span class="at">fitted=</span>model)</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># include subtitle or not in the graph (first plot only)</span></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>    bool_st <span class="ot">&lt;-</span> <span class="cf">if</span>(model <span class="sc">==</span> model_names[<span class="dv">1</span>]) <span class="cn">TRUE</span> <span class="cf">else</span> <span class="cn">FALSE</span></span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># include legend or not in the graph (last plot only)</span></span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>    bool_legend <span class="ot">&lt;-</span> <span class="cf">if</span>(model <span class="sc">==</span> model_names[<span class="fu">length</span>(model_names)]) <span class="cn">TRUE</span> <span class="cf">else</span> <span class="cn">FALSE</span></span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># draw plot</span></span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>    tracking_g[[model]] <span class="ot">&lt;-</span> <span class="fu">GraphModelVals</span>(dat, </span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">primary_predictor =</span> primary_predictor, </span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">secondary_predictor =</span> secondary_predictor, </span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">secondary_predictor_val =</span> secondary_predictor_val, </span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">xaxis_label =</span> xaxis_label, </span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">yaxis_label =</span> yaxis_label, </span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">var_names =</span> vn, </span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">include_st =</span> bool_st, </span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">include_legend =</span> bool_legend,</span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">font_size =</span> font_size)<span class="sc">$</span>graph <span class="sc">+</span></span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Modelled values for"</span>, model)) <span class="sc">+</span> </span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span> (<span class="at">plot.title =</span> <span class="fu">element_text</span> (<span class="at">size =</span> (font_size<span class="sc">+</span><span class="dv">1</span>)))</span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># use patchwork to wrap all plots into a single display  </span></span>
<span id="cb66-42"><a href="#cb66-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">wrap_plots</span>(tracking_g, <span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb66-43"><a href="#cb66-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-44"><a href="#cb66-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-45"><a href="#cb66-45" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">QTracking</span>(model_forecasts,</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">model_names =</span> model_names,</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">primary_predictor =</span> <span class="st">"acc"</span>,</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">secondary_predictor =</span> <span class="st">"dev"</span>,</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">secondary_predictor_val =</span> <span class="dv">5</span>,</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">xaxis_label =</span> <span class="st">"Accident Quarter"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_mlr3example_files/figure-html/unnamed-chunk-56-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>Because this is mostly old data and because it is not affected by the interaction, the tracking should be generally good, even for the Chain ladder - which is the case (apart from the final quarter being a bit wild as can happen with a Chain ladder). The decision tree model is poor, the random forest and XGBoost model show some evidence of overfitting. The LASSO model seems to strike the right balance.</p>
<p>Here are a few more tracking plots to help further illustrate the model fits.</p>
<p><strong>Tracking for accident quarter when development quarter = 24</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">QTracking</span>(model_forecasts,</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">model_names =</span> model_names,</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">primary_predictor =</span> <span class="st">"acc"</span>,</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">secondary_predictor =</span> <span class="st">"dev"</span>,</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">secondary_predictor_val =</span> <span class="dv">24</span>,</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">xaxis_label =</span> <span class="st">"Accident Quarter"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_mlr3example_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>Development quarter 24 is impacted by the interactions for accident quarters&gt;17. All models reflect this to different extents, with XGBoost and the LASSO doing the best.</p>
<p><strong>Tracking for accident quarter when development quarter = 35</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">QTracking</span>(model_forecasts,</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">model_names =</span> model_names,</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">primary_predictor =</span> <span class="st">"acc"</span>,</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">secondary_predictor =</span> <span class="st">"dev"</span>,</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">secondary_predictor_val =</span> <span class="dv">35</span>,</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">xaxis_label =</span> <span class="st">"Accident Quarter"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_mlr3example_files/figure-html/unnamed-chunk-58-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>This is quite hard for the models since most of the values are in the future. XGBoost (previously tuned) and the LASSO are the best here.</p>
<p>We can look at similar plots by development quarter for older and newer accident quarters</p>
<p><strong>Tracking for development quarter when accident quarter = 5</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">QTracking</span>(model_forecasts,</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">model_names =</span> model_names,</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">primary_predictor =</span> <span class="st">"dev"</span>,</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">secondary_predictor =</span> <span class="st">"acc"</span>,</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">secondary_predictor_val =</span> <span class="dv">5</span>,</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">xaxis_label =</span> <span class="st">"Development Quarter"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_mlr3example_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p><strong>Tracking for development quarter when accident quarter = 20</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">QTracking</span>(model_forecasts,</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">model_names =</span> model_names,</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">primary_predictor =</span> <span class="st">"dev"</span>,</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">secondary_predictor =</span> <span class="st">"acc"</span>,</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">secondary_predictor_val =</span> <span class="dv">20</span>,</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">xaxis_label =</span> <span class="st">"Development Quarter"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_mlr3example_files/figure-html/unnamed-chunk-60-1.png" class="img-fluid" width="768"></p>
</div>
</div>
</section>
</section>
</section>
<section id="reserves" class="level2" data-number="9.9">
<h2 data-number="9.9" class="anchored" data-anchor-id="reserves"><span class="header-section-number">9.9</span> Reserves</h2>
<p>Finally, we’ll look at the reserve estimates from the different models. For convenience, here’s the mapping of model name to model type again:</p>
<ul>
<li><code>regr.glm</code> - Chainladder</li>
<li><code>regr.cv_glmnet</code> - LASSO</li>
<li><code>regr.rpart</code> - decision tree</li>
<li><code>regr.ranger</code> - random forest</li>
<li><code>regr.xgboost</code> and <code>regr.xgboost_prev</code> - the two XGBoost models.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># summarise the future payments and each model projection by accident quarter</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="co"># remember ml is a character vector of all the model names, which are columns of</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   fitted values in model_forecasts</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="co"># get reserves and payments by accident quarter</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>os_acc <span class="ot">&lt;-</span> model_forecasts_long[train_ind <span class="sc">==</span> <span class="cn">FALSE</span>, .(<span class="at">actual=</span><span class="fu">sum</span>(pmts)<span class="sc">/</span><span class="fl">1e9</span>, <span class="at">reserve=</span><span class="fu">sum</span>(fitted)<span class="sc">/</span><span class="fl">1e9</span>), by<span class="ot">=</span>.(model, acc)]</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="co"># make full tidy data set by stacking actuals</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>os_acc <span class="ot">&lt;-</span> <span class="fu">rbind</span>(os_acc[model<span class="sc">==</span><span class="st">"regr.glm"</span>,][, <span class="at">reserve :=</span> actual][, <span class="at">model :=</span> <span class="st">"actual"</span>],</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>                os_acc)</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a><span class="co"># adjust levels of factor to ger correct ordering</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>os_acc[, model <span class="sc">:</span><span class="er">=</span> <span class="fu">factor</span>(<span class="fu">as.character</span>(model), <span class="at">level=</span><span class="fu">c</span>(<span class="st">"actual"</span>, <span class="st">"regr.cv_glmnet"</span>, <span class="st">"regr.glm"</span>, <span class="st">"regr.ranger"</span>, </span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>                                                      <span class="st">"regr.rpart"</span>, <span class="st">"regr.xgboost"</span>, <span class="st">"regr.xgboost_prev"</span>))]</span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(os_acc, model, acc)</span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a><span class="co"># create a factor variable from model so we can order it in the plot as we wish</span></span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>g1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>os_acc, <span class="fu">aes</span>(<span class="at">x=</span>acc, <span class="at">y=</span>reserve, <span class="at">group=</span>model)) <span class="sc">+</span></span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">linetype=</span>model, <span class="at">colour=</span>model, <span class="at">size=</span>model, <span class="at">alpha=</span>model))<span class="sc">+</span></span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">name=</span><span class="st">""</span>, <span class="at">values=</span><span class="fu">c</span>(dgrey, red, dgrey, fuscia, dgrey, mblue, gold))<span class="sc">+</span></span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">name=</span><span class="st">""</span>, <span class="at">values=</span><span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"solid"</span>, <span class="st">"dotted"</span>, <span class="st">"dotdash"</span>, <span class="st">"dashed"</span>, <span class="st">"longdash"</span>, <span class="st">"solid"</span>))<span class="sc">+</span></span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_manual</span>(<span class="at">name=</span><span class="st">""</span>, <span class="at">values=</span><span class="fu">c</span>(<span class="fl">2.5</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="fl">1.25</span>, <span class="dv">1</span>, <span class="fl">1.25</span>, <span class="fl">1.5</span>))<span class="sc">+</span></span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">name=</span><span class="st">""</span>, <span class="at">values=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.9</span>, <span class="fl">0.5</span>, <span class="fl">0.7</span>, <span class="fl">0.5</span>, <span class="fl">0.7</span>, <span class="fl">0.9</span>))<span class="sc">+</span></span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">100</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">40</span>))<span class="sc">+</span></span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)<span class="sc">+</span></span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"Reserve (Bn)"</span>, <span class="at">x=</span><span class="st">"Accident Quarter"</span>)<span class="sc">+</span></span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NULL</span></span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a>g1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_mlr3example_files/figure-html/unnamed-chunk-61-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Let’s look at a zoomed in version of this plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>g1 <span class="sc">+</span> <span class="fu">coord_cartesian</span>(<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">40</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">40</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_mlr3example_files/figure-html/unnamed-chunk-62-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Finally, here are the overall reserves, summed over all accident quarters</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>os <span class="ot">&lt;-</span> os_acc[, .(<span class="at">reserve=</span><span class="fu">sum</span>(reserve), <span class="at">actual=</span><span class="fu">sum</span>(actual)), by<span class="ot">=</span>.(model)]</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>os[, ratio <span class="sc">:</span><span class="er">=</span> reserve <span class="sc">/</span> actual][, actual <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="co"># sort</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>os[, ratio_diff <span class="sc">:</span><span class="er">=</span> <span class="fu">abs</span>(ratio<span class="dv">-100</span>)]</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>os <span class="ot">&lt;-</span> os[<span class="fu">order</span>(ratio_diff)][, ratio_diff <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a><span class="co"># output table</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(os, <span class="fu">c</span>(<span class="st">"model"</span>, <span class="st">"reserve"</span>, <span class="st">"ratio"</span>), <span class="fu">c</span>(<span class="st">"Model"</span>, <span class="st">"Reserve(Bn)"</span>, <span class="st">"Ratio to actual(%)"</span>))</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>os <span class="sc">|&gt;</span> </span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>() <span class="sc">|&gt;</span> </span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatRound</span>(<span class="st">"Reserve(Bn)"</span>, <span class="at">digits =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatPercentage</span>(<span class="st">"Ratio to actual(%)"</span>, <span class="at">digits =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-ee91a2ee24c81ec32bf2" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-ee91a2ee24c81ec32bf2">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7"],["regr.rpart","regr.xgboost_prev","regr.ranger","regr.xgboost","regr.cv_glmnet","actual","regr.glm"],[1680.145847816887,931.6348768207499,845.1389739097615,774.8098594735626,627.6456864709465,608.4863200373112,563.0650857197218],[2.761189187809291,1.531069551019033,1.388920253553012,1.273339817115449,1.031486930441527,1,0.9253537297029055]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Model<\/th>\n      <th>Reserve(Bn)<\/th>\n      <th>Ratio to actual(%)<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"targets":3,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatPercentage(data, 0, 3, \",\", \".\", null);\n  }"},{"targets":2,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 1, 3, \",\", \".\", null);\n  }"},{"className":"dt-right","targets":[2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":["options.columnDefs.0.render","options.columnDefs.1.render"],"jsHooks":[]}</script>
</div>
</div>
<p>The best performers are the LASSO and the previously tuned XGBoost model. The overall reserve for the Chainladder model (regr.glm) hides the fact that this result is actually significant under-estimation in most accident quarters balanced by significant over-estimation in the last.</p>
</section>
<section id="commentary" class="level2" data-number="9.10">
<h2 data-number="9.10" class="anchored" data-anchor-id="commentary"><span class="header-section-number">9.10</span> Commentary</h2>
<p>What’s going on with the XGBoost results?</p>
<p>As we noted when we fitted the XGBoost model, there are a few components of randomness from one run to another, with different seeds:</p>
<ol type="1">
<li>The cross validation folds will be different</li>
<li>The random search parameters will be different.</li>
</ol>
<p>For a small data set like this one, this has the potential to alter the results - afterall, getting a good result on the future data depends on whether the tuning gets lucky in terms of estimating the magnitude of the interaction.</p>
<p>We could reduce the variability by uisng a grid-search over a fixed set of parameters but - full disclosure - that led to even worse results.</p>
<p>So what’s going on? It might be helpful to have another look at the folds used in the cross-validation. These are shown below - the yellow dots represent training data points in each fold, the blue dots are the test data. The grey rectangle marks the interaction.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="07_mlr3example_files/figure-html/unnamed-chunk-65-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The first thing that is apparent is that the interaction only applies to a very small number of points (10) in the past data. So in that sense, it’s quite remarkable that the models perform as well as they actually do - they all detect the interaction. Where they start to slip up is that they do not necessarily follow the development quarter shape in the tail.</p>
<p>With cross-validation, all points are in the test data set once and once only. So it seems to be the case that the particular allocation of data into folds in this notebook leads to poorer results for the XGBoost model. In other words, in our previous tuning for XGBoost we got lucky.</p>
<p>So far, XGBoost seems to be the only model impacted in this way. Based on looking at a few different sets of results, the LASSO model has generally been good for different folds and for 5-, 6- and 8-fold validation. The performance of the ranger model doesn’t appear to change all that much.</p>
<p>However, given XGBoost’s popularity and flexibility, this result is not ideal. The question is: can we improve matters?</p>
<p>Success in machine learning often comes down to optimising the following:</p>
<ul>
<li>What you model</li>
<li>How you model (i.e.&nbsp;what features you use)</li>
<li>Your performance measure</li>
<li>Your train/test split.</li>
</ul>
<p>Reserving is a forecasting problem - we have a time series of payments and we want to forecast into the future. This suggests that cross-validation is not an ideal method for tuning reserving models - we would be better with a train/test split where the test data is in the future relative to the past data.</p>
<p>This problem has been discussed in the context of time series modelling, where the use of rolling window cross-validation techniques has been advocated. We’ll be discussing this in a future article.</p>
</section>
<section id="conclusion" class="level2" data-number="9.11">
<h2 data-number="9.11" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">9.11</span> Conclusion</h2>
<p>We set out to demonstrate how to fit a number of reserving models to a data set. Our results have been mixed - but we expected that in advance. This work lays a baseline for our upcoming articles where we will look at ways of improving the results through:</p>
<ul>
<li>expanding the range of models</li>
<li>considering more appropriate validation techniques.</li>
</ul>
<section id="what-next" class="level3" data-number="9.11.1">
<h3 data-number="9.11.1" class="anchored" data-anchor-id="what-next"><span class="header-section-number">9.11.1</span> What next?</h3>
<p>You can try running this code and changing some things - e.g.&nbsp;the hyper-parameters tuned, search strategy, number of iterations etc.</p>
<p>You can also try running the code for different data sets. It’s best to initially work with data sets that are familiar to you, so your own data sets or other simulated data sets may be useful here. In the code block below, we’ve shared the code used to generate the data set we used. You can generate other data sets as described in the <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3241906">LASSO paper</a> using the code block below. More details are in the paper, but in brief:</p>
<ul>
<li>Data set 1 = a Chainladder model</li>
<li>Data set 2 = a Chainladder model + calendar period effects</li>
<li>Data set 3 = the data set used here</li>
<li>Data set 4 = data set 2 but where the strength of the calendar period effect varies by development period.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="co"># this function generates the four different forms of data set as described in the LASSO paper</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>CreateSyntheticData<span class="ot">&lt;-</span><span class="cf">function</span>(whichsim, numperiods)</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create the acc/dev/cal parameters</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>    kk <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>numperiods, <span class="at">each =</span> numperiods) <span class="co">#AQ</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>    jj <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>numperiods, <span class="at">times=</span> numperiods) <span class="co">#DQ</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>    tt <span class="ot">&lt;-</span> kk<span class="sc">+</span>jj<span class="dv">-1</span> <span class="co"># PQ</span></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># set alpha/beta/gamma - hard-code up the sim values</span></span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (whichsim <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>        alpha <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="dv">100000</span>)<span class="sc">+</span><span class="fl">0.1</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">1</span>,<span class="dv">15</span>)<span class="sc">+</span><span class="fl">0.2</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">15</span>,<span class="dv">20</span>) <span class="sc">-</span> <span class="fl">0.05</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">30</span>,<span class="dv">40</span>) </span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>        beta  <span class="ot">&lt;-</span> (<span class="dv">16</span><span class="sc">/</span><span class="dv">3</span> <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="fu">log</span>(jj)<span class="sc">-</span> (<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)<span class="sc">*</span>jj</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>        gamma <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>        mu <span class="ot">&lt;-</span> <span class="fu">exp</span>( alpha <span class="sc">+</span> beta <span class="sc">+</span> gamma)  </span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> (whichsim <span class="sc">==</span> <span class="dv">2</span>){</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>        alpha <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="dv">100000</span>)<span class="sc">+</span><span class="fl">0.1</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">1</span>,<span class="dv">15</span>)<span class="sc">+</span><span class="fl">0.2</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">15</span>,<span class="dv">20</span>) <span class="sc">-</span> <span class="fl">0.05</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">30</span>,<span class="dv">40</span>) </span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>        beta  <span class="ot">&lt;-</span> (<span class="dv">16</span><span class="sc">/</span><span class="dv">3</span> <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="fu">log</span>(jj)<span class="sc">-</span> (<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)<span class="sc">*</span>jj  <span class="co"># a is 16/3, b is 1/3 </span></span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>        gamma <span class="ot">&lt;-</span> <span class="fu">gammafunc</span>(tt)</span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>        mu <span class="ot">&lt;-</span> <span class="fu">exp</span>( alpha <span class="sc">+</span> beta <span class="sc">+</span> gamma)  </span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> (whichsim <span class="sc">==</span> <span class="dv">3</span>){</span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a>        alpha <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="dv">100000</span>)<span class="sc">+</span><span class="fl">0.1</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">1</span>,<span class="dv">15</span>)<span class="sc">+</span><span class="fl">0.2</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">15</span>,<span class="dv">20</span>) <span class="sc">-</span> <span class="fl">0.05</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">30</span>,<span class="dv">40</span>) </span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a>        beta  <span class="ot">&lt;-</span> (<span class="dv">16</span><span class="sc">/</span><span class="dv">3</span> <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="fu">log</span>(jj)<span class="sc">-</span> (<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)<span class="sc">*</span>jj  <span class="co"># a is 16/3, b is 1/3 </span></span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a>        gamma <span class="ot">&lt;-</span> <span class="fu">gammafunc</span>(tt)</span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a>        mu <span class="ot">&lt;-</span> <span class="fu">exp</span>( alpha <span class="sc">+</span> beta <span class="sc">+</span> gamma <span class="sc">+</span> <span class="fl">0.3</span><span class="sc">*</span>beta<span class="sc">*</span><span class="fu">ifelse</span>(kk<span class="sc">&gt;</span><span class="dv">16</span> <span class="sc">&amp;</span> jj<span class="sc">&gt;</span><span class="dv">20</span>,<span class="dv">1</span>,<span class="dv">0</span>))  </span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> (whichsim <span class="sc">==</span> <span class="dv">4</span>){</span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a>        alpha <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="dv">100000</span>)<span class="sc">+</span><span class="fl">0.1</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">1</span>,<span class="dv">15</span>)<span class="sc">+</span><span class="fl">0.2</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">15</span>,<span class="dv">20</span>) <span class="sc">-</span> <span class="fl">0.05</span><span class="sc">*</span><span class="fu">LinearSpline</span>(kk,<span class="dv">30</span>,<span class="dv">40</span>) </span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a>        beta  <span class="ot">&lt;-</span> (<span class="dv">16</span><span class="sc">/</span><span class="dv">3</span> <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="fu">log</span>(jj)<span class="sc">-</span> (<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)<span class="sc">*</span>jj  <span class="co"># a is 16/3, b is 1/3 </span></span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a>        gamma <span class="ot">&lt;-</span> <span class="fu">gammafunc</span>(tt)</span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a>        mu <span class="ot">&lt;-</span> <span class="fu">exp</span>( alpha <span class="sc">+</span> beta <span class="sc">+</span> gamma<span class="sc">*</span>((numperiods<span class="dv">-1</span>)<span class="sc">-</span><span class="fu">LinearSpline</span>(jj,<span class="dv">1</span>,numperiods))<span class="sc">/</span>(numperiods<span class="dv">-1</span>) )  <span class="co"># need to check</span></span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a>    varbase <span class="ot">&lt;-</span> (<span class="fl">0.3</span> <span class="sc">*</span> mu[  kk<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> jj <span class="sc">==</span><span class="dv">16</span>] )<span class="sc">^</span><span class="dv">2</span> <span class="co"># can scale variance up and down here</span></span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a>    CC  <span class="ot">&lt;-</span>  varbase <span class="sc">/</span> mu[  kk<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> jj <span class="sc">==</span><span class="dv">16</span>]</span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-42"><a href="#cb75-42" aria-hidden="true" tabindex="-1"></a>    vars   <span class="ot">&lt;-</span> CC<span class="sc">*</span>mu</span>
<span id="cb75-43"><a href="#cb75-43" aria-hidden="true" tabindex="-1"></a>    tausq  <span class="ot">&lt;-</span> <span class="fu">log</span> (vars <span class="sc">/</span> (mu<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb75-44"><a href="#cb75-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-45"><a href="#cb75-45" aria-hidden="true" tabindex="-1"></a>    pmts <span class="ot">&lt;-</span> <span class="fu">exp</span>( <span class="fu">rnorm</span>( numperiods<span class="sc">^</span><span class="dv">2</span>, <span class="at">mean =</span> <span class="fu">log</span>(mu)<span class="sc">-</span><span class="fl">0.5</span><span class="sc">*</span>tausq , <span class="at">sd =</span> <span class="fu">sqrt</span>(tausq)  ) )</span>
<span id="cb75-46"><a href="#cb75-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-47"><a href="#cb75-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># indicator for past/future = traint/test</span></span>
<span id="cb75-48"><a href="#cb75-48" aria-hidden="true" tabindex="-1"></a>    train_ind<span class="ot">&lt;-</span>(tt<span class="sc">&lt;=</span>numperiods)</span>
<span id="cb75-49"><a href="#cb75-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-50"><a href="#cb75-50" aria-hidden="true" tabindex="-1"></a>    <span class="do">### data fram for output</span></span>
<span id="cb75-51"><a href="#cb75-51" aria-hidden="true" tabindex="-1"></a>    full<span class="ot">&lt;-</span><span class="fu">data.table</span>(pmts, <span class="at">acc=</span><span class="fu">as.integer</span>(kk), <span class="at">dev=</span><span class="fu">as.integer</span>(jj), <span class="at">cal=</span><span class="fu">as.integer</span>(tt), mu, train_ind )</span>
<span id="cb75-52"><a href="#cb75-52" aria-hidden="true" tabindex="-1"></a>    full</span>
<span id="cb75-53"><a href="#cb75-53" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-54"><a href="#cb75-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-55"><a href="#cb75-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-56"><a href="#cb75-56" aria-hidden="true" tabindex="-1"></a><span class="co">#---------------------------</span></span>
<span id="cb75-57"><a href="#cb75-57" aria-hidden="true" tabindex="-1"></a><span class="co"># function to generate calendar period effects used in CreateSyntheticData()</span></span>
<span id="cb75-58"><a href="#cb75-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-59"><a href="#cb75-59" aria-hidden="true" tabindex="-1"></a>gammafunc <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb75-60"><a href="#cb75-60" aria-hidden="true" tabindex="-1"></a>    gg <span class="ot">&lt;-</span> </span>
<span id="cb75-61"><a href="#cb75-61" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ifelse</span>( t<span class="sc">&lt;=</span><span class="dv">12</span>, gg <span class="ot">&lt;-</span> <span class="fl">0.0075</span><span class="sc">*</span><span class="fu">LinearSpline</span>(t,<span class="dv">1</span>,<span class="dv">12</span>),</span>
<span id="cb75-62"><a href="#cb75-62" aria-hidden="true" tabindex="-1"></a>                <span class="fu">ifelse</span>(t<span class="sc">&lt;=</span><span class="dv">24</span>,  gg <span class="ot">&lt;-</span> <span class="fl">0.0075</span><span class="sc">*</span><span class="fu">LinearSpline</span>(<span class="dv">12</span>,<span class="dv">1</span>,<span class="dv">12</span>) <span class="sc">+</span> <span class="fl">0.001</span><span class="sc">*</span> (t<span class="dv">-12</span>)<span class="sc">*</span>(t<span class="dv">-11</span>)<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb75-63"><a href="#cb75-63" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">ifelse</span>(t<span class="sc">&lt;=</span><span class="dv">32</span>, gg <span class="ot">&lt;-</span> <span class="fl">0.0075</span><span class="sc">*</span><span class="fu">LinearSpline</span>(<span class="dv">12</span>,<span class="dv">1</span>,<span class="dv">12</span>) <span class="sc">+</span> <span class="fl">0.001</span><span class="sc">*</span> (<span class="dv">24-12</span>)<span class="sc">*</span>(<span class="dv">24-11</span>)<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb75-64"><a href="#cb75-64" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">ifelse</span>(t<span class="sc">&lt;=</span><span class="dv">40</span>, gg <span class="ot">&lt;-</span> <span class="fl">0.0075</span><span class="sc">*</span><span class="fu">LinearSpline</span>(<span class="dv">12</span>,<span class="dv">1</span>,<span class="dv">12</span>) <span class="sc">+</span> <span class="fl">0.001</span><span class="sc">*</span> (<span class="dv">24-12</span>)<span class="sc">*</span>(<span class="dv">24-11</span>)<span class="sc">/</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.002</span><span class="sc">*</span>(t<span class="dv">-32</span>)<span class="sc">*</span>(t<span class="dv">-31</span>)<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb75-65"><a href="#cb75-65" aria-hidden="true" tabindex="-1"></a>                               <span class="fl">0.0075</span><span class="sc">*</span><span class="fu">LinearSpline</span>(<span class="dv">12</span>,<span class="dv">1</span>,<span class="dv">12</span>) <span class="sc">+</span> <span class="fl">0.001</span><span class="sc">*</span> (<span class="dv">24-12</span>)<span class="sc">*</span>(<span class="dv">24-11</span>)<span class="sc">/</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.002</span><span class="sc">*</span>(<span class="dv">40-32</span>)<span class="sc">*</span>(<span class="dv">40-31</span>)<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb75-66"><a href="#cb75-66" aria-hidden="true" tabindex="-1"></a>                           ))))</span>
<span id="cb75-67"><a href="#cb75-67" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">*</span>gg  <span class="co">#can scale up shape here if desired</span></span>
<span id="cb75-68"><a href="#cb75-68" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-69"><a href="#cb75-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-70"><a href="#cb75-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-71"><a href="#cb75-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-72"><a href="#cb75-72" aria-hidden="true" tabindex="-1"></a><span class="co">#---------------------------</span></span>
<span id="cb75-73"><a href="#cb75-73" aria-hidden="true" tabindex="-1"></a><span class="co"># linear spline function - used in data generation and in spline generation below</span></span>
<span id="cb75-74"><a href="#cb75-74" aria-hidden="true" tabindex="-1"></a><span class="co"># this was defined earlier on in this worked example, but including the definition here so it is self-contained</span></span>
<span id="cb75-75"><a href="#cb75-75" aria-hidden="true" tabindex="-1"></a>LinearSpline <span class="ot">&lt;-</span> <span class="cf">function</span>(var, start, stop){</span>
<span id="cb75-76"><a href="#cb75-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pmin</span>(stop <span class="sc">-</span> start, <span class="fu">pmax</span>(<span class="dv">0</span>, var <span class="sc">-</span> start))</span>
<span id="cb75-77"><a href="#cb75-77" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-78"><a href="#cb75-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-79"><a href="#cb75-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-80"><a href="#cb75-80" aria-hidden="true" tabindex="-1"></a><span class="co">#---------------------------</span></span>
<span id="cb75-81"><a href="#cb75-81" aria-hidden="true" tabindex="-1"></a><span class="co"># How to run the code</span></span>
<span id="cb75-82"><a href="#cb75-82" aria-hidden="true" tabindex="-1"></a><span class="co"># The code below, including the seed value, recreate the data we used above</span></span>
<span id="cb75-83"><a href="#cb75-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-84"><a href="#cb75-84" aria-hidden="true" tabindex="-1"></a><span class="co"># vary the seed to create different data sets of the same form</span></span>
<span id="cb75-85"><a href="#cb75-85" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">130</span>)  </span>
<span id="cb75-86"><a href="#cb75-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-87"><a href="#cb75-87" aria-hidden="true" tabindex="-1"></a><span class="co"># whichsim can be 1, 2, 3, 4 to produce data sets in the form above</span></span>
<span id="cb75-88"><a href="#cb75-88" aria-hidden="true" tabindex="-1"></a><span class="co"># numperiods sets the dimensions of the triangle</span></span>
<span id="cb75-89"><a href="#cb75-89" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">CreateSyntheticData</span>(<span class="at">whichsim =</span> <span class="dv">3</span>, <span class="at">numperiods =</span> <span class="dv">40</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="session-details" class="level2" data-number="9.12">
<h2 data-number="9.12" class="anchored" data-anchor-id="session-details"><span class="header-section-number">9.12</span> Session details</h2>
<p>The details of the R session used to generate the results are below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16 ucrt)
Platform: x86_64-w64-mingw32/x64 (64-bit)
Running under: Windows 10 x64 (build 19045)

Matrix products: default


locale:
[1] LC_COLLATE=English_Ireland.utf8  LC_CTYPE=English_Ireland.utf8   
[3] LC_MONETARY=English_Ireland.utf8 LC_NUMERIC=C                    
[5] LC_TIME=English_Ireland.utf8    

time zone: Europe/Dublin
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices datasets  utils     methods   base     

other attached packages:
[1] DT_0.30                      rpart.plot_3.1.1            
[3] rpart_4.1.19                 patchwork_1.1.3             
[5] ggplot2_3.4.4                data.table_1.14.8           
[7] mlr3extralearners_0.7.1-9000 mlr3verse_0.2.8             
[9] mlr3_0.16.1                 

loaded via a namespace (and not attached):
  [1] gridExtra_2.3          rlang_1.1.1            magrittr_2.0.3        
  [4] clue_0.3-65            compiler_4.3.1         flexmix_2.3-19        
  [7] vctrs_0.6.4            pkgconfig_2.0.3        shape_1.4.6           
 [10] crayon_1.5.2           fastmap_1.1.1          ellipsis_0.3.2        
 [13] backports_1.4.1        labeling_0.4.3         utf8_1.2.4            
 [16] rmarkdown_2.25         mlr3cluster_0.1.8      xfun_0.40             
 [19] glmnet_4.1-8           modeltools_0.2-23      cachem_1.0.8          
 [22] mlr3misc_0.13.0        jsonlite_1.8.7         uuid_1.1-1            
 [25] fpc_2.2-10             mlr3measures_0.5.0     mlr3fselect_0.11.0    
 [28] parallel_4.3.1         prabclus_2.3-3         cluster_2.1.4         
 [31] R6_2.5.1               bslib_0.5.1            ranger_0.15.1         
 [34] parallelly_1.36.0      jquerylib_0.1.4        diptest_0.76-0        
 [37] xgboost_1.7.5.1        Rcpp_1.0.11            iterators_1.0.14      
 [40] knitr_1.44             future.apply_1.11.0    Matrix_1.5-4.1        
 [43] splines_4.3.1          nnet_7.3-19            tidyselect_1.2.0      
 [46] rstudioapi_0.15.0      yaml_2.3.7             viridis_0.6.4         
 [49] mlr3tuning_0.19.0      mlr3viz_0.6.1          codetools_0.2-19      
 [52] listenv_0.9.0          lattice_0.21-8         tibble_3.2.1          
 [55] withr_2.5.1            evaluate_0.22          future_1.33.0         
 [58] survival_3.5-5         mclust_6.0.0           kernlab_0.9-32        
 [61] pillar_1.9.0           mlr3mbo_0.2.1          mlr3filters_0.7.1     
 [64] checkmate_2.3.0        renv_1.0.3             foreach_1.5.2         
 [67] stats4_4.3.1           generics_0.1.3         bbotk_0.7.2           
 [70] munsell_0.5.0          scales_1.2.1           globals_0.16.2        
 [73] class_7.3-22           glue_1.6.2             tools_4.3.1           
 [76] mlr3pipelines_0.5.0-1  robustbase_0.99-0      mlr3hyperband_0.4.5   
 [79] grid_4.3.1             crosstalk_1.2.0        mlr3data_0.7.0        
 [82] colorspace_2.1-0       paradox_0.11.1         palmerpenguins_0.1.1  
 [85] cli_3.6.1              spacefillr_0.3.2       fansi_1.0.5           
 [88] viridisLite_0.4.2      dplyr_1.1.3            gtable_0.3.4          
 [91] DEoptimR_1.1-3         sass_0.4.7             digest_0.6.33         
 [94] lgr_0.4.4              htmlwidgets_1.6.2      farver_2.1.1          
 [97] htmltools_0.5.6.1      lifecycle_1.0.3        mlr3learners_0.5.6    
[100] mlr3tuningspaces_0.4.0 MASS_7.3-60           </code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../Foundations/06_lasso.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Self-assembling claim reserving models using the LASSO</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../Foundations/08_intro_glm_gam_xgboost.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Getting to grips with GLM, GAM and XGBoost</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>